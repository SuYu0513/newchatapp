-- PostgreSQL パスワードリセット手順
-- 管理者権限で実行してください

-- 1. PostgreSQL サービスを停止
Stop-Service -Name "postgresql-x64-12"

-- 2. pg_hba.conf のバックアップを作成
Copy-Item "C:\Program Files\PostgreSQL\12\data\pg_hba.conf" "C:\Program Files\PostgreSQL\12\data\pg_hba.conf.backup"

-- 3. pg_hba.conf を一時的に trust に変更
(Get-Content "C:\Program Files\PostgreSQL\12\data\pg_hba.conf") -replace "host    all             all             127.0.0.1/32            md5", "host    all             all             127.0.0.1/32            trust" | Set-Content "C:\Program Files\PostgreSQL\12\data\pg_hba.conf"

-- 4. PostgreSQL サービスを再起動
Start-Service -Name "postgresql-x64-12"

-- 5. パスワードなしで接続してパスワードを設定
psql -h localhost -p 909 -U postgres -d postgres

-- 6. PostgreSQL内でパスワードを設定
ALTER USER postgres PASSWORD 'newpassword';

-- 7. pg_hba.conf を元に戻す
Copy-Item "C:\Program Files\PostgreSQL\12\data\pg_hba.conf.backup" "C:\Program Files\PostgreSQL\12\data\pg_hba.conf"

-- 8. PostgreSQL サービスを再起動
Restart-Service -Name "postgresql-x64-12"