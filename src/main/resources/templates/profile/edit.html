<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プロフィール編集 - チャットアプリ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/common.css" rel="stylesheet">
    <link href="/css/profile-edit.css" rel="stylesheet">
    <link href="/css/create-profile.css" rel="stylesheet">
    <style>
        .avatar-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary-color);
            transition: all 0.3s ease;
        }
        
        .avatar-upload-area {
            position: relative;
            display: inline-block;
        }
        
        .avatar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            cursor: pointer;
        }
        
        .avatar-upload-area:hover .avatar-overlay {
            opacity: 1;
        }
        
        .character-counter {
            font-size: 0.8rem;
            text-align: right;
        }
        
        .character-counter.warning {
            color: #f39c12;
        }
        
        .character-counter.danger {
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/chat">
                <i class="fas fa-comments me-2"></i>チャットアプリ
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" th:href="@{/chat}">
                    <i class="fas fa-comment me-1"></i>チャット
                </a>
                <a class="nav-link" th:href="@{/rooms}">
                    <i class="fas fa-list me-1"></i>ルーム一覧
                </a>
                <a class="nav-link" th:href="@{/profile}">
                    <i class="fas fa-user me-1"></i>プロフィール
                </a>
                <a class="nav-link" th:href="@{/logout}">
                    <i class="fas fa-sign-out-alt me-1"></i>ログアウト
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- ページヘッダー -->
        <div class="row mb-4">
            <div class="col">
                <h2>
                    <i class="fas fa-user-edit me-2"></i>プロフィール編集
                </h2>
                <p class="text-muted">あなたの情報を設定・変更できます</p>
            </div>
            <div class="col-auto">
                <a th:href="@{/profile}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>戻る
                </a>
            </div>
        </div>

        <!-- 成功・エラーメッセージ -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <form th:action="@{/profile/update}" method="post" enctype="multipart/form-data" id="profileForm">
            <div class="row">
                <!-- アバター編集 -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-image me-2"></i>アバター画像
                            </h6>
                        </div>
                        <div class="card-body text-center">
                            <div class="avatar-upload-area mb-3">
                                <img id="avatarPreview" 
                                     th:src="${profile.avatarUrlOrDefault}" 
                                     class="avatar-preview"
                                     alt="アバタープレビュー">
                                <div class="avatar-overlay">
                                    <i class="fas fa-camera text-white fa-2x"></i>
                                </div>
                                <input type="file" 
                                       id="avatarFile" 
                                       name="avatarFile" 
                                       accept="image/*" 
                                       style="display: none;">
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-primary" onclick="document.getElementById('avatarFile').click()">
                                    <i class="fas fa-upload me-2"></i>画像を選択
                                </button>
                                <button type="button" class="btn btn-outline-danger" id="removeAvatarBtn" 
                                        th:if="${profile.avatarUrl != null and !profile.avatarUrl.isEmpty()}">
                                    <i class="fas fa-trash me-2"></i>画像を削除
                                </button>
                            </div>
                            
                            <small class="text-muted mt-2 d-block">
                                JPG, PNG, GIF形式<br>
                                最大5MB
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- プロフィール情報編集 -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-user-circle me-2"></i>基本情報
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- 表示名 -->
                            <div class="mb-3">
                                <label for="displayName" class="form-label">
                                    <i class="fas fa-tag me-1"></i>表示名
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="displayName" 
                                       name="displayName" 
                                       th:value="${profile.displayName}"
                                       maxlength="50"
                                       placeholder="表示名を入力（空の場合はユーザー名が使用されます）">
                                <div class="character-counter" id="displayNameCounter">
                                    <span id="displayNameCount">0</span>/50
                                </div>
                            </div>
                            
                            <!-- 自己紹介 -->
                            <div class="mb-3">
                                <label for="bio" class="form-label">
                                    <i class="fas fa-info-circle me-1"></i>自己紹介
                                </label>
                                <textarea class="form-control" 
                                          id="bio" 
                                          name="bio" 
                                          rows="4" 
                                          maxlength="500"
                                          placeholder="あなた自身について教えてください..."
                                          th:text="${profile.bio}"></textarea>
                                <div class="character-counter" id="bioCounter">
                                    <span id="bioCount">0</span>/500
                                </div>
                            </div>
                            
                            <!-- 居住地 -->
                            <div class="mb-3">
                                <label for="location" class="form-label">
                                    <i class="fas fa-map-marker-alt me-1"></i>居住地
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="location" 
                                       name="location" 
                                       th:value="${profile.location}"
                                       maxlength="100"
                                       placeholder="例: 東京都, 日本">
                                <div class="character-counter" id="locationCounter">
                                    <span id="locationCount">0</span>/100
                                </div>
                            </div>
                            
                            <!-- ステータスメッセージ -->
                            <div class="mb-3">
                                <label for="status" class="form-label">
                                    <i class="fas fa-quote-left me-1"></i>ステータスメッセージ
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="status" 
                                       name="status" 
                                       th:value="${profile.status}"
                                       maxlength="100"
                                       placeholder="今の気分や状況を一言で...">
                                <div class="character-counter" id="statusCounter">
                                    <span id="statusCount">0</span>/100
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ランダムマッチング情報 -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-dice me-2"></i>ランダムマッチング情報
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">
                                以下の情報を設定すると、より相性の良い人とマッチングできます
                            </p>
                            
                            <!-- 年齢層 -->
                            <div class="mb-3">
                                <label for="ageGroup" class="form-label">
                                    <i class="fas fa-birthday-cake me-1"></i>年齢層
                                </label>
                                <select class="form-select" id="ageGroup" name="ageGroup">
                                    <option value="">選択してください</option>
                                    <option value="TEENS" th:selected="${profile.ageGroup == T(com.example.chatapp.entity.UserProfile.AgeGroup).TEENS}">10代</option>
                                    <option value="TWENTIES" th:selected="${profile.ageGroup == T(com.example.chatapp.entity.UserProfile.AgeGroup).TWENTIES}">20代</option>
                                    <option value="THIRTIES" th:selected="${profile.ageGroup == T(com.example.chatapp.entity.UserProfile.AgeGroup).THIRTIES}">30代</option>
                                    <option value="FORTIES" th:selected="${profile.ageGroup == T(com.example.chatapp.entity.UserProfile.AgeGroup).FORTIES}">40代</option>
                                    <option value="FIFTIES_PLUS" th:selected="${profile.ageGroup == T(com.example.chatapp.entity.UserProfile.AgeGroup).FIFTIES_PLUS}">50代以上</option>
                                    <option value="NOT_SPECIFIED" th:selected="${profile.ageGroup == T(com.example.chatapp.entity.UserProfile.AgeGroup).NOT_SPECIFIED}">未設定</option>
                                </select>
                            </div>
                            
                            <!-- チャットスタイル -->
                            <div class="mb-3">
                                <label for="chatStyle" class="form-label">
                                    <i class="fas fa-comments me-1"></i>チャットスタイル
                                </label>
                                <select class="form-select" id="chatStyle" name="chatStyle">
                                    <option value="">選択してください</option>
                                    <option value="CASUAL" th:selected="${profile.chatStyle == T(com.example.chatapp.entity.UserProfile.ChatStyle).CASUAL}">カジュアル</option>
                                    <option value="SERIOUS" th:selected="${profile.chatStyle == T(com.example.chatapp.entity.UserProfile.ChatStyle).SERIOUS}">真面目</option>
                                    <option value="FUNNY" th:selected="${profile.chatStyle == T(com.example.chatapp.entity.UserProfile.ChatStyle).FUNNY}">面白い</option>
                                    <option value="DEEP" th:selected="${profile.chatStyle == T(com.example.chatapp.entity.UserProfile.ChatStyle).DEEP}">深い話</option>
                                    <option value="LIGHT" th:selected="${profile.chatStyle == T(com.example.chatapp.entity.UserProfile.ChatStyle).LIGHT}">軽い話</option>
                                    <option value="CREATIVE" th:selected="${profile.chatStyle == T(com.example.chatapp.entity.UserProfile.ChatStyle).CREATIVE}">創造的</option>
                                    <option value="NOT_SPECIFIED" th:selected="${profile.chatStyle == T(com.example.chatapp.entity.UserProfile.ChatStyle).NOT_SPECIFIED}">未設定</option>
                                </select>
                            </div>
                            
                            <!-- 興味・関心 -->
                            <div class="mb-4">
                                <label class="form-label">
                                    <i class="fas fa-heart me-1"></i>興味・関心
                                </label>
                                <div class="tag-input-area mb-2">
                                    <input type="text" 
                                           class="form-control" 
                                           id="interestsInput"
                                           placeholder="興味・関心を入力..."
                                           maxlength="30">
                                    <button type="button" class="btn" onclick="addTag('interests')">
                                        <i class="fas fa-plus me-1"></i>追加
                                    </button>
                                </div>
                                <div id="interestsTags" class="tags-container"></div>
                                <div id="interestsCounter" class="tag-counter">0 / 30</div>
                                <input type="hidden" id="interests" name="interests" th:value="${profile.interests}">
                            </div>
                            
                            <!-- 趣味 -->
                            <div class="mb-4">
                                <label class="form-label">
                                    <i class="fas fa-gamepad me-1"></i>趣味
                                </label>
                                <div class="tag-input-area mb-2">
                                    <input type="text" 
                                           class="form-control" 
                                           id="hobbiesInput"
                                           placeholder="趣味を入力..."
                                           maxlength="30">
                                    <button type="button" class="btn" onclick="addTag('hobbies')">
                                        <i class="fas fa-plus me-1"></i>追加
                                    </button>
                                </div>
                                <div id="hobbiesTags" class="tags-container"></div>
                                <div id="hobbiesCounter" class="tag-counter">0 / 30</div>
                                <input type="hidden" id="hobbies" name="hobbies" th:value="${profile.hobbies}">
                            </div>
                            
                            <!-- 好きなもの -->
                            <div class="mb-4">
                                <label class="form-label">
                                    <i class="fas fa-star me-1"></i>好きなもの
                                </label>
                                <div class="tag-input-area mb-2">
                                    <input type="text" 
                                           class="form-control" 
                                           id="favoriteThingsInput"
                                           placeholder="好きなものを入力..."
                                           maxlength="30">
                                    <button type="button" class="btn" onclick="addTag('favoriteThings')">
                                        <i class="fas fa-plus me-1"></i>追加
                                    </button>
                                </div>
                                <div id="favoriteThingsTags" class="tags-container"></div>
                                <div id="favoriteThingsCounter" class="tag-counter">0 / 30</div>
                                <input type="hidden" id="favoriteThings" name="favoriteThings" th:value="${profile.favoriteThings}">
                            </div>
                            
                            <!-- 話せる言語 -->
                            <div class="mb-4">
                                <label class="form-label">
                                    <i class="fas fa-globe me-1"></i>話せる言語
                                </label>
                                <div class="tag-input-area mb-2">
                                    <input type="text" 
                                           class="form-control" 
                                           id="languagesInput"
                                           placeholder="言語を入力..."
                                           maxlength="30">
                                    <button type="button" class="btn" onclick="addTag('languages')">
                                        <i class="fas fa-plus me-1"></i>追加
                                    </button>
                                </div>
                                <div id="languagesTags" class="tags-container"></div>
                                <div id="languagesCounter" class="tag-counter">0 / 30</div>
                                <input type="hidden" id="languages" name="languages" th:value="${profile.languages}">
                            </div>
                            
                            <!-- 性格特性 -->
                            <div class="mb-4">
                                <label class="form-label">
                                    <i class="fas fa-user-circle me-1"></i>性格特性
                                </label>
                                <div class="tag-input-area mb-2">
                                    <input type="text" 
                                           class="form-control" 
                                           id="personalityTraitsInput"
                                           placeholder="性格特性を入力..."
                                           maxlength="30">
                                    <button type="button" class="btn" onclick="addTag('personalityTraits')">
                                        <i class="fas fa-plus me-1"></i>追加
                                    </button>
                                </div>
                                <div id="personalityTraitsTags" class="tags-container"></div>
                                <div id="personalityTraitsCounter" class="tag-counter">0 / 30</div>
                                <input type="hidden" id="personalityTraits" name="personalityTraits" th:value="${profile.personalityTraits}">
                            </div>
                        </div>
                    </div>
                    
                    <!-- プライバシー設定 -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-shield-alt me-2"></i>プライバシー設定
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- プロフィール公開レベル -->
                            <div class="mb-3">
                                <label for="privacyLevel" class="form-label">
                                    <i class="fas fa-eye me-1"></i>プロフィール公開レベル
                                </label>
                                <select class="form-select" id="privacyLevel" name="privacyLevel">
                                    <option value="PUBLIC" 
                                            th:selected="${profile.privacyLevel.name() == 'PUBLIC'}">
                                        誰でも閲覧可能
                                    </option>
                                    <option value="FRIENDS_ONLY" 
                                            th:selected="${profile.privacyLevel.name() == 'FRIENDS_ONLY'}">
                                        フレンドのみ
                                    </option>
                                    <option value="PRIVATE" 
                                            th:selected="${profile.privacyLevel.name() == 'PRIVATE'}">
                                        非公開
                                    </option>
                                </select>
                                <small class="text-muted">
                                    プロフィールを誰が閲覧できるかを設定します
                                </small>
                            </div>
                            
                            <!-- 検索可能設定 -->
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="isSearchable" 
                                           name="isSearchable" 
                                           th:checked="${profile.isSearchable}">
                                    <label class="form-check-label" for="isSearchable">
                                        <i class="fas fa-search me-1"></i>検索結果に表示する
                                    </label>
                                </div>
                                <small class="text-muted">
                                    他のユーザーがあなたを検索できるようになります
                                </small>
                            </div>
                            
                            <!-- ランダムマッチング設定 -->
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="allowRandomMatching" 
                                           name="allowRandomMatching" 
                                           th:checked="${profile.allowRandomMatching}">
                                    <label class="form-check-label" for="allowRandomMatching">
                                        <i class="fas fa-random me-1"></i>ランダムマッチングに参加する
                                    </label>
                                </div>
                                <small class="text-muted">
                                    知らない人とのランダムチャットに参加できます
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 保存ボタン -->
                    <div class="card mt-3">
                        <div class="card-body">
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-outline-secondary me-md-2" onclick="location.href='/profile'">
                                    <i class="fas fa-times me-1"></i>キャンセル
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>変更を保存
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // アバター画像プレビュー
            const avatarFile = document.getElementById('avatarFile');
            const avatarPreview = document.getElementById('avatarPreview');
            const removeAvatarBtn = document.getElementById('removeAvatarBtn');
            
            // アバターエリアクリックでファイル選択
            document.querySelector('.avatar-upload-area').addEventListener('click', function() {
                avatarFile.click();
            });
            
            // ファイル選択時のプレビュー更新
            avatarFile.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // ファイルサイズチェック (5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('ファイルサイズは5MB以下にしてください。');
                        this.value = '';
                        return;
                    }
                    
                    // プレビュー表示
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        avatarPreview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    
                    // 削除ボタンを表示
                    if (removeAvatarBtn) {
                        removeAvatarBtn.style.display = 'block';
                    }
                }
            });
            
            // アバター削除
            if (removeAvatarBtn) {
                removeAvatarBtn.addEventListener('click', function() {
                    if (confirm('アバター画像を削除しますか？')) {
                        avatarPreview.src = '/images/default-avatar.png';
                        avatarFile.value = '';
                        
                        // サーバーに削除リクエストを送信
                        fetch('/profile/avatar/delete', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        }).then(response => {
                            if (response.ok) {
                                this.style.display = 'none';
                            }
                        });
                    }
                });
            }
            
            // 文字数カウンター
            function updateCharacterCounter(inputId, counterId, maxLength) {
                const input = document.getElementById(inputId);
                const counter = document.getElementById(counterId);
                const countSpan = document.getElementById(counterId.replace('Counter', 'Count'));
                
                function updateCount() {
                    const currentLength = input.value.length;
                    countSpan.textContent = currentLength;
                    
                    counter.classList.remove('warning', 'danger');
                    if (currentLength > maxLength * 0.8) {
                        counter.classList.add('warning');
                    }
                    if (currentLength > maxLength * 0.95) {
                        counter.classList.add('danger');
                    }
                }
                
                input.addEventListener('input', updateCount);
                updateCount(); // 初期表示
            }
            
            // 各フィールドの文字数カウンター初期化
            updateCharacterCounter('displayName', 'displayNameCounter', 50);
            updateCharacterCounter('bio', 'bioCounter', 500);
            updateCharacterCounter('location', 'locationCounter', 100);
            updateCharacterCounter('status', 'statusCounter', 100);
            
            // フォーム送信前のバリデーション
            document.getElementById('profileForm').addEventListener('submit', function(e) {
                const displayName = document.getElementById('displayName').value;
                const bio = document.getElementById('bio').value;
                const location = document.getElementById('location').value;
                const status = document.getElementById('status').value;
                
                // 長さチェック
                if (displayName.length > 50 || bio.length > 500 || 
                    location.length > 100 || status.length > 100) {
                    e.preventDefault();
                    alert('入力文字数が制限を超えています。');
                    return;
                }
                
                // 送信中の表示
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>保存中...';
                submitBtn.disabled = true;
                
                // エラー時の復元（タイムアウト）
                setTimeout(function() {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }, 10000);
            });
            
            // タグ管理システム
            const MAX_TAGS = 30;
            const tagSets = {
                interests: new Set(),
                hobbies: new Set(),
                favoriteThings: new Set(),
                languages: new Set(),
                personalityTraits: new Set()
            };
            
            // 既存のタグを読み込む
            function loadExistingTags() {
                ['interests', 'hobbies', 'favoriteThings', 'languages', 'personalityTraits'].forEach(fieldName => {
                    const hiddenInput = document.getElementById(fieldName);
                    if (hiddenInput && hiddenInput.value) {
                        const tags = hiddenInput.value.split(',').map(t => t.trim()).filter(t => t);
                        tags.forEach(tag => tagSets[fieldName].add(tag));
                        updateTagsDisplay(fieldName);
                    }
                });
            }
            
            // タグ追加
            function addTag(fieldName) {
                const input = document.getElementById(fieldName + 'Input');
                const tagName = input.value.trim();
                
                if (!tagName) {
                    return;
                }
                
                if (tagSets[fieldName].size >= MAX_TAGS) {
                    alert(`タグは最大${MAX_TAGS}個までです`);
                    return;
                }
                
                if (tagSets[fieldName].has(tagName)) {
                    alert('このタグは既に追加されています');
                    return;
                }
                
                tagSets[fieldName].add(tagName);
                input.value = '';
                updateTagsDisplay(fieldName);
            }
            
            // タグ削除
            function removeTag(fieldName, tagName) {
                tagSets[fieldName].delete(tagName);
                updateTagsDisplay(fieldName);
            }
            
            // タグ表示更新
            function updateTagsDisplay(fieldName) {
                const container = document.getElementById(fieldName + 'Tags');
                const counter = document.getElementById(fieldName + 'Counter');
                const hiddenInput = document.getElementById(fieldName);
                
                // コンテナをクリア
                container.innerHTML = '';
                
                // タグを表示
                tagSets[fieldName].forEach(tagName => {
                    const tagElement = document.createElement('div');
                    tagElement.className = 'tag selected';
                    tagElement.innerHTML = `
                        <span>${tagName}</span>
                        <i class="fas fa-times" onclick="removeTag('${fieldName}', '${tagName}')"></i>
                    `;
                    container.appendChild(tagElement);
                });
                
                // カウンター更新
                const count = tagSets[fieldName].size;
                counter.textContent = `${count} / ${MAX_TAGS}`;
                counter.classList.toggle('limit', count >= MAX_TAGS);
                
                // 隠しフィールド更新
                hiddenInput.value = Array.from(tagSets[fieldName]).join(',');
            }
            
            // Enterキーでタグ追加
            ['interests', 'hobbies', 'favoriteThings', 'languages', 'personalityTraits'].forEach(fieldName => {
                const input = document.getElementById(fieldName + 'Input');
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addTag(fieldName);
                    }
                });
            });
            
            // グローバル関数として定義
            window.addTag = addTag;
            window.removeTag = removeTag;
            
            // 初期化
            loadExistingTags();
        });
    </script>
</body>
</html>
