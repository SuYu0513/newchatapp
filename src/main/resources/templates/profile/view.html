<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« - ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/chat-style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ³ãƒˆ */
        * {
            font-family: 'Noto Sans JP', 'Poppins', sans-serif;
        }
        
        /* èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        .floating-shapes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .shape {
            position: absolute;
            opacity: 0.1;
            animation: float 6s ease-in-out infinite;
        }
        
        .shape:nth-child(1) {
            top: 10%;
            left: 10%;
            width: 80px;
            height: 80px;
            background: #ff6b6b;
            border-radius: 50%;
            animation-delay: 0s;
        }
        
        .shape:nth-child(2) {
            top: 20%;
            right: 20%;
            width: 60px;
            height: 60px;
            background: #4ecdc4;
            border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
            animation-delay: 1s;
        }
        
        .shape:nth-child(3) {
            bottom: 30%;
            left: 15%;
            width: 100px;
            height: 100px;
            background: #45b7d1;
            border-radius: 20px;
            animation-delay: 2s;
            transform: rotate(45deg);
        }
        
        .shape:nth-child(4) {
            bottom: 20%;
            right: 10%;
            width: 70px;
            height: 70px;
            background: #f9ca24;
            border-radius: 50% 0 50% 0;
            animation-delay: 3s;
        }
        
        .shape:nth-child(5) {
            top: 50%;
            left: 50%;
            width: 90px;
            height: 90px;
            background: #6c5ce7;
            border-radius: 50%;
            animation-delay: 4s;
        }
        
        .shape:nth-child(6) {
            top: 70%;
            right: 40%;
            width: 50px;
            height: 50px;
            background: #fd79a8;
            border-radius: 50%;
            animation-delay: 5s;
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
            }
            50% {
                transform: translateY(-20px) rotate(180deg);
            }
        }
        
        /* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: particle-float 8s linear infinite;
        }
        
        @keyframes particle-float {
            0% {
                transform: translateY(100vh) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-10vh) scale(1);
                opacity: 0;
            }
        }
        
        /* ã‚«ãƒ¼ãƒ‰ ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 20px 20px 0 0 !important;
            padding: 1.5rem;
        }
        
        .card-body {
            padding: 2rem;
        }
        
        /* ã‚¢ãƒã‚¿ãƒ¼ ã‚¹ã‚¿ã‚¤ãƒ« */
        .avatar-container {
            position: relative;
            display: inline-block;
            margin-bottom: 2rem;
        }
        
        .avatar-container::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #f9ca24);
            border-radius: 50%;
            z-index: -1;
            animation: rotate 4s linear infinite;
        }
        
        @keyframes rotate {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        .avatar-img {
            border: 6px solid white;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }
        
        .avatar-img:hover {
            transform: scale(1.05);
        }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ãƒãƒƒã‚¸ */
        .status-badge {
            position: relative;
            overflow: hidden;
            border-radius: 25px;
            padding: 0.5rem 1rem;
            margin: 0.5rem;
            transition: all 0.3s ease;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
            }
        }
        
        /* ãƒœã‚¿ãƒ³ ã‚¹ã‚¿ã‚¤ãƒ« */
        .btn {
            border-radius: 25px;
            padding: 0.75rem 2rem;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f9ca24 0%, #f0932b 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }
        
        /* çµ±è¨ˆæƒ…å ± */
        .stats-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.8) 100%);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #f9ca24);
            animation: shimmer 2s linear infinite;
        }
        
        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
        }
        
        /* ã‚¢ãƒ©ãƒ¼ãƒˆ ã‚¹ã‚¿ã‚¤ãƒ« */
        .alert {
            border-radius: 15px;
            border: none;
            padding: 1rem 1.5rem;
            backdrop-filter: blur(10px);
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .navbar {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand, .nav-link {
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            transform: translateY(-2px);
            color: #f8f9fa !important;
        }
        
        /* ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®š */
        .privacy-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 1rem;
            margin: 0.5rem 0;
            transition: all 0.3s ease;
        }
        
        .privacy-item:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateX(5px);
        }
        
        /* ãƒ•ãƒ¬ãƒ³ãƒ‰ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .friend-status-container {
            border-radius: 15px;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(139, 195, 74, 0.1) 100%);
            border: 2px solid rgba(76, 175, 80, 0.2);
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .card-body {
                padding: 1rem;
            }
            
            .stats-number {
                font-size: 2rem;
            }
            
            .shape {
                display: none;
            }
        }
        
        /* ãƒ­ãƒ¼ãƒ‰ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        
        .loader {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ€ãƒ¼ -->
    <div class="page-loader" id="pageLoader">
        <div class="loader"></div>
    </div>
    
    <!-- èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="floating-shapes">
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
    </div>
    
    <!-- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ -->
    <div class="particles" id="particles"></div>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/chat">
                <i class="fas fa-comments me-2"></i>âœ¨ ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" th:href="@{/chat}">
                    <i class="fas fa-comment me-1"></i>ãƒãƒ£ãƒƒãƒˆ
                </a>
                <a class="nav-link" th:href="@{/friends}">
                    <i class="fas fa-user-friends me-1"></i>ãƒ•ãƒ¬ãƒ³ãƒ‰
                </a>
                <a class="nav-link" th:href="@{/rooms}">
                    <i class="fas fa-list me-1"></i>ãƒ«ãƒ¼ãƒ ä¸€è¦§
                </a>
                <a class="nav-link active" th:href="@{/profile}">
                    <i class="fas fa-user me-1"></i>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
                </a>
                <a class="nav-link" th:href="@{/logout}">
                    <i class="fas fa-sign-out-alt me-1"></i>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- æˆåŠŸãƒ»ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="row">
            <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <!-- ã‚¢ãƒã‚¿ãƒ¼ç”»åƒ -->
                        <div class="avatar-container">
                            <img th:src="${profile.avatarUrlOrDefault}" 
                                 class="rounded-circle avatar-img" 
                                 width="150" 
                                 height="150" 
                                 style="object-fit: cover;"
                                 alt="ã‚¢ãƒã‚¿ãƒ¼">
                        </div>
                        
                        <!-- è¡¨ç¤ºåãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼å -->
                        <h4 th:text="${profile.displayNameOrUsername}" class="mb-1 fw-bold">è¡¨ç¤ºå</h4>
                        <p class="text-muted mb-3">
                            <i class="fas fa-at me-1"></i><span th:text="${user.username}">username</span>
                        </p>
                        
                        <!-- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
                        <div class="mb-3">
                            <span class="badge status-badge" 
                                  th:classappend="${profile.onlineStatus.name() == 'ONLINE'} ? 'bg-success' : 
                                                 (${profile.onlineStatus.name() == 'AWAY'} ? 'bg-warning' : 
                                                 (${profile.onlineStatus.name() == 'BUSY'} ? 'bg-danger' : 'bg-secondary'))"
                                  th:text="${profile.onlineStatus.displayName}">
                                <i class="fas fa-circle me-1"></i>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                            </span>
                        </div>
                        
                        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                        <div th:if="${profile.status != null and !profile.status.isEmpty()}" class="mb-3">
                            <div class="alert alert-info py-2" style="border-radius: 15px;">
                                <i class="fas fa-quote-left me-1"></i>
                                <span th:text="${profile.status}">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</span>
                                <i class="fas fa-quote-right ms-1"></i>
                            </div>
                        </div>
                        
                        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                        <div class="d-grid gap-2" th:if="${isOwnProfile}">
                            <a th:href="@{/profile/edit}" class="btn btn-primary">
                                <i class="fas fa-edit me-2"></i>âœ¨ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
                            </a>
                        </div>
                        
                        <!-- ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®å ´åˆã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                        <div class="d-grid gap-2" th:unless="${isOwnProfile}">
                            <!-- ãƒ•ãƒ¬ãƒ³ãƒ‰é–¢ä¿‚ã®çŠ¶æ…‹ã«å¿œã˜ãŸãƒœã‚¿ãƒ³è¡¨ç¤º -->
                            
                            <!-- ãƒ•ãƒ¬ãƒ³ãƒ‰ã§ãªã„å ´åˆ: ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ãƒœã‚¿ãƒ³ -->
                            <button th:if="${friendshipStatus == 'NONE'}" 
                                    class="btn btn-success"
                                    onclick="sendFriendRequest()"
                                    id="friendActionBtn">
                                <i class="fas fa-user-plus me-2"></i>ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹
                            </button>
                            
                            <!-- ç”³è«‹é€ä¿¡æ¸ˆã¿ã®å ´åˆ: ç”³è«‹æ¸ˆã¿ãƒœã‚¿ãƒ³ -->
                            <button th:if="${friendshipStatus == 'REQUEST_SENT'}" 
                                    class="btn btn-warning" 
                                    onclick="cancelFriendRequest()"
                                    id="friendActionBtn">
                                <i class="fas fa-clock me-2"></i>ç”³è«‹æ¸ˆã¿ï¼ˆå–ã‚Šæ¶ˆã—ï¼‰
                            </button>
                            
                            <!-- ç”³è«‹å—ä¿¡ã®å ´åˆ: æ‰¿èªãƒ»æ‹’å¦ãƒœã‚¿ãƒ³ -->
                            <div th:if="${friendshipStatus == 'REQUEST_RECEIVED'}" class="d-grid gap-1">
                                <button class="btn btn-success" onclick="acceptFriendRequest()">
                                    <i class="fas fa-check me-2"></i>ç”³è«‹ã‚’æ‰¿èª
                                </button>
                                <button class="btn btn-outline-danger" onclick="declineFriendRequest()">
                                    <i class="fas fa-times me-2"></i>ç”³è«‹ã‚’æ‹’å¦
                                </button>
                            </div>
                            
                            <!-- æ—¢ã«ãƒ•ãƒ¬ãƒ³ãƒ‰ã®å ´åˆ: ãƒ•ãƒ¬ãƒ³ãƒ‰è¡¨ç¤ºã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                            <div th:if="${friendshipStatus == 'FRIEND'}" class="friend-status-container">
                                <!-- ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
                                <div class="alert alert-success d-flex align-items-center mb-3" role="alert">
                                    <i class="fas fa-user-friends fs-4 me-3"></i>
                                    <div>
                                        <strong>ãƒ•ãƒ¬ãƒ³ãƒ‰</strong>
                                        <div class="small">ã“ã®äººã¨ãƒ•ãƒ¬ãƒ³ãƒ‰ã§ã™</div>
                                    </div>
                                </div>
                                
                                <!-- ãƒ•ãƒ¬ãƒ³ãƒ‰å‘ã‘ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="startPrivateChat()">
                                        <i class="fas fa-comment me-2"></i>ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒƒãƒˆ
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="removeFriend()">
                                        <i class="fas fa-user-minus me-2"></i>ãƒ•ãƒ¬ãƒ³ãƒ‰è§£é™¤
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="blockUser()">
                                        <i class="fas fa-ban me-2"></i>ãƒ–ãƒ­ãƒƒã‚¯
                                    </button>
                                </div>
                            </div>
                            
                            <!-- ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆ -->
                            <div th:if="${friendshipStatus == 'BLOCKED'}" class="alert alert-danger d-flex align-items-center" role="alert">
                                <i class="fas fa-ban fs-4 me-3"></i>
                                <div>
                                    <strong>ãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿</strong>
                                    <div class="small">ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- çµ±è¨ˆæƒ…å ± -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-chart-bar me-2"></i>ğŸ“Š çµ±è¨ˆæƒ…å ±
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="stats-card">
                                    <div class="stats-number">0</div>
                                    <small class="text-muted fw-bold">
                                        <i class="fas fa-user-friends me-1"></i>ãƒ•ãƒ¬ãƒ³ãƒ‰
                                    </small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stats-card">
                                    <div class="stats-number">0</div>
                                    <small class="text-muted fw-bold">
                                        <i class="fas fa-comment-dots me-1"></i>ãƒãƒ£ãƒƒãƒˆæ•°
                                    </small>
                                </div>
                            </div>
                        </div>
                        <hr style="border-color: rgba(102, 126, 234, 0.2);">
                        <div class="text-center">
                            <small class="text-muted">
                                <i class="fas fa-calendar-plus me-1"></i>
                                å‚åŠ æ—¥: <span th:text="${#temporals.format(profile.createdAt, 'yyyy/MM/dd')}" class="fw-bold">2024/01/01</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è©³ç´° -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0 fw-bold">
                            <i class="fas fa-user-circle me-2"></i>ğŸ’« ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è©³ç´°
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- è‡ªå·±ç´¹ä»‹ -->
                        <div class="mb-4" th:if="${profile.bio != null and !profile.bio.isEmpty()}">
                            <h6 class="text-primary fw-bold">
                                <i class="fas fa-info-circle me-2"></i>ğŸ“ è‡ªå·±ç´¹ä»‹
                            </h6>
                            <div class="p-3" style="background: rgba(102, 126, 234, 0.05); border-radius: 10px; border-left: 4px solid #667eea;">
                                <p th:text="${profile.bio}" class="text-muted mb-0">
                                    è‡ªå·±ç´¹ä»‹æ–‡ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                                </p>
                            </div>
                        </div>
                        
                        <!-- å±…ä½åœ° -->
                        <div class="mb-4" th:if="${profile.location != null and !profile.location.isEmpty()}">
                            <h6 class="text-primary fw-bold">
                                <i class="fas fa-map-marker-alt me-2"></i>ğŸŒ å±…ä½åœ°
                            </h6>
                            <div class="p-3" style="background: rgba(76, 175, 80, 0.05); border-radius: 10px; border-left: 4px solid #4caf50;">
                                <p th:text="${profile.location}" class="text-muted mb-0">
                                    å±…ä½åœ°
                                </p>
                            </div>
                        </div>
                        
                        <!-- ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ï¼ˆè‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
                        <div class="mb-4" th:if="${isOwnProfile}">
                            <h6 class="text-primary fw-bold">
                                <i class="fas fa-id-card me-2"></i>ğŸ”‘ ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰
                            </h6>
                            <div class="p-3" style="background: rgba(255, 193, 7, 0.05); border-radius: 10px; border-left: 4px solid #ffc107;">
                                <div class="d-flex align-items-center">
                                    <code class="bg-light border rounded px-3 py-2 me-2 flex-grow-1" 
                                          style="font-size: 1.1em; letter-spacing: 1px; border-radius: 10px !important; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;"
                                          th:text="${user.friendCode}">12345678</code>
                                    <button class="btn btn-outline-primary btn-sm" 
                                            onclick="copyFriendCode()"
                                            title="ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼"
                                            style="border-radius: 10px;">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <small class="text-muted mt-2 d-block">
                                    <i class="fas fa-info-circle me-1"></i>
                                    ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å‹é”ã«æ•™ãˆã¦ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ã—ã¦ã‚‚ã‚‰ã„ã¾ã—ã‚‡ã† âœ¨
                                </small>
                            </div>
                        </div>
                        
                        <!-- æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³ -->
                        <div class="mb-4" th:if="${profile.lastSeen != null}">
                            <h6 class="text-primary fw-bold">
                                <i class="fas fa-clock me-2"></i>â° æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³
                            </h6>
                            <div class="p-3" style="background: rgba(156, 39, 176, 0.05); border-radius: 10px; border-left: 4px solid #9c27b0;">
                                <p th:text="${#temporals.format(profile.lastSeen, 'yyyyå¹´MMæœˆddæ—¥ HH:mm')}" class="text-muted mb-0">
                                    æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ™‚é–“
                                </p>
                            </div>
                        </div>
                        
                        <!-- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®šè¡¨ç¤º -->
                        <div class="mb-4" th:if="${isOwnProfile}">
                            <h6 class="text-primary fw-bold">
                                <i class="fas fa-shield-alt me-2"></i>ğŸ”’ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®š
                            </h6>
                            <div style="background: rgba(96, 125, 139, 0.05); border-radius: 10px; padding: 1rem;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="privacy-item">
                                            <small class="text-muted fw-bold">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å…¬é–‹ãƒ¬ãƒ™ãƒ«:</small>
                                            <div class="mt-1">
                                                <span class="badge bg-info" th:text="${profile.privacyLevel.displayName}">å…¬é–‹</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="privacy-item">
                                            <small class="text-muted fw-bold">æ¤œç´¢å¯èƒ½:</small>
                                            <div class="mt-1">
                                                <span class="badge" 
                                                      th:classappend="${profile.isSearchable} ? 'bg-success' : 'bg-danger'"
                                                      th:text="${profile.isSearchable} ? 'ã¯ã„' : 'ã„ã„ãˆ'">ã¯ã„</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <div class="privacy-item">
                                            <small class="text-muted fw-bold">ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒƒãƒãƒ³ã‚°:</small>
                                            <div class="mt-1">
                                                <span class="badge" 
                                                      th:classappend="${profile.allowRandomMatching} ? 'bg-success' : 'bg-danger'"
                                                      th:text="${profile.allowRandomMatching} ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'">æœ‰åŠ¹</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒç©ºã®å ´åˆ -->
                        <div th:if="${profile.bio == null or profile.bio.isEmpty()}" class="text-center py-5">
                            <div style="animation: bounce 2s infinite;">
                                <i class="fas fa-user-circle fa-3x text-muted mb-3"></i>
                            </div>
                            <p class="text-muted mb-3">âœ¨ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                            <a th:if="${isOwnProfile}" th:href="@{/profile/edit}" class="btn btn-outline-primary">
                                <i class="fas fa-edit me-1"></i>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- ãƒ•ãƒ¬ãƒ³ãƒ‰ä¸€è¦§ï¼ˆä»Šå¾Œå®Ÿè£…ï¼‰ -->
                <!-- <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-users me-2"></i>ãƒ•ãƒ¬ãƒ³ãƒ‰ä¸€è¦§
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="text-center py-3">
                            <i class="fas fa-users fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-0">ãƒ•ãƒ¬ãƒ³ãƒ‰æ©Ÿèƒ½ã¯è¿‘æ—¥å®Ÿè£…äºˆå®šã§ã™</p>
                        </div>
                    </div>
                </div> -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ -->
    <script>
        // URLã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
        const currentUrl = window.location.pathname; // /profile/4 ã®ã‚ˆã†ãªå½¢å¼
        const urlUserIdMatch = currentUrl.match(/\/profile\/(\d+)$/);
        const urlUserId = urlUserIdMatch ? parseInt(urlUserIdMatch[1]) : null;
        
        // Thymeleafã‹ã‚‰å€¤ã‚’å–å¾—
        const rawUserId = /*[[${user.id}]]*/ null;
        const rawIsOwnProfile = /*[[${isOwnProfile}]]*/ true;
        const currentUserId = /*[[${currentUser.id}]]*/ null;
        
        // ã‚ˆã‚Šç¢ºå®Ÿãªåˆ¤å®šæ–¹æ³•ï¼šè¤‡æ•°ã®æ–¹æ³•ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
        let targetUserId = null;
        let isOwnProfile = false;
        
        // ä½¿ç”¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆURLã‹ã‚‰å–å¾—ã—ãŸã‚‚ã®ã‚’å„ªå…ˆï¼‰
        const displayUserId = urlUserId || rawUserId;
        
        // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨è¡¨ç¤ºãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒåŒã˜å ´åˆã¯è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
        if (currentUserId && displayUserId && currentUserId === displayUserId) {
            isOwnProfile = true;
            targetUserId = null;
        } else if (displayUserId) {
            isOwnProfile = false;
            targetUserId = displayUserId;
        } else {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šThymeleafã®isOwnProfileã‚’ä½¿ç”¨
            isOwnProfile = rawIsOwnProfile;
            targetUserId = isOwnProfile ? null : (rawUserId || urlUserId);
        }
        
        const userId = displayUserId;
        const friendshipStatus = /*[[${friendshipStatus}]]*/ 'NONE';
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
        console.log('=== ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢ãƒ‡ãƒãƒƒã‚°æƒ…å ± ===');
        console.log('ç¾åœ¨ã®URL:', currentUrl);
        console.log('URLã‹ã‚‰å–å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ID:', urlUserId);
        console.log('currentUserId:', currentUserId, '(type:', typeof currentUserId, ')');
        console.log('rawUserId:', rawUserId, '(type:', typeof rawUserId, ')');
        console.log('rawIsOwnProfile:', rawIsOwnProfile, '(type:', typeof rawIsOwnProfile, ')');
        console.log('ä½¿ç”¨ã™ã‚‹displayUserId:', displayUserId);
        console.log('è¨ˆç®—å¾Œ isOwnProfile:', isOwnProfile);
        console.log('è¨ˆç®—å¾Œ targetUserId:', targetUserId);
        console.log('userId:', userId);
        console.log('friendshipStatus:', friendshipStatus);
        console.log('currentUserId === displayUserId:', currentUserId === displayUserId);
        console.log('====================================');
        
        function copyFriendCode() {
            const friendCodeElement = document.querySelector('code');
            const friendCode = friendCodeElement.textContent;
            
            if (navigator.clipboard && window.isSecureContext) {
                // Clipboard API ã‚’ä½¿ç”¨ï¼ˆHTTPSå¿…é ˆï¼‰
                navigator.clipboard.writeText(friendCode).then(() => {
                    showCopySuccess();
                }).catch(err => {
                    console.error('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
                    fallbackCopy(friendCode);
                });
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ–¹æ³•
                fallbackCopy(friendCode);
            }
        }
        
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showCopySuccess();
            } catch (err) {
                console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
            } finally {
                document.body.removeChild(textArea);
            }
        }
        
        function showCopySuccess() {
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            
            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä¸€æ™‚çš„ã«å¤‰æ›´
            button.innerHTML = '<i class="fas fa-check text-success"></i>';
            button.classList.add('btn-success');
            button.classList.remove('btn-outline-primary');
            
            // ä¸€å®šæ™‚é–“å¾Œã«å…ƒã«æˆ»ã™
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-primary');
            }, 2000);
            
            // ãƒˆãƒ¼ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            showToast('ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼', 'success');
        }
        
        function showToast(message, type = 'info') {
            // æ—¢å­˜ã®ãƒˆãƒ¼ã‚¹ãƒˆã‚’å‰Šé™¤
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // ãƒˆãƒ¼ã‚¹ãƒˆHTML
            const toastHTML = `
                <div class="toast-container position-fixed top-0 end-0 p-3">
                    <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header bg-${type} text-white">
                            <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                            <strong class="me-auto">é€šçŸ¥</strong>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                        </div>
                        <div class="toast-body">
                            ${message}
                        </div>
                    </div>
                </div>
            `;
            
            // ãƒˆãƒ¼ã‚¹ãƒˆã‚’è¡¨ç¤º
            document.body.insertAdjacentHTML('beforeend', toastHTML);
            
            // 3ç§’å¾Œã«è‡ªå‹•ã§éš ã™
            setTimeout(() => {
                const toast = document.querySelector('.toast');
                if (toast) {
                    toast.classList.remove('show');
                    setTimeout(() => toast.parentElement.remove(), 150);
                }
            }, 3000);
        }
        
        // ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹é–¢é€£ã®é–¢æ•°
        function sendFriendRequest() {
            console.log('=== sendFriendRequesté–¢æ•°ãƒ‡ãƒãƒƒã‚° ===');
            console.log('currentUserId:', currentUserId);
            console.log('displayUserId:', displayUserId);
            console.log('urlUserId:', urlUserId);
            console.log('rawUserId:', rawUserId);
            console.log('rawIsOwnProfile:', rawIsOwnProfile);
            console.log('è¨ˆç®—å¾Œ isOwnProfile:', isOwnProfile);
            console.log('targetUserId:', targetUserId);
            console.log('======================================');
            
            // ã¾ãšåŸºæœ¬çš„ãªãƒã‚§ãƒƒã‚¯ï¼šIDãƒ™ãƒ¼ã‚¹ã§ã®åˆ¤å®š
            if (currentUserId && displayUserId && currentUserId === displayUserId) {
                console.error('è‡ªåˆ†è‡ªèº«ã«ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ã¯ã§ãã¾ã›ã‚“ï¼ˆIDãƒ™ãƒ¼ã‚¹åˆ¤å®šï¼‰');
                showToast('è‡ªåˆ†è‡ªèº«ã«ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ã¯ã§ãã¾ã›ã‚“', 'danger');
                return;
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯åˆ¤å®š
            if (isOwnProfile === true) {
                console.error('è‡ªåˆ†è‡ªèº«ã«ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ã¯ã§ãã¾ã›ã‚“ï¼ˆãƒ•ãƒ©ã‚°ãƒ™ãƒ¼ã‚¹åˆ¤å®šï¼‰');
                showToast('è‡ªåˆ†è‡ªèº«ã«ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ã¯ã§ãã¾ã›ã‚“', 'danger');
                return;
            }
            
            // é€ä¿¡ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’æ±ºå®šï¼ˆè¤‡æ•°ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ï¼‰
            const userIdToSend = targetUserId || displayUserId || rawUserId || urlUserId;
            
            if (!userIdToSend) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“');
                console.log('åˆ©ç”¨å¯èƒ½ãªå€¤:', {
                    targetUserId: targetUserId,
                    displayUserId: displayUserId,
                    rawUserId: rawUserId,
                    urlUserId: urlUserId,
                    userId: userId
                });
                showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ', 'danger');
                return;
            }
            
            const button = document.getElementById('friendActionBtn');
            if (!button) {
                console.error('friendActionBtnãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>é€ä¿¡ä¸­...';
            
            console.log('ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹APIã‚’å‘¼ã³å‡ºã—ã¾ã™:', userIdToSend);
            
            fetch('/friends/request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    targetUserId: userIdToSend
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    button.className = 'btn btn-warning';
                    button.innerHTML = '<i class="fas fa-clock me-2"></i>ç”³è«‹æ¸ˆã¿ï¼ˆå–ã‚Šæ¶ˆã—ï¼‰';
                    button.onclick = cancelFriendRequest;
                    showToast('ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼', 'success');
                } else {
                    showToast(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
                    button.innerHTML = '<i class="fas fa-user-plus me-2"></i>ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹';
                }
                button.disabled = false;
            })
            .catch(error => {
                console.error('ã‚¨ãƒ©ãƒ¼:', error);
                showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
                button.innerHTML = '<i class="fas fa-user-plus me-2"></i>ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹';
                button.disabled = false;
            });
        }
        
        function cancelFriendRequest() {
            const userIdToSend = targetUserId || displayUserId || rawUserId || urlUserId;
            if (!userIdToSend) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“');
                showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ', 'danger');
                return;
            }
            
            const button = document.getElementById('friendActionBtn');
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>å–ã‚Šæ¶ˆã—ä¸­...';
            
            fetch('/friends/cancel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    targetUserId: userIdToSend
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    button.className = 'btn btn-success';
                    button.innerHTML = '<i class="fas fa-user-plus me-2"></i>ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹';
                    button.onclick = sendFriendRequest;
                    showToast('ç”³è«‹ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ', 'info');
                } else {
                    showToast(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
                    button.innerHTML = '<i class="fas fa-clock me-2"></i>ç”³è«‹æ¸ˆã¿ï¼ˆå–ã‚Šæ¶ˆã—ï¼‰';
                }
                button.disabled = false;
            })
            .catch(error => {
                console.error('ã‚¨ãƒ©ãƒ¼:', error);
                showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
                button.innerHTML = '<i class="fas fa-clock me-2"></i>ç”³è«‹æ¸ˆã¿ï¼ˆå–ã‚Šæ¶ˆã—ï¼‰';
                button.disabled = false;
            });
        }
        
        function acceptFriendRequest() {
            const userIdToSend = targetUserId || displayUserId || rawUserId || urlUserId;
            if (!userIdToSend) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“');
                showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ', 'danger');
                return;
            }
            
            fetch('/friends/accept', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    requesterId: userIdToSend
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ã‚’æ‰¿èªã—ã¾ã—ãŸï¼', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
                }
            })
            .catch(error => {
                console.error('ã‚¨ãƒ©ãƒ¼:', error);
                showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
            });
        }
        
        function declineFriendRequest() {
            const userIdToSend = targetUserId || displayUserId || rawUserId || urlUserId;
            if (!userIdToSend) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“');
                showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ', 'danger');
                return;
            }
            
            fetch('/friends/decline', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    requesterId: userIdToSend
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ã‚’æ‹’å¦ã—ã¾ã—ãŸ', 'info');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
                }
            })
            .catch(error => {
                console.error('ã‚¨ãƒ©ãƒ¼:', error);
                showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
            });
        }
        
        function startPrivateChat() {
            console.log('=== startPrivateChaté–¢æ•°ãƒ‡ãƒãƒƒã‚° ===');
            console.log('currentUserId:', currentUserId);
            console.log('displayUserId:', displayUserId);
            console.log('urlUserId:', urlUserId);
            console.log('rawUserId:', rawUserId);
            console.log('rawIsOwnProfile:', rawIsOwnProfile);
            console.log('è¨ˆç®—å¾Œ isOwnProfile:', isOwnProfile);
            console.log('targetUserId:', targetUserId);
            console.log('======================================');
            
            // ã¾ãšåŸºæœ¬çš„ãªãƒã‚§ãƒƒã‚¯ï¼šIDãƒ™ãƒ¼ã‚¹ã§ã®åˆ¤å®š
            if (currentUserId && displayUserId && currentUserId === displayUserId) {
                console.error('è‡ªåˆ†è‡ªèº«ã¨ã®ãƒãƒ£ãƒƒãƒˆã¯ã§ãã¾ã›ã‚“ï¼ˆIDãƒ™ãƒ¼ã‚¹åˆ¤å®šï¼‰');
                showToast('è‡ªåˆ†è‡ªèº«ã¨ã®ãƒãƒ£ãƒƒãƒˆã¯ã§ãã¾ã›ã‚“', 'danger');
                return;
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯åˆ¤å®š
            if (isOwnProfile === true) {
                console.error('è‡ªåˆ†è‡ªèº«ã¨ã®ãƒãƒ£ãƒƒãƒˆã¯ã§ãã¾ã›ã‚“ï¼ˆãƒ•ãƒ©ã‚°ãƒ™ãƒ¼ã‚¹åˆ¤å®šï¼‰');
                showToast('è‡ªåˆ†è‡ªèº«ã¨ã®ãƒãƒ£ãƒƒãƒˆã¯ã§ãã¾ã›ã‚“', 'danger');
                return;
            }
            
            // é€ä¿¡ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’æ±ºå®šï¼ˆè¤‡æ•°ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ï¼‰
            const userIdToSend = targetUserId || displayUserId || rawUserId || urlUserId;
            
            if (!userIdToSend) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“');
                console.log('åˆ©ç”¨å¯èƒ½ãªå€¤:', {
                    targetUserId: targetUserId,
                    displayUserId: displayUserId,
                    rawUserId: rawUserId,
                    urlUserId: urlUserId,
                    userId: userId
                });
                showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ', 'danger');
                return;
            }
            
            console.log('ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒƒãƒˆAPIã‚’å‘¼ã³å‡ºã—ã¾ã™:', userIdToSend);
            
            fetch('/friends/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    friendId: userIdToSend
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = `/chat?room=${data.roomId}`;
                } else {
                    showToast(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
                }
            })
            .catch(error => {
                console.error('ã‚¨ãƒ©ãƒ¼:', error);
                showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
            });
        }

        // ãƒ•ãƒ¬ãƒ³ãƒ‰è§£é™¤æ©Ÿèƒ½
        function removeFriend() {
            if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ãƒ•ãƒ¬ãƒ³ãƒ‰é–¢ä¿‚ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            const userIdToSend = targetUserId || displayUserId || rawUserId || urlUserId;
            if (!userIdToSend) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“');
                showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ', 'danger');
                return;
            }
            
            fetch('/friends/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    friendId: userIdToSend
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('ãƒ•ãƒ¬ãƒ³ãƒ‰é–¢ä¿‚ã‚’è§£é™¤ã—ã¾ã—ãŸ', 'success');
                    // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦çŠ¶æ…‹ã‚’æ›´æ–°
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showToast(data.message || 'ãƒ•ãƒ¬ãƒ³ãƒ‰è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
                }
            })
            .catch(error => {
                console.error('ãƒ•ãƒ¬ãƒ³ãƒ‰è§£é™¤ã‚¨ãƒ©ãƒ¼:', error);
                showToast('ãƒ•ãƒ¬ãƒ³ãƒ‰è§£é™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
            });
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ–ãƒ­ãƒƒã‚¯æ©Ÿèƒ½
        function blockUser() {
            if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã™ã‹ï¼Ÿãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã¨ç›¸æ‰‹ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚„ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ã‚’å—ã‘å–ã‚‰ãªããªã‚Šã¾ã™ã€‚')) {
                return;
            }

            const userIdToSend = targetUserId || displayUserId || rawUserId || urlUserId;
            if (!userIdToSend) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“');
                showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ', 'danger');
                return;
            }
            
            fetch('/friends/block', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    targetUserId: userIdToSend
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸ', 'success');
                    // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦çŠ¶æ…‹ã‚’æ›´æ–°
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showToast(data.message || 'ãƒ–ãƒ­ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
                }
            })
            .catch(error => {
                console.error('ãƒ–ãƒ­ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                showToast('ãƒ–ãƒ­ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
            });
        }
    </script>
    
    <!-- ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆè‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®å ´åˆã®ã¿ï¼‰ -->
    <script th:if="${isOwnProfile}">
        // 5åˆ†ã”ã¨ã«ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã‚’é€ä¿¡
        setInterval(function() {
            fetch('/profile/heartbeat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            }).catch(error => {
                console.warn('ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆé€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            });
        }, 5 * 60 * 1000); // 5åˆ†é–“éš”
    </script>
    
    <!-- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ -->
    <script>
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ€ãƒ¼
        window.addEventListener('load', function() {
            setTimeout(function() {
                document.getElementById('pageLoader').style.opacity = '0';
                setTimeout(function() {
                    document.getElementById('pageLoader').style.display = 'none';
                }, 500);
            }, 1000);
        });
        
        // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«åŠ¹æœ
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 5) + 's';
                particlesContainer.appendChild(particle);
            }
        }
        
        // ã‚«ãƒ¼ãƒ‰ã®ãƒ›ãƒãƒ¼åŠ¹æœ
        function addCardEffects() {
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px) scale(1.02)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });
        }
        
        // ãƒã‚¦ãƒ³ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function addBounceAnimation() {
            const style = document.createElement('style');
            style.textContent = `
                @keyframes bounce {
                    0%, 20%, 50%, 80%, 100% {
                        transform: translateY(0);
                    }
                    40% {
                        transform: translateY(-10px);
                    }
                    60% {
                        transform: translateY(-5px);
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function addScrollAnimations() {
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };
            
            const observer = new IntersectionObserver(function(entries) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, observerOptions);
            
            // è¦ç´ ã‚’è¦³å¯Ÿå¯¾è±¡ã«è¿½åŠ 
            document.querySelectorAll('.card, .alert').forEach(el => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(30px)';
                el.style.transition = 'all 0.6s ease';
                observer.observe(el);
            });
        }
        
        // æ•°å­—ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function animateStats() {
            const statsNumbers = document.querySelectorAll('.stats-number');
            statsNumbers.forEach(stat => {
                const target = parseInt(stat.textContent);
                let current = 0;
                const increment = target / 30;
                const timer = setInterval(function() {
                    current += increment;
                    if (current >= target) {
                        current = target;
                        clearInterval(timer);
                    }
                    stat.textContent = Math.floor(current);
                }, 50);
            });
        }
        
        // ãƒœã‚¿ãƒ³ã®ãƒªãƒƒãƒ—ãƒ«åŠ¹æœ
        function addRippleEffect() {
            document.querySelectorAll('.btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    
                    ripple.style.width = ripple.style.height = size + 'px';
                    ripple.style.left = x + 'px';
                    ripple.style.top = y + 'px';
                    ripple.classList.add('ripple-effect');
                    
                    this.appendChild(ripple);
                    
                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                });
            });
            
            // ãƒªãƒƒãƒ—ãƒ«åŠ¹æœã®ã‚¹ã‚¿ã‚¤ãƒ«
            const rippleStyle = document.createElement('style');
            rippleStyle.textContent = `
                .btn {
                    position: relative;
                    overflow: hidden;
                }
                
                .ripple-effect {
                    position: absolute;
                    border-radius: 50%;
                    background: rgba(255, 255, 255, 0.6);
                    animation: ripple 0.6s linear;
                    pointer-events: none;
                }
                
                @keyframes ripple {
                    0% {
                        transform: scale(0);
                        opacity: 1;
                    }
                    100% {
                        transform: scale(2);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(rippleStyle);
        }
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            createParticles();
            addCardEffects();
            addBounceAnimation();
            addScrollAnimations();
            addRippleEffect();
            
            // å°‘ã—é…ã‚Œã¦çµ±è¨ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            setTimeout(animateStats, 1500);
        });
        
        // ãƒ›ãƒãƒ¼æ™‚ã®ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœ
        function addSparkleEffect(element) {
            element.addEventListener('mouseenter', function() {
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        const sparkle = document.createElement('div');
                        sparkle.innerHTML = 'âœ¨';
                        sparkle.style.position = 'absolute';
                        sparkle.style.pointerEvents = 'none';
                        sparkle.style.animation = 'sparkle 1s ease-out forwards';
                        sparkle.style.left = Math.random() * 100 + '%';
                        sparkle.style.top = Math.random() * 100 + '%';
                        this.appendChild(sparkle);
                        
                        setTimeout(() => sparkle.remove(), 1000);
                    }, i * 200);
                }
            });
        }
        
        // ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœã®ã‚¹ã‚¿ã‚¤ãƒ«
        const sparkleStyle = document.createElement('style');
        sparkleStyle.textContent = `
            @keyframes sparkle {
                0% {
                    transform: scale(0) rotate(0deg);
                    opacity: 0;
                }
                50% {
                    transform: scale(1) rotate(180deg);
                    opacity: 1;
                }
                100% {
                    transform: scale(0) rotate(360deg);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(sparkleStyle);
        
        // ã‚¢ãƒã‚¿ãƒ¼ã«ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœã‚’è¿½åŠ 
        document.addEventListener('DOMContentLoaded', function() {
            const avatar = document.querySelector('.avatar-container');
            if (avatar) {
                addSparkleEffect(avatar);
            }
        });
    </script>
</body>
</html>
