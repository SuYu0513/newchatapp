<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プロフィール - チャットアプリ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/chat-style.css" rel="stylesheet">
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/chat">
                <i class="fas fa-comments me-2"></i>チャットアプリ
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" th:href="@{/chat}">
                    <i class="fas fa-comment me-1"></i>チャット
                </a>
                <a class="nav-link" th:href="@{/friends}">
                    <i class="fas fa-user-friends me-1"></i>フレンド
                </a>
                <a class="nav-link" th:href="@{/rooms}">
                    <i class="fas fa-list me-1"></i>ルーム一覧
                </a>
                <a class="nav-link" th:href="@{/profile}">
                    <i class="fas fa-user me-1"></i>プロフィール
                </a>
                <a class="nav-link" th:href="@{/logout}">
                    <i class="fas fa-sign-out-alt me-1"></i>ログアウト
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 成功・エラーメッセージ -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="row">
            <!-- プロフィールカード -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <!-- アバター画像 -->
                        <div class="mb-3">
                            <img th:src="${profile.avatarUrlOrDefault}" 
                                 class="rounded-circle" 
                                 width="150" 
                                 height="150" 
                                 style="object-fit: cover; border: 4px solid var(--primary-color);"
                                 alt="アバター">
                        </div>
                        
                        <!-- 表示名・ユーザー名 -->
                        <h4 th:text="${profile.displayNameOrUsername}" class="mb-1">表示名</h4>
                        <p class="text-muted mb-2">
                            @<span th:text="${user.username}">username</span>
                        </p>
                        
                        <!-- オンラインステータス -->
                        <div class="mb-3">
                            <span class="badge" 
                                  th:classappend="${profile.onlineStatus.name() == 'ONLINE'} ? 'bg-success' : 
                                                 (${profile.onlineStatus.name() == 'AWAY'} ? 'bg-warning' : 
                                                 (${profile.onlineStatus.name() == 'BUSY'} ? 'bg-danger' : 'bg-secondary'))"
                                  th:text="${profile.onlineStatus.displayName}">
                                ステータス
                            </span>
                        </div>
                        
                        <!-- ステータスメッセージ -->
                        <div th:if="${profile.status != null and !profile.status.isEmpty()}" class="mb-3">
                            <div class="alert alert-info py-2">
                                <i class="fas fa-quote-left me-1"></i>
                                <span th:text="${profile.status}">ステータスメッセージ</span>
                            </div>
                        </div>
                        
                        <!-- アクションボタン -->
                        <div class="d-grid gap-2" th:if="${isOwnProfile}">
                            <a th:href="@{/profile/edit}" class="btn btn-primary">
                                <i class="fas fa-edit me-2"></i>プロフィール編集
                            </a>
                        </div>
                        
                        <!-- 他のユーザーのプロフィールの場合のアクションボタン -->
                        <div class="d-grid gap-2" th:unless="${isOwnProfile}">
                            <!-- フレンド関係の状態に応じたボタン表示 -->
                            
                            <!-- フレンドでない場合: フレンド申請ボタン -->
                            <button th:if="${friendshipStatus == 'NONE'}" 
                                    class="btn btn-success"
                                    onclick="sendFriendRequest()"
                                    id="friendActionBtn">
                                <i class="fas fa-user-plus me-2"></i>フレンド申請
                            </button>
                            
                            <!-- 申請送信済みの場合: 申請済みボタン -->
                            <button th:if="${friendshipStatus == 'REQUEST_SENT'}" 
                                    class="btn btn-warning" 
                                    onclick="cancelFriendRequest()"
                                    id="friendActionBtn">
                                <i class="fas fa-clock me-2"></i>申請済み（取り消し）
                            </button>
                            
                            <!-- 申請受信の場合: 承認・拒否ボタン -->
                            <div th:if="${friendshipStatus == 'REQUEST_RECEIVED'}" class="d-grid gap-1">
                                <button class="btn btn-success" onclick="acceptFriendRequest()">
                                    <i class="fas fa-check me-2"></i>申請を承認
                                </button>
                                <button class="btn btn-outline-danger" onclick="declineFriendRequest()">
                                    <i class="fas fa-times me-2"></i>申請を拒否
                                </button>
                            </div>
                            
                            <!-- 既にフレンドの場合: フレンド表示 -->
                            <button th:if="${friendshipStatus == 'FRIEND'}" 
                                    class="btn btn-info" 
                                    disabled>
                                <i class="fas fa-user-check me-2"></i>フレンド
                            </button>
                            
                            <!-- ブロックされている場合 -->
                            <button th:if="${friendshipStatus == 'BLOCKED'}" 
                                    class="btn btn-secondary" 
                                    disabled>
                                <i class="fas fa-ban me-2"></i>ブロック済み
                            </button>
                            
                            <!-- メッセージボタン（フレンドの場合のみ表示） -->
                            <button th:if="${friendshipStatus == 'FRIEND'}" 
                                    class="btn btn-primary" 
                                    onclick="startPrivateChat()">
                                <i class="fas fa-comment me-2"></i>メッセージ
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 統計情報 -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>統計情報
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="h4 text-primary mb-1">0</div>
                                <small class="text-muted">フレンド</small>
                            </div>
                            <div class="col-6">
                                <div class="h4 text-success mb-1">0</div>
                                <small class="text-muted">チャット数</small>
                            </div>
                        </div>
                        <hr>
                        <div class="text-center">
                            <small class="text-muted">
                                参加日: <span th:text="${#temporals.format(profile.createdAt, 'yyyy/MM/dd')}">2024/01/01</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- プロフィール詳細 -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-user-circle me-2"></i>プロフィール詳細
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- 自己紹介 -->
                        <div class="mb-4" th:if="${profile.bio != null and !profile.bio.isEmpty()}">
                            <h6 class="text-primary">
                                <i class="fas fa-info-circle me-2"></i>自己紹介
                            </h6>
                            <p th:text="${profile.bio}" class="text-muted">
                                自己紹介文がここに表示されます。
                            </p>
                        </div>
                        
                        <!-- 居住地 -->
                        <div class="mb-4" th:if="${profile.location != null and !profile.location.isEmpty()}">
                            <h6 class="text-primary">
                                <i class="fas fa-map-marker-alt me-2"></i>居住地
                            </h6>
                            <p th:text="${profile.location}" class="text-muted">
                                居住地
                            </p>
                        </div>
                        
                        <!-- フレンドコード（自分のプロフィールの場合のみ表示） -->
                        <div class="mb-4" th:if="${isOwnProfile}">
                            <h6 class="text-primary">
                                <i class="fas fa-id-card me-2"></i>フレンドコード
                            </h6>
                            <div class="d-flex align-items-center">
                                <code class="bg-light border rounded px-3 py-2 me-2 flex-grow-1" 
                                      style="font-size: 1.1em; letter-spacing: 1px;"
                                      th:text="${user.friendCode}">12345678</code>
                                <button class="btn btn-outline-primary btn-sm" 
                                        onclick="copyFriendCode()"
                                        title="フレンドコードをコピー">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                このコードを友達に教えてフレンド申請してもらいましょう
                            </small>
                        </div>
                        
                        <!-- 最終ログイン -->
                        <div class="mb-4" th:if="${profile.lastSeen != null}">
                            <h6 class="text-primary">
                                <i class="fas fa-clock me-2"></i>最終ログイン
                            </h6>
                            <p th:text="${#temporals.format(profile.lastSeen, 'yyyy年MM月dd日 HH:mm')}" class="text-muted">
                                最終ログイン時間
                            </p>
                        </div>
                        
                        <!-- プライバシー設定表示 -->
                        <div class="mb-4" th:if="${isOwnProfile}">
                            <h6 class="text-primary">
                                <i class="fas fa-shield-alt me-2"></i>プライバシー設定
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <small class="text-muted">プロフィール公開レベル:</small>
                                    <div>
                                        <span class="badge bg-info" th:text="${profile.privacyLevel.displayName}">公開</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">検索可能:</small>
                                    <div>
                                        <span class="badge" 
                                              th:classappend="${profile.isSearchable} ? 'bg-success' : 'bg-danger'"
                                              th:text="${profile.isSearchable} ? 'はい' : 'いいえ'">はい</span>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <small class="text-muted">ランダムマッチング:</small>
                                    <div>
                                        <span class="badge" 
                                              th:classappend="${profile.allowRandomMatching} ? 'bg-success' : 'bg-danger'"
                                              th:text="${profile.allowRandomMatching} ? '有効' : '無効'">有効</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- プロフィールが空の場合 -->
                        <div th:if="${profile.bio == null or profile.bio.isEmpty()}" class="text-center py-5">
                            <i class="fas fa-user-circle fa-3x text-muted mb-3"></i>
                            <p class="text-muted">プロフィール情報が設定されていません</p>
                            <a th:if="${isOwnProfile}" th:href="@{/profile/edit}" class="btn btn-outline-primary">
                                <i class="fas fa-edit me-1"></i>プロフィールを編集
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- フレンド一覧（今後実装） -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-users me-2"></i>フレンド一覧
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="text-center py-3">
                            <i class="fas fa-users fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-0">フレンド機能は近日実装予定です</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- フレンドコードコピー機能 -->
    <script>
        // 現在表示しているユーザーのID（他のユーザーのプロフィールの場合）
        const targetUserId = /*[[${!isOwnProfile ? user.id : null}]]*/ null;
        
        function copyFriendCode() {
            const friendCodeElement = document.querySelector('code');
            const friendCode = friendCodeElement.textContent;
            
            if (navigator.clipboard && window.isSecureContext) {
                // Clipboard API を使用（HTTPS必須）
                navigator.clipboard.writeText(friendCode).then(() => {
                    showCopySuccess();
                }).catch(err => {
                    console.error('クリップボードへのコピーに失敗しました:', err);
                    fallbackCopy(friendCode);
                });
            } else {
                // フォールバック方法
                fallbackCopy(friendCode);
            }
        }
        
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showCopySuccess();
            } catch (err) {
                console.error('コピーに失敗しました:', err);
                alert('コピーに失敗しました。手動でコードを選択してコピーしてください。');
            } finally {
                document.body.removeChild(textArea);
            }
        }
        
        function showCopySuccess() {
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            
            // ボタンのアイコンを一時的に変更
            button.innerHTML = '<i class="fas fa-check text-success"></i>';
            button.classList.add('btn-success');
            button.classList.remove('btn-outline-primary');
            
            // 一定時間後に元に戻す
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-primary');
            }, 2000);
            
            // トーストメッセージを表示
            showToast('フレンドコードをコピーしました！', 'success');
        }
        
        function showToast(message, type = 'info') {
            // 既存のトーストを削除
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // トーストHTML
            const toastHTML = `
                <div class="toast-container position-fixed top-0 end-0 p-3">
                    <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header bg-${type} text-white">
                            <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                            <strong class="me-auto">通知</strong>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                        </div>
                        <div class="toast-body">
                            ${message}
                        </div>
                    </div>
                </div>
            `;
            
            // トーストを表示
            document.body.insertAdjacentHTML('beforeend', toastHTML);
            
            // 3秒後に自動で隠す
            setTimeout(() => {
                const toast = document.querySelector('.toast');
                if (toast) {
                    toast.classList.remove('show');
                    setTimeout(() => toast.parentElement.remove(), 150);
                }
            }, 3000);
        }
        
        // フレンド申請関連の関数
        function sendFriendRequest() {
            if (!targetUserId) return;
            
            const button = document.getElementById('friendActionBtn');
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>送信中...';
            
            fetch('/friends/request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    targetUserId: targetUserId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    button.className = 'btn btn-warning';
                    button.innerHTML = '<i class="fas fa-clock me-2"></i>申請済み（取り消し）';
                    button.onclick = cancelFriendRequest;
                    showToast('フレンド申請を送信しました！', 'success');
                } else {
                    showToast(data.message || 'エラーが発生しました', 'danger');
                    button.innerHTML = '<i class="fas fa-user-plus me-2"></i>フレンド申請';
                }
                button.disabled = false;
            })
            .catch(error => {
                console.error('エラー:', error);
                showToast('エラーが発生しました', 'danger');
                button.innerHTML = '<i class="fas fa-user-plus me-2"></i>フレンド申請';
                button.disabled = false;
            });
        }
        
        function cancelFriendRequest() {
            if (!targetUserId) return;
            
            const button = document.getElementById('friendActionBtn');
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>取り消し中...';
            
            fetch('/friends/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    friendId: targetUserId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    button.className = 'btn btn-success';
                    button.innerHTML = '<i class="fas fa-user-plus me-2"></i>フレンド申請';
                    button.onclick = sendFriendRequest;
                    showToast('申請を取り消しました', 'info');
                } else {
                    showToast(data.message || 'エラーが発生しました', 'danger');
                    button.innerHTML = '<i class="fas fa-clock me-2"></i>申請済み（取り消し）';
                }
                button.disabled = false;
            })
            .catch(error => {
                console.error('エラー:', error);
                showToast('エラーが発生しました', 'danger');
                button.innerHTML = '<i class="fas fa-clock me-2"></i>申請済み（取り消し）';
                button.disabled = false;
            });
        }
        
        function acceptFriendRequest() {
            if (!targetUserId) return;
            
            fetch('/friends/accept', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    requesterId: targetUserId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('フレンド申請を承認しました！', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.message || 'エラーが発生しました', 'danger');
                }
            })
            .catch(error => {
                console.error('エラー:', error);
                showToast('エラーが発生しました', 'danger');
            });
        }
        
        function declineFriendRequest() {
            if (!targetUserId) return;
            
            fetch('/friends/decline', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    requesterId: targetUserId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('フレンド申請を拒否しました', 'info');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.message || 'エラーが発生しました', 'danger');
                }
            })
            .catch(error => {
                console.error('エラー:', error);
                showToast('エラーが発生しました', 'danger');
            });
        }
        
        function startPrivateChat() {
            if (!targetUserId) return;
            
            fetch('/friends/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    friendId: targetUserId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = `/chat?room=${data.roomId}`;
                } else {
                    showToast(data.message || 'エラーが発生しました', 'danger');
                }
            })
            .catch(error => {
                console.error('エラー:', error);
                showToast('エラーが発生しました', 'danger');
            });
        }
    </script>
    
    <!-- ハートビート機能（自分のプロフィールの場合のみ） -->
    <script th:if="${isOwnProfile}">
        // 5分ごとにハートビートを送信
        setInterval(function() {
            fetch('/profile/heartbeat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            }).catch(error => {
                console.warn('ハートビート送信エラー:', error);
            });
        }, 5 * 60 * 1000); // 5分間隔
    </script>
</body>
</html>
