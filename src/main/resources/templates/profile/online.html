<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オンラインユーザー - チャットアプリ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/chat-style.css" rel="stylesheet">
    <style>
        .online-user-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 4px solid transparent;
        }
        
        .online-user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left-color: var(--primary-color);
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            position: relative;
        }
        
        .status-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .status-online { background-color: #28a745; }
        .status-away { background-color: #ffc107; }
        .status-busy { background-color: #dc3545; }
        .status-offline { background-color: #6c757d; }
        
        .refresh-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .auto-refresh-info {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .filter-tabs {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 10px;
            margin-bottom: 20px;
        }
        
        .user-count-badge {
            font-size: 0.8rem;
            vertical-align: super;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/chat">
                <i class="fas fa-comments me-2"></i>チャットアプリ
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" th:href="@{/chat}">
                    <i class="fas fa-comment me-1"></i>チャット
                </a>
                <a class="nav-link" th:href="@{/rooms}">
                    <i class="fas fa-list me-1"></i>ルーム一覧
                </a>
                <a class="nav-link" th:href="@{/profile}">
                    <i class="fas fa-user me-1"></i>プロフィール
                </a>
                <a class="nav-link" th:href="@{/logout}">
                    <i class="fas fa-sign-out-alt me-1"></i>ログアウト
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- ページヘッダー -->
        <div class="row mb-4">
            <div class="col">
                <h2>
                    <i class="fas fa-circle text-success me-2"></i>オンラインユーザー
                </h2>
                <p class="text-muted">現在アクティブなユーザー一覧</p>
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-primary" onclick="refreshUsers()">
                    <i class="fas fa-sync-alt me-1" id="refreshIcon"></i>更新
                </button>
            </div>
        </div>

        <!-- フィルタータブ -->
        <div class="filter-tabs">
            <ul class="nav nav-pills justify-content-center" id="statusTabs">
                <li class="nav-item">
                    <a class="nav-link active" href="#all" onclick="filterByStatus('all')">
                        すべて
                        <span class="badge bg-secondary user-count-badge ms-1" id="countAll">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#online" onclick="filterByStatus('online')">
                        <i class="fas fa-circle text-success me-1"></i>オンライン
                        <span class="badge bg-success user-count-badge ms-1" id="countOnline">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#away" onclick="filterByStatus('away')">
                        <i class="fas fa-circle text-warning me-1"></i>離席中
                        <span class="badge bg-warning user-count-badge ms-1" id="countAway">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#busy" onclick="filterByStatus('busy')">
                        <i class="fas fa-circle text-danger me-1"></i>取り込み中
                        <span class="badge bg-danger user-count-badge ms-1" id="countBusy">0</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- 自動更新情報 -->
        <div class="auto-refresh-info text-center mb-3">
            <i class="fas fa-info-circle me-1"></i>
            自動更新: <span id="countdown">30</span>秒後
            <button class="btn btn-link btn-sm p-0 ms-2" onclick="toggleAutoRefresh()">
                <span id="autoRefreshToggle">停止</span>
            </button>
        </div>

        <!-- ユーザー一覧 -->
        <div id="usersList">
            <div class="row" id="usersContainer">
                <!-- ユーザーカードが動的に挿入される -->
            </div>
            
            <!-- ローディング表示 -->
            <div class="text-center py-5" id="loadingSpinner" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">読み込み中...</span>
                </div>
                <p class="mt-2">ユーザー情報を取得中...</p>
            </div>
            
            <!-- ユーザーなし表示 -->
            <div class="text-center py-5" id="noUsersMessage" style="display: none;">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <h4>オンラインユーザーがいません</h4>
                <p class="text-muted">現在、条件に一致するユーザーはいません</p>
            </div>
        </div>
    </div>

    <!-- 固定更新ボタン -->
    <button class="btn btn-primary refresh-button" onclick="refreshUsers()" title="ユーザー一覧を更新">
        <i class="fas fa-sync-alt" id="fixedRefreshIcon"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let users = [];
        let currentFilter = 'all';
        let autoRefreshInterval;
        let countdownInterval;
        let countdown = 30;
        let autoRefreshEnabled = true;

        // ページ読み込み時にユーザー一覧を取得
        document.addEventListener('DOMContentLoaded', function() {
            refreshUsers();
            startAutoRefresh();
        });

        // ユーザー一覧を取得・更新
        function refreshUsers() {
            showLoading(true);
            
            // 更新アイコンを回転
            const refreshIcon = document.getElementById('refreshIcon');
            const fixedRefreshIcon = document.getElementById('fixedRefreshIcon');
            refreshIcon.classList.add('fa-spin');
            fixedRefreshIcon.classList.add('fa-spin');
            
            fetch('/profile/online-users')
                .then(response => response.json())
                .then(data => {
                    users = data;
                    displayUsers();
                    updateCounts();
                    showLoading(false);
                    
                    // 回転を停止
                    refreshIcon.classList.remove('fa-spin');
                    fixedRefreshIcon.classList.remove('fa-spin');
                    
                    // カウントダウンをリセット
                    countdown = 30;
                })
                .catch(error => {
                    console.error('Error fetching users:', error);
                    showLoading(false);
                    refreshIcon.classList.remove('fa-spin');
                    fixedRefreshIcon.classList.remove('fa-spin');
                });
        }

        // ユーザー一覧を表示
        function displayUsers() {
            const container = document.getElementById('usersContainer');
            const filteredUsers = filterUsers(users, currentFilter);
            
            if (filteredUsers.length === 0) {
                container.innerHTML = '';
                document.getElementById('noUsersMessage').style.display = 'block';
                return;
            }
            
            document.getElementById('noUsersMessage').style.display = 'none';
            
            container.innerHTML = filteredUsers.map(user => `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card online-user-card h-100" onclick="viewProfile(${user.userId})">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="position-relative me-3">
                                    <img src="${user.avatarUrl || '/images/default-avatar.png'}" 
                                         class="user-avatar" 
                                         alt="アバター">
                                    <div class="status-indicator status-${user.onlineStatus.toLowerCase()}"></div>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-1">${user.displayName || user.username}</h6>
                                    <small class="text-muted">@${user.username}</small>
                                </div>
                                <div>
                                    <span class="badge ${getStatusBadgeClass(user.onlineStatus)}">
                                        ${getStatusDisplayName(user.onlineStatus)}
                                    </span>
                                </div>
                            </div>
                            
                            ${user.status ? `
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-quote-left me-1"></i>
                                        ${user.status}
                                    </small>
                                </div>
                            ` : ''}
                            
                            ${user.location ? `
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-map-marker-alt me-1"></i>
                                        ${user.location}
                                    </small>
                                </div>
                            ` : ''}
                            
                            <div class="mb-2">
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    最終: ${formatDateTime(user.lastSeen)}
                                </small>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex mt-3">
                                <button class="btn btn-sm btn-outline-primary flex-fill" 
                                        onclick="event.stopPropagation(); viewProfile(${user.userId})">
                                    <i class="fas fa-eye me-1"></i>プロフィール
                                </button>
                                <button class="btn btn-sm btn-success flex-fill" 
                                        onclick="event.stopPropagation(); startChat(${user.userId})">
                                    <i class="fas fa-comment me-1"></i>チャット
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ステータスでフィルタリング
        function filterUsers(users, status) {
            if (status === 'all') {
                return users;
            }
            return users.filter(user => user.onlineStatus.toLowerCase() === status);
        }

        // フィルター切り替え
        function filterByStatus(status) {
            currentFilter = status;
            
            // タブの表示を更新
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[href="#${status}"]`).classList.add('active');
            
            displayUsers();
        }

        // カウント数を更新
        function updateCounts() {
            const counts = {
                all: users.length,
                online: users.filter(u => u.onlineStatus === 'ONLINE').length,
                away: users.filter(u => u.onlineStatus === 'AWAY').length,
                busy: users.filter(u => u.onlineStatus === 'BUSY').length
            };
            
            Object.keys(counts).forEach(status => {
                const element = document.getElementById(`count${status.charAt(0).toUpperCase() + status.slice(1)}`);
                if (element) {
                    element.textContent = counts[status];
                }
            });
        }

        // ローディング表示切り替え
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
            document.getElementById('usersContainer').style.display = show ? 'none' : 'block';
        }

        // 自動更新開始
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            if (!autoRefreshEnabled) return;
            
            autoRefreshInterval = setInterval(refreshUsers, 30000); // 30秒間隔
            
            countdownInterval = setInterval(function() {
                countdown--;
                document.getElementById('countdown').textContent = countdown;
                
                if (countdown <= 0) {
                    countdown = 30;
                }
            }, 1000);
        }

        // 自動更新の切り替え
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const toggleButton = document.getElementById('autoRefreshToggle');
            
            if (autoRefreshEnabled) {
                toggleButton.textContent = '停止';
                startAutoRefresh();
            } else {
                toggleButton.textContent = '開始';
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                }
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                }
                document.getElementById('countdown').textContent = '--';
            }
        }

        // プロフィール表示
        function viewProfile(userId) {
            window.open(`/profile/view/${userId}`, '_blank');
        }

        // チャット開始
        function startChat(userId) {
            // プライベートチャットルーム作成のAPI呼び出し
            fetch('/chat/private', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    targetUserId: userId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.open(`/chat?room=${data.roomId}`, '_blank');
                } else {
                    alert('チャットルームの作成に失敗しました');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('エラーが発生しました');
            });
        }

        // ユーティリティ関数
        function getStatusBadgeClass(status) {
            const classes = {
                'ONLINE': 'bg-success',
                'AWAY': 'bg-warning',
                'BUSY': 'bg-danger',
                'OFFLINE': 'bg-secondary'
            };
            return classes[status] || 'bg-secondary';
        }

        function getStatusDisplayName(status) {
            const names = {
                'ONLINE': 'オンライン',
                'AWAY': '離席中',
                'BUSY': '取り込み中',
                'OFFLINE': 'オフライン'
            };
            return names[status] || 'オフライン';
        }

        function formatDateTime(dateString) {
            if (!dateString) return '--:--';
            
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) { // 1分以内
                return '今';
            } else if (diff < 3600000) { // 1時間以内
                return Math.floor(diff / 60000) + '分前';
            } else if (diff < 86400000) { // 24時間以内
                return Math.floor(diff / 3600000) + '時間前';
            } else {
                return date.toLocaleDateString('ja-JP', {
                    month: 'numeric',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }

        // ページが非表示になったら自動更新を停止
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                }
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                }
            } else if (autoRefreshEnabled) {
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>
