<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, interactive-widget=resizes-visual-viewport">
    <title>ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª</title>
    
    <!-- PWAè¨­å®š -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/common.css(v=${@appVersion})}" rel="stylesheet">
    <link th:href="@{/css/main-app.css(v=${@appVersion})}" rel="stylesheet">
</head>
<body>
    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="app-container"
         th:attr="data-current-user-id=${user != null ? user.id : ''}, data-current-username=${username != null ? username : ''}">
        
        <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
        <section class="app-section active" id="home-section">
            <div class="section-content">
                <!-- æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-1"></i>
                    <span th:text="${success}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                
                <!-- æŠ•ç¨¿ãƒªã‚¹ãƒˆ -->
                <div class="posts-container">
                    <div th:if="${posts == null or posts.isEmpty()}" class="no-posts">
                        <i class="fas fa-inbox fa-3x mb-3 text-muted"></i>
                        <p class="text-muted">ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                    
                    <div th:each="post : ${posts}" class="post-card">
                        <div class="post-header">
                            <div class="post-user-info">
                                <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒãŒã‚ã‚‹å ´åˆ -->
                                <div class="post-avatar user-profile-link" 
                                     th:if="${post.user.profile != null and post.user.profile.avatarUrl != null and !post.user.profile.avatarUrl.isEmpty()}"
                                     th:style="'background-image: url(' + ${post.user.profile.avatarUrl} + '); background-size: cover; background-position: center; cursor: pointer;'"
                                     th:attr="data-user-id=${post.user.id}, data-friend-code=${post.userFriendCode}">
                                </div>
                                <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³ -->
                                <div class="post-avatar default-avatar user-profile-link" 
                                     th:if="${post.user.profile == null or post.user.profile.avatarUrl == null or post.user.profile.avatarUrl.isEmpty()}"
                                     th:attr="data-username=${post.user.username}, data-user-id=${post.user.id}, data-friend-code=${post.userFriendCode}"
                                     style="cursor: pointer;">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="post-user-details">
                                    <span class="post-username clickable-username user-profile-link" 
                                          th:text="${post.user.profile != null and post.user.profile.displayName != null and !post.user.profile.displayName.isEmpty() ? post.user.profile.displayName : post.user.username}"
                                          th:attr="data-user-id=${post.user.id}, data-friend-code=${post.userFriendCode}">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</span>
                                    <span class="post-time" th:text="${#temporals.format(post.createdAt, 'yyyyå¹´MMæœˆddæ—¥ HH:mm')}">æŠ•ç¨¿æ—¥æ™‚</span>
                                </div>
                            </div>
                        </div>
                        <div class="post-content">
                            <p th:text="${post.content}">æŠ•ç¨¿å†…å®¹</p>
                            
                            <!-- ãƒ¡ãƒ‡ã‚£ã‚¢è¡¨ç¤º -->
                            <div th:if="${post.mediaPath != null and !post.mediaPath.isEmpty()}" class="post-media-grid">
                                <div th:each="mediaUrl : ${#strings.arraySplit(post.mediaPath, ',')}" class="post-media-item">
                                    <!-- ç”»åƒã®å ´åˆ -->
                                    <img th:if="${#strings.endsWith(mediaUrl, '.jpg') or #strings.endsWith(mediaUrl, '.jpeg') or #strings.endsWith(mediaUrl, '.png') or #strings.endsWith(mediaUrl, '.gif') or #strings.endsWith(mediaUrl, '.webp')}"
                                         th:src="${mediaUrl}" 
                                         alt="æŠ•ç¨¿ç”»åƒ"
                                         class="post-media-image"
                                         loading="lazy"
                                         onclick="openImageModal(this.src)">
                                    <!-- å‹•ç”»ã®å ´åˆ -->
                                    <video th:if="${#strings.endsWith(mediaUrl, '.mp4') or #strings.endsWith(mediaUrl, '.webm') or #strings.endsWith(mediaUrl, '.mov')}"
                                           th:src="${mediaUrl}" 
                                           preload="metadata"
                                           controls
                                           class="post-media-video"></video>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- æŠ•ç¨¿ä½œæˆç”»é¢ -->
        <section class="app-section" id="create-post-section">
            <div class="section-content">
                <div class="create-post-header">
                    <button class="btn-back" id="btnBackFromPost">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h1>æ–°è¦æŠ•ç¨¿</h1>
                    <div></div>
                </div>
                
                <form th:action="@{/home/post}" method="post" enctype="multipart/form-data" class="create-post-form" id="createPostForm">
                    <div class="form-group">
                        <label for="postContent" class="form-label">
                            <i class="fas fa-pen me-2"></i>æŠ•ç¨¿å†…å®¹
                        </label>
                        <textarea id="postContent" name="content" class="form-textarea" 
                                  placeholder="ä»Šä½•ã—ã¦ã‚‹ï¼Ÿ" 
                                  maxlength="1000" 
                                  rows="8"
                                  required></textarea>
                        <div class="char-counter-container">
                            <span class="char-counter" id="charCounter">0 / 1000</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="mediaUpload" class="form-label">
                            <i class="fas fa-image me-2"></i>å†™çœŸãƒ»å‹•ç”»
                        </label>
                        <div class="upload-area" id="uploadArea">
                            <input type="file" id="mediaUpload" name="media" 
                                   accept="image/*,video/*" 
                                   multiple 
                                   class="file-input">
                            <label for="mediaUpload" class="upload-label">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                                <p class="mb-0">ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸãƒ»å‹•ç”»ã‚’é¸æŠ</p>
                                <small class="text-muted">ã¾ãŸã¯ã€ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</small>
                            </label>
                        </div>
                        <div class="preview-container" id="previewContainer"></div>
                    </div>
                    
                    <button type="submit" class="btn-submit-post">
                        <i class="fas fa-paper-plane me-2"></i>æŠ•ç¨¿ã™ã‚‹
                    </button>
                </form>
            </div>
        </section>
        
        <!-- ãƒ«ãƒ¼ãƒ ç”»é¢ -->
        <section class="app-section" id="room-section">
            <div class="section-content">
                <div class="chat-list-header">
                    <button class="tab-btn active" data-tab="joined-rooms">å‚åŠ ä¸­</button>
                    <button class="tab-btn" data-tab="available-rooms">å‚åŠ å¯èƒ½</button>
                    <button class="tab-btn" id="btnRoomRequests">
                        ç”³è«‹
                        <span class="badge" id="requestBadge" style="display: none;">0</span>
                    </button>
                    <button class="tab-btn" id="btnRoomApprovals">
                        æ‰¿èª
                        <span class="badge" id="approvalBadge" style="display: none;">0</span>
                    </button>
                    <button class="tab-btn" id="btnRoomInvite">
                        æ‹›å¾…
                    </button>
                </div>
                
                <!-- å‚åŠ ä¸­ã®ãƒ«ãƒ¼ãƒ  -->
                <div class="tab-content active" id="joined-rooms-tab">
                    <div class="chat-list room-list">
                        <div class="no-chats" style="display: none;">
                            <i class="fas fa-door-open"></i>
                            <p>å‚åŠ ä¸­ã®ãƒ«ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    </div>
                </div>
                
                <!-- å‚åŠ å¯èƒ½ãªãƒ«ãƒ¼ãƒ  -->
                <div class="tab-content" id="available-rooms-tab">
                    <div class="chat-list room-list">
                        <div class="no-chats" style="display: none;">
                            <i class="fas fa-door-open"></i>
                            <p>å‚åŠ å¯èƒ½ãªãƒ«ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    </div>
                </div>

                <!-- ç”³è«‹ä¸­ã®ãƒ«ãƒ¼ãƒ  -->
                <div class="tab-content" id="requests-tab">
                    <div class="chat-list room-list">
                        <div class="no-chats" style="display: none;">
                            <i class="fas fa-inbox"></i>
                            <p>ç”³è«‹ä¸­ã®ãƒ«ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    </div>
                </div>

                <!-- æ‰¿èªå¾…ã¡ã®ãƒ«ãƒ¼ãƒ  -->
                <div class="tab-content" id="approvals-tab">
                    <div class="chat-list room-list">
                        <div class="no-chats" style="display: none;">
                            <i class="fas fa-user-check"></i>
                            <p>æ‰¿èªå¾…ã¡ã®ãƒ«ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    </div>
                </div>

                <!-- æ‹›å¾… -->
                <div class="tab-content" id="invite-tab">
                    <div class="chat-list room-list">
                        <div class="no-chats" style="display: none;">
                            <i class="fas fa-user-plus"></i>
                            <p>æ‹›å¾…æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™</p>
                        </div>
                    </div>
                </div>

                <!-- ãƒ«ãƒ¼ãƒ ä½œæˆãƒœã‚¿ãƒ³ -->
                <button class="btn-create-room" id="btnCreateRoom">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </section>

        <!-- ãƒ«ãƒ¼ãƒ ä½œæˆç”»é¢ -->
        <section class="app-section" id="create-room-section">
            <div class="section-content">
                <div class="create-post-header">
                    <button class="btn-back" id="btnBackFromRoom">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h1>ãƒ«ãƒ¼ãƒ ä½œæˆ</h1>
                    <div></div>
                </div>

                <form id="createRoomForm" class="create-post-form">
                    <div class="form-group">
                        <label for="roomName" class="form-label">
                            <i class="fas fa-tag me-2"></i>ãƒ«ãƒ¼ãƒ å
                        </label>
                        <input type="text" id="roomName" name="name" class="form-input"
                               placeholder="ä¾‹: ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°é›‘è«‡" required maxlength="100">
                        <small class="form-text">æœ€å¤§100æ–‡å­—ã¾ã§</small>
                    </div>

                    <div class="form-group">
                        <label for="roomDescription" class="form-label">
                            <i class="fas fa-align-left me-2"></i>èª¬æ˜æ–‡
                        </label>
                        <textarea id="roomDescription" name="description" class="form-textarea"
                                  rows="3" placeholder="ä¾‹: ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã«é–¢ã™ã‚‹é›‘è«‡ã‚„è³ªå•ã€æƒ…å ±å…±æœ‰ã®å ´ã§ã™"
                                  maxlength="500"></textarea>
                        <small class="form-text">æœ€å¤§500æ–‡å­—ã¾ã§ï¼ˆä»»æ„ï¼‰</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-globe me-2"></i>å…¬é–‹è¨­å®š
                        </label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="isPublic" value="true" checked>
                                <span><i class="fas fa-globe text-success me-1"></i>ãƒ‘ãƒ–ãƒªãƒƒã‚¯ - èª°ã§ã‚‚æ¤œç´¢ãƒ»å‚åŠ å¯èƒ½</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="isPublic" value="false">
                                <span><i class="fas fa-lock text-info me-1"></i>ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ - æ‹›å¾…ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿å‚åŠ å¯èƒ½</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-user-plus me-2"></i>å‹é”ã‚’æ‹›å¾…ï¼ˆä»»æ„ï¼‰
                        </label>
                        <div id="friendSelectionContainer" class="friend-selection-container">
                            <p class="loading-text">å‹é”ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                        </div>
                    </div>

                    <button type="submit" class="btn-submit">
                        <i class="fas fa-plus me-2"></i>ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ
                    </button>
                </form>
            </div>
        </section>
        
        <!-- ãƒãƒƒãƒç”»é¢ -->
        <section class="app-section" id="match-section">
            <div class="section-content">
                <div class="welcome-section">
                    <h1>ğŸ² ãƒãƒƒãƒ</h1>
                    <p class="text-white-50">æº–å‚™ä¸­...</p>
                </div>
            </div>
        </section>
        
        <!-- ãƒãƒ£ãƒƒãƒˆç”»é¢ -->
        <section class="app-section" id="chat-section">
            <div class="section-content">
                <div class="chat-list-header">
                    <div class="header-tabs">
                        <button class="tab-btn active" data-tab="all-chat">ã™ã¹ã¦</button>
                        <button class="tab-btn" data-tab="friends-chat">å‹é”</button>
                    </div>
                </div>
                
                <!-- ã™ã¹ã¦ã®ãƒãƒ£ãƒƒãƒˆ -->
                <div class="tab-content active" id="all-chat-tab">
                    <div class="chat-list">
                        <div class="no-chats">
                            <i class="fas fa-comments fa-3x mb-3 text-muted"></i>
                            <p class="text-muted">ãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                        
                        <!-- ãƒãƒ£ãƒƒãƒˆã‚¢ã‚¤ãƒ†ãƒ ä¾‹ï¼ˆå‹•çš„ã«ç”Ÿæˆäºˆå®šï¼‰ -->
                        <!-- 
                        <div class="chat-item">
                            <div class="chat-avatar">
                                <img src="/images/avatar.png" alt="ã‚¢ãƒã‚¿ãƒ¼">
                            </div>
                            <div class="chat-content">
                                <div class="chat-top">
                                    <span class="chat-name">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</span>
                                    <span class="chat-time">09:38</span>
                                </div>
                                <div class="chat-bottom">
                                    <p class="chat-message">æœ€æ–°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                                    <span class="chat-badge">1</span>
                                </div>
                            </div>
                        </div>
                        -->
                    </div>
                </div>
                
                <!-- å‹é”ã®ãƒãƒ£ãƒƒãƒˆ -->
                <div class="tab-content" id="friends-chat-tab">
                    <div class="chat-list">
                        <div class="no-chats">
                            <i class="fas fa-user-friends fa-3x mb-3 text-muted"></i>
                            <p class="text-muted">å‹é”ã¨ã®ãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- DMç”»é¢ -->
        <section class="app-section" id="dm-section" style="display: none;">
            <div class="section-content">
                <!-- DMãƒ˜ãƒƒãƒ€ãƒ¼ -->
                <div class="dm-header">
                    <button class="back-btn" id="backFromDmBtn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="dm-user-info" id="dmUserInfo" style="cursor: pointer;">
                        <div class="dm-avatar"></div>
                        <span class="dm-username"></span>
                    </div>
                </div>
                
                <!-- DMãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
                <div class="dm-messages-container" id="dmMessagesContainer">
                    <div class="dm-messages" id="dmMessages">
                        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>
                
                <!-- DMå…¥åŠ›ã‚¨ãƒªã‚¢ -->
                <div class="dm-input-area">
                    <textarea 
                        class="dm-input" 
                        id="dmInput" 
                        placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." 
                        rows="1"></textarea>
                    <button class="dm-send-btn" id="dmSendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- ãƒ«ãƒ¼ãƒ ãƒãƒ£ãƒƒãƒˆç”»é¢ -->
        <section class="app-section" id="room-chat-section" style="display: none;">
            <div class="section-content">
                <!-- ãƒ«ãƒ¼ãƒ ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ -->
                <div class="dm-header">
                    <button class="back-btn" id="backFromRoomChatBtn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="dm-user-info" id="roomChatInfo" style="cursor: pointer;" title="ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º">
                        <div class="dm-avatar">
                            <i class="fas fa-users"></i>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-start;">
                            <span class="dm-username" id="roomChatName"></span>
                            <span style="font-size: 0.75rem; color: #6c757d;" id="roomChatMemberCount"></span>
                        </div>
                        <i class="fas fa-chevron-right" style="margin-left: auto; color: #6c757d; font-size: 0.9rem;"></i>
                    </div>
                </div>

                <!-- ãƒ«ãƒ¼ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
                <div class="dm-messages-container" id="roomMessagesContainer">
                    <div class="dm-messages" id="roomMessages">
                        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>

                <!-- ãƒ«ãƒ¼ãƒ å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                <div class="dm-input-area">
                    <textarea
                        class="dm-input"
                        id="roomInput"
                        placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
                        rows="1"></textarea>
                    <button class="dm-send-btn" id="roomSendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- ãƒ«ãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ãƒ‘ãƒãƒ« -->
        <section class="app-section" id="room-members-section" style="display: none;">
            <div class="section-content">
                <div class="dm-header">
                    <button class="back-btn" id="backFromMembersBtn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="dm-user-info">
                        <div class="dm-avatar">
                            <i class="fas fa-users"></i>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-start;">
                            <span class="dm-username" id="membersPanelRoomName">ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§</span>
                            <span style="font-size: 0.75rem; color: #6c757d;" id="membersPanelCount"></span>
                        </div>
                    </div>
                </div>
                <div class="members-list-container" style="padding: 1rem; overflow-y: auto; flex: 1;">
                    <div id="membersList" class="members-list">
                        <!-- ãƒ¡ãƒ³ãƒãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>
            </div>
        </section>

        <!-- ãƒã‚¤ãƒšãƒ¼ã‚¸ç”»é¢ -->
        <section class="app-section" id="mypage-section">
            <div class="section-content">
                <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="profile-section">
                    <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ -->
                    <button class="hamburger-btn" type="button" id="mypageMenuBtn">
                        <i class="fas fa-bars" style="font-size: 1.5rem;"></i>
                    </button>
                    <div class="profile-main">
                        <div class="profile-main-top">
                            <!-- ã‚¢ã‚¤ã‚³ãƒ³ -->
                            <div class="profile-avatar" 
                                 th:if="${profile != null and profile.avatarUrl != null and !profile.avatarUrl.isEmpty()}"
                                 th:style="'background-image: url(' + ${profile.avatarUrl} + '); background-size: cover; background-position: center;'">
                            </div>
                            <div class="profile-avatar default-avatar" 
                                 th:if="${profile == null or profile.avatarUrl == null or profile.avatarUrl.isEmpty()}"
                                 th:attr="data-username=${user != null ? user.username : 'unknown'}">
                                <i class="fas fa-user"></i>
                            </div>
                            
                            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ± -->
                            <div class="profile-info-top">
                                <h2 class="profile-username" th:text="${profile != null and profile.displayName != null ? profile.displayName : (user != null ? user.username : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å')}">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</h2>
                                <p class="profile-friendcode" th:text="${user != null and user.friendCode != null ? 'FC: ' + user.friendCode : 'FC: æœªè¨­å®š'}">FC: XXXX-XXXX</p>
                            </div>
                        </div>
                        
                        <!-- è‡ªå·±ç´¹ä»‹æ–‡ã¨ã‚¿ã‚°ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã®ä¸‹ï¼‰ -->
                        <div class="profile-info-bottom">
                            <!-- è‡ªå·±ç´¹ä»‹æ–‡ -->
                            <p class="profile-bio" th:if="${profile != null and profile.bio != null and !profile.bio.isEmpty()}" th:text="${profile.bio}">è‡ªå·±ç´¹ä»‹æ–‡ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                            <p class="profile-bio text-muted" th:if="${profile == null or profile.bio == null or profile.bio.isEmpty()}">è‡ªå·±ç´¹ä»‹ãŒæœªè¨­å®šã§ã™</p>
                            
                            <!-- å¥½ããªã‚‚ã®ã‚¿ã‚°ï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ -->
                            <div class="profile-tags-container" th:if="${profile != null and profile.favoriteThings != null and !profile.favoriteThings.isEmpty()}">
                                <div class="profile-tags-scroll">
                                    <span class="profile-tag" th:each="tag : ${#strings.arraySplit(profile.favoriteThings, ',')}" 
                                          th:text="${tag.trim()}">ã‚¿ã‚°</span>
                                </div>
                            </div>
                            
                            <!-- ãƒ•ã‚©ãƒ­ãƒ¼/ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼/ãƒ•ãƒ¬ãƒ³ãƒ‰æ•° -->
                            <div class="profile-stats">
                                <div class="stat-item">
                                    <span class="stat-label">ãƒ•ã‚©ãƒ­ãƒ¼</span>
                                    <span class="stat-value" id="myFollowingCount" th:text="${followingCount != null ? followingCount : 0}">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</span>
                                    <span class="stat-value" id="myFollowerCount" th:text="${followerCount != null ? followerCount : 0}">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å‹é”</span>
                                    <span class="stat-value" id="myFriendCount" th:text="${friendCount != null ? friendCount : 0}">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é–²è¦§ç”»é¢ -->
        <section class="app-section" id="user-profile-view-section">
            <div class="section-content">
                <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="profile-section profile-view-mode">
                    <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
                    <button class="back-btn" type="button" id="backToHomeBtn">
                        <i class="fas fa-chevron-left" style="font-size: 1.2rem;"></i>
                    </button>
                    <div class="profile-main" id="viewedProfileContent">
                        <!-- JavaScriptã§å‹•çš„ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ -->
                    </div>
                </div>
            </div>
        </section>
        
    </div>
    
    <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆé–²è¦§ç”¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢å°‚ç”¨ï¼‰ -->
    <div class="profile-actions" id="profileActions" style="display: none;">
        <button class="btn-action btn-chat" id="btnStartChat">
            <i class="fas fa-comment me-2"></i>ãƒãƒ£ãƒƒãƒˆ
        </button>
        <button class="btn-action btn-follow" id="btnFollowUser">
            <i class="fas fa-user-plus me-2"></i>ãƒ•ã‚©ãƒ­ãƒ¼
        </button>
    </div>
    
    <!-- ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal(event)">
        <button class="image-modal-close" onclick="closeImageModal(event)">
            <i class="fas fa-times"></i>
        </button>
        <img class="image-modal-content" id="modalImage" src="" alt="æ‹¡å¤§ç”»åƒ">
    </div>
    
    <!-- ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="slide-menu-overlay" id="slideMenuOverlay"></div>
    
    <!-- ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="slide-menu" id="slideMenu">
        <button class="slide-menu-close" id="slideMenuClose">
            <i class="fas fa-times"></i>
        </button>
        
        <!-- ã‚¢ã‚¤ã‚³ãƒ³ -->
        <div class="slide-menu-avatar-container">
            <div class="slide-menu-avatar" 
                 th:if="${profile != null and profile.avatarUrl != null and !profile.avatarUrl.isEmpty()}"
                 th:style="'background-image: url(' + ${profile.avatarUrl} + '); background-size: cover; background-position: center;'">
            </div>
            <div class="slide-menu-avatar default-avatar" 
                 th:if="${profile == null or profile.avatarUrl == null or profile.avatarUrl.isEmpty()}"
                 th:attr="data-username=${user != null ? user.username : username}">
                <i class="fas fa-user"></i>
            </div>
        </div>
        
        <!-- ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  -->
        <div class="slide-menu-nickname">
            <span th:text="${profile != null and profile.displayName != null ? profile.displayName : (user != null ? user.username : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å')}">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</span>
        </div>
        
        <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <nav class="slide-menu-nav">
            <a href="/profile/edit" class="slide-menu-item">
                <i class="fas fa-user-edit me-3"></i>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
            </a>
        </nav>
        
        <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼ˆæœ€ä¸‹éƒ¨ï¼‰ -->
        <div class="slide-menu-footer">
            <a href="/logout" class="slide-menu-item logout-item" onclick="handleLogout(event)">
                <i class="fas fa-sign-out-alt me-3"></i>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </a>
        </div>
    </div>
    
    <!-- æŠ•ç¨¿ãƒœã‚¿ãƒ³ï¼ˆãƒ•ãƒƒã‚¿ãƒ¼ã®ä¸Šï¼‰ -->
    <button class="btn-create-post" id="btnCreatePost">
        <i class="fas fa-plus"></i>
    </button>
    
    <!-- ãƒãƒƒãƒãƒ³ã‚°ç¨®é¡ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒãƒƒãƒç”»é¢ã®ã¿è¡¨ç¤ºï¼‰ -->
    <div class="match-header" id="matchHeader" style="display: none;">
        <button class="match-type-btn" data-match-type="nearby">
            <i class="fas fa-map-marker-alt"></i>
            <span>è¿‘æ‰€</span>
        </button>
        <button class="match-type-btn" data-match-type="hobby">
            <i class="fas fa-heart"></i>
            <span>è¶£å‘³</span>
        </button>
        <button class="match-type-btn" data-match-type="age">
            <i class="fas fa-calendar-alt"></i>
            <span>å¹´é½¢</span>
        </button>
        <button class="match-type-btn" data-match-type="destiny">
            <i class="fas fa-star"></i>
            <span>é‹å‘½</span>
        </button>
    </div>
    
    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <footer class="bottom-nav">
        <button class="nav-item active" data-section="home">
            <i class="fas fa-home"></i>
            <span>ãƒ›ãƒ¼ãƒ </span>
        </button>
        <button class="nav-item" data-section="room">
            <i class="fas fa-door-open"></i>
            <span>ãƒ«ãƒ¼ãƒ </span>
        </button>
        <button class="nav-item" data-section="match">
            <i class="fas fa-random"></i>
            <span>ãƒãƒƒãƒ</span>
        </button>
        <button class="nav-item" data-section="chat">
            <i class="fas fa-comments"></i>
            <span>ãƒãƒ£ãƒƒãƒˆ</span>
        </button>
        <button class="nav-item" data-section="mypage">
            <i class="fas fa-user"></i>
            <span>ãƒã‚¤ãƒšãƒ¼ã‚¸</span>
        </button>
    </footer>

    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script>
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒã‚¿ãƒ¼ã®è‰²è¨­å®šé–¢æ•°
        function setDefaultAvatarColor(avatarElement) {
            if (!avatarElement) return;
            
            // data-usernameå±æ€§ã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‹ã‚‰å–å¾—
            const username = avatarElement.getAttribute('data-username') || 
                           avatarElement.textContent.trim() ||
                           'default';
            
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
                '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B88B', '#AAB7B8'
            ];
            
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            const color = colors[Math.abs(hash) % colors.length];
            avatarElement.style.backgroundColor = color;
        }
        
        // WebSocketæ¥ç¶š
        let stompClient = null;
        let isWebSocketConnected = false;

        // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼‰
        let currentUserId = null;

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ä¿å­˜
        window.currentUser = null;
        window.stompClient = null;
        window.requestedRoomIds = new Set(); // ç”³è«‹ä¸­ã®ãƒ«ãƒ¼ãƒ IDã‚’ä¿æŒ

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å¤‰æ›´æ¤œçŸ¥ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
        function checkUserChange() {
            const appContainer = document.querySelector('.app-container');
            const currentUsername = appContainer?.dataset.currentUsername;
            const storedUsername = sessionStorage.getItem('chatapp_current_user');

            console.log('ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼å¤‰æ›´ãƒã‚§ãƒƒã‚¯ - ç¾åœ¨:', currentUsername, ', ä¿å­˜:', storedUsername);

            if (storedUsername && storedUsername !== currentUsername) {
                console.log('âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸï¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™');
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
                window.requestedRoomIds = new Set();
                sessionStorage.clear();
                // Service Workerã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚ã‚¯ãƒªã‚¢
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            caches.delete(name);
                            console.log('ğŸ—‘ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤:', name);
                        });
                    });
                }
            }

            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ä¿å­˜
            if (currentUsername) {
                sessionStorage.setItem('chatapp_current_user', currentUsername);
            }
        }

        // åˆæœŸåŒ–é–¢æ•°ï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œï¼‰
        function initializeApp() {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
            checkUserChange();

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
            const appContainer = document.querySelector('.app-container');
            if (appContainer && appContainer.dataset.currentUserId) {
                currentUserId = parseInt(appContainer.dataset.currentUserId);
                console.log('ğŸ‘¤ ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:', currentUserId);
            } else {
                console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“');
            }

            if (appContainer && appContainer.dataset.currentUsername) {
                window.currentUser = appContainer.dataset.currentUsername;
                console.log('ğŸ‘¤ ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å:', window.currentUser);
            }
            
            // WebSocketæ¥ç¶šã‚’é–‹å§‹
            connectWebSocket();
            
            // æ¥ç¶šçŠ¶æ…‹ã‚’å®šæœŸçš„ã«ç¢ºèª
            setInterval(function() {
                if (!isWebSocketConnected) {
                    connectWebSocket();
                }
            }, 60000); // 60ç§’ã”ã¨

            // åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
            console.log('ğŸ“‹ åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...');
            loadJoinedRooms();
            loadDMConversations();

            // ç”³è«‹ãƒãƒƒã‚¸ã‚’æ›´æ–°ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ï¼‰
            loadRequestedRooms().catch(err => console.error('ç”³è«‹æ•°å–å¾—ã‚¨ãƒ©ãƒ¼:', err));
        }
        
        function connectWebSocket() {
            console.log('===== WebSocketæ¥ç¶šé–‹å§‹ =====');
            console.log('æ¥ç¶šå…ˆ:', window.location.origin + '/ws');
            
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            window.stompClient = stompClient;  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜

            // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’ç„¡åŠ¹åŒ–ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯æœ‰åŠ¹ã«ã™ã‚‹ã¨æƒ…å ±ãŒå¤šã™ãã‚‹ï¼‰
            stompClient.debug = null;

            stompClient.connect({}, function(frame) {
                isWebSocketConnected = true;
                console.log('âœ… WebSocketæ¥ç¶šæˆåŠŸ');
                console.log('æ¥ç¶šæƒ…å ±:', frame);
                
                // æ–°è¦æŠ•ç¨¿ã®è³¼èª­
                stompClient.subscribe('/topic/posts', function(message) {
                    console.log('ğŸ“¨ æ–°è¦æŠ•ç¨¿ã‚’å—ä¿¡:', message.body);
                    const postData = JSON.parse(message.body);
                    addNewPostToDOM(postData);
                });
                
                // ãƒ•ã‚©ãƒ­ãƒ¼æ•°æ›´æ–°ã®è³¼èª­
                stompClient.subscribe('/topic/follow-updates', function(message) {
                    console.log('ğŸ“Š ãƒ•ã‚©ãƒ­ãƒ¼æ›´æ–°ã‚’å—ä¿¡:', message.body);
                    const updateData = JSON.parse(message.body);
                    updateFollowCountsForUser(updateData);
                });
                
                // DMãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è³¼èª­
                stompClient.subscribe('/user/queue/dm', function(message) {
                    console.log('ï¿½ WebSocketã‹ã‚‰DMãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡:', message.body);
                    try {
                        const dmData = JSON.parse(message.body);
                        handleIncomingDM(dmData);
                    } catch (error) {
                        console.error('âŒ DMãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
                    }
                });
                
                // DMæ—¢èª­é€šçŸ¥ã®è³¼èª­
                stompClient.subscribe('/user/queue/dm-read', function(message) {
                    console.log('âœ… DMæ—¢èª­é€šçŸ¥ã‚’å—ä¿¡:', message.body);
                    try {
                        const readData = JSON.parse(message.body);
                        handleDMReadNotification(readData);
                    } catch (error) {
                        console.error('âŒ DMæ—¢èª­é€šçŸ¥ã®ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
                    }
                });

                // ãƒ«ãƒ¼ãƒ æ›´æ–°ã®è³¼èª­
                stompClient.subscribe('/topic/rooms', function(message) {
                    console.log('ğŸ  ãƒ«ãƒ¼ãƒ æ›´æ–°ã‚’å—ä¿¡:', message.body);
                    try {
                        const roomData = JSON.parse(message.body);
                        handleRoomUpdate(roomData);
                    } catch (error) {
                        console.error('âŒ ãƒ«ãƒ¼ãƒ æ›´æ–°ã®ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
                    }
                });

                console.log('ğŸ“¡ WebSocketã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å®Œäº†');
            }, function(error) {
                isWebSocketConnected = false;
                console.error('âŒ WebSocketæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                console.log('â° 5ç§’å¾Œã«å†æ¥ç¶šã‚’è©¦è¡Œã—ã¾ã™...');
                // 5ç§’å¾Œã«å†æ¥ç¶š
                setTimeout(connectWebSocket, 5000);
            });
            
            // æ¥ç¶šçŠ¶æ…‹ã®ç›£è¦–
            socket.onclose = function() {
                isWebSocketConnected = false;
                console.warn('âš ï¸ WebSocketæ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
            };
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ ã‚¢ãƒ—ãƒªåˆæœŸåŒ–é–‹å§‹');
            initializeApp();
        });
        
        // æ–°è¦æŠ•ç¨¿ã‚’DOMã«è¿½åŠ 
        function addNewPostToDOM(postData) {
            const postsContainer = document.querySelector('.posts-container');
            const noPosts = postsContainer.querySelector('.no-posts');
            
            // "ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
            if (noPosts) {
                noPosts.remove();
            }
            
            // æŠ•ç¨¿ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
            const postCard = document.createElement('div');
            postCard.className = 'post-card';
            
            const user = postData.user;
            const displayName = user.displayName || user.username;
            const colorIndex = getUserColor(user.username);
            
            // ã‚¢ãƒã‚¿ãƒ¼HTML
            let avatarHtml = '';
            if (user.avatarUrl) {
                avatarHtml = `<div class="post-avatar user-profile-link" style="background-image: url(${user.avatarUrl}); background-size: cover; background-position: center; cursor: pointer;" data-user-id="${user.id}" data-friend-code="${postData.userFriendCode || ''}"></div>`;
            } else {
                avatarHtml = `<div class="post-avatar default-avatar user-profile-link" data-username="${user.username}" data-color="${colorIndex}" data-user-id="${user.id}" data-friend-code="${postData.userFriendCode || ''}" style="cursor: pointer;"><i class="fas fa-user"></i></div>`;
            }
            
            // ãƒ¡ãƒ‡ã‚£ã‚¢HTML
            let mediaHtml = '';
            if (postData.mediaPath) {
                const mediaUrls = postData.mediaPath.split(',');
                mediaHtml = '<div class="post-media-grid">';
                mediaUrls.forEach(url => {
                    if (url.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                        mediaHtml += `<div class="post-media-item"><img src="${url}" alt="æŠ•ç¨¿ç”»åƒ" class="post-media-image" loading="lazy" onclick="openImageModal(this.src)"></div>`;
                    } else if (url.match(/\.(mp4|webm|mov)$/i)) {
                        mediaHtml += `<div class="post-media-item"><video src="${url}" class="post-media-video" preload="metadata" controls></video></div>`;
                        mediaHtml += `<div class="post-media-item"><video src="${url}" controls class="post-media-video"></video></div>`;
                    }
                });
                mediaHtml += '</div>';
            }
            
            // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const createdAt = new Date(postData.createdAt);
            const formattedDate = `${createdAt.getFullYear()}å¹´${String(createdAt.getMonth() + 1).padStart(2, '0')}æœˆ${String(createdAt.getDate()).padStart(2, '0')}æ—¥ ${String(createdAt.getHours()).padStart(2, '0')}:${String(createdAt.getMinutes()).padStart(2, '0')}`;
            
            postCard.innerHTML = `
                <div class="post-header">
                    <div class="post-user-info">
                        ${avatarHtml}
                        <div class="post-user-details">
                            <span class="post-username clickable-username user-profile-link" data-user-id="${user.id}" data-friend-code="${user.friendCode || ''}">${displayName}</span>
                            <span class="post-time">${formattedDate}</span>
                        </div>
                    </div>
                </div>
                <div class="post-content">
                    <p>${postData.content}</p>
                    ${mediaHtml}
                </div>
            `;
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒã‚¿ãƒ¼ã®è‰²ã‚’è¨­å®š
            const defaultAvatar = postCard.querySelector('.default-avatar');
            if (defaultAvatar) {
                setDefaultAvatarColor(defaultAvatar);
            }
            
            // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
            postCard.querySelectorAll('.user-profile-link').forEach(element => {
                element.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    const friendCode = this.getAttribute('data-friend-code');
                    console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ãƒªãƒƒã‚¯ - ID:', userId, 'FriendCode:', friendCode);
                    if (userId) {
                        viewUserProfile(userId);
                    }
                });
            });
            
            // å…ˆé ­ã«è¿½åŠ ï¼ˆæ–°ã—ã„æŠ•ç¨¿ãŒä¸€ç•ªä¸Šã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
            postsContainer.insertBefore(postCard, postsContainer.firstChild);
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
            postCard.style.opacity = '0';
            postCard.style.transform = 'translateY(-20px)';
            setTimeout(() => {
                postCard.style.transition = 'all 0.5s ease';
                postCard.style.opacity = '1';
                postCard.style.transform = 'translateY(0)';
            }, 10);
        }
        
        // ãƒ•ã‚©ãƒ­ãƒ¼æ•°ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
        async function updateFollowCountsForUser(updateData) {
            const followedData = updateData.followedUserData;
            const followerData = updateData.followerUserData;
            
            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
            const currentUserId = document.querySelector('.app-container').dataset.currentUserId;
            
            console.log('ğŸ”„ ãƒ•ã‚©ãƒ­ãƒ¼æ›´æ–°ãƒ‡ãƒ¼ã‚¿å—ä¿¡:', {
                followedUserId: followedData?.userId,
                followerUserId: followerData?.userId,
                currentUserId: currentUserId,
                currentViewedUserId: currentViewedUserId
            });
            
            console.log('å‹ãƒã‚§ãƒƒã‚¯:', {
                followedUserIdType: typeof followedData?.userId,
                followerUserIdType: typeof followerData?.userId,
                currentUserIdType: typeof currentUserId
            });
            
            // è‡ªåˆ†ãŒãƒ•ã‚©ãƒ­ãƒ¼ã•ã‚ŒãŸå ´åˆï¼ˆè‡ªåˆ†ã®ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°ã‚’æ›´æ–°ï¼‰
            const isFollowed = followedData && followedData.userId == currentUserId;
            console.log('è‡ªåˆ†ãŒãƒ•ã‚©ãƒ­ãƒ¼ã•ã‚ŒãŸï¼Ÿ', isFollowed, 'followedData.userId:', followedData?.userId, 'currentUserId:', currentUserId);
            
            if (isFollowed) {
                console.log('âœ… è‡ªåˆ†ãŒãƒ•ã‚©ãƒ­ãƒ¼ã•ã‚Œã¾ã—ãŸï¼ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¾ã™');
                const myFollowerCount = document.getElementById('myFollowerCount');
                console.log('myFollowerCountè¦ç´ :', myFollowerCount);
                if (myFollowerCount && followedData.followerCount !== undefined) {
                    console.log('ğŸ“Š ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°æ›´æ–°:', followedData.followerCount);
                    myFollowerCount.textContent = followedData.followerCount;
                } else {
                    console.warn('âš ï¸ ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°ã‚’æ›´æ–°ã§ãã¾ã›ã‚“:', {
                        element: myFollowerCount,
                        count: followedData.followerCount
                    });
                }
                
                const myFriendCount = document.getElementById('myFriendCount');
                if (myFriendCount && followedData.friendCount !== undefined) {
                    console.log('ğŸ“Š ãƒã‚¤ãƒšãƒ¼ã‚¸ã®å‹é”æ•°æ›´æ–°:', followedData.friendCount);
                    myFriendCount.textContent = followedData.friendCount;
                }
            }
            
            // è‡ªåˆ†ãŒãƒ•ã‚©ãƒ­ãƒ¼ã—ãŸå ´åˆï¼ˆè‡ªåˆ†ã®ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚©ãƒ­ãƒ¼æ•°ã‚’æ›´æ–°ï¼‰
            const isFollowing = followerData && followerData.userId == currentUserId;
            console.log('è‡ªåˆ†ãŒãƒ•ã‚©ãƒ­ãƒ¼ã—ãŸï¼Ÿ', isFollowing, 'followerData.userId:', followerData?.userId, 'currentUserId:', currentUserId);
            
            if (isFollowing) {
                console.log('âœ… è‡ªåˆ†ãŒãƒ•ã‚©ãƒ­ãƒ¼ã—ã¾ã—ãŸï¼ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¾ã™');
                const myFollowingCount = document.getElementById('myFollowingCount');
                console.log('myFollowingCountè¦ç´ :', myFollowingCount);
                if (myFollowingCount && followerData.followingCount !== undefined) {
                    console.log('ğŸ“Š ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚©ãƒ­ãƒ¼æ•°æ›´æ–°:', followerData.followingCount);
                    myFollowingCount.textContent = followerData.followingCount;
                } else {
                    console.warn('âš ï¸ ãƒ•ã‚©ãƒ­ãƒ¼æ•°ã‚’æ›´æ–°ã§ãã¾ã›ã‚“:', {
                        element: myFollowingCount,
                        count: followerData.followingCount
                    });
                }
                
                const myFriendCount = document.getElementById('myFriendCount');
                if (myFriendCount && followerData.friendCount !== undefined) {
                    console.log('ğŸ“Š ãƒã‚¤ãƒšãƒ¼ã‚¸ã®å‹é”æ•°æ›´æ–°:', followerData.friendCount);
                    myFriendCount.textContent = followerData.friendCount;
                }
            }
            
            // ãƒ•ã‚©ãƒ­ãƒ¼ã•ã‚ŒãŸäººã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¦‹ã¦ã„ã‚‹å ´åˆ
            if (followedData && currentViewedUserId && currentViewedUserId == followedData.userId) {
                const targetFollowerCount = document.getElementById('targetFollowerCount');
                if (targetFollowerCount && followedData.followerCount !== undefined) {
                    targetFollowerCount.textContent = followedData.followerCount;
                }
                
                // ãƒ•ã‚©ãƒ­ãƒ¼æ•°ã¨å‹é”æ•°ã‚‚æ›´æ–°
                const profileStats = document.querySelector('#user-profile-view-section .profile-stats');
                if (profileStats) {
                    const statValues = profileStats.querySelectorAll('.stat-value');
                    if (statValues.length >= 3 && followedData.followingCount !== undefined) {
                        statValues[0].textContent = followedData.followingCount;
                    }
                    if (statValues.length >= 3 && followedData.friendCount !== undefined) {
                        statValues[2].textContent = followedData.friendCount;
                    }
                }
                
                // ãƒœã‚¿ãƒ³ã‚‚æ›´æ–°
                await updateFollowButton(currentViewedUserId);
            }
            
            // ãƒ•ã‚©ãƒ­ãƒ¼ã—ãŸäººã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¦‹ã¦ã„ã‚‹å ´åˆ
            if (followerData && currentViewedUserId && currentViewedUserId == followerData.userId) {
                const targetFollowerCount = document.getElementById('targetFollowerCount');
                if (targetFollowerCount && followerData.followerCount !== undefined) {
                    targetFollowerCount.textContent = followerData.followerCount;
                }
                
                // ãƒ•ã‚©ãƒ­ãƒ¼æ•°ã¨å‹é”æ•°ã‚‚æ›´æ–°
                const profileStats = document.querySelector('#user-profile-view-section .profile-stats');
                if (profileStats) {
                    const statValues = profileStats.querySelectorAll('.stat-value');
                    if (statValues.length >= 3 && followerData.followingCount !== undefined) {
                        statValues[0].textContent = followerData.followingCount;
                    }
                    if (statValues.length >= 3 && followerData.friendCount !== undefined) {
                        statValues[2].textContent = followerData.friendCount;
                    }
                }
                
                // ãƒœã‚¿ãƒ³ã‚‚æ›´æ–°
                await updateFollowButton(currentViewedUserId);
            }
        }
        
        // ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function openImageModal(src) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modalImg.src = src;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        // ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeImageModal(event) {
            // ç”»åƒè‡ªä½“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯é–‰ã˜ãªã„
            if (event.target.classList.contains('image-modal-content')) {
                return;
            }
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        function handleLogout(event) {
            // localStorageã‹ã‚‰è¨˜æ†¶ã—ãŸãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’å‰Šé™¤
            localStorage.removeItem('rememberLogin');
            localStorage.removeItem('savedUsername');
            sessionStorage.clear();
            console.log('ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’ç¶šè¡Œï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒªãƒ³ã‚¯å‹•ä½œï¼‰
        }
        
        // æ˜Ÿã‚’ç”Ÿæˆ
        function createStars() {
            const container = document.querySelector('.app-container');
            const starCount = 100; // æ˜Ÿã®æ•°
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = Math.random() > 0.8 ? 'star large' : 'star';
                
                // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                
                // ãƒ©ãƒ³ãƒ€ãƒ ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é…å»¶
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.animationDuration = (Math.random() * 2 + 2) + 's';
                
                container.appendChild(star);
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ˜Ÿã‚’ç”Ÿæˆ
        createStars();
        
        // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã«localStorageã«è¨˜æ†¶
        const pendingUsername = sessionStorage.getItem('pendingUsername');
        if (pendingUsername) {
            localStorage.setItem('rememberLogin', 'true');
            localStorage.setItem('savedUsername', pendingUsername);
            sessionStorage.removeItem('pendingUsername');
            // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼‰
            sessionStorage.removeItem('loginRedirectCount');
            console.log('ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’è¨˜æ†¶ã—ã¾ã—ãŸ: ' + pendingUsername);
        } else {
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‹ã‚‰ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã§ãªã„å ´åˆã‚‚ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            sessionStorage.removeItem('loginRedirectCount');
        }
        
        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆ
        const navItems = document.querySelectorAll('.nav-item');
        const sections = document.querySelectorAll('.app-section');
        const createPostBtn = document.getElementById('btnCreatePost');
        const matchHeader = document.getElementById('matchHeader');
        
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const sectionName = item.dataset.section;
                
                // å…¨ã¦ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ active ã‚’å‰Šé™¤
                navItems.forEach(nav => nav.classList.remove('active'));
                sections.forEach(section => section.classList.remove('active'));
                
                // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã¨å¯¾å¿œã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã« active ã‚’è¿½åŠ 
                item.classList.add('active');
                document.getElementById(sectionName + '-section').classList.add('active');
                
                // ãƒ›ãƒ¼ãƒ ç”»é¢ã®å ´åˆã®ã¿ï¼‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                if (sectionName === 'home') {
                    createPostBtn.style.display = 'flex';
                } else {
                    createPostBtn.style.display = 'none';
                }
                
                // ãƒãƒƒãƒç”»é¢ã®å ´åˆã®ã¿ãƒãƒƒãƒãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¡¨ç¤º
                if (sectionName === 'match') {
                    matchHeader.style.display = 'flex';
                } else {
                    matchHeader.style.display = 'none';
                }
                
                // ãƒãƒ£ãƒƒãƒˆç”»é¢ã«é·ç§»ã—ãŸæ™‚ã«DMä¼šè©±ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
                if (sectionName === 'chat') {
                    loadDMConversations();
                }
                
                // ãƒ«ãƒ¼ãƒ ç”»é¢ã«é·ç§»ã—ãŸæ™‚ã«ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
                if (sectionName === 'room') {
                    loadJoinedRooms();
                }
            });
        });
        
        // ãƒãƒ£ãƒƒãƒˆã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆï¼ˆã™ã¹ã¦/å‹é”ï¼‰
        const chatTabBtns = document.querySelectorAll('.chat-list-header .tab-btn');
        chatTabBtns.forEach(btn => {
            btn.addEventListener('click', async () => {
                const tabName = btn.dataset.tab;
                
                chatTabBtns.forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.chat-list-header + div, .chat-list-header + div + div').forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                const targetTab = document.getElementById(tabName + '-tab');
                if (targetTab) {
                    targetTab.classList.add('active');
                }
                
                // å‹é”ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆãŸå ´åˆã¯å‹é”ã®DMã‚’èª­ã¿è¾¼ã‚€
                if (tabName === 'friends-chat') {
                    await loadFriendsDMConversations();
                }
            });
        });
        
        // ãƒ«ãƒ¼ãƒ ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        const roomTabBtns = document.querySelectorAll('#room-section .chat-list-header .tab-btn');
        
        if (roomTabBtns.length > 0) {
            console.log('ãƒ«ãƒ¼ãƒ ã‚¿ãƒ–ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:', roomTabBtns.length, 'å€‹');
            roomTabBtns.forEach(btn => {
                btn.addEventListener('click', async () => {
                    const tabName = btn.dataset.tab;
                    console.log('ãƒ«ãƒ¼ãƒ ã‚¿ãƒ–ã‚¯ãƒªãƒƒã‚¯:', tabName);
                    
                    roomTabBtns.forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('#room-section .tab-content').forEach(c => c.classList.remove('active'));
                    
                    btn.classList.add('active');
                    const targetContent = document.getElementById(tabName + '-tab');
                    if (targetContent) {
                        targetContent.classList.add('active');
                        console.log('ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º:', tabName);
                    }
                    
                    // ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
                    if (tabName === 'joined-rooms') {
                        await loadJoinedRooms();
                    } else if (tabName === 'available-rooms') {
                        await loadAvailableRooms();
                    }
                });
            });
        } else {
            console.warn('âš ï¸ ãƒ«ãƒ¼ãƒ ã‚¿ãƒ–ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        
        // ãƒãƒƒãƒç¨®é¡ãƒœã‚¿ãƒ³åˆ‡ã‚Šæ›¿ãˆ
        const matchTypeBtns = document.querySelectorAll('.match-type-btn');
        
        matchTypeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const matchType = btn.dataset.matchType;
                
                // å…¨ã¦ã®ãƒœã‚¿ãƒ³ã‹ã‚‰activeã‚’å‰Šé™¤
                matchTypeBtns.forEach(b => b.classList.remove('active'));
                
                // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
                btn.classList.add('active');
                
                // ãƒãƒƒãƒãƒ³ã‚°å‡¦ç†ã‚’ã“ã“ã«å®Ÿè£…ï¼ˆä¾‹ï¼šãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚„ãƒãƒƒãƒãƒ³ã‚°é–‹å§‹ï¼‰
                console.log(`ãƒãƒƒãƒãƒ³ã‚°ã‚¿ã‚¤ãƒ—: ${matchType}`);
                startMatching(matchType);
            });
        });
        
        // ãƒãƒƒãƒãƒ³ã‚°é–‹å§‹é–¢æ•°ï¼ˆå„ãƒãƒƒãƒã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸå‡¦ç†ï¼‰
        function startMatching(matchType) {
            const matchSection = document.getElementById('match-section');
            const welcomeSection = matchSection.querySelector('.welcome-section');
            
            switch(matchType) {
                case 'nearby':
                    welcomeSection.innerHTML = `
                        <h1>ğŸ“ è¿‘æ‰€ã§ãƒãƒƒãƒãƒ³ã‚°</h1>
                        <p class="text-white-50">è¿‘ãã«ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¢ã—ã¦ã„ã¾ã™...</p>
                    `;
                    break;
                case 'hobby':
                    welcomeSection.innerHTML = `
                        <h1>â¤ï¸ è¶£å‘³ã§ãƒãƒƒãƒãƒ³ã‚°</h1>
                        <p class="text-white-50">å…±é€šã®è¶£å‘³ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¢ã—ã¦ã„ã¾ã™...</p>
                    `;
                    break;
                case 'age':
                    welcomeSection.innerHTML = `
                        <h1>ğŸ“… å¹´é½¢ã§ãƒãƒƒãƒãƒ³ã‚°</h1>
                        <p class="text-white-50">åŒå¹´ä»£ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¢ã—ã¦ã„ã¾ã™...</p>
                    `;
                    break;
                case 'destiny':
                    welcomeSection.innerHTML = `
                        <h1>â­ é‹å‘½ã®ãƒãƒƒãƒãƒ³ã‚°</h1>
                        <p class="text-white-50">é‹å‘½ã®ç›¸æ‰‹ã‚’æ¢ã—ã¦ã„ã¾ã™...</p>
                    `;
                    break;
            }
            
            // TODO: å®Ÿéš›ã®ãƒãƒƒãƒãƒ³ã‚°å‡¦ç†ã‚’ã“ã“ã«å®Ÿè£…
            // ä¾‹: APIã‚’å‘¼ã³å‡ºã—ã¦é©åˆ‡ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢ã—ã€çµæœã‚’è¡¨ç¤º
        }
        
        // å‚åŠ ãƒœã‚¿ãƒ³
        document.querySelectorAll('.btn-join').forEach(btn => {
            btn.addEventListener('click', async function(e) {
                e.stopPropagation();
                const roomId = this.dataset.roomId;
                
                try {
                    const response = await fetch(`/rooms/${roomId}/join`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        window.location.href = data.redirectUrl;
                    } else {
                        alert(data.message);
                    }
                } catch (error) {
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            });
        });
        
        // æŠ•ç¨¿ãƒœã‚¿ãƒ³ - æŠ•ç¨¿ç”»é¢ã¸é·ç§»
        const btnCreatePost = document.getElementById('btnCreatePost');
        const btnBackFromPost = document.getElementById('btnBackFromPost');
        const createPostSection = document.getElementById('create-post-section');
        const homeSection = document.getElementById('home-section');
        
        if (btnCreatePost) {
            btnCreatePost.addEventListener('click', () => {
                sections.forEach(section => section.classList.remove('active'));
                createPostSection.classList.add('active');
            });
        }
        
        if (btnBackFromPost) {
            btnBackFromPost.addEventListener('click', () => {
                createPostSection.classList.remove('active');
                homeSection.classList.add('active');
                navItems.forEach(nav => nav.classList.remove('active'));
                navItems[0].classList.add('active');
            });
        }

        // ãƒ«ãƒ¼ãƒ ä½œæˆãƒœã‚¿ãƒ³ - ãƒ«ãƒ¼ãƒ ä½œæˆç”»é¢ã¸é·ç§»
        const btnCreateRoom = document.getElementById('btnCreateRoom');
        const btnBackFromRoom = document.getElementById('btnBackFromRoom');
        const createRoomSection = document.getElementById('create-room-section');
        const roomSection = document.getElementById('room-section');

        if (btnCreateRoom) {
            btnCreateRoom.addEventListener('click', async () => {
                sections.forEach(section => section.classList.remove('active'));
                createRoomSection.classList.add('active');
                // å‹é”ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
                await loadFriendsForInvite();
            });
        }

        if (btnBackFromRoom) {
            btnBackFromRoom.addEventListener('click', () => {
                createRoomSection.classList.remove('active');
                roomSection.classList.add('active');
                navItems.forEach(nav => nav.classList.remove('active'));
                navItems[1].classList.add('active'); // ãƒ«ãƒ¼ãƒ ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            });
        }

        // ãƒ«ãƒ¼ãƒ ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆï¼ˆ5ã¤å…¨ã¦ï¼‰- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã‚ãšå¸¸ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const roomTabButtons = document.querySelectorAll('#room-section .tab-btn');
        const roomTabContents = document.querySelectorAll('#room-section .tab-content');

        roomTabButtons.forEach(button => {
            button.addEventListener('click', async () => {
                // å…¨ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã® active ã‚’å‰Šé™¤
                roomTabButtons.forEach(btn => btn.classList.remove('active'));
                roomTabContents.forEach(content => content.classList.remove('active'));

                // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’ active ã«
                button.classList.add('active');

                // data-tabå±æ€§ãŒã‚ã‚Œã°å¯¾å¿œã™ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
                const targetTab = button.getAttribute('data-tab');
                if (targetTab) {
                    const targetContent = document.getElementById(targetTab + '-tab');
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                }

                // ã‚¿ãƒ–ã«å¿œã˜ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢åŠ¹æœï¼‰
                console.log('ğŸ”„ ãƒ«ãƒ¼ãƒ ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ - ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿:', targetTab || button.id);

                if (targetTab === 'joined-rooms') {
                    await loadJoinedRooms();
                } else if (targetTab === 'available-rooms') {
                    await loadAvailableRooms();
                } else if (button.id === 'btnRoomRequests') {
                    console.log('ğŸ“¥ ç”³è«‹ã‚¿ãƒ–ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                    document.getElementById('requests-tab').classList.add('active');
                    await loadRequestedRooms();
                } else if (button.id === 'btnRoomApprovals') {
                    console.log('âœ… æ‰¿èªã‚¿ãƒ–ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                    document.getElementById('approvals-tab').classList.add('active');
                    await loadPendingApprovals();
                } else if (button.id === 'btnRoomInvite') {
                    console.log('ğŸ‘¥ æ‹›å¾…ã‚¿ãƒ–ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                    document.getElementById('invite-tab').classList.add('active');
                    // TODO: æ‹›å¾…æ©Ÿèƒ½
                }
            });
        });

        // ãƒ«ãƒ¼ãƒ ä½œæˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        const createRoomForm = document.getElementById('createRoomForm');
        if (createRoomForm) {
            createRoomForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = new FormData(createRoomForm);

                // é¸æŠã•ã‚ŒãŸå‹é”ã®usernameã‚’å–å¾—
                const selectedFriends = Array.from(document.querySelectorAll('.friend-checkbox:checked'))
                    .map(checkbox => checkbox.dataset.username);

                const roomData = {
                    name: formData.get('name'),
                    description: formData.get('description'),
                    type: 'GROUP',
                    isPublic: formData.get('isPublic') === 'true',
                    invitedUsernames: selectedFriends.join(',')  // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§é€ä¿¡
                };

                try {
                    console.log('ğŸš€ ãƒ«ãƒ¼ãƒ ä½œæˆé–‹å§‹:', roomData);
                    const response = await fetch('/rooms/api/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams(roomData)
                    });

                    const data = await response.json();
                    console.log('ğŸ“¦ ãƒ«ãƒ¼ãƒ ä½œæˆãƒ¬ã‚¹ãƒãƒ³ã‚¹:', data);

                    if (data.success) {
                        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                        createRoomForm.reset();
                        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚‚ãƒªã‚»ãƒƒãƒˆ
                        document.querySelectorAll('.friend-checkbox').forEach(cb => cb.checked = false);

                        // ãƒ«ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹
                        createRoomSection.classList.remove('active');
                        roomSection.classList.add('active');

                        // ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                        await loadJoinedRooms();

                        alert('ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã—ãŸ!');
                        console.log('âœ… ãƒ«ãƒ¼ãƒ ä½œæˆæˆåŠŸ - ID:', data.roomId);
                    } else {
                        alert(data.message || 'ãƒ«ãƒ¼ãƒ ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                        console.error('âŒ ãƒ«ãƒ¼ãƒ ä½œæˆå¤±æ•—:', data.message);
                    }
                } catch (error) {
                    console.error('âŒ ãƒ«ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ«ãƒ¼ãƒ ã®ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            });
        }

        // æ–‡å­—ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
        const postContent = document.getElementById('postContent');
        const charCounter = document.getElementById('charCounter');
        
        if (postContent && charCounter) {
            postContent.addEventListener('input', function() {
                const length = this.value.length;
                charCounter.textContent = length + ' / 1000';
                
                if (length > 900) {
                    charCounter.style.color = '#dc3545';
                } else if (length > 800) {
                    charCounter.style.color = '#ffc107';
                } else {
                    charCounter.style.color = '#6c757d';
                }
            });
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
        const mediaUpload = document.getElementById('mediaUpload');
        const uploadArea = document.getElementById('uploadArea');
        const previewContainer = document.getElementById('previewContainer');
        
        if (mediaUpload && previewContainer) {
            mediaUpload.addEventListener('change', function(e) {
                previewFiles(e.target.files);
            });
            
            // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                previewFiles(e.dataTransfer.files);
                mediaUpload.files = e.dataTransfer.files;
            });
        }
        
        function previewFiles(files) {
            previewContainer.innerHTML = '';
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    
                    if (file.type.startsWith('image/')) {
                        previewItem.innerHTML = `
                            <img src="${e.target.result}" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                            <button type="button" class="btn-remove-preview" onclick="this.parentElement.remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                    } else if (file.type.startsWith('video/')) {
                        previewItem.innerHTML = `
                            <video src="${e.target.result}" controls></video>
                            <button type="button" class="btn-remove-preview" onclick="this.parentElement.remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                    }
                    
                    previewContainer.appendChild(previewItem);
                };
                
                reader.readAsDataURL(file);
            });
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‹ã‚‰è‰²ã‚’æ±ºå®šã™ã‚‹é–¢æ•°
        function getUserColor(username) {
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            return Math.abs(hash) % 10;
        }
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã«è‰²ã‚’è¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            // ã™ã¹ã¦ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒã‚¿ãƒ¼ã«è‰²ã‚’è¨­å®š
            document.querySelectorAll('.default-avatar').forEach(avatar => {
                setDefaultAvatarColor(avatar);
            });
            
            // ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ã‚¢ãƒã‚¿ãƒ¼ã«ã‚‚è‰²ã‚’è¨­å®š
            document.querySelectorAll('.profile-avatar').forEach(avatar => {
                setDefaultAvatarColor(avatar);
            });
            
            // ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åˆ¶å¾¡
            const mypageMenuBtn = document.getElementById('mypageMenuBtn');
            const slideMenu = document.getElementById('slideMenu');
            const slideMenuOverlay = document.getElementById('slideMenuOverlay');
            const slideMenuClose = document.getElementById('slideMenuClose');
            
            if (mypageMenuBtn && slideMenu && slideMenuOverlay) {
                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã
                mypageMenuBtn.addEventListener('click', () => {
                    slideMenu.classList.add('active');
                    slideMenuOverlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                });
                
                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ï¼‰
                slideMenuOverlay.addEventListener('click', () => {
                    slideMenu.classList.remove('active');
                    slideMenuOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                });
                
                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹ï¼ˆÃ—ãƒœã‚¿ãƒ³ï¼‰
                if (slideMenuClose) {
                    slideMenuClose.addEventListener('click', () => {
                        slideMenu.classList.remove('active');
                        slideMenuOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                    });
                }
            }
        });
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é–²è¦§æ©Ÿèƒ½
        let currentViewedUserId = null; // é–²è¦§ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
        
        async function viewUserProfile(userId) {
            // ç¾åœ¨ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®IDã‚’å–å¾—
            const currentUserId = document.querySelector('.app-container').dataset.currentUserId;
            
            // é–²è¦§ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ä¿å­˜
            currentViewedUserId = userId;
            
            // è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯ãƒã‚¤ãƒšãƒ¼ã‚¸ã«é·ç§»
            if (userId === currentUserId) {
                // ãƒã‚¤ãƒšãƒ¼ã‚¸ã«é·ç§»
                sections.forEach(section => section.classList.remove('active'));
                document.getElementById('mypage-section').classList.add('active');
                navItems.forEach(nav => nav.classList.remove('active'));
                // ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹ï¼ˆæœ€å¾Œã®ã‚¢ã‚¤ãƒ†ãƒ ï¼‰
                navItems[navItems.length - 1].classList.add('active');
                createPostBtn.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/users/${userId}/profile`);
                const data = await response.json();
                
                console.log('===== ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾— =====');
                console.log('UserID:', userId);
                console.log('APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', data);
                console.log('Following:', data.followingCount);
                console.log('Follower:', data.followerCount);
                console.log('Friend:', data.friendCount);
                
                if (data.success) {
                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’è¡¨ç¤º
                    const viewedProfileContent = document.getElementById('viewedProfileContent');
                    const user = data.user;
                    const profile = data.profile;
                    
                    // ã‚¢ã‚¤ã‚³ãƒ³ã®HTML
                    let avatarHtml = '';
                    if (profile && profile.avatarUrl) {
                        avatarHtml = `<div class="profile-avatar" style="background-image: url(${profile.avatarUrl}); background-size: cover; background-position: center;"></div>`;
                    } else {
                        const colorIndex = getUserColor(user.username);
                        avatarHtml = `<div class="profile-avatar default-avatar" data-username="${user.username}" data-color="${colorIndex}"><i class="fas fa-user"></i></div>`;
                    }
                    
                    // ã‚¿ã‚°ã®HTML
                    let tagsHtml = '';
                    if (profile && profile.favoriteThings) {
                        const tags = profile.favoriteThings.split(',').map(tag => tag.trim()).filter(tag => tag);
                        if (tags.length > 0) {
                            tagsHtml = `
                                <div class="profile-tags-container">
                                    <div class="profile-tags-scroll">
                                        ${tags.map(tag => `<span class="profile-tag">${tag}</span>`).join('')}
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    viewedProfileContent.innerHTML = `
                        <div class="profile-main-top">
                            ${avatarHtml}
                            <div class="profile-info-top">
                                <h2 class="profile-username">${profile && profile.displayName ? profile.displayName : user.username}</h2>
                                <p class="profile-friendcode">${user.friendCode ? 'FC: ' + user.friendCode : 'FC: æœªè¨­å®š'}</p>
                            </div>
                        </div>
                        <div class="profile-info-bottom" style="text-align: left;">
                            <p class="profile-bio ${!profile || !profile.bio ? 'text-muted' : ''}" style="text-align: left !important;">${profile && profile.bio ? profile.bio : 'è‡ªå·±ç´¹ä»‹ãŒæœªè¨­å®šã§ã™'}</p>
                            ${tagsHtml}
                            <div class="profile-stats">
                                <div class="stat-item">
                                    <span class="stat-label">ãƒ•ã‚©ãƒ­ãƒ¼</span>
                                    <span class="stat-value">${data.followingCount || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</span>
                                    <span class="stat-value" id="targetFollowerCount">${data.followerCount || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å‹é”</span>
                                    <span class="stat-value">${data.friendCount || 0}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // ãƒ•ã‚©ãƒ­ãƒ¼çŠ¶æ…‹ã‚’å–å¾—ã—ã¦ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
                    await updateFollowButton(userId);
                    
                    // ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’è¨­å®š
                    const btnStartChat = document.getElementById('btnStartChat');
                    btnStartChat.dataset.userId = userId;
                    
                    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
                    sections.forEach(section => section.classList.remove('active'));
                    document.getElementById('user-profile-view-section').classList.add('active');
                    navItems.forEach(nav => nav.classList.remove('active'));
                    
                    // DMç”»é¢ã‚’ç¢ºå®Ÿã«éè¡¨ç¤º
                    const dmSection = document.getElementById('dm-section');
                    if (dmSection) {
                        dmSection.style.display = 'none';
                        dmSection.classList.remove('active');
                    }
                    
                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã€ãƒ•ãƒƒã‚¿ãƒ¼ã‚’éè¡¨ç¤º
                    const profileActions = document.getElementById('profileActions');
                    if (profileActions) {
                        profileActions.style.cssText = 'display: flex;';
                    }
                    const bottomNav = document.querySelector('.bottom-nav');
                    if (bottomNav) {
                        bottomNav.style.display = 'none';
                    }
                    createPostBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // ãƒ•ã‚©ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        async function updateFollowButton(userId) {
            try {
                const response = await fetch(`/api/users/${userId}/relationship`);
                const data = await response.json();
                
                if (data.success) {
                    const followBtn = document.getElementById('btnFollowUser');
                    const relationship = data.relationship;
                    
                    // relationship: "friend" (ç›¸äº’ãƒ•ã‚©ãƒ­ãƒ¼), "following" (ãƒ•ã‚©ãƒ­ãƒ¼ä¸­), "follower" (ãƒ•ã‚©ãƒ­ãƒ¼ã•ã‚Œã¦ã„ã‚‹), "none" (é–¢ä¿‚ãªã—)
                    if (relationship === 'friend') {
                        followBtn.innerHTML = '<i class="fas fa-user-check me-2"></i>å‹é”';
                        followBtn.classList.add('following');
                        followBtn.dataset.relationship = 'friend'; // ãƒ‡ãƒ¼ã‚¿å±æ€§ã«é–¢ä¿‚æ€§ã‚’ä¿å­˜
                    } else if (relationship === 'following') {
                        followBtn.innerHTML = '<i class="fas fa-user-check me-2"></i>ãƒ•ã‚©ãƒ­ãƒ¼ä¸­';
                        followBtn.classList.add('following');
                        followBtn.dataset.relationship = 'following'; // ãƒ‡ãƒ¼ã‚¿å±æ€§ã«é–¢ä¿‚æ€§ã‚’ä¿å­˜
                    } else if (relationship === 'follower') {
                        followBtn.innerHTML = '<i class="fas fa-user-plus me-2"></i>ãƒ•ã‚©ãƒ­ãƒ¼ãƒãƒƒã‚¯';
                        followBtn.classList.remove('following');
                        followBtn.dataset.relationship = 'follower';
                    } else {
                        followBtn.innerHTML = '<i class="fas fa-user-plus me-2"></i>ãƒ•ã‚©ãƒ­ãƒ¼';
                        followBtn.classList.remove('following');
                        followBtn.dataset.relationship = 'none';
                    }
                }
            } catch (error) {
                console.error('Error getting relationship:', error);
            }
        }
        
        // ãƒ•ã‚©ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        const btnFollowUser = document.getElementById('btnFollowUser');
        if (btnFollowUser) {
            btnFollowUser.addEventListener('click', async () => {
                if (!currentViewedUserId) {
                    return;
                }
                
                const isFollowing = btnFollowUser.classList.contains('following');
                const relationship = btnFollowUser.dataset.relationship;
                
                // ãƒ•ã‚©ãƒ­ãƒ¼æ¸ˆã¿ãƒ»å‹é”ã®å ´åˆã¯ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
                if (isFollowing) {
                    let confirmMessage = 'ãƒ•ã‚©ãƒ­ãƒ¼ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ';
                    
                    // å‹é”ã®å ´åˆã¯æ˜ç¤ºçš„ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰æ›´
                    if (relationship === 'friend') {
                        confirmMessage = 'å‹é”é–¢ä¿‚ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆç›¸äº’ãƒ•ã‚©ãƒ­ãƒ¼ãŒè§£é™¤ã•ã‚Œã¾ã™ï¼‰';
                    }
                    
                    const confirmUnfollow = confirm(confirmMessage);
                    if (!confirmUnfollow) {
                        return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„
                    }
                }
                
                const endpoint = isFollowing ? 'unfollow' : 'follow';
                
                // ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
                btnFollowUser.disabled = true;
                const originalText = btnFollowUser.innerHTML;
                btnFollowUser.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>å‡¦ç†ä¸­...';
                
                try {
                    const response = await fetch(`/api/users/${currentViewedUserId}/${endpoint}`, {
                        method: 'POST'
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’å³åº§ã«æ›´æ–°
                        await updateFollowButton(currentViewedUserId);
                        
                        console.log('Follow response data:', data); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
                        
                        // é–²è¦§ä¸­ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°ã‚’æ›´æ–°
                        const followerCountElement = document.getElementById('targetFollowerCount');
                        if (followerCountElement && data.targetFollowerCount !== undefined) {
                            console.log('Updating targetFollowerCount to:', data.targetFollowerCount); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
                            followerCountElement.textContent = data.targetFollowerCount;
                        } else {
                            console.warn('targetFollowerCount element not found or data missing'); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
                        }
                        
                        // ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚©ãƒ­ãƒ¼/ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼/å‹é”æ•°ã‚’æ›´æ–°
                        const myFollowingCount = document.getElementById('myFollowingCount');
                        if (myFollowingCount && data.followingCount !== undefined) {
                            myFollowingCount.textContent = data.followingCount;
                        }
                        
                        const myFollowerCount = document.getElementById('myFollowerCount');
                        if (myFollowerCount && data.followerCount !== undefined) {
                            myFollowerCount.textContent = data.followerCount;
                        }
                        
                        const myFriendCount = document.getElementById('myFriendCount');
                        if (myFriendCount && data.friendCount !== undefined) {
                            myFriendCount.textContent = data.friendCount;
                        }
                        
                        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                        // alert(data.message);
                    } else {
                        alert(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                        btnFollowUser.innerHTML = originalText; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã«æˆ»ã™
                    }
                } catch (error) {
                    console.error('Error toggling follow:', error);
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                    btnFollowUser.innerHTML = originalText; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã«æˆ»ã™
                } finally {
                    // ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
                    btnFollowUser.disabled = false;
                }
            });
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒªãƒ³ã‚¯ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        document.addEventListener('click', function(e) {
            const target = e.target.closest('.user-profile-link');
            if (target && target.dataset.userId) {
                const userId = target.dataset.userId;
                const friendCode = target.dataset.friendCode;
                const username = target.dataset.username;
                console.log('===== ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¯ãƒªãƒƒã‚¯ =====');
                console.log('ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ :', target);
                console.log('User ID:', userId);
                console.log('Friend Code:', friendCode);
                console.log('Username:', username);
                console.log('================================');
                viewUserProfile(userId);
            }
        });
        
        // æˆ»ã‚‹ãƒœã‚¿ãƒ³
        const backToHomeBtn = document.getElementById('backToHomeBtn');
        if (backToHomeBtn) {
            backToHomeBtn.addEventListener('click', () => {
                sections.forEach(section => section.classList.remove('active'));
                homeSection.classList.add('active');
                navItems.forEach(nav => nav.classList.remove('active'));
                navItems[0].classList.add('active');
                createPostBtn.style.display = 'flex';
                
                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã€ãƒ•ãƒƒã‚¿ãƒ¼ã‚’å†è¡¨ç¤º
                document.getElementById('profileActions').style.display = 'none';
                document.querySelector('.bottom-nav').style.display = 'flex';
            });
        }
        
        // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã§æˆ»ã‚‹
        const userProfileViewSection = document.getElementById('user-profile-view-section');
        if (userProfileViewSection) {
            let touchStartX = 0;
            let touchEndX = 0;
            
            userProfileViewSection.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });
            
            userProfileViewSection.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });
            
            function handleSwipe() {
                if (touchEndX - touchStartX > 100) { // å³ã‚¹ãƒ¯ã‚¤ãƒ—
                    backToHomeBtn.click();
                }
            }
        }
        
        // ========================================
        // ãƒ«ãƒ¼ãƒ æ©Ÿèƒ½
        // ========================================
        
        // å‚åŠ ä¸­ã®ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
        async function loadJoinedRooms() {
            try {
                console.log('ğŸ“‹ å‚åŠ ä¸­ã®ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const response = await fetch('/rooms/api/joined', {
                    credentials: 'same-origin',
                    cache: 'no-store',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    console.error('âŒ APIå‘¼ã³å‡ºã—å¤±æ•—:', response.status);
                    return;
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('âŒ JSONã§ã¯ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡:', contentType);
                    return;
                }

                const data = await response.json();

                if (!data.success) {
                    console.error('âŒ ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆå–å¾—å¤±æ•—:', data.message);
                    return;
                }

                const rooms = data.rooms || [];
                console.log('âœ… å‚åŠ ä¸­ã®ãƒ«ãƒ¼ãƒ å–å¾—:', rooms.length, 'ä»¶');

                displayRoomList(rooms, 'joined-rooms-tab');
            } catch (error) {
                console.error('âŒ å‚åŠ ä¸­ã®ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // å‚åŠ å¯èƒ½ãªãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
        async function loadAvailableRooms() {
            try {
                // å…ˆã«ç”³è«‹æ¸ˆã¿ãƒ«ãƒ¼ãƒ IDã‚’å–å¾—ï¼ˆè¡¨ç¤ºæ™‚ã«å¿…è¦ï¼‰
                await fetchRequestedRoomIds();

                console.log('ğŸ“‹ å‚åŠ å¯èƒ½ãªãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const response = await fetch('/rooms/api/available', {
                    credentials: 'same-origin',
                    cache: 'no-store',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    console.error('âŒ APIå‘¼ã³å‡ºã—å¤±æ•—:', response.status);
                    return;
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('âŒ JSONã§ã¯ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡:', contentType);
                    return;
                }

                const data = await response.json();

                if (!data.success) {
                    console.error('âŒ ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆå–å¾—å¤±æ•—:', data.message);
                    return;
                }

                const rooms = data.rooms || [];
                console.log('âœ… å‚åŠ å¯èƒ½ãªãƒ«ãƒ¼ãƒ å–å¾—:', rooms.length, 'ä»¶');

                displayAvailableRoomList(rooms, 'available-rooms-tab');
            } catch (error) {
                console.error('âŒ å‚åŠ å¯èƒ½ãªãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ç”³è«‹æ¸ˆã¿ãƒ«ãƒ¼ãƒ IDã®ã¿ã‚’å–å¾—ï¼ˆUIã¯æ›´æ–°ã—ãªã„ï¼‰
        async function fetchRequestedRoomIds() {
            try {
                const response = await fetch('/rooms/api/my-requests', {
                    credentials: 'same-origin',
                    cache: 'no-store',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) return;

                const data = await response.json();
                if (data.success) {
                    const rooms = data.rooms || [];
                    window.requestedRoomIds = new Set(rooms.map(room => room.id));
                }
            } catch (error) {
                console.error('âŒ ç”³è«‹æ¸ˆã¿ãƒ«ãƒ¼ãƒ IDå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ç”³è«‹ä¸­ã®ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
        async function loadRequestedRooms() {
            try {
                console.log('ğŸ“‹ ç”³è«‹ä¸­ã®ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const response = await fetch('/rooms/api/my-requests', {
                    credentials: 'same-origin',
                    cache: 'no-store',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    console.error('âŒ APIå‘¼ã³å‡ºã—å¤±æ•—:', response.status);
                    return;
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('âŒ JSONã§ã¯ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡:', contentType);
                    return;
                }

                const data = await response.json();

                if (!data.success) {
                    console.error('âŒ ç”³è«‹ä¸­ã®ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆå–å¾—å¤±æ•—:', data.message);
                    return;
                }

                const rooms = data.rooms || [];
                console.log('âœ… ç”³è«‹ä¸­ã®ãƒ«ãƒ¼ãƒ å–å¾—:', rooms.length, 'ä»¶');

                // ç”³è«‹ä¸­ã®ãƒ«ãƒ¼ãƒ IDã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
                window.requestedRoomIds = new Set(rooms.map(room => room.id));
                console.log('ğŸ“ ç”³è«‹ä¸­ã®ãƒ«ãƒ¼ãƒ ID:', [...window.requestedRoomIds]);

                displayRequestedRoomList(rooms);

                // ãƒãƒƒã‚¸ã‚’æ›´æ–°
                updateRequestBadge(rooms.length);
            } catch (error) {
                console.error('âŒ ç”³è«‹ä¸­ã®ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ«ãƒ¼ãƒ ä½œæˆæ™‚ã®å‹é”æ‹›å¾…ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
        async function loadFriendsForInvite() {
            const container = document.getElementById('friendSelectionContainer');
            if (!container) return;

            try {
                console.log('ğŸ‘¥ å‹é”ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const response = await fetch('/friends/api/list', {
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    container.innerHTML = '<p class="error-text">å‹é”ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
                    return;
                }

                const friends = await response.json();
                console.log('âœ… å‹é”å–å¾—:', friends.length, 'äºº');

                if (friends.length === 0) {
                    container.innerHTML = '<p class="empty-text">å‹é”ãŒã„ã¾ã›ã‚“</p>';
                    return;
                }

                // å‹é”ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
                let html = '<div class="friend-select-list">';
                friends.forEach(friend => {
                    const avatarUrl = friend.avatarUrl || '/images/default-avatar.png';
                    html += `
                        <label class="friend-select-item">
                            <input type="checkbox" class="friend-checkbox" data-username="${escapeHtml(friend.username)}">
                            <img src="${escapeHtml(avatarUrl)}" class="friend-avatar" alt="${escapeHtml(friend.displayName)}">
                            <span class="friend-name">${escapeHtml(friend.displayName)}</span>
                        </label>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                console.error('âŒ å‹é”ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                container.innerHTML = '<p class="error-text">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
            }
        }

        // ç”³è«‹ä¸­ã®ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        function displayRequestedRoomList(rooms) {
            const requestsTab = document.getElementById('requests-tab');
            const roomListContainer = requestsTab.querySelector('.room-list');
            const noRoomsElement = roomListContainer.querySelector('.no-chats');

            if (!roomListContainer) {
                console.error('âŒ ç”³è«‹ä¸­ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            // æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤
            const existingItems = roomListContainer.querySelectorAll('.chat-item');
            existingItems.forEach(item => item.remove());

            if (rooms.length === 0) {
                if (noRoomsElement) {
                    noRoomsElement.style.display = 'block';
                }
                console.log('ğŸ“‹ ç”³è«‹ä¸­ã®ãƒ«ãƒ¼ãƒ ãªã—');
                return;
            }

            if (noRoomsElement) {
                noRoomsElement.style.display = 'none';
            }

            console.log('ğŸ“‹ ç”³è«‹ä¸­ã®ãƒ«ãƒ¼ãƒ ã‚’è¡¨ç¤º:', rooms.length, 'ä»¶');

            rooms.forEach(room => {
                const roomItem = document.createElement('div');
                roomItem.className = 'chat-item';
                roomItem.dataset.roomId = room.id;

                // æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ™‚åˆ»ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const lastActivityTime = room.lastActivityAt ? formatTime(new Date(room.lastActivityAt)) : '';

                // ãƒ«ãƒ¼ãƒ èª¬æ˜ã®æœ€åˆã®1è¡Œã ã‘ã‚’å–å¾—ï¼ˆæœ€å¤§10æ–‡å­—ï¼‰
                let descriptionPreview = room.description || '';
                if (descriptionPreview) {
                    const firstLine = descriptionPreview.split('\n')[0];
                    descriptionPreview = firstLine.length > 10 ? firstLine.substring(0, 10) + '...' : firstLine;
                } else {
                    descriptionPreview = 'èª¬æ˜ãªã—';
                }

                // å‚åŠ äººæ•°ã®è¡¨ç¤º
                const memberCountText = `ãƒ¡ãƒ³ãƒãƒ¼${room.memberCount || 0}äºº`;

                // ãƒ«ãƒ¼ãƒ ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆé¢¨ï¼‰
                const roomIcon = '<div class="chat-avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><i class="fas fa-users"></i></div>';

                roomItem.innerHTML = `
                    ${roomIcon}
                    <div class="chat-info" style="flex: 1;">
                        <div class="chat-name-row">
                            <span class="chat-name">${escapeHtml(room.name)} <span style="font-size: 0.85em; color: #888;">(${memberCountText})</span></span>
                            <span class="chat-time">${lastActivityTime}</span>
                        </div>
                        <div class="chat-message-preview">
                            ${escapeHtml(descriptionPreview)}
                        </div>
                    </div>
                    <button class="cancel-request-btn" data-room-id="${room.id}" data-room-name="${escapeHtml(room.name)}" style="margin-left: 10px; white-space: nowrap; background: #ffa500; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 500;">
                        æ‰¿èªå¾…ã¡
                    </button>
                `;

                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                const cancelBtn = roomItem.querySelector('.cancel-request-btn');
                cancelBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const roomId = cancelBtn.dataset.roomId;
                    const roomName = cancelBtn.dataset.roomName;

                    if (confirm(`ã€Œ${roomName}ã€ã¸ã®å‚åŠ ç”³è«‹ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹?`)) {
                        await cancelJoinRequest(roomId);
                    }
                });

                roomListContainer.appendChild(roomItem);
            });
        }

        // ç”³è«‹ãƒãƒƒã‚¸ã‚’æ›´æ–°
        function updateRequestBadge(count) {
            const badge = document.getElementById('requestBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // ãƒ«ãƒ¼ãƒ å‚åŠ ç”³è«‹ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        async function cancelJoinRequest(roomId) {
            try {
                console.log('ğŸš« ãƒ«ãƒ¼ãƒ å‚åŠ ç”³è«‹ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä¸­... roomId:', roomId);
                const response = await fetch(`/rooms/${roomId}/cancel-request`, {
                    method: 'DELETE',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('âŒ ç”³è«‹ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¤±æ•—:', response.status);
                    alert('ç”³è«‹ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    console.log('âœ… ç”³è«‹ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
                    alert(data.message || 'å‚åŠ ç”³è«‹ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');

                    // ç”³è«‹ä¸­ã®ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                    await loadRequestedRooms();
                } else {
                    console.error('âŒ ç”³è«‹ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¤±æ•—:', data.message);
                    alert(data.message || 'ç”³è«‹ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('âŒ ç”³è«‹ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¨ãƒ©ãƒ¼:', error);
                alert('ç”³è«‹ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // æ‰¿èªå¾…ã¡ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        async function loadPendingApprovals() {
            try {
                console.log('ğŸ“‹ æ‰¿èªå¾…ã¡ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const response = await fetch('/rooms/api/pending-approvals', {
                    credentials: 'same-origin',
                    cache: 'no-store',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    console.error('âŒ APIå‘¼ã³å‡ºã—å¤±æ•—:', response.status);
                    return;
                }

                const data = await response.json();

                if (!data.success) {
                    console.error('âŒ æ‰¿èªå¾…ã¡ä¸€è¦§å–å¾—å¤±æ•—:', data.message);
                    return;
                }

                const approvals = data.approvals || [];
                console.log('âœ… æ‰¿èªå¾…ã¡ä¸€è¦§å–å¾—:', approvals.length, 'ä»¶');

                displayApprovalsList(approvals);
                updateApprovalBadge(approvals.length);
            } catch (error) {
                console.error('âŒ æ‰¿èªå¾…ã¡ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // æ‰¿èªå¾…ã¡ä¸€è¦§ã‚’è¡¨ç¤º
        function displayApprovalsList(approvals) {
            const approvalsTab = document.getElementById('approvals-tab');
            const roomListContainer = approvalsTab.querySelector('.room-list');
            const noRoomsElement = roomListContainer.querySelector('.no-chats');

            if (!roomListContainer) {
                console.error('âŒ æ‰¿èªå¾…ã¡ãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            // æ—¢å­˜ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤
            const existingItems = roomListContainer.querySelectorAll('.chat-item');
            existingItems.forEach(item => item.remove());

            if (approvals.length === 0) {
                if (noRoomsElement) {
                    noRoomsElement.style.display = 'block';
                }
                console.log('ğŸ“‹ æ‰¿èªå¾…ã¡ãªã—');
                return;
            }

            if (noRoomsElement) {
                noRoomsElement.style.display = 'none';
            }

            console.log('ğŸ“‹ æ‰¿èªå¾…ã¡ã‚’è¡¨ç¤º:', approvals.length, 'ä»¶');

            approvals.forEach(approval => {
                const approvalItem = document.createElement('div');
                approvalItem.className = 'chat-item';
                approvalItem.dataset.requestId = approval.requestId;

                // è‡ªå·±ç´¹ä»‹æ–‡ã®æœ€åˆã®1è¡Œã‚’å–å¾—ï¼ˆæœ€å¤§10æ–‡å­—ï¼‰
                let bioPreview = approval.bio || '';
                if (bioPreview) {
                    const firstLine = bioPreview.split('\n')[0];
                    bioPreview = firstLine.length > 10 ? firstLine.substring(0, 10) + '...' : firstLine;
                } else {
                    bioPreview = 'è‡ªå·±ç´¹ä»‹ãªã—';
                }

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ãƒã‚¿ãƒ¼
                const avatarUrl = approval.avatarUrl || '/images/default-avatar.png';
                const userAvatar = `<div class="chat-avatar"><img src="${escapeHtml(avatarUrl)}" alt="avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"></div>`;

                approvalItem.innerHTML = `
                    ${userAvatar}
                    <div class="chat-info" style="flex: 1;">
                        <div class="chat-name-row">
                            <span class="chat-name">${escapeHtml(approval.displayName)}</span>
                            <span class="chat-time" style="font-size: 0.75rem; color: #888;">${escapeHtml(approval.roomName)}</span>
                        </div>
                        <div class="chat-message-preview">
                            ${escapeHtml(bioPreview)}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-left: 10px;">
                        <button class="approve-btn" data-room-id="${approval.roomId}" data-username="${escapeHtml(approval.username)}" style="white-space: nowrap; background: #4CAF50; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 500;">
                            æ‰¿èª
                        </button>
                        <button class="reject-btn" data-room-id="${approval.roomId}" data-username="${escapeHtml(approval.username)}" style="white-space: nowrap; background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 500;">
                            æ‹’å¦
                        </button>
                    </div>
                `;

                // æ‰¿èªãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                const approveBtn = approvalItem.querySelector('.approve-btn');
                approveBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const roomId = approveBtn.dataset.roomId;
                    const username = approveBtn.dataset.username;

                    if (confirm(`${approval.displayName}ã•ã‚“ã®ç”³è«‹ã‚’æ‰¿èªã—ã¾ã™ã‹?`)) {
                        await approveJoinRequest(roomId, username);
                    }
                });

                // æ‹’å¦ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                const rejectBtn = approvalItem.querySelector('.reject-btn');
                rejectBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const roomId = rejectBtn.dataset.roomId;
                    const username = rejectBtn.dataset.username;

                    if (confirm(`${approval.displayName}ã•ã‚“ã®ç”³è«‹ã‚’æ‹’å¦ã—ã¾ã™ã‹?`)) {
                        await rejectJoinRequest(roomId, username);
                    }
                });

                roomListContainer.appendChild(approvalItem);
            });
        }

        // æ‰¿èªãƒãƒƒã‚¸ã‚’æ›´æ–°
        function updateApprovalBadge(count) {
            const badge = document.getElementById('approvalBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // å‚åŠ ç”³è«‹ã‚’æ‰¿èª
        async function approveJoinRequest(roomId, username) {
            try {
                console.log('âœ… å‚åŠ ç”³è«‹ã‚’æ‰¿èªä¸­... roomId:', roomId, 'username:', username);
                const response = await fetch(`/rooms/${roomId}/approve-request?username=${encodeURIComponent(username)}`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('âŒ æ‰¿èªå¤±æ•—:', response.status);
                    alert('æ‰¿èªã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    console.log('âœ… ç”³è«‹ã‚’æ‰¿èªã—ã¾ã—ãŸ');
                    alert(data.message || 'å‚åŠ ç”³è«‹ã‚’æ‰¿èªã—ã¾ã—ãŸ');

                    // æ‰¿èªå¾…ã¡ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                    await loadPendingApprovals();
                } else {
                    console.error('âŒ æ‰¿èªå¤±æ•—:', data.message);
                    alert(data.message || 'æ‰¿èªã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('âŒ æ‰¿èªã‚¨ãƒ©ãƒ¼:', error);
                alert('æ‰¿èªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // å‚åŠ ç”³è«‹ã‚’æ‹’å¦
        async function rejectJoinRequest(roomId, username) {
            try {
                console.log('âŒ å‚åŠ ç”³è«‹ã‚’æ‹’å¦ä¸­... roomId:', roomId, 'username:', username);
                const response = await fetch(`/rooms/${roomId}/reject-request?username=${encodeURIComponent(username)}`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('âŒ æ‹’å¦å¤±æ•—:', response.status);
                    alert('æ‹’å¦ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    console.log('âœ… ç”³è«‹ã‚’æ‹’å¦ã—ã¾ã—ãŸ');
                    alert(data.message || 'å‚åŠ ç”³è«‹ã‚’æ‹’å¦ã—ã¾ã—ãŸ');

                    // æ‰¿èªå¾…ã¡ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                    await loadPendingApprovals();
                } else {
                    console.error('âŒ æ‹’å¦å¤±æ•—:', data.message);
                    alert(data.message || 'æ‹’å¦ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('âŒ æ‹’å¦ã‚¨ãƒ©ãƒ¼:', error);
                alert('æ‹’å¦ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // å‚åŠ å¯èƒ½ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºï¼ˆç”³è«‹ãƒœã‚¿ãƒ³ä»˜ãï¼‰
        function displayAvailableRoomList(rooms, tabId) {
            const tabElement = document.getElementById(tabId);
            const roomListContainer = tabElement.querySelector('.room-list');
            const noRoomsElement = roomListContainer.querySelector('.no-chats');

            if (!roomListContainer) {
                console.error('âŒ ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            // æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤
            const existingItems = roomListContainer.querySelectorAll('.chat-item');
            existingItems.forEach(item => item.remove());

            if (rooms.length === 0) {
                if (noRoomsElement) {
                    noRoomsElement.style.display = 'block';
                }
                console.log('ğŸ“‹ å‚åŠ å¯èƒ½ãªãƒ«ãƒ¼ãƒ ãªã—');
                return;
            }

            if (noRoomsElement) {
                noRoomsElement.style.display = 'none';
            }

            console.log('ğŸ“‹ å‚åŠ å¯èƒ½ãªãƒ«ãƒ¼ãƒ ã‚’è¡¨ç¤º:', rooms.length, 'ä»¶');

            rooms.forEach(room => {
                const roomItem = document.createElement('div');
                roomItem.className = 'chat-item';
                roomItem.dataset.roomId = room.id;

                // æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ™‚åˆ»ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const lastActivityTime = room.lastActivityAt ? formatTime(new Date(room.lastActivityAt)) : '';

                // ãƒ«ãƒ¼ãƒ èª¬æ˜ã®æœ€åˆã®1è¡Œã ã‘ã‚’å–å¾—ï¼ˆæœ€å¤§10æ–‡å­—ï¼‰
                let descriptionPreview = room.description || '';
                if (descriptionPreview) {
                    const firstLine = descriptionPreview.split('\n')[0];
                    descriptionPreview = firstLine.length > 10 ? firstLine.substring(0, 10) + '...' : firstLine;
                } else {
                    descriptionPreview = 'èª¬æ˜ãªã—';
                }

                // å‚åŠ äººæ•°ã®è¡¨ç¤º
                const memberCountText = `ãƒ¡ãƒ³ãƒãƒ¼${room.memberCount || 0}äºº`;

                // ãƒ«ãƒ¼ãƒ ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆé¢¨ï¼‰
                const roomIcon = '<div class="chat-avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><i class="fas fa-users"></i></div>';

                // æ—¢ã«ç”³è«‹ä¸­ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
                const isRequested = window.requestedRoomIds && window.requestedRoomIds.has(room.id);
                const buttonClass = isRequested ? 'btn btn-sm btn-secondary room-join-btn' : 'btn btn-sm btn-primary room-join-btn';
                const buttonIcon = isRequested ? '<i class="fas fa-clock"></i> ç”³è«‹ä¸­' : '<i class="fas fa-sign-in-alt"></i> ç”³è«‹';
                const buttonDisabled = isRequested ? 'disabled' : '';

                roomItem.innerHTML = `
                    ${roomIcon}
                    <div class="chat-info" style="flex: 1;">
                        <div class="chat-name-row">
                            <span class="chat-name">${escapeHtml(room.name)} <span style="font-size: 0.85em; color: #888;">(${memberCountText})</span></span>
                            <span class="chat-time">${lastActivityTime}</span>
                        </div>
                        <div class="chat-message-preview">${escapeHtml(descriptionPreview)}</div>
                    </div>
                    <button class="${buttonClass}" data-room-id="${room.id}" style="margin-left: 10px; white-space: nowrap;" ${buttonDisabled}>
                        ${buttonIcon}
                    </button>
                `;

                // ç”³è«‹ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç”³è«‹ä¸­ã§ãªã„å ´åˆã®ã¿ï¼‰
                const joinBtn = roomItem.querySelector('.room-join-btn');
                if (!isRequested) {
                    joinBtn.addEventListener('click', async (e) => {
                        e.stopPropagation(); // è¦ªè¦ç´ ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’é˜²æ­¢
                        await requestJoinRoom(room.id, joinBtn);
                    });
                }

                roomListContainer.appendChild(roomItem);
            });
        }

        // ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºï¼ˆå‚åŠ ä¸­ã‚¿ãƒ–ç”¨ï¼‰
        function displayRoomList(rooms, tabId) {
            const tabElement = document.getElementById(tabId);
            const roomListContainer = tabElement.querySelector('.room-list');
            const noRoomsElement = roomListContainer.querySelector('.no-chats');

            if (!roomListContainer) {
                console.error('âŒ ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            // æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—ã‚³ãƒ³ãƒ†ãƒŠã‚‚å«ã‚€ï¼‰
            const existingItems = roomListContainer.querySelectorAll('.chat-item, .swipe-container');
            existingItems.forEach(item => item.remove());

            if (rooms.length === 0) {
                if (noRoomsElement) {
                    noRoomsElement.style.display = 'block';
                }
                console.log('ğŸ“‹ ãƒ«ãƒ¼ãƒ ãªã—');
                return;
            }

            if (noRoomsElement) {
                noRoomsElement.style.display = 'none';
            }

            console.log('ğŸ“‹ ãƒ«ãƒ¼ãƒ ã‚’è¡¨ç¤º:', rooms.length, 'ä»¶');

            const currentUsername = window.currentUser || '';

            rooms.forEach(room => {
                // ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ (ID=1)ã¯ã‚¹ãƒ¯ã‚¤ãƒ—ä¸å¯
                const isMainRoom = room.id === 1;
                const isCreator = room.createdByUsername === currentUsername;

                // æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ™‚åˆ»ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const lastActivityTime = room.lastActivityAt ? formatTime(new Date(room.lastActivityAt)) : '';

                // ãƒ«ãƒ¼ãƒ èª¬æ˜ã®æœ€åˆã®1è¡Œã ã‘ã‚’å–å¾—ï¼ˆæœ€å¤§10æ–‡å­—ï¼‰
                let descriptionPreview = room.description || '';
                if (descriptionPreview) {
                    const firstLine = descriptionPreview.split('\n')[0];
                    descriptionPreview = firstLine.length > 10 ? firstLine.substring(0, 10) + '...' : firstLine;
                } else {
                    descriptionPreview = 'èª¬æ˜ãªã—';
                }

                // å‚åŠ äººæ•°ã®è¡¨ç¤º
                const memberCountText = `ãƒ¡ãƒ³ãƒãƒ¼${room.memberCount || 0}äºº`;

                // ãƒ«ãƒ¼ãƒ ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆé¢¨ï¼‰
                const roomIcon = '<div class="chat-avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><i class="fas fa-users"></i></div>';

                if (isMainRoom) {
                    // ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ ã¯ã‚¹ãƒ¯ã‚¤ãƒ—ãªã—
                    const roomItem = document.createElement('div');
                    roomItem.className = 'chat-item';
                    roomItem.dataset.roomId = room.id;
                    roomItem.innerHTML = `
                        ${roomIcon}
                        <div class="chat-info">
                            <div class="chat-name-row">
                                <span class="chat-name">${escapeHtml(room.name)} <span style="font-size: 0.85em; color: #888;">(${memberCountText})</span></span>
                                <span class="chat-time">${lastActivityTime}</span>
                            </div>
                            <div class="chat-message-preview">${escapeHtml(descriptionPreview)}</div>
                        </div>
                    `;
                    roomItem.addEventListener('click', () => openRoomChat(room));
                    roomListContainer.appendChild(roomItem);
                } else {
                    // ã‚¹ãƒ¯ã‚¤ãƒ—å¯èƒ½ãªã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
                    const swipeContainer = document.createElement('div');
                    swipeContainer.className = 'swipe-container';
                    swipeContainer.dataset.roomId = room.id;
                    swipeContainer.dataset.roomName = room.name;
                    swipeContainer.dataset.isCreator = isCreator ? 'true' : 'false';

                    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆé€€å®¤ or è§£æ•£ï¼‰
                    const actionBtn = isCreator
                        ? `<button class="swipe-action-btn dissolve-btn" data-room-id="${room.id}">
                               <i class="fas fa-trash-alt"></i>è§£æ•£
                           </button>`
                        : `<button class="swipe-action-btn leave-btn" data-room-id="${room.id}">
                               <i class="fas fa-sign-out-alt"></i>é€€å®¤
                           </button>`;

                    swipeContainer.innerHTML = `
                        <div class="swipe-actions">
                            ${actionBtn}
                        </div>
                        <div class="swipe-content">
                            ${roomIcon}
                            <div class="chat-info">
                                <div class="chat-name-row">
                                    <span class="chat-name">${escapeHtml(room.name)} <span style="font-size: 0.85em; color: #888;">(${memberCountText})</span></span>
                                    <span class="chat-time">${lastActivityTime}</span>
                                </div>
                                <div class="chat-message-preview">${escapeHtml(descriptionPreview)}</div>
                            </div>
                        </div>
                    `;

                    // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚¯ãƒªãƒƒã‚¯ã§ãƒ«ãƒ¼ãƒ ã‚’é–‹ã
                    const swipeContent = swipeContainer.querySelector('.swipe-content');
                    swipeContent.addEventListener('click', (e) => {
                        // ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã§ãªã‘ã‚Œã°ãƒ«ãƒ¼ãƒ ã‚’é–‹ã
                        if (!swipeContainer.classList.contains('swiped')) {
                            openRoomChat(room);
                        }
                    });

                    // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
                    setupSwipeEvents(swipeContainer);

                    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                    const actionButton = swipeContainer.querySelector('.swipe-action-btn');
                    actionButton.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const roomId = parseInt(actionButton.dataset.roomId);
                        const roomName = swipeContainer.dataset.roomName;
                        const isCreatorRoom = swipeContainer.dataset.isCreator === 'true';

                        if (isCreatorRoom) {
                            // è§£æ•£ç¢ºèª
                            if (confirm(`ã€Œ${roomName}ã€ã‚’è§£æ•£ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                                await dissolveRoom(roomId);
                            }
                        } else {
                            // é€€å®¤ç¢ºèª
                            if (confirm(`ã€Œ${roomName}ã€ã‹ã‚‰é€€å®¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                                await leaveRoom(roomId);
                            }
                        }
                    });

                    roomListContainer.appendChild(swipeContainer);
                }
            });
        }

        // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupSwipeEvents(container) {
            let startX = 0;
            let currentX = 0;
            let isDragging = false;
            const swipeContent = container.querySelector('.swipe-content');
            const threshold = 50; // ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¤å®šã®é–¾å€¤

            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
            container.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                currentX = startX; // ã‚¿ãƒƒãƒ—æ™‚ã«currentXã‚‚åˆæœŸåŒ–ï¼ˆã‚¿ãƒƒãƒ—ã§ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¤å®šã•ã‚Œãªã„ã‚ˆã†ã«ï¼‰
                isDragging = true;
                swipeContent.style.transition = 'none';
            }, { passive: true });

            container.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                currentX = e.touches[0].clientX;
                const diff = startX - currentX;

                // ã‚¹ãƒ¯ã‚¤ãƒ—é–‹å§‹æ™‚ã«swipingã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                if (diff > 5) {
                    container.classList.add('swiping');
                }

                // å·¦æ–¹å‘ã®ã¿ã‚¹ãƒ¯ã‚¤ãƒ—å¯èƒ½ï¼ˆ-80pxã¾ã§ï¼‰
                if (diff > 0) {
                    const translateX = Math.min(diff, 80);
                    swipeContent.style.transform = `translateX(-${translateX}px)`;
                } else if (container.classList.contains('swiped')) {
                    // é–‰ã˜ã‚‹æ–¹å‘ã®ã‚¹ãƒ¯ã‚¤ãƒ—
                    const translateX = Math.max(80 + diff, 0);
                    swipeContent.style.transform = `translateX(-${translateX}px)`;
                }
            }, { passive: true });

            container.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;
                swipeContent.style.transition = 'transform 0.3s ease';
                container.classList.remove('swiping');

                const diff = startX - currentX;

                if (container.classList.contains('swiped')) {
                    // æ—¢ã«é–‹ã„ã¦ã„ã‚‹å ´åˆ
                    if (diff < -threshold) {
                        // é–‰ã˜ã‚‹
                        container.classList.remove('swiped');
                        swipeContent.style.transform = 'translateX(0)';
                    } else {
                        // é–‹ã„ãŸã¾ã¾ã«ã™ã‚‹
                        swipeContent.style.transform = 'translateX(-80px)';
                    }
                } else {
                    // é–‰ã˜ã¦ã„ã‚‹å ´åˆ
                    if (diff > threshold) {
                        // é–‹ã
                        container.classList.add('swiped');
                        swipeContent.style.transform = 'translateX(-80px)';
                        // ä»–ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã‚³ãƒ³ãƒ†ãƒŠã‚’é–‰ã˜ã‚‹
                        closeOtherSwipeContainers(container);
                    } else {
                        // é–‰ã˜ãŸã¾ã¾ã«ã™ã‚‹
                        swipeContent.style.transform = 'translateX(0)';
                    }
                }
            });

            // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆPCå¯¾å¿œï¼‰
            container.addEventListener('mousedown', (e) => {
                startX = e.clientX;
                currentX = startX; // ã‚¯ãƒªãƒƒã‚¯æ™‚ã«currentXã‚‚åˆæœŸåŒ–
                isDragging = true;
                swipeContent.style.transition = 'none';
            });

            container.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                currentX = e.clientX;
                const diff = startX - currentX;

                // ã‚¹ãƒ¯ã‚¤ãƒ—é–‹å§‹æ™‚ã«swipingã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                if (diff > 5) {
                    container.classList.add('swiping');
                }

                if (diff > 0) {
                    const translateX = Math.min(diff, 80);
                    swipeContent.style.transform = `translateX(-${translateX}px)`;
                } else if (container.classList.contains('swiped')) {
                    const translateX = Math.max(80 + diff, 0);
                    swipeContent.style.transform = `translateX(-${translateX}px)`;
                }
            });

            container.addEventListener('mouseup', (e) => {
                if (!isDragging) return;
                isDragging = false;
                swipeContent.style.transition = 'transform 0.3s ease';
                container.classList.remove('swiping');

                const diff = startX - currentX;

                if (container.classList.contains('swiped')) {
                    if (diff < -threshold) {
                        container.classList.remove('swiped');
                        swipeContent.style.transform = 'translateX(0)';
                    } else {
                        swipeContent.style.transform = 'translateX(-80px)';
                    }
                } else {
                    if (diff > threshold) {
                        container.classList.add('swiped');
                        swipeContent.style.transform = 'translateX(-80px)';
                        closeOtherSwipeContainers(container);
                    } else {
                        swipeContent.style.transform = 'translateX(0)';
                    }
                }
            });

            container.addEventListener('mouseleave', () => {
                if (isDragging) {
                    isDragging = false;
                    swipeContent.style.transition = 'transform 0.3s ease';
                    container.classList.remove('swiping');
                    if (!container.classList.contains('swiped')) {
                        swipeContent.style.transform = 'translateX(0)';
                    }
                }
            });
        }

        // ä»–ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã‚³ãƒ³ãƒ†ãƒŠã‚’é–‰ã˜ã‚‹
        function closeOtherSwipeContainers(currentContainer) {
            document.querySelectorAll('.swipe-container.swiped').forEach(container => {
                if (container !== currentContainer) {
                    container.classList.remove('swiped');
                    const content = container.querySelector('.swipe-content');
                    if (content) {
                        content.style.transform = 'translateX(0)';
                    }
                }
            });
        }

        // ãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å®¤
        async function leaveRoom(roomId) {
            try {
                const response = await fetch(`/rooms/${roomId}/leave`, {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                const data = await response.json();

                if (data.success) {
                    alert('ãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å®¤ã—ã¾ã—ãŸ');
                    loadJoinedRooms();
                    loadAvailableRooms();
                } else {
                    alert('é€€å®¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.message);
                }
            } catch (error) {
                console.error('âŒ é€€å®¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('é€€å®¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // ãƒ«ãƒ¼ãƒ ã‚’è§£æ•£
        async function dissolveRoom(roomId) {
            try {
                const response = await fetch(`/rooms/${roomId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });

                const data = await response.json();

                if (data.success) {
                    alert('ãƒ«ãƒ¼ãƒ ã‚’è§£æ•£ã—ã¾ã—ãŸ');
                    loadJoinedRooms();
                } else {
                    alert('è§£æ•£ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.message);
                }
            } catch (error) {
                console.error('âŒ è§£æ•£ã‚¨ãƒ©ãƒ¼:', error);
                alert('è§£æ•£ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // ãƒ«ãƒ¼ãƒ å‚åŠ ç”³è«‹
        async function requestJoinRoom(roomId, buttonElement) {
            try {
                console.log('ğŸ“ ãƒ«ãƒ¼ãƒ å‚åŠ ç”³è«‹:', roomId);

                // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦å‡¦ç†ä¸­è¡¨ç¤º
                if (buttonElement) {
                    buttonElement.disabled = true;
                    buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> é€ä¿¡ä¸­...';
                }

                const response = await fetch(`/rooms/${roomId}/request-join`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    console.log('âœ… å‚åŠ ç”³è«‹æˆåŠŸ');

                    // ãƒœã‚¿ãƒ³ã‚’ã€Œç”³è«‹ä¸­ã€è¡¨ç¤ºã«å¤‰æ›´
                    if (buttonElement) {
                        buttonElement.innerHTML = '<i class="fas fa-clock"></i> ç”³è«‹ä¸­';
                        buttonElement.classList.remove('btn-primary');
                        buttonElement.classList.add('btn-secondary');
                        buttonElement.disabled = true;
                    }

                    // ç”³è«‹ä¸­ã®ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                    await loadRequestedRooms();

                    alert('å‚åŠ ç”³è«‹ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ«ãƒ¼ãƒ ä½œæˆè€…ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚');
                } else {
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                    if (buttonElement) {
                        buttonElement.disabled = false;
                        buttonElement.innerHTML = '<i class="fas fa-sign-in-alt"></i> ç”³è«‹';
                    }
                    alert(data.message || 'å‚åŠ ç”³è«‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    console.error('âŒ å‚åŠ ç”³è«‹å¤±æ•—:', data.message);
                }
            } catch (error) {
                console.error('âŒ å‚åŠ ç”³è«‹ã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                if (buttonElement) {
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = '<i class="fas fa-sign-in-alt"></i> ç”³è«‹';
                }
                alert('å‚åŠ ç”³è«‹ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // WebSocketã‹ã‚‰ã®ãƒ«ãƒ¼ãƒ æ›´æ–°ã‚’å‡¦ç†
        function handleRoomUpdate(roomData) {
            console.log('ğŸ  ãƒ«ãƒ¼ãƒ æ›´æ–°å‡¦ç†:', roomData);

            if (roomData.type === 'room_created') {
                // æ–°ã—ã„ãƒ«ãƒ¼ãƒ ãŒä½œæˆã•ã‚ŒãŸ
                console.log('âœ¨ æ–°è¦ãƒ«ãƒ¼ãƒ ä½œæˆ:', roomData.room.name);

                // ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚¿ãƒ–ã‚’ç¢ºèªã—ã¦é©åˆ‡ãªãƒªã‚¹ãƒˆã‚’æ›´æ–°
                // å‚åŠ ä¸­ãƒ«ãƒ¼ãƒ ã¨å‚åŠ å¯èƒ½ãƒ«ãƒ¼ãƒ ã®ä¸¡æ–¹ã‚’å†èª­ã¿è¾¼ã¿
                loadJoinedRooms();
                loadAvailableRooms();
            } else if (roomData.type === 'room_updated') {
                // ãƒ«ãƒ¼ãƒ æƒ…å ±ãŒæ›´æ–°ã•ã‚ŒãŸ
                console.log('ğŸ”„ ãƒ«ãƒ¼ãƒ æ›´æ–°:', roomData.room.name);

                // ä¸¡æ–¹ã®ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                loadJoinedRooms();
                loadAvailableRooms();
            } else if (roomData.type === 'user_joined') {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ«ãƒ¼ãƒ ã«å‚åŠ ã—ãŸ
                console.log('ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼å‚åŠ :', roomData.username, 'ãŒãƒ«ãƒ¼ãƒ ', roomData.room.name, 'ã«å‚åŠ ');

                // è‡ªåˆ†ãŒå‚åŠ ã—ãŸå ´åˆã¯ä¸¡æ–¹ã®ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                loadJoinedRooms();
                loadAvailableRooms();
            } else if (roomData.type === 'user_left') {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å‡ºã—ãŸ
                console.log('ğŸ‘‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼é€€å‡º:', roomData.username, 'ãŒãƒ«ãƒ¼ãƒ ', roomData.room.name, 'ã‹ã‚‰é€€å‡º');

                // ãƒ¡ãƒ³ãƒãƒ¼æ•°ãŒæ›´æ–°ã•ã‚Œã‚‹ã®ã§ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                loadJoinedRooms();
                loadAvailableRooms();
            } else if (roomData.type === 'join_request') {
                // ãƒ«ãƒ¼ãƒ å‚åŠ ç”³è«‹ãŒã‚ã£ãŸ
                console.log('ğŸ“¥ å‚åŠ ç”³è«‹:', roomData.applicantDisplayName, 'ãŒ', roomData.roomName, 'ã«ç”³è«‹');

                // è‡ªåˆ†ãŒä½œæˆã—ãŸãƒ«ãƒ¼ãƒ ã¸ã®ç”³è«‹ã®å ´åˆã€æ‰¿èªã‚¿ãƒ–ã‚’æ›´æ–°
                const currentUsername = window.currentUser || '';
                if (roomData.creatorUsername === currentUsername) {
                    console.log('âœ… è‡ªåˆ†ãŒä½œæˆã—ãŸãƒ«ãƒ¼ãƒ ã¸ã®ç”³è«‹ - æ‰¿èªã‚¿ãƒ–ã‚’æ›´æ–°');
                    loadPendingApprovals();
                }
            } else if (roomData.type === 'request_approved') {
                // å‚åŠ ç”³è«‹ãŒæ‰¿èªã•ã‚ŒãŸ
                console.log('âœ… ç”³è«‹æ‰¿èª:', roomData.applicantUsername, 'ã®', roomData.roomName, 'ã¸ã®ç”³è«‹ãŒæ‰¿èª');

                const currentUsername = window.currentUser || '';
                console.log('ğŸ“Œ ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼:', currentUsername, ', ç”³è«‹è€…:', roomData.applicantUsername, ', ä½œæˆè€…:', roomData.creatorUsername);

                // ãƒ«ãƒ¼ãƒ ä½œæˆè€…ã®å ´åˆï¼šæ‰¿èªã‚¿ãƒ–ã‚’æ›´æ–°ï¼ˆè‡ªåˆ†ã§æ‰¿èªã—ãŸå ´åˆã¯æ—¢ã«æ›´æ–°æ¸ˆã¿ãªã®ã§ã‚¹ã‚­ãƒƒãƒ—å¯ï¼‰
                if (roomData.creatorUsername === currentUsername) {
                    console.log('ğŸ“‹ æ‰¿èªã‚¿ãƒ–ã‚’æ›´æ–°ï¼ˆä½œæˆè€…ï¼‰');
                    loadPendingApprovals();
                }

                // ç”³è«‹è€…ã®å ´åˆï¼šç”³è«‹ä¸­ã‹ã‚‰æ¶ˆãˆã€å‚åŠ å¯èƒ½ã‹ã‚‰æ¶ˆãˆã€å‚åŠ ä¸­ã«è¡¨ç¤º
                if (roomData.applicantUsername === currentUsername) {
                    console.log('ğŸ‰ è‡ªåˆ†ã®ç”³è«‹ãŒæ‰¿èªã•ã‚ŒãŸï¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã™');
                    // ç”³è«‹ä¸­ã®ãƒ«ãƒ¼ãƒ IDã‹ã‚‰å‰Šé™¤
                    if (window.requestedRoomIds) {
                        window.requestedRoomIds.delete(roomData.roomId);
                    }
                    // å„ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                    loadRequestedRooms();     // ç”³è«‹ä¸­ã‚¿ãƒ–ã‚’æ›´æ–°
                    loadAvailableRooms();     // å‚åŠ å¯èƒ½ã‚¿ãƒ–ã‚’æ›´æ–°
                    loadJoinedRooms();        // å‚åŠ ä¸­ã‚¿ãƒ–ã‚’æ›´æ–°
                    alert('ğŸ‰ ã€Œ' + roomData.roomName + 'ã€ã¸ã®å‚åŠ ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸï¼');
                }
            } else if (roomData.type === 'request_rejected') {
                // å‚åŠ ç”³è«‹ãŒæ‹’å¦ã•ã‚ŒãŸ
                console.log('âŒ ç”³è«‹æ‹’å¦:', roomData.applicantUsername, 'ã®', roomData.roomName, 'ã¸ã®ç”³è«‹ãŒæ‹’å¦');

                const currentUsername = window.currentUser || '';
                console.log('ğŸ“Œ ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼:', currentUsername, ', ç”³è«‹è€…:', roomData.applicantUsername, ', ä½œæˆè€…:', roomData.creatorUsername);

                // ãƒ«ãƒ¼ãƒ ä½œæˆè€…ã®å ´åˆï¼šæ‰¿èªã‚¿ãƒ–ã‚’æ›´æ–°
                if (roomData.creatorUsername === currentUsername) {
                    console.log('ğŸ“‹ æ‰¿èªã‚¿ãƒ–ã‚’æ›´æ–°ï¼ˆä½œæˆè€…ï¼‰');
                    loadPendingApprovals();
                }

                // ç”³è«‹è€…ã®å ´åˆï¼šç”³è«‹ä¸­ã‹ã‚‰æ¶ˆãˆã€å‚åŠ å¯èƒ½ã«æˆ»ã‚‹
                if (roomData.applicantUsername === currentUsername) {
                    console.log('ğŸ˜¢ è‡ªåˆ†ã®ç”³è«‹ãŒæ‹’å¦ã•ã‚ŒãŸï¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã™');
                    // ç”³è«‹ä¸­ã®ãƒ«ãƒ¼ãƒ IDã‹ã‚‰å‰Šé™¤
                    if (window.requestedRoomIds) {
                        window.requestedRoomIds.delete(roomData.roomId);
                    }
                    // å„ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                    loadRequestedRooms();     // ç”³è«‹ä¸­ã‚¿ãƒ–ã‚’æ›´æ–°
                    loadAvailableRooms();     // å‚åŠ å¯èƒ½ã‚¿ãƒ–ã‚’æ›´æ–°ï¼ˆç”³è«‹ãƒœã‚¿ãƒ³ã«æˆ»ã‚‹ï¼‰
                    alert('ğŸ˜¢ ã€Œ' + roomData.roomName + 'ã€ã¸ã®å‚åŠ ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
                }
            } else if (roomData.type === 'member_kicked') {
                // ãƒ¡ãƒ³ãƒãƒ¼ãŒé€€ä¼šã•ã›ã‚‰ã‚ŒãŸ
                console.log('ğŸ‘¢ ãƒ¡ãƒ³ãƒãƒ¼é€€ä¼š:', roomData.kickedUsername, 'ãŒ', roomData.roomName, 'ã‹ã‚‰é€€ä¼šã•ã›ã‚‰ã‚ŒãŸ');

                const currentUsername = window.currentUser || '';

                // è‡ªåˆ†ãŒé€€ä¼šã•ã›ã‚‰ã‚ŒãŸå ´åˆ
                if (roomData.kickedUsername === currentUsername) {
                    console.log('ğŸ˜¢ è‡ªåˆ†ãŒé€€ä¼šã•ã›ã‚‰ã‚ŒãŸï¼');

                    // ãƒ¡ãƒ³ãƒãƒ¼ãƒ‘ãƒãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯é–‰ã˜ã‚‹
                    const membersSection = document.getElementById('room-members-section');
                    if (membersSection && membersSection.style.display !== 'none') {
                        membersSection.style.display = 'none';
                        membersSection.classList.remove('active');
                    }

                    // ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’æ›´æ–°
                    loadJoinedRooms();
                    loadAvailableRooms();

                    // ã‚‚ã—ç¾åœ¨ãã®ãƒ«ãƒ¼ãƒ ã®ãƒãƒ£ãƒƒãƒˆç”»é¢ã«ã„ã‚‹å ´åˆã¯é€€å‡º
                    if (currentRoomId === roomData.roomId) {
                        alert('ğŸ˜¢ ã€Œ' + roomData.roomName + 'ã€ã‹ã‚‰é€€ä¼šã•ã›ã‚‰ã‚Œã¾ã—ãŸ');
                        // ãƒ«ãƒ¼ãƒ ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’é–‰ã˜ã¦ãƒ«ãƒ¼ãƒ ä¸€è¦§ã«æˆ»ã‚‹
                        document.getElementById('backFromRoomChatBtn').click();
                    } else {
                        alert('ğŸ˜¢ ã€Œ' + roomData.roomName + 'ã€ã‹ã‚‰é€€ä¼šã•ã›ã‚‰ã‚Œã¾ã—ãŸ');
                    }
                }

                // ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ç”»é¢ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯æ›´æ–°
                const membersSection = document.getElementById('room-members-section');
                if (membersSection && membersSection.style.display !== 'none' && currentRoomId === roomData.roomId) {
                    loadRoomMembers(roomData.roomId);
                }
            }
        }

        // ========================================
        // DMæ©Ÿèƒ½
        // ========================================
        
        let currentConversationId = null;
        let currentDMUser = null;
        
        // DMä¼šè©±ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
        async function loadDMConversations() {
            try {
                console.log('ğŸ“‹ DMä¼šè©±ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const response = await fetch('/api/dm/conversations');
                console.log('ğŸ“¡ API Response Status:', response.status);
                
                const data = await response.json();
                console.log('ğŸ“¦ API Response Data:', data);
                
                if (!data.success) {
                    console.error('âŒ DMä¼šè©±ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }
                
                const conversations = data.conversations;
                console.log('âœ… DMä¼šè©±ãƒªã‚¹ãƒˆå–å¾—:', conversations.length, 'ä»¶');
                console.log('ğŸ“‹ Conversations Detail:', conversations);
                
                displayConversationList(conversations);
            } catch (error) {
                console.error('âŒ DMä¼šè©±ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // DMä¼šè©±ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        function displayConversationList(conversations) {
            const chatListContainer = document.querySelector('#all-chat-tab .chat-list');
            const noChatsElement = chatListContainer.querySelector('.no-chats');
            
            if (!chatListContainer) {
                console.error('âŒ ãƒãƒ£ãƒƒãƒˆãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒƒãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤
            const existingItems = chatListContainer.querySelectorAll('.chat-item');
            existingItems.forEach(item => item.remove());
            
            if (conversations.length === 0) {
                // ä¼šè©±ãŒãªã„å ´åˆã¯ã€Œãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€ã‚’è¡¨ç¤º
                if (noChatsElement) {
                    noChatsElement.style.display = 'flex';
                }
                console.log('ğŸ“‹ DMä¼šè©±ãªã—');
                return;
            }
            
            // ä¼šè©±ãŒã‚ã‚‹å ´åˆã¯ã€Œãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€ã‚’éè¡¨ç¤º
            if (noChatsElement) {
                noChatsElement.style.display = 'none';
            }
            
            console.log('ğŸ“‹ DMä¼šè©±ã‚’è¡¨ç¤º:', conversations.length, 'ä»¶');
            
            // ä¼šè©±ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
            conversations.forEach(conv => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.dataset.conversationId = conv.conversationId;
                chatItem.dataset.userId = conv.userId;
                
                // æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ™‚åˆ»ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const lastMessageTime = conv.lastMessageAt ? formatTime(new Date(conv.lastMessageAt)) : '';
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æœ€åˆã®1è¡Œã ã‘ã‚’å–å¾—ï¼ˆæœ€å¤§10æ–‡å­—ï¼‰
                let messagePreview = conv.lastMessage || '';
                const firstLine = messagePreview.split('\n')[0]; // æœ€åˆã®1è¡Œ
                const truncatedMessage = firstLine.length > 10 ? firstLine.substring(0, 10) + '...' : firstLine;
                
                // ã‚¢ãƒã‚¿ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«
                const avatarStyle = conv.avatarUrl 
                    ? `background-image: url(${conv.avatarUrl}); background-size: cover; background-position: center;` 
                    : '';
                
                chatItem.innerHTML = `
                    <div class="chat-avatar" style="${avatarStyle}">
                        ${!conv.avatarUrl ? '<i class="fas fa-user"></i>' : ''}
                    </div>
                    <div class="chat-content">
                        <div class="chat-top">
                            <span class="chat-name">${escapeHtml(conv.displayName || conv.username)}</span>
                            <span class="chat-time">${lastMessageTime}</span>
                        </div>
                        <div class="chat-bottom">
                            <p class="chat-message">${escapeHtml(truncatedMessage)}</p>
                            ${conv.unreadCount > 0 ? `<span class="chat-badge">${conv.unreadCount}</span>` : ''}
                        </div>
                    </div>
                `;
                
                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                chatItem.addEventListener('click', async () => {
                    await startConversationFromList(conv.conversationId, conv.userId, conv.displayName || conv.username, conv.avatarUrl);
                });
                
                chatListContainer.appendChild(chatItem);
            });
        }
        
        // æ™‚åˆ»ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            const hours = Math.floor(diff / 1000 / 60 / 60);
            
            if (hours < 1) {
                const minutes = Math.floor(diff / 1000 / 60);
                return minutes < 1 ? 'ãŸã£ãŸä»Š' : `${minutes}åˆ†å‰`;
            } else if (hours < 24) {
                return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            } else if (hours < 48) {
                return 'æ˜¨æ—¥';
            } else {
                return date.toLocaleDateString('ja-JP', { month: '2-digit', day: '2-digit' });
            }
        }
        
        // å‹é”ã®DMä¼šè©±ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
        async function loadFriendsDMConversations() {
            try {
                console.log('ğŸ“‹ å‹é”ã®DMä¼šè©±ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const response = await fetch('/api/dm/conversations/friends');
                console.log('ğŸ“¡ Friends API Response Status:', response.status);
                
                const data = await response.json();
                console.log('ğŸ“¦ Friends API Response Data:', data);
                
                if (!data.success) {
                    console.error('âŒ å‹é”ã®DMä¼šè©±ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }
                
                const conversations = data.conversations;
                console.log('âœ… å‹é”ã®DMä¼šè©±ãƒªã‚¹ãƒˆå–å¾—:', conversations.length, 'ä»¶');
                console.log('ğŸ“‹ Friends Conversations Detail:', conversations);
                
                displayFriendsConversationList(conversations);
            } catch (error) {
                console.error('âŒ å‹é”ã®DMä¼šè©±ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // å‹é”ã®DMä¼šè©±ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        function displayFriendsConversationList(conversations) {
            const chatListContainer = document.querySelector('#friends-chat-tab .chat-list');
            const noChatsElement = chatListContainer.querySelector('.no-chats');
            
            if (!chatListContainer) {
                console.error('âŒ å‹é”ãƒãƒ£ãƒƒãƒˆãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒƒãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤
            const existingItems = chatListContainer.querySelectorAll('.chat-item');
            existingItems.forEach(item => item.remove());
            
            if (conversations.length === 0) {
                // ä¼šè©±ãŒãªã„å ´åˆã¯ã€Œå‹é”ã¨ã®ãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€ã‚’è¡¨ç¤º
                if (noChatsElement) {
                    noChatsElement.style.display = 'flex';
                }
                console.log('ğŸ“‹ å‹é”ã®DMä¼šè©±ãªã—');
                return;
            }
            
            // ä¼šè©±ãŒã‚ã‚‹å ´åˆã¯ã€Œå‹é”ã¨ã®ãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€ã‚’éè¡¨ç¤º
            if (noChatsElement) {
                noChatsElement.style.display = 'none';
            }
            
            console.log('ğŸ“‹ å‹é”ã®DMä¼šè©±ã‚’è¡¨ç¤º:', conversations.length, 'ä»¶');
            
            // ä¼šè©±ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºï¼ˆdisplayConversationListã¨åŒã˜å‡¦ç†ï¼‰
            conversations.forEach(conv => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.dataset.conversationId = conv.conversationId;
                chatItem.dataset.userId = conv.userId;
                
                // æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ™‚åˆ»ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const lastMessageTime = conv.lastMessageAt ? formatTime(new Date(conv.lastMessageAt)) : '';
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æœ€åˆã®1è¡Œã ã‘ã‚’å–å¾—ï¼ˆæœ€å¤§10æ–‡å­—ï¼‰
                let messagePreview = conv.lastMessage || '';
                const firstLine = messagePreview.split('\n')[0]; // æœ€åˆã®1è¡Œ
                const truncatedMessage = firstLine.length > 10 ? firstLine.substring(0, 10) + '...' : firstLine;
                
                // ã‚¢ãƒã‚¿ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«
                const avatarStyle = conv.avatarUrl 
                    ? `background-image: url(${conv.avatarUrl}); background-size: cover; background-position: center;` 
                    : '';
                
                chatItem.innerHTML = `
                    <div class="chat-avatar" style="${avatarStyle}">
                        ${!conv.avatarUrl ? '<i class="fas fa-user"></i>' : ''}
                    </div>
                    <div class="chat-content">
                        <div class="chat-top">
                            <span class="chat-name">${escapeHtml(conv.displayName || conv.username)}</span>
                            <span class="chat-time">${lastMessageTime}</span>
                        </div>
                        <div class="chat-bottom">
                            <p class="chat-message">${escapeHtml(truncatedMessage)}</p>
                            ${conv.unreadCount > 0 ? `<span class="chat-badge">${conv.unreadCount}</span>` : ''}
                        </div>
                    </div>
                `;
                
                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                chatItem.addEventListener('click', async () => {
                    await startConversationFromList(conv.conversationId, conv.userId, conv.displayName || conv.username, conv.avatarUrl);
                });
                
                chatListContainer.appendChild(chatItem);
            });
        }
        
        // ä¼šè©±ãƒªã‚¹ãƒˆã‹ã‚‰DMã‚’é–‹å§‹
        async function startConversationFromList(conversationId, userId, displayName, avatarUrl) {
            currentConversationId = conversationId;
            currentDMUser = {
                userId: userId,
                username: displayName,
                displayName: displayName,
                avatarUrl: avatarUrl
            };
            await openDMScreen(conversationId);
        }
        
        // é–²è¦§ç”¨ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ã€Œãƒãƒ£ãƒƒãƒˆã€ãƒœã‚¿ãƒ³
        document.getElementById('btnStartChat').addEventListener('click', async function() {
            const viewedUserId = this.dataset.userId;
            if (!viewedUserId) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            try {
                console.log('ğŸš€ DMä¼šè©±ã‚’é–‹å§‹:', viewedUserId);
                
                const response = await fetch('/api/dm/conversations/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targetUserId: parseInt(viewedUserId) })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const conversation = data.conversation;
                    currentConversationId = conversation.conversationId;
                    currentDMUser = {
                        userId: conversation.userId,
                        username: conversation.username,
                        displayName: conversation.displayName,
                        avatarUrl: conversation.avatarUrl
                    };
                    await openDMScreen(currentConversationId);
                } else {
                    alert('DMã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('DMé–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                alert('DMã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });
        
        async function openDMScreen(conversationId) {
            try {
                const response = await fetch(`/api/dm/conversations/${conversationId}/messages`);
                const data = await response.json();
                
                if (!data.success) throw new Error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å–å¾—ã«å¤±æ•—');
                
                // ä¼šè©±IDã‚’æ˜ç¤ºçš„ã«æ•°å€¤ã¨ã—ã¦è¨­å®š
                currentConversationId = parseInt(conversationId);
                console.log('ğŸ”§ DMç”»é¢ã‚ªãƒ¼ãƒ—ãƒ³ - ä¼šè©±IDè¨­å®š:', currentConversationId);
                
                const dmHeader = document.querySelector('.dm-header .dm-user-info');
                const conversation = data.conversation;
                const avatarStyle = conversation.avatarUrl 
                    ? `background-image: url(${conversation.avatarUrl})` 
                    : '';
                dmHeader.innerHTML = `
                    <div class="dm-avatar" style="${avatarStyle}"></div>
                    <span class="dm-username">${conversation.displayName || conversation.username}</span>
                `;
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã§ç›¸æ‰‹ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«é·ç§»
                dmHeader.onclick = () => {
                    viewUserProfile(currentDMUser.userId);
                };
                
                displayDMMessages(data.messages);
                
                const sections = document.querySelectorAll('.app-section');
                sections.forEach(section => section.classList.remove('active'));
                document.getElementById('dm-section').style.display = 'block';
                document.getElementById('dm-section').classList.add('active');
                
                // ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
                const bottomNav = document.querySelector('.bottom-nav');
                if (bottomNav) {
                    bottomNav.style.display = 'none';
                }
                
                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆãƒãƒ£ãƒƒãƒˆãƒ»ãƒ•ã‚©ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ï¼‰ã‚’éè¡¨ç¤º
                const profileActions = document.getElementById('profileActions');
                if (profileActions) {
                    profileActions.style.display = 'none';
                }
                
                // æŠ•ç¨¿ãƒœã‚¿ãƒ³ã‚‚éè¡¨ç¤º
                const createPostBtn = document.getElementById('btnCreatePost');
                if (createPostBtn) {
                    createPostBtn.style.display = 'none';
                }
                
                console.log('âœ… DMç”»é¢ã‚’é–‹ãã¾ã—ãŸ - WebSocketæ¥ç¶šçŠ¶æ…‹:', isWebSocketConnected);
                
                // WebSocketãŒæ¥ç¶šã•ã‚Œã¦ã„ãªã„å ´åˆã¯æ¥ç¶šã‚’è©¦ã¿ã‚‹
                if (!isWebSocketConnected) {
                    console.warn('âš ï¸ WebSocketãŒæœªæ¥ç¶šã§ã™ã€‚å†æ¥ç¶šã‚’è©¦ã¿ã¾ã™...');
                    connectWebSocket();
                }
            } catch (error) {
                console.error('DMç”»é¢ã‚ªãƒ¼ãƒ—ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                alert('DMã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        function displayDMMessages(messages) {
            console.log('ğŸ“œ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã‚’è¡¨ç¤º:', messages.length, 'ä»¶');
            const messagesContainer = document.getElementById('dmMessages');
            messagesContainer.innerHTML = '';
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `dm-message ${msg.isOwn ? 'own' : 'other'}`;
                
                const time = new Date(msg.sentAt).toLocaleTimeString('ja-JP', { 
                    hour: '2-digit', minute: '2-digit' 
                });
                
                const avatarStyle = msg.senderAvatarUrl 
                    ? `background-image: url(${msg.senderAvatarUrl})` 
                    : '';
                
                messageDiv.innerHTML = `
                    ${!msg.isOwn ? `<div class="dm-message-avatar" style="${avatarStyle}"></div>` : ''}
                    <div class="dm-message-bubble">
                        <div class="dm-message-content">${escapeHtml(msg.content)}</div>
                        <div class="dm-message-time">${time}</div>
                    </div>
                    ${msg.isOwn ? `<div class="dm-message-avatar" style="${avatarStyle}"></div>` : ''}
                `;
                
                messagesContainer.appendChild(messageDiv);
            });
            
            scrollDMToBottom();
            console.log('âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã®è¡¨ç¤ºå®Œäº†');
        }
        
        document.getElementById('dmSendBtn').addEventListener('click', sendDM);
        document.getElementById('dmInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendDM();
            }
        });
        
        async function sendDM() {
            const input = document.getElementById('dmInput');
            const content = input.value.trim();
            
            console.log('ğŸ“¤ DMé€ä¿¡è©¦è¡Œ:', {
                content: content,
                conversationId: currentConversationId,
                connected: isWebSocketConnected
            });
            
            if (!content || !currentConversationId) {
                console.warn('âš ï¸ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©ºã¾ãŸã¯ä¼šè©±IDãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (stompClient && isWebSocketConnected) {
                const payload = {
                    conversationId: currentConversationId,
                    content: content
                };
                console.log('ğŸ“¨ WebSocketã§é€ä¿¡:', payload);
                stompClient.send('/app/dm.send', {}, JSON.stringify(payload));
                
                input.value = '';
                input.style.height = 'auto';
                console.log('âœ… DMãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å®Œäº†');
            } else {
                console.error('âŒ WebSocketæœªæ¥ç¶š');
                alert('æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¦ã„ã¾ã™');
            }
        }
        
        function handleIncomingDM(dmData) {
            console.log('ğŸ“¨ DMå—ä¿¡:', dmData);
            console.log('ç¾åœ¨ã®ä¼šè©±ID:', currentConversationId, '(å‹:', typeof currentConversationId + ')');
            console.log('å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¼šè©±ID:', dmData.conversationId, '(å‹:', typeof dmData.conversationId + ')');
            console.log('ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:', currentUserId);
            console.log('é€ä¿¡è€…ID:', dmData.senderId);
            
            // ä¼šè©±IDã‚’æ˜ç¤ºçš„ã«æ•°å€¤ã¨ã—ã¦æ¯”è¼ƒ
            const receivedConversationId = parseInt(dmData.conversationId);
            const currentConvId = parseInt(currentConversationId);
            
            console.log('æ¯”è¼ƒ: ', receivedConversationId, '===', currentConvId, '?', receivedConversationId === currentConvId);
            
            // DMç”»é¢ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
            if (receivedConversationId === currentConvId) {
                console.log('âœ… ç¾åœ¨ã®ä¼šè©±ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™ã€‚è¡¨ç¤ºã—ã¾ã™ã€‚');
                const messagesContainer = document.getElementById('dmMessages');
                if (!messagesContainer) {
                    console.error('âŒ dmMessagesã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const messageDiv = document.createElement('div');
                const isOwn = parseInt(dmData.senderId) === parseInt(currentUserId);
                console.log('è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ï¼Ÿ:', isOwn);
                messageDiv.className = `dm-message ${isOwn ? 'own' : 'other'}`;
                
                const time = new Date(dmData.sentAt).toLocaleTimeString('ja-JP', { 
                    hour: '2-digit', minute: '2-digit' 
                });
                
                const avatarStyle = dmData.senderAvatarUrl 
                    ? `background-image: url(${dmData.senderAvatarUrl})` 
                    : '';
                
                messageDiv.innerHTML = `
                    ${!isOwn ? `<div class="dm-message-avatar" style="${avatarStyle}"></div>` : ''}
                    <div class="dm-message-bubble">
                        <div class="dm-message-content">${escapeHtml(dmData.content)}</div>
                        <div class="dm-message-time">${time}</div>
                    </div>
                    ${isOwn ? `<div class="dm-message-avatar" style="${avatarStyle}"></div>` : ''}
                `;
                
                messagesContainer.appendChild(messageDiv);
                scrollDMToBottom();
                console.log('ğŸ“ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’DOMã«è¿½åŠ ã—ã¾ã—ãŸ');
                
                if (!isOwn && stompClient && isWebSocketConnected) {
                    stompClient.send('/app/dm.read', {}, JSON.stringify({
                        conversationId: currentConversationId
                    }));
                }
            } else {
                console.log('âš ï¸ åˆ¥ã®ä¼šè©±ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™ã€‚DMç”»é¢ã«ã¯è¡¨ç¤ºã—ã¾ã›ã‚“ã€‚');
            }
            
            // ãƒãƒ£ãƒƒãƒˆç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ä¼šè©±ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
            const chatSection = document.getElementById('chat-section');
            if (chatSection && chatSection.classList.contains('active')) {
                console.log('ğŸ”„ ãƒãƒ£ãƒƒãƒˆç”»é¢ãŒè¡¨ç¤ºä¸­ãªã®ã§ä¼šè©±ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã™');
                loadDMConversations();
            }
        }
        
        function handleDMReadNotification(readData) {
            console.log('âœ… æ—¢èª­é€šçŸ¥:', readData);
        }
        
        function scrollDMToBottom() {
            const container = document.getElementById('dmMessagesContainer');
            container.scrollTop = container.scrollHeight;
        }
        
        document.getElementById('backFromDmBtn').addEventListener('click', function() {
            document.getElementById('dm-section').style.display = 'none';
            document.getElementById('dm-section').classList.remove('active');
            
            const sections = document.querySelectorAll('.app-section');
            sections.forEach(section => section.classList.remove('active'));
            document.getElementById('home-section').classList.add('active');
            
            // ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†è¡¨ç¤º
            const bottomNav = document.querySelector('.bottom-nav');
            if (bottomNav) {
                bottomNav.style.display = 'flex';
            }
            
            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã®ã¾ã¾ï¼ˆå…ƒã®ç”»é¢ã«æˆ»ã‚‹ã ã‘ãªã®ã§ï¼‰
            const profileActions = document.getElementById('profileActions');
            if (profileActions) {
                profileActions.style.display = 'none';
            }
            
            // æŠ•ç¨¿ãƒœã‚¿ãƒ³ã‚’å†è¡¨ç¤º
            const createPostBtn = document.getElementById('btnCreatePost');
            if (createPostBtn) {
                createPostBtn.style.display = 'flex';
            }
            
            currentConversationId = null;
            currentDMUser = null;
        });

        // ========================================
        // ãƒ«ãƒ¼ãƒ ãƒãƒ£ãƒƒãƒˆé–¢é€£
        // ========================================

        let currentRoomId = null;
        let roomStompClient = null;
        let roomSubscription = null;

        // ãƒ«ãƒ¼ãƒ ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’é–‹ã
        function openRoomChat(room) {
            console.log('ğŸšª ãƒ«ãƒ¼ãƒ ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’é–‹ã:', room);

            currentRoomId = room.id;

            // ãƒ«ãƒ¼ãƒ ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’è¡¨ç¤º
            const sections = document.querySelectorAll('.app-section');
            sections.forEach(section => section.classList.remove('active'));

            const roomChatSection = document.getElementById('room-chat-section');
            roomChatSection.style.display = 'block';
            roomChatSection.classList.add('active');

            // ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã‚’è¨­å®š
            document.getElementById('roomChatName').textContent = room.name;
            document.getElementById('roomChatMemberCount').textContent = `ãƒ¡ãƒ³ãƒãƒ¼${room.memberCount || 0}äºº`;

            // ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
            const bottomNav = document.querySelector('.bottom-nav');
            if (bottomNav) {
                bottomNav.style.display = 'none';
            }

            // æŠ•ç¨¿ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            const createPostBtn = document.getElementById('btnCreatePost');
            if (createPostBtn) {
                createPostBtn.style.display = 'none';
            }

            // ãƒ«ãƒ¼ãƒ ä½œæˆãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            const btnCreateRoom = document.getElementById('btnCreateRoom');
            if (btnCreateRoom) {
                btnCreateRoom.style.display = 'none';
            }

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('roomMessages').innerHTML = '';
            document.getElementById('roomInput').value = '';

            // WebSocketæ¥ç¶šã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚€
            connectToRoomWebSocket(room.id);
            loadRoomMessages(room.id);
        }

        // ãƒ«ãƒ¼ãƒ ãƒãƒ£ãƒƒãƒˆç”»é¢ã®æˆ»ã‚‹ãƒœã‚¿ãƒ³
        document.getElementById('backFromRoomChatBtn').addEventListener('click', function() {
            // WebSocketåˆ‡æ–­
            if (roomSubscription) {
                roomSubscription.unsubscribe();
                roomSubscription = null;
            }

            const roomChatSection = document.getElementById('room-chat-section');
            roomChatSection.style.display = 'none';
            roomChatSection.classList.remove('active');

            const sections = document.querySelectorAll('.app-section');
            sections.forEach(section => section.classList.remove('active'));

            // ãƒ«ãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«æˆ»ã‚‹
            const roomSection = document.getElementById('room-section');
            roomSection.classList.add('active');

            // ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†è¡¨ç¤º
            const bottomNav = document.querySelector('.bottom-nav');
            if (bottomNav) {
                bottomNav.style.display = 'flex';
            }

            // ãƒ«ãƒ¼ãƒ ä½œæˆãƒœã‚¿ãƒ³ã‚’å†è¡¨ç¤º
            const btnCreateRoom = document.getElementById('btnCreateRoom');
            if (btnCreateRoom) {
                btnCreateRoom.style.display = 'flex';
            }

            currentRoomId = null;
        });

        // ãƒ«ãƒ¼ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º
        document.getElementById('roomChatInfo').addEventListener('click', function() {
            if (currentRoomId && currentRoomId !== 1) {
                // ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ (ID=1)ä»¥å¤–ã®å ´åˆã®ã¿ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º
                showMembersPanel(currentRoomId);
            }
        });

        // ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ãƒ‘ãƒãƒ«ã®æˆ»ã‚‹ãƒœã‚¿ãƒ³
        document.getElementById('backFromMembersBtn').addEventListener('click', function() {
            const membersSection = document.getElementById('room-members-section');
            membersSection.style.display = 'none';
            membersSection.classList.remove('active');

            // ãƒ«ãƒ¼ãƒ ãƒãƒ£ãƒƒãƒˆç”»é¢ã«æˆ»ã‚‹
            const roomChatSection = document.getElementById('room-chat-section');
            roomChatSection.style.display = 'block';
            roomChatSection.classList.add('active');
        });

        // ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
        async function showMembersPanel(roomId) {
            // ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
            const roomChatSection = document.getElementById('room-chat-section');
            roomChatSection.style.display = 'none';
            roomChatSection.classList.remove('active');

            const membersSection = document.getElementById('room-members-section');
            membersSection.style.display = 'block';
            membersSection.classList.add('active');

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            document.getElementById('membersList').innerHTML = `
                <div class="members-loading">
                    <i class="fas fa-spinner"></i>
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            `;

            // ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’å–å¾—
            await loadRoomMembers(roomId);
        }

        // ãƒ«ãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        async function loadRoomMembers(roomId) {
            try {
                const response = await fetch(`/rooms/${roomId}/api/members`, {
                    credentials: 'same-origin',
                    cache: 'no-store',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    console.error('âŒ ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§å–å¾—å¤±æ•—:', response.status);
                    return;
                }

                const data = await response.json();

                if (!data.success) {
                    console.error('âŒ ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§å–å¾—å¤±æ•—:', data.message);
                    document.getElementById('membersList').innerHTML = `
                        <div class="members-empty">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>${data.message || 'ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ'}</p>
                        </div>
                    `;
                    return;
                }

                // ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã‚’æ›´æ–°
                document.getElementById('membersPanelRoomName').textContent = data.roomName;
                document.getElementById('membersPanelCount').textContent = `${data.memberCount}äººå‚åŠ ä¸­`;

                // ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º
                displayMembersList(data.members, data.isCreator, data.creatorUsername);

            } catch (error) {
                console.error('âŒ ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('membersList').innerHTML = `
                    <div class="members-empty">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>
                    </div>
                `;
            }
        }

        // ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º
        function displayMembersList(members, isCreator, creatorUsername) {
            const container = document.getElementById('membersList');

            if (!members || members.length === 0) {
                container.innerHTML = `
                    <div class="members-empty">
                        <i class="fas fa-users-slash"></i>
                        <p>ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“</p>
                    </div>
                `;
                return;
            }

            // ä½œæˆè€…ã‚’å…ˆé ­ã«ã‚½ãƒ¼ãƒˆ
            const sortedMembers = [...members].sort((a, b) => {
                if (a.isCreator) return -1;
                if (b.isCreator) return 1;
                return 0;
            });

            let html = '';
            for (const member of sortedMembers) {
                const avatarHtml = member.avatarUrl
                    ? `<img src="${member.avatarUrl}" alt="${escapeHtml(member.displayName)}">`
                    : `<i class="fas fa-user"></i>`;

                const creatorBadge = member.isCreator
                    ? `<span class="creator-badge">ä½œæˆè€…</span>`
                    : '';

                const bioText = member.shortBio || '';

                // é€€ä¼šãƒœã‚¿ãƒ³ï¼ˆä½œæˆè€…ãŒè¦‹ã¦ã„ã‚‹å ´åˆã®ã¿ã€ã‹ã¤è‡ªåˆ†è‡ªèº«ã¨ä½œæˆè€…ä»¥å¤–ï¼‰
                let kickButton = '';
                if (isCreator && !member.isCreator && member.username !== window.currentUser) {
                    kickButton = `
                        <div class="member-actions">
                            <button class="kick-btn" data-username="${escapeHtml(member.username)}" data-display-name="${escapeHtml(member.displayName)}">
                                é€€ä¼š
                            </button>
                        </div>
                    `;
                }

                html += `
                    <div class="member-item" data-username="${escapeHtml(member.username)}">
                        <div class="member-avatar">
                            ${avatarHtml}
                        </div>
                        <div class="member-info">
                            <div class="member-name">
                                ${escapeHtml(member.displayName)}
                                ${creatorBadge}
                            </div>
                            <div class="member-bio">${escapeHtml(bioText)}</div>
                        </div>
                        ${kickButton}
                    </div>
                `;
            }

            container.innerHTML = html;

            // é€€ä¼šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            container.querySelectorAll('.kick-btn').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    const username = this.dataset.username;
                    const displayName = this.dataset.displayName;
                    if (confirm(`${displayName}ã•ã‚“ã‚’ãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€ä¼šã•ã›ã¾ã™ã‹ï¼Ÿ`)) {
                        await kickMember(currentRoomId, username);
                    }
                });
            });
        }

        // ãƒ¡ãƒ³ãƒãƒ¼ã‚’é€€ä¼šã•ã›ã‚‹
        async function kickMember(roomId, username) {
            try {
                const response = await fetch(`/rooms/${roomId}/kick-member?username=${encodeURIComponent(username)}`, {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    // ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã¦ãƒ«ãƒ¼ãƒ ãƒãƒ£ãƒƒãƒˆã«æˆ»ã‚‹
                    const membersSection = document.getElementById('room-members-section');
                    membersSection.style.display = 'none';
                    membersSection.classList.remove('active');

                    const roomChatSection = document.getElementById('room-chat-section');
                    roomChatSection.style.display = 'block';
                    roomChatSection.classList.add('active');
                } else {
                    alert('é€€ä¼šå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.message);
                }
            } catch (error) {
                console.error('âŒ é€€ä¼šå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                alert('é€€ä¼šå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // ãƒ«ãƒ¼ãƒ ã®WebSocketã«æ¥ç¶š
        function connectToRoomWebSocket(roomId) {
            if (typeof SockJS === 'undefined' || typeof Stomp === 'undefined') {
                console.error('âŒ SockJS ã¾ãŸã¯ Stomp ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            // æ—¢å­˜ã®æ¥ç¶šãŒã‚ã‚Œã°åˆ‡æ–­
            if (roomSubscription) {
                roomSubscription.unsubscribe();
            }

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®stompClientã‚’ä½¿ç”¨ï¼ˆæ—¢ã«æ¥ç¶šæ¸ˆã¿ã¨ä»®å®šï¼‰
            if (window.stompClient && window.stompClient.connected) {
                roomSubscription = window.stompClient.subscribe(`/topic/room/${roomId}`, function(message) {
                    const chatMessage = JSON.parse(message.body);
                    displayRoomMessage(chatMessage);
                });
                console.log('âœ… ãƒ«ãƒ¼ãƒ ', roomId, 'ã®WebSocketã«æ¥ç¶šã—ã¾ã—ãŸ');
            } else {
                console.error('âŒ WebSocketãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
        }

        // ãƒ«ãƒ¼ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚€
        async function loadRoomMessages(roomId) {
            try {
                console.log('ğŸ“¨ ãƒ«ãƒ¼ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ä¸­...', roomId);
                const response = await fetch(`/api/messages/room/${roomId}`, {
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('âŒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¤±æ•—:', response.status);
                    return;
                }

                const messages = await response.json();
                console.log('âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—:', messages.length, 'ä»¶');

                const messagesContainer = document.getElementById('roomMessages');
                messagesContainer.innerHTML = '';

                messages.forEach(msg => {
                    displayRoomMessage(msg);
                });

                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«
                scrollRoomMessagesToBottom();
            } catch (error) {
                console.error('âŒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ«ãƒ¼ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        function displayRoomMessage(message) {
            const messagesContainer = document.getElementById('roomMessages');
            const messageDiv = document.createElement('div');

            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰ï¼‰
            const currentUsername = window.currentUser || '';
            const isOwnMessage = message.sender === currentUsername || message.username === currentUsername;

            messageDiv.className = isOwnMessage ? 'dm-message own' : 'dm-message other';

            const timestamp = message.timestamp || message.createdAt;
            const timeStr = timestamp ? formatTime(new Date(timestamp)) : '';
            const senderName = message.senderDisplayName || message.sender || message.username || 'ä¸æ˜';

            if (isOwnMessage) {
                messageDiv.innerHTML = `
                    <div class="dm-message-content own">
                        <div class="dm-message-text">${escapeHtml(message.content || message.message || '')}</div>
                        <div class="dm-message-time">${timeStr}</div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="dm-message-sender">${escapeHtml(senderName)}</div>
                    <div class="dm-message-content other">
                        <div class="dm-message-text">${escapeHtml(message.content || message.message || '')}</div>
                        <div class="dm-message-time">${timeStr}</div>
                    </div>
                `;
            }

            messagesContainer.appendChild(messageDiv);
        }

        // ãƒ«ãƒ¼ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        function scrollRoomMessagesToBottom() {
            const container = document.getElementById('roomMessagesContainer');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }

        // ãƒ«ãƒ¼ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        document.getElementById('roomSendBtn').addEventListener('click', function() {
            sendRoomMessage();
        });

        document.getElementById('roomInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendRoomMessage();
            }
        });

        function sendRoomMessage() {
            const input = document.getElementById('roomInput');
            const message = input.value.trim();

            if (!message || !currentRoomId) {
                return;
            }

            if (!window.stompClient || !window.stompClient.connected) {
                alert('WebSocketãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            const chatMessage = {
                roomId: currentRoomId,
                content: message,
                type: 'CHAT'
            };

            try {
                window.stompClient.send(`/app/chat.sendMessage/${currentRoomId}`, {}, JSON.stringify(chatMessage));
                input.value = '';

                // è‡ªå‹•ã§ã‚µã‚¤ã‚ºã‚’ãƒªã‚»ãƒƒãƒˆ
                input.style.height = 'auto';
            } catch (error) {
                console.error('âŒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
