<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, interactive-widget=resizes-visual-viewport">
    <title>チャットアプリ</title>
    
    <!-- PWA設定 -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/common.css(v=${@appVersion})}" rel="stylesheet">
    <link th:href="@{/css/main-app.css(v=${@appVersion})}" rel="stylesheet">
</head>
<body>
    <!-- メインコンテナ -->
    <div class="app-container"
         th:attr="data-current-user-id=${user != null ? user.id : ''}, data-current-username=${username != null ? username : ''}">
        
        <!-- ホーム画面 -->
        <section class="app-section active" id="home-section">
            <div class="section-content">
                <!-- ホームヘッダー -->
                <div class="home-header">
                    <button class="home-tab-btn active" data-home-tab="all">すべて</button>
                    <button class="home-tab-btn" data-home-tab="following">フォロー</button>
                </div>

                <!-- 成功メッセージ -->
                <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-1"></i>
                    <span th:text="${success}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- 投稿リスト -->
                <div class="posts-container">
                    <div th:if="${posts == null or posts.isEmpty()}" class="no-posts">
                        <i class="fas fa-inbox fa-3x mb-3 text-muted"></i>
                        <p class="text-muted">まだ投稿がありません</p>
                    </div>
                    
                    <div th:each="post : ${posts}" class="post-card">
                        <div class="post-header">
                            <div class="post-user-info">
                                <!-- プロフィール画像がある場合 -->
                                <div class="post-avatar user-profile-link" 
                                     th:if="${post.user.profile != null and post.user.profile.avatarUrl != null and !post.user.profile.avatarUrl.isEmpty()}"
                                     th:style="'background-image: url(' + ${post.user.profile.avatarUrl} + '); background-size: cover; background-position: center; cursor: pointer;'"
                                     th:attr="data-user-id=${post.user.id}, data-friend-code=${post.userFriendCode}">
                                </div>
                                <!-- デフォルトアイコン -->
                                <div class="post-avatar default-avatar user-profile-link" 
                                     th:if="${post.user.profile == null or post.user.profile.avatarUrl == null or post.user.profile.avatarUrl.isEmpty()}"
                                     th:attr="data-username=${post.user.username}, data-user-id=${post.user.id}, data-friend-code=${post.userFriendCode}"
                                     style="cursor: pointer;">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="post-user-details">
                                    <span class="post-username clickable-username user-profile-link" 
                                          th:text="${post.user.profile != null and post.user.profile.displayName != null and !post.user.profile.displayName.isEmpty() ? post.user.profile.displayName : post.user.username}"
                                          th:attr="data-user-id=${post.user.id}, data-friend-code=${post.userFriendCode}">ユーザー名</span>
                                    <span class="post-time" th:text="${#temporals.format(post.createdAt, 'yyyy年MM月dd日 HH:mm')}">投稿日時</span>
                                </div>
                            </div>
                        </div>
                        <div class="post-content">
                            <p th:text="${post.content}">投稿内容</p>
                            
                            <!-- メディア表示 -->
                            <div th:if="${post.mediaPath != null and !post.mediaPath.isEmpty()}" class="post-media-grid">
                                <div th:each="mediaUrl : ${#strings.arraySplit(post.mediaPath, ',')}" class="post-media-item">
                                    <!-- 画像の場合 -->
                                    <img th:if="${#strings.endsWith(mediaUrl, '.jpg') or #strings.endsWith(mediaUrl, '.jpeg') or #strings.endsWith(mediaUrl, '.png') or #strings.endsWith(mediaUrl, '.gif') or #strings.endsWith(mediaUrl, '.webp')}"
                                         th:src="${mediaUrl}" 
                                         alt="投稿画像"
                                         class="post-media-image"
                                         loading="lazy"
                                         onclick="openImageModal(this.src)">
                                    <!-- 動画の場合 -->
                                    <video th:if="${#strings.endsWith(mediaUrl, '.mp4') or #strings.endsWith(mediaUrl, '.webm') or #strings.endsWith(mediaUrl, '.mov')}"
                                           th:src="${mediaUrl}" 
                                           preload="metadata"
                                           controls
                                           class="post-media-video"></video>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- 投稿作成画面 -->
        <section class="app-section" id="create-post-section">
            <div class="section-content">
                <div class="create-post-header">
                    <button class="btn-back" id="btnBackFromPost">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h1>新規投稿</h1>
                    <div></div>
                </div>
                
                <form th:action="@{/home/post}" method="post" enctype="multipart/form-data" class="create-post-form" id="createPostForm">
                    <div class="form-group">
                        <label for="postContent" class="form-label">
                            <i class="fas fa-pen me-2"></i>投稿内容
                        </label>
                        <textarea id="postContent" name="content" class="form-textarea" 
                                  placeholder="今何してる？" 
                                  maxlength="1000" 
                                  rows="8"
                                  required></textarea>
                        <div class="char-counter-container">
                            <span class="char-counter" id="charCounter">0 / 1000</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="mediaUpload" class="form-label">
                            <i class="fas fa-image me-2"></i>写真・動画
                        </label>
                        <div class="upload-area" id="uploadArea">
                            <input type="file" id="mediaUpload" name="media" 
                                   accept="image/*,video/*" 
                                   multiple 
                                   class="file-input">
                            <label for="mediaUpload" class="upload-label">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                                <p class="mb-0">タップして写真・動画を選択</p>
                                <small class="text-muted">または、ここにドラッグ＆ドロップ</small>
                            </label>
                        </div>
                        <div class="preview-container" id="previewContainer"></div>
                    </div>
                    
                    <button type="submit" class="btn-submit-post">
                        <i class="fas fa-paper-plane me-2"></i>投稿する
                    </button>
                </form>
            </div>
        </section>
        
        <!-- ルーム画面 -->
        <section class="app-section" id="room-section">
            <div class="section-content">
                <div class="chat-list-header">
                    <button class="tab-btn active" data-tab="joined-rooms">参加中</button>
                    <button class="tab-btn" data-tab="available-rooms">参加可能</button>
                    <button class="tab-btn" id="btnRoomRequests">
                        申請
                        <span class="badge" id="requestBadge" style="display: none;">0</span>
                    </button>
                    <button class="tab-btn" id="btnRoomApprovals">
                        承認
                        <span class="badge" id="approvalBadge" style="display: none;">0</span>
                    </button>
                    <button class="tab-btn" id="btnRoomInvite">
                        招待
                        <span class="badge" id="inviteBadge" style="display: none;">0</span>
                    </button>
                </div>
                
                <!-- 参加中のルーム -->
                <div class="tab-content active" id="joined-rooms-tab">
                    <div class="chat-list room-list">
                        <div class="no-chats" style="display: none;">
                            <i class="fas fa-door-open"></i>
                            <p>参加中のルームがありません</p>
                        </div>
                    </div>
                </div>
                
                <!-- 参加可能なルーム -->
                <div class="tab-content" id="available-rooms-tab">
                    <div class="chat-list room-list">
                        <div class="no-chats" style="display: none;">
                            <i class="fas fa-door-open"></i>
                            <p>参加可能なルームがありません</p>
                        </div>
                    </div>
                </div>

                <!-- 申請中のルーム -->
                <div class="tab-content" id="requests-tab">
                    <div class="chat-list room-list">
                        <div class="no-chats" style="display: none;">
                            <i class="fas fa-inbox"></i>
                            <p>申請中のルームがありません</p>
                        </div>
                    </div>
                </div>

                <!-- 承認待ちのルーム -->
                <div class="tab-content" id="approvals-tab">
                    <div class="chat-list room-list">
                        <div class="no-chats" style="display: none;">
                            <i class="fas fa-user-check"></i>
                            <p>承認待ちのルームがありません</p>
                        </div>
                    </div>
                </div>

                <!-- 招待 -->
                <div class="tab-content" id="invite-tab">
                    <div class="chat-list room-list" id="invitations-list">
                        <div class="no-chats" style="display: none;">
                            <i class="fas fa-envelope-open"></i>
                            <p>招待がありません</p>
                        </div>
                    </div>
                </div>

                <!-- ルーム作成ボタン -->
                <button class="btn-create-room" id="btnCreateRoom">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </section>

        <!-- ルーム作成画面 -->
        <section class="app-section" id="create-room-section">
            <div class="section-content">
                <div class="create-post-header">
                    <button class="btn-back" id="btnBackFromRoom">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h1>ルーム作成</h1>
                    <div></div>
                </div>

                <form id="createRoomForm" class="create-post-form">
                    <div class="form-group">
                        <label for="roomName" class="form-label">
                            <i class="fas fa-tag me-2"></i>ルーム名
                        </label>
                        <input type="text" id="roomName" name="name" class="form-input"
                               placeholder="例: プログラミング雑談" required maxlength="100">
                        <small class="form-text">最大100文字まで</small>
                    </div>

                    <div class="form-group">
                        <label for="roomDescription" class="form-label">
                            <i class="fas fa-align-left me-2"></i>説明文
                        </label>
                        <textarea id="roomDescription" name="description" class="form-textarea"
                                  rows="3" placeholder="例: プログラミングに関する雑談や質問、情報共有の場です"
                                  maxlength="500"></textarea>
                        <small class="form-text">最大500文字まで（任意）</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-globe me-2"></i>公開設定
                        </label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="isPublic" value="true" checked>
                                <span><i class="fas fa-globe text-success me-1"></i>パブリック - 誰でも検索・参加可能</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="isPublic" value="false">
                                <span><i class="fas fa-lock text-info me-1"></i>プライベート - 招待されたユーザーのみ参加可能</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-user-plus me-2"></i>フレンドを招待（任意）
                        </label>
                        <div id="friendSelectionContainer" class="friend-selection-container">
                            <p class="loading-text">フレンドリストを読み込み中...</p>
                        </div>
                    </div>

                    <button type="submit" class="btn-submit">
                        <i class="fas fa-plus me-2"></i>ルームを作成
                    </button>
                </form>
            </div>
        </section>
        
        <!-- マッチ画面 -->
        <section class="app-section" id="match-section">
            <div class="section-content">
                <div class="match-header" id="matchHeader">
                    <button class="match-type-btn" data-match-type="nearby">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>近所</span>
                    </button>
                    <button class="match-type-btn" data-match-type="hobby">
                        <i class="fas fa-heart"></i>
                        <span>趣味</span>
                    </button>
                    <button class="match-type-btn" data-match-type="age">
                        <i class="fas fa-calendar-alt"></i>
                        <span>年齢</span>
                    </button>
                    <button class="match-type-btn" data-match-type="destiny">
                        <i class="fas fa-star"></i>
                        <span>運命</span>
                    </button>
                </div>
                <div class="match-content" id="matchContent">
                    <!-- カードスタック -->
                    <div class="swipe-card-stack" id="swipeCardStack">
                        <!-- JSで動的に生成 -->
                    </div>

                    <!-- 候補者なし表示 -->
                    <div class="swipe-empty" id="swipeEmpty" style="display: none;">
                        <i class="fas fa-search fa-3x" style="color: rgba(255,255,255,0.3); margin-bottom: 16px;"></i>
                        <p style="color: rgba(255,255,255,0.5);">候補者が見つかりませんでした</p>
                    </div>

                    <!-- ローディング -->
                    <div class="swipe-loading" id="swipeLoading" style="display: none;">
                        <i class="fas fa-spinner fa-spin fa-2x" style="color: rgba(255,255,255,0.5);"></i>
                    </div>

                    <!-- アクションボタン -->
                    <div class="swipe-actions" id="swipeActions" style="display: none;">
                        <button class="swipe-btn swipe-btn-skip" id="btnSwipeSkip" title="スキップ">
                            <i class="fas fa-times"></i>
                        </button>
                        <button class="swipe-btn swipe-btn-like" id="btnSwipeLike" title="いいね">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>
                </div>

                <!-- いいね一覧パネル（タブ切替で表示） -->
                <div class="match-like-panel" id="matchLikePanel" style="display: none;">
                    <div class="match-like-list" id="matchLikeList">
                        <!-- JSで動的に描画 -->
                    </div>
                </div>

                <!-- サブフッター -->
                <div class="match-sub-footer">
                    <button class="match-sub-tab active" data-like-tab="swipe">
                        <i class="fas fa-clone"></i>
                        <span>スワイプ</span>
                    </button>
                    <button class="match-sub-tab" data-like-tab="sent">
                        <i class="fas fa-paper-plane"></i>
                        <span>いいね</span>
                        <span class="match-badge" id="badgeLikeSent" style="display:none;">0</span>
                    </button>
                    <button class="match-sub-tab" data-like-tab="received">
                        <i class="fas fa-inbox"></i>
                        <span>もらった</span>
                        <span class="match-badge" id="badgeLikeReceived" style="display:none;">0</span>
                    </button>
                    <button class="match-sub-tab" data-like-tab="mutual">
                        <i class="fas fa-handshake"></i>
                        <span>マッチ</span>
                        <span class="match-badge" id="badgeLikeMutual" style="display:none;">0</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- チャット画面 -->
        <section class="app-section" id="chat-section">
            <div class="section-content">
                <div class="chat-list-header">
                    <div class="header-tabs">
                        <button class="tab-btn active" data-tab="all-chat">すべて</button>
                        <button class="tab-btn" data-tab="friends-chat">フレンド</button>
                    </div>
                </div>
                
                <!-- すべてのチャット -->
                <div class="tab-content active" id="all-chat-tab">
                    <div class="chat-list">
                        <div class="no-chats">
                            <i class="fas fa-comments fa-3x mb-3 text-muted"></i>
                            <p class="text-muted">チャットがありません</p>
                        </div>
                        
                        <!-- チャットアイテム例（動的に生成予定） -->
                        <!-- 
                        <div class="chat-item">
                            <div class="chat-avatar">
                                <img src="/images/avatar.png" alt="アバター">
                            </div>
                            <div class="chat-content">
                                <div class="chat-top">
                                    <span class="chat-name">ユーザー名</span>
                                    <span class="chat-time">09:38</span>
                                </div>
                                <div class="chat-bottom">
                                    <p class="chat-message">最新のメッセージがここに表示されます</p>
                                    <span class="chat-badge">1</span>
                                </div>
                            </div>
                        </div>
                        -->
                    </div>
                </div>
                
                <!-- フレンドのチャット -->
                <div class="tab-content" id="friends-chat-tab">
                    <div class="chat-list">
                        <div class="no-chats">
                            <i class="fas fa-user-friends fa-3x mb-3 text-muted"></i>
                            <p class="text-muted">フレンドとのチャットがありません</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- DM画面 -->
        <section class="app-section" id="dm-section" style="display: none;">
            <div class="section-content">
                <!-- DMヘッダー -->
                <div class="dm-header">
                    <button class="back-btn" id="backFromDmBtn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="dm-user-info" id="dmUserInfo" style="cursor: pointer;">
                        <div class="dm-avatar"></div>
                        <span class="dm-username"></span>
                    </div>
                </div>
                
                <!-- DMメッセージエリア -->
                <div class="dm-messages-container" id="dmMessagesContainer">
                    <div class="dm-messages" id="dmMessages">
                        <!-- メッセージがここに表示されます -->
                    </div>
                </div>
                
                <!-- DM入力エリア -->
                <div class="dm-input-area">
                    <textarea 
                        class="dm-input" 
                        id="dmInput" 
                        placeholder="メッセージを入力..." 
                        rows="1"></textarea>
                    <button class="dm-send-btn" id="dmSendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- ルームチャット画面 -->
        <section class="app-section" id="room-chat-section" style="display: none;">
            <div class="section-content">
                <!-- ルームチャットヘッダー -->
                <div class="dm-header">
                    <button class="back-btn" id="backFromRoomChatBtn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <input type="file" id="roomIconInput" accept="image/jpeg,image/png,image/gif" style="display: none;">
                    <div class="dm-user-info" id="roomChatInfo" style="cursor: pointer;" title="メンバー一覧を表示">
                        <div class="dm-avatar" id="roomChatAvatar">
                            <i class="fas fa-users"></i>
                        </div>
                        <span class="dm-username" id="roomChatName"></span>
                        <span style="font-size: 0.75rem; color: #6c757d;" id="roomChatMemberCount"></span>
                    </div>
                    <button class="room-invite-btn" id="roomInviteBtn" style="display: none;" title="フォロワーを招待">
                        <i class="fas fa-user-plus"></i>
                    </button>
                </div>

                <!-- ルームメッセージエリア -->
                <div class="dm-messages-container" id="roomMessagesContainer">
                    <div class="dm-messages" id="roomMessages">
                        <!-- メッセージがここに表示されます -->
                    </div>
                </div>

                <!-- ルーム入力エリア -->
                <div class="dm-input-area">
                    <textarea
                        class="dm-input"
                        id="roomInput"
                        placeholder="メッセージを入力..."
                        rows="1"></textarea>
                    <button class="dm-send-btn" id="roomSendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- ルームメンバー一覧パネル -->
        <section class="app-section" id="room-members-section" style="display: none;">
            <div class="section-content">
                <div class="dm-header">
                    <button class="back-btn" id="backFromMembersBtn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="dm-user-info">
                        <div class="dm-avatar">
                            <i class="fas fa-users"></i>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-start;">
                            <span class="dm-username" id="membersPanelRoomName">メンバー一覧</span>
                            <span style="font-size: 0.75rem; color: #6c757d;" id="membersPanelCount"></span>
                        </div>
                    </div>
                </div>
                <div class="members-list-container" style="padding: 1rem; overflow-y: auto; flex: 1;">
                    <div id="membersList" class="members-list">
                        <!-- メンバーがここに表示されます -->
                    </div>
                </div>
            </div>
        </section>

        <!-- ルーム追加招待画面 -->
        <section class="app-section" id="room-invite-section" style="display: none;">
            <div class="section-content">
                <div class="dm-header">
                    <button class="back-btn" id="backFromRoomInviteBtn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="dm-user-info">
                        <div class="dm-avatar">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-start;">
                            <span class="dm-username">フォロワーを招待</span>
                            <span style="font-size: 0.75rem; color: #6c757d;" id="inviteRoomName"></span>
                        </div>
                    </div>
                </div>
                <div class="members-list-container" style="padding: 1rem; overflow-y: auto; flex: 1;">
                    <div id="followerInviteList" class="members-list">
                        <!-- フォロワーがここに表示されます -->
                    </div>
                </div>
            </div>
        </section>

        <!-- マイページ画面 -->
        <section class="app-section" id="mypage-section">
            <div class="section-content">
                <!-- プロフィールセクション -->
                <div class="profile-section">
                    <!-- ハンバーガーメニューボタン -->
                    <button class="hamburger-btn" type="button" id="mypageMenuBtn">
                        <i class="fas fa-bars" style="font-size: 1.5rem;"></i>
                    </button>
                    <div class="profile-main">
                        <div class="profile-main-top">
                            <!-- アイコン -->
                            <div class="profile-avatar" 
                                 th:if="${profile != null and profile.avatarUrl != null and !profile.avatarUrl.isEmpty()}"
                                 th:style="'background-image: url(' + ${profile.avatarUrl} + '); background-size: cover; background-position: center;'">
                            </div>
                            <div class="profile-avatar default-avatar" 
                                 th:if="${profile == null or profile.avatarUrl == null or profile.avatarUrl.isEmpty()}"
                                 th:attr="data-username=${user != null ? user.username : 'unknown'}">
                                <i class="fas fa-user"></i>
                            </div>
                            
                            <!-- ユーザー基本情報 -->
                            <div class="profile-info-top">
                                <h2 class="profile-username" th:text="${profile != null and profile.displayName != null ? profile.displayName : (user != null ? user.username : 'ユーザー名')}">ユーザー名</h2>
                                <p class="profile-friendcode" th:text="${user != null and user.friendCode != null ? 'FC: ' + user.friendCode : 'FC: 未設定'}">FC: XXXX-XXXX</p>
                            </div>
                        </div>
                        
                        <!-- 自己紹介文とタグ（アイコンの下） -->
                        <div class="profile-info-bottom">
                            <!-- 自己紹介文 -->
                            <p class="profile-bio" th:if="${profile != null and profile.bio != null and !profile.bio.isEmpty()}" th:text="${profile.bio}">自己紹介文がここに表示されます</p>
                            <p class="profile-bio text-muted" th:if="${profile == null or profile.bio == null or profile.bio.isEmpty()}">自己紹介が未設定です</p>
                            
                            <!-- 好きなものタグ（横スクロール） -->
                            <div class="profile-tags-container" th:if="${profile != null and profile.favoriteThings != null and !profile.favoriteThings.isEmpty()}">
                                <div class="profile-tags-scroll">
                                    <span class="profile-tag" th:each="tag : ${#strings.arraySplit(profile.favoriteThings, ',')}" 
                                          th:text="${tag.trim()}">タグ</span>
                                </div>
                            </div>
                            
                            <!-- フォロー/フォロワー/フレンド数 -->
                            <div class="profile-stats">
                                <div class="stat-item stat-clickable" data-tab="following">
                                    <span class="stat-label">フォロー</span>
                                    <span class="stat-value" id="myFollowingCount" th:text="${followingCount != null ? followingCount : 0}">0</span>
                                </div>
                                <div class="stat-item stat-clickable" data-tab="followers">
                                    <span class="stat-label">フォロワー</span>
                                    <span class="stat-value" id="myFollowerCount" th:text="${followerCount != null ? followerCount : 0}">0</span>
                                </div>
                                <div class="stat-item stat-clickable" data-tab="friends">
                                    <span class="stat-label">フレンド</span>
                                    <span class="stat-value" id="myFriendCount" th:text="${friendCount != null ? friendCount : 0}">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 自分の投稿一覧 -->
                <div class="my-posts-section">
                    <div class="my-posts-header">
                        <h3 class="my-posts-title"><i class="fas fa-pen me-2"></i>自分の投稿</h3>
                    </div>
                    <div class="my-posts-container" id="myPostsContainer">
                        <div class="loading-posts">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p>読み込み中...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- 他ユーザープロフィール閲覧画面 -->
        <section class="app-section" id="user-profile-view-section">
            <div class="section-content">
                <!-- プロフィールセクション -->
                <div class="profile-section profile-view-mode">
                    <!-- 戻るボタン -->
                    <button class="back-btn" type="button" id="backToHomeBtn">
                        <i class="fas fa-chevron-left" style="font-size: 1.2rem;"></i>
                    </button>
                    <div class="profile-main" id="viewedProfileContent">
                        <!-- JavaScriptで動的にロードされる -->
                    </div>
                </div>

                <!-- そのユーザーの投稿一覧 -->
                <div class="user-posts-section">
                    <div class="my-posts-header">
                        <h3 class="my-posts-title"><i class="fas fa-pen me-2"></i>投稿</h3>
                    </div>
                    <div class="my-posts-container" id="viewedUserPostsContainer">
                        <div class="loading-posts">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p>読み込み中...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- フォロー/フォロワー/フレンド一覧セクション -->
        <section class="app-section" id="relations-section" style="display: none;">
            <div class="section-content">
                <!-- ヘッダー -->
                <div class="relations-header">
                    <button class="back-btn" type="button" id="backFromRelationsBtn">
                        <i class="fas fa-chevron-left" style="font-size: 1.2rem;"></i>
                    </button>
                    <div class="relations-tabs">
                        <button class="relations-tab active" data-tab="following">フォロー</button>
                        <button class="relations-tab" data-tab="followers">フォロワー</button>
                        <button class="relations-tab" data-tab="friends">フレンド</button>
                    </div>
                </div>
                <!-- 一覧表示エリア -->
                <div class="relations-list-container" id="relationsListContainer">
                    <div class="relations-list" id="relationsList">
                        <!-- 動的にロードされる -->
                    </div>
                </div>
            </div>
        </section>

    </div>

    <!-- プロフィールアクションボタン（閲覧用プロフィール画面専用） -->
    <div class="profile-actions" id="profileActions" style="display: none;">
        <button class="btn-action btn-chat" id="btnStartChat">
            <i class="fas fa-comment me-2"></i>チャット
        </button>
        <button class="btn-action btn-follow" id="btnFollowUser">
            <i class="fas fa-user-plus me-2"></i>フォロー
        </button>
    </div>
    
    <!-- 画像モーダル -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal(event)">
        <button class="image-modal-close" onclick="closeImageModal(event)">
            <i class="fas fa-times"></i>
        </button>
        <img class="image-modal-content" id="modalImage" src="" alt="拡大画像">
    </div>

    <!-- 画像クロップモーダル -->
    <div class="crop-modal-overlay" id="cropModalOverlay">
        <div class="crop-canvas-wrap" id="cropCanvasWrap">
            <canvas id="cropCanvas" width="560" height="560"></canvas>
        </div>
        <div class="crop-controls">
            <div class="crop-zoom-row">
                <i class="fas fa-search-minus"></i>
                <input type="range" class="crop-zoom-slider" id="cropZoomSlider" min="100" max="400" value="100">
                <i class="fas fa-search-plus"></i>
            </div>
            <div class="crop-btn-row">
                <button class="crop-btn crop-btn-cancel" id="cropCancelBtn">キャンセル</button>
                <button class="crop-btn crop-btn-confirm" id="cropConfirmBtn">確定</button>
            </div>
        </div>
    </div>

    <!-- ユーザープロフィールポップアップ -->
    <div class="profile-popup-overlay" id="profilePopupOverlay" onclick="closeProfilePopup(event)">
        <div class="profile-popup" onclick="event.stopPropagation()">
            <button class="profile-popup-close" onclick="closeProfilePopup(event)">
                <i class="fas fa-times"></i>
            </button>
            <div class="profile-popup-content" id="profilePopupContent">
                <!-- 動的にロードされる -->
            </div>
            <div class="profile-popup-actions">
                <button class="btn-popup-action btn-popup-chat" id="btnPopupChat">
                    <i class="fas fa-comment me-2"></i>DM
                </button>
                <button class="btn-popup-action btn-popup-follow" id="btnPopupFollow">
                    <i class="fas fa-user-plus me-2"></i>フォロー
                </button>
            </div>
        </div>
    </div>

    <!-- スライドメニューオーバーレイ -->
    <div class="slide-menu-overlay" id="slideMenuOverlay"></div>
    
    <!-- スライドメニュー -->
    <div class="slide-menu" id="slideMenu">
        <button class="slide-menu-close" id="slideMenuClose">
            <i class="fas fa-times"></i>
        </button>
        
        <!-- アイコン -->
        <div class="slide-menu-avatar-container">
            <div class="slide-menu-avatar" 
                 th:if="${profile != null and profile.avatarUrl != null and !profile.avatarUrl.isEmpty()}"
                 th:style="'background-image: url(' + ${profile.avatarUrl} + '); background-size: cover; background-position: center;'">
            </div>
            <div class="slide-menu-avatar default-avatar" 
                 th:if="${profile == null or profile.avatarUrl == null or profile.avatarUrl.isEmpty()}"
                 th:attr="data-username=${user != null ? user.username : username}">
                <i class="fas fa-user"></i>
            </div>
        </div>
        
        <!-- ニックネーム -->
        <div class="slide-menu-nickname">
            <span th:text="${profile != null and profile.displayName != null ? profile.displayName : (user != null ? user.username : 'ユーザー名')}">ユーザー名</span>
        </div>
        
        <!-- ナビゲーション -->
        <nav class="slide-menu-nav">
            <a href="/profile/edit" class="slide-menu-item">
                <i class="fas fa-user-edit me-3"></i>プロフィール編集
            </a>
            <a href="/random-matching/settings" class="slide-menu-item">
                <i class="fas fa-sliders-h me-3"></i>マッチング設定
            </a>
        </nav>
        
        <!-- ログアウト（最下部） -->
        <div class="slide-menu-footer">
            <a href="/logout" class="slide-menu-item logout-item" onclick="handleLogout(event)">
                <i class="fas fa-sign-out-alt me-3"></i>ログアウト
            </a>
        </div>
    </div>
    
    <!-- 投稿ボタン（フッターの上） -->
    <button class="btn-create-post" id="btnCreatePost">
        <i class="fas fa-plus"></i>
    </button>
    
    
    <!-- フッターナビゲーション -->
    <footer class="bottom-nav">
        <button class="nav-item active" data-section="home">
            <i class="fas fa-home"></i>
            <span>ホーム</span>
        </button>
        <button class="nav-item" data-section="room">
            <i class="fas fa-door-open"></i>
            <span>ルーム</span>
        </button>
        <button class="nav-item" data-section="match">
            <i class="fas fa-random"></i>
            <span>マッチ</span>
        </button>
        <button class="nav-item" data-section="chat">
            <i class="fas fa-comments"></i>
            <span>チャット</span>
        </button>
        <button class="nav-item" data-section="mypage">
            <i class="fas fa-user"></i>
            <span>マイページ</span>
        </button>
    </footer>

    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script>
        // デフォルトアバターの色設定関数
        function setDefaultAvatarColor(avatarElement) {
            if (!avatarElement) return;
            
            // data-username属性またはテキストコンテンツから取得
            const username = avatarElement.getAttribute('data-username') || 
                           avatarElement.textContent.trim() ||
                           'default';
            
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
                '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B88B', '#AAB7B8'
            ];
            
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            const color = colors[Math.abs(hash) % colors.length];
            avatarElement.style.backgroundColor = color;
        }

        // ========================================
        // 画像クロップモーダル
        // ========================================
        const CropModal = (function() {
            let canvas, ctx, img;
            let offsetX = 0, offsetY = 0, scale = 1, minScale = 1;
            let dragging = false, lastX = 0, lastY = 0;
            let pinchStartDist = 0, pinchStartScale = 1;
            let onConfirmCallback = null;
            const SIZE = 560; // canvas解像度
            const OUT = 300;  // 出力サイズ

            function init() {
                canvas = document.getElementById('cropCanvas');
                ctx = canvas.getContext('2d');
                const wrap = document.getElementById('cropCanvasWrap');
                const slider = document.getElementById('cropZoomSlider');

                // ドラッグ
                wrap.addEventListener('pointerdown', onPointerDown);
                wrap.addEventListener('pointermove', onPointerMove);
                wrap.addEventListener('pointerup', onPointerUp);
                wrap.addEventListener('pointercancel', onPointerUp);

                // ピンチズーム
                wrap.addEventListener('touchstart', onTouchStart, {passive: false});
                wrap.addEventListener('touchmove', onTouchMove, {passive: false});

                // スクロールズーム
                wrap.addEventListener('wheel', function(e) {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? -0.05 : 0.05;
                    setScale(scale + delta);
                    draw();
                    slider.value = Math.round(scale / minScale * 100);
                }, {passive: false});

                // スライダー
                slider.addEventListener('input', function() {
                    setScale(minScale * (this.value / 100));
                    draw();
                });

                document.getElementById('cropCancelBtn').addEventListener('click', close);
                document.getElementById('cropConfirmBtn').addEventListener('click', confirm);
            }

            function open(file, callback) {
                onConfirmCallback = callback;
                img = new Image();
                img.onload = function() {
                    // 画像が円に収まる最小スケール
                    minScale = SIZE / Math.min(img.width, img.height);
                    scale = minScale;
                    offsetX = (SIZE - img.width * scale) / 2;
                    offsetY = (SIZE - img.height * scale) / 2;

                    const slider = document.getElementById('cropZoomSlider');
                    slider.value = 100;
                    slider.min = 100;
                    slider.max = 400;

                    draw();
                    document.getElementById('cropModalOverlay').classList.add('active');
                    document.body.style.overflow = 'hidden';
                };
                img.src = URL.createObjectURL(file);
            }

            function close() {
                document.getElementById('cropModalOverlay').classList.remove('active');
                document.body.style.overflow = '';
                if (img && img.src.startsWith('blob:')) URL.revokeObjectURL(img.src);
                onConfirmCallback = null;
            }

            function draw() {
                ctx.clearRect(0, 0, SIZE, SIZE);
                // 画像描画
                ctx.drawImage(img, offsetX, offsetY, img.width * scale, img.height * scale);
            }

            function clampOffset() {
                const w = img.width * scale;
                const h = img.height * scale;
                if (w >= SIZE) {
                    offsetX = Math.min(0, Math.max(SIZE - w, offsetX));
                } else {
                    offsetX = (SIZE - w) / 2;
                }
                if (h >= SIZE) {
                    offsetY = Math.min(0, Math.max(SIZE - h, offsetY));
                } else {
                    offsetY = (SIZE - h) / 2;
                }
            }

            function setScale(newScale) {
                const centerX = SIZE / 2;
                const centerY = SIZE / 2;
                const oldScale = scale;
                scale = Math.max(minScale, Math.min(minScale * 4, newScale));
                // 中心を基準にズーム
                offsetX = centerX - (centerX - offsetX) * (scale / oldScale);
                offsetY = centerY - (centerY - offsetY) * (scale / oldScale);
                clampOffset();
            }

            // Pointer events（ドラッグ）
            function onPointerDown(e) {
                if (e.pointerType === 'touch' && e.isPrimary === false) return;
                dragging = true;
                lastX = e.clientX;
                lastY = e.clientY;
                e.currentTarget.setPointerCapture(e.pointerId);
            }
            function onPointerMove(e) {
                if (!dragging) return;
                const rect = canvas.getBoundingClientRect();
                const ratio = SIZE / rect.width;
                offsetX += (e.clientX - lastX) * ratio;
                offsetY += (e.clientY - lastY) * ratio;
                lastX = e.clientX;
                lastY = e.clientY;
                clampOffset();
                draw();
            }
            function onPointerUp() {
                dragging = false;
            }

            // ピンチズーム
            function onTouchStart(e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    pinchStartDist = getTouchDist(e.touches);
                    pinchStartScale = scale;
                }
            }
            function onTouchMove(e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const dist = getTouchDist(e.touches);
                    const newScale = pinchStartScale * (dist / pinchStartDist);
                    setScale(newScale);
                    draw();
                    document.getElementById('cropZoomSlider').value = Math.round(scale / minScale * 100);
                }
            }
            function getTouchDist(touches) {
                const dx = touches[0].clientX - touches[1].clientX;
                const dy = touches[0].clientY - touches[1].clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }

            function confirm() {
                // 出力用Canvas
                const outCanvas = document.createElement('canvas');
                outCanvas.width = OUT;
                outCanvas.height = OUT;
                const outCtx = outCanvas.getContext('2d');

                // 円形クリップ
                outCtx.beginPath();
                outCtx.arc(OUT / 2, OUT / 2, OUT / 2, 0, Math.PI * 2);
                outCtx.closePath();
                outCtx.clip();

                // スケーリングして描画
                const ratio = OUT / SIZE;
                outCtx.drawImage(img, offsetX * ratio, offsetY * ratio, img.width * scale * ratio, img.height * scale * ratio);

                outCanvas.toBlob(function(blob) {
                    if (onConfirmCallback) onConfirmCallback(blob);
                    close();
                }, 'image/png');
            }

            return { init, open, close };
        })();

        // DOMContentLoaded後に初期化
        document.addEventListener('DOMContentLoaded', function() {
            CropModal.init();
        });
        
        // WebSocket接続
        let stompClient = null;
        let isWebSocketConnected = false;

        // 現在のユーザーID（グローバル変数）
        let currentUserId = null;

        // グローバル変数として現在のユーザー名を保存
        window.currentUser = null;
        window.stompClient = null;
        window.requestedRoomIds = new Set(); // 申請中のルームIDを保持

        // ユーザー変更検知とキャッシュクリア
        function checkUserChange() {
            const appContainer = document.querySelector('.app-container');
            const currentUsername = appContainer?.dataset.currentUsername;
            const storedUsername = sessionStorage.getItem('chatapp_current_user');

            console.log('🔍 ユーザー変更チェック - 現在:', currentUsername, ', 保存:', storedUsername);

            if (storedUsername && storedUsername !== currentUsername) {
                console.log('⚠️ ユーザーが変更されました！キャッシュをクリアします');
                // キャッシュをクリア
                window.requestedRoomIds = new Set();
                sessionStorage.clear();
                // Service Workerのキャッシュもクリア
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            caches.delete(name);
                            console.log('🗑️ キャッシュ削除:', name);
                        });
                    });
                }
            }

            // 現在のユーザー名を保存
            if (currentUsername) {
                sessionStorage.setItem('chatapp_current_user', currentUsername);
            }
        }

        // 初期化関数（ページ読み込み時に実行）
        function initializeApp() {
            // ユーザー変更をチェック
            checkUserChange();

            // ユーザーIDとユーザー名を取得
            const appContainer = document.querySelector('.app-container');
            if (appContainer && appContainer.dataset.currentUserId) {
                currentUserId = parseInt(appContainer.dataset.currentUserId);
                console.log('👤 現在のユーザーID:', currentUserId);
            } else {
                console.error('❌ ユーザーIDが取得できません');
            }

            if (appContainer && appContainer.dataset.currentUsername) {
                window.currentUser = appContainer.dataset.currentUsername;
                console.log('👤 現在のユーザー名:', window.currentUser);
            }
            
            // WebSocket接続を開始
            connectWebSocket();
            
            // 接続状態を定期的に確認
            setInterval(function() {
                if (!isWebSocketConnected) {
                    connectWebSocket();
                }
            }, 60000); // 60秒ごと

            // 初期データをロード
            console.log('📋 初期データをロード中...');
            loadJoinedRooms();
            loadDMConversations();

            // 申請バッジを更新（バックグラウンドで）
            loadRequestedRooms().catch(err => console.error('申請数取得エラー:', err));
            // 承認バッジを更新（バックグラウンドで）
            loadPendingApprovals().catch(err => console.error('承認数取得エラー:', err));
            // 招待バッジを更新（バックグラウンドで）
            loadReceivedInvitations().catch(err => console.error('招待数取得エラー:', err));
        }
        
        function connectWebSocket() {
            console.log('===== WebSocket接続開始 =====');
            console.log('接続先:', window.location.origin + '/ws');
            
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            window.stompClient = stompClient;  // グローバルに保存

            // デバッグログを無効化（本番環境では有効にすると情報が多すぎる）
            stompClient.debug = null;

            stompClient.connect({}, function(frame) {
                isWebSocketConnected = true;
                console.log('✅ WebSocket接続成功');
                console.log('接続情報:', frame);
                
                // 新規投稿の購読
                stompClient.subscribe('/topic/posts', function(message) {
                    console.log('📨 新規投稿を受信:', message.body);
                    const postData = JSON.parse(message.body);
                    addNewPostToDOM(postData);
                });
                
                // フォロー数更新の購読
                stompClient.subscribe('/topic/follow-updates', function(message) {
                    console.log('📊 フォロー更新を受信:', message.body);
                    const updateData = JSON.parse(message.body);
                    updateFollowCountsForUser(updateData);
                });
                
                // DMメッセージの購読
                stompClient.subscribe('/user/queue/dm', function(message) {
                    console.log('� WebSocketからDMメッセージ受信:', message.body);
                    try {
                        const dmData = JSON.parse(message.body);
                        handleIncomingDM(dmData);
                    } catch (error) {
                        console.error('❌ DMメッセージのパースエラー:', error);
                    }
                });
                
                // DM既読通知の購読
                stompClient.subscribe('/user/queue/dm-read', function(message) {
                    console.log('✅ DM既読通知を受信:', message.body);
                    try {
                        const readData = JSON.parse(message.body);
                        handleDMReadNotification(readData);
                    } catch (error) {
                        console.error('❌ DM既読通知のパースエラー:', error);
                    }
                });

                // ルーム更新の購読
                stompClient.subscribe('/topic/rooms', function(message) {
                    console.log('🏠 ルーム更新を受信:', message.body);
                    try {
                        const roomData = JSON.parse(message.body);
                        handleRoomUpdate(roomData);
                    } catch (error) {
                        console.error('❌ ルーム更新のパースエラー:', error);
                    }
                });

                console.log('📡 WebSocketサブスクリプション完了');
            }, function(error) {
                isWebSocketConnected = false;
                console.error('❌ WebSocket接続エラー:', error);
                console.log('⏰ 5秒後に再接続を試行します...');
                // 5秒後に再接続
                setTimeout(connectWebSocket, 5000);
            });
            
            // 接続状態の監視
            socket.onclose = function() {
                isWebSocketConnected = false;
                console.warn('⚠️ WebSocket接続が切断されました');
            };
        }
        
        // ページ読み込み時に初期化
        window.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 アプリ初期化開始');
            initializeApp();

            // ホームタブの初期化
            initHomeTabsEvent();

            // URLパラメータでタブを切り替え
            const urlParams = new URLSearchParams(window.location.search);
            const tabParam = urlParams.get('tab');
            if (tabParam === 'mypage') {
                // マイページタブをアクティブにする
                setTimeout(function() {
                    const sections = document.querySelectorAll('.app-section');
                    const navItems = document.querySelectorAll('.nav-item');
                    const createPostBtn = document.getElementById('btnCreatePost');

                    sections.forEach(section => section.classList.remove('active'));
                    document.getElementById('mypage-section').classList.add('active');
                    navItems.forEach(nav => nav.classList.remove('active'));
                    navItems[navItems.length - 1].classList.add('active');
                    if (createPostBtn) createPostBtn.style.display = 'none';

                    // 自分の投稿を読み込み、スクロールハンドラを設定
                    loadMyPosts();
                    setTimeout(setupMypageScroll, 100);

                    // URLパラメータを削除してきれいなURLに
                    window.history.replaceState({}, document.title, '/home');
                }, 100);
            }
        });

        // 現在のホームタブ
        let currentHomeTab = 'all';

        // ホームタブのイベント初期化
        function initHomeTabsEvent() {
            document.querySelectorAll('.home-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tab = this.getAttribute('data-home-tab');
                    if (tab !== currentHomeTab) {
                        // タブのアクティブ状態を更新
                        document.querySelectorAll('.home-tab-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        currentHomeTab = tab;

                        // 投稿を読み込む
                        loadHomePosts(tab);
                    }
                });
            });
        }

        // ホームの投稿を読み込む
        async function loadHomePosts(tab) {
            const postsContainer = document.querySelector('.posts-container');

            // ローディング表示
            postsContainer.innerHTML = `
                <div class="loading-posts">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>読み込み中...</p>
                </div>
            `;

            try {
                const endpoint = tab === 'following' ? '/api/posts/following' : '/api/posts/all';
                const response = await fetch(endpoint);
                const data = await response.json();

                if (data.success) {
                    renderHomePosts(data.posts);
                } else {
                    postsContainer.innerHTML = `
                        <div class="no-posts">
                            <i class="fas fa-exclamation-circle fa-3x mb-3 text-muted"></i>
                            <p class="text-muted">${data.message || 'エラーが発生しました'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('投稿読み込みエラー:', error);
                postsContainer.innerHTML = `
                    <div class="no-posts">
                        <i class="fas fa-exclamation-circle fa-3x mb-3 text-muted"></i>
                        <p class="text-muted">投稿の読み込みに失敗しました</p>
                    </div>
                `;
            }
        }

        // 投稿を描画
        function renderHomePosts(posts) {
            const postsContainer = document.querySelector('.posts-container');

            if (!posts || posts.length === 0) {
                const message = currentHomeTab === 'following'
                    ? 'フォロー中のユーザーの投稿がありません'
                    : 'まだ投稿がありません';
                postsContainer.innerHTML = `
                    <div class="no-posts">
                        <i class="fas fa-inbox fa-3x mb-3 text-muted"></i>
                        <p class="text-muted">${message}</p>
                    </div>
                `;
                return;
            }

            postsContainer.innerHTML = '';

            posts.forEach(post => {
                const postCard = document.createElement('div');
                postCard.className = 'post-card';

                const user = post.user;
                const displayName = user.displayName || user.username;
                const colorIndex = getUserColor(user.username);

                // アバターHTML
                let avatarHtml = '';
                if (user.avatarUrl) {
                    avatarHtml = `<div class="post-avatar user-profile-link" style="background-image: url(${user.avatarUrl}); background-size: cover; background-position: center; cursor: pointer;" data-user-id="${user.id}" data-friend-code="${user.friendCode || ''}"></div>`;
                } else {
                    avatarHtml = `<div class="post-avatar default-avatar user-profile-link" data-username="${user.username}" data-color="${colorIndex}" data-user-id="${user.id}" data-friend-code="${user.friendCode || ''}" style="cursor: pointer;"><i class="fas fa-user"></i></div>`;
                }

                // メディアHTML
                let mediaHtml = '';
                if (post.mediaPath) {
                    const mediaUrls = post.mediaPath.split(',');
                    mediaHtml = '<div class="post-media-grid">';
                    mediaUrls.forEach(url => {
                        if (url.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                            mediaHtml += `<div class="post-media-item"><img src="${url}" alt="投稿画像" class="post-media-image" loading="lazy" onclick="openImageModal(this.src)"></div>`;
                        } else if (url.match(/\.(mp4|webm|mov)$/i)) {
                            mediaHtml += `<div class="post-media-item"><video src="${url}" controls class="post-media-video" preload="metadata"></video></div>`;
                        }
                    });
                    mediaHtml += '</div>';
                }

                postCard.innerHTML = `
                    <div class="post-header">
                        <div class="post-user-info">
                            ${avatarHtml}
                            <div class="post-user-details">
                                <span class="post-username clickable-username user-profile-link" data-user-id="${user.id}" data-friend-code="${user.friendCode || ''}">${displayName}</span>
                                <span class="post-time">${post.createdAt}</span>
                            </div>
                        </div>
                    </div>
                    <div class="post-content">
                        <p>${post.content}</p>
                        ${mediaHtml}
                    </div>
                `;

                // デフォルトアバターの色を設定
                const defaultAvatar = postCard.querySelector('.default-avatar');
                if (defaultAvatar) {
                    setDefaultAvatarColor(defaultAvatar);
                }

                // クリックイベントを追加
                postCard.querySelectorAll('.user-profile-link').forEach(element => {
                    element.addEventListener('click', function() {
                        const userId = this.getAttribute('data-user-id');
                        const friendCode = this.getAttribute('data-friend-code');
                        if (userId) {
                            viewUserProfile(userId);
                        }
                    });
                });

                postsContainer.appendChild(postCard);
            });
        }

        // マイページのプロフィールヘッダー コンパクトモード切り替え
        function setupMypageScroll() {
            const mypageSection = document.getElementById('mypage-section');
            const profileSection = mypageSection?.querySelector('.profile-section');
            const sectionContent = mypageSection?.querySelector('.section-content');

            if (!profileSection || !sectionContent) return;

            let initialProfileHeight = 0;
            let isCompact = false;

            // 初期高さを取得
            function getInitialHeight() {
                profileSection.classList.remove('compact');
                initialProfileHeight = profileSection.offsetHeight;
            }

            // スクロールイベントハンドラ
            function handleMypageScroll() {
                const scrollTop = sectionContent.scrollTop;
                const threshold = initialProfileHeight / 3;

                if (scrollTop > threshold && !isCompact) {
                    profileSection.classList.add('compact');
                    isCompact = true;
                } else if (scrollTop <= threshold && isCompact) {
                    profileSection.classList.remove('compact');
                    isCompact = false;
                }
            }

            // 初期化
            getInitialHeight();
            sectionContent.addEventListener('scroll', handleMypageScroll);
        }

        // 閲覧中ユーザーのプロフィールヘッダー コンパクトモード切り替え
        let userProfileScrollHandler = null;
        function setupUserProfileScroll() {
            const profileViewSection = document.getElementById('user-profile-view-section');
            const profileSection = profileViewSection?.querySelector('.profile-section');
            const sectionContent = profileViewSection?.querySelector('.section-content');

            if (!profileSection || !sectionContent) return;

            // 既存のリスナーを削除
            if (userProfileScrollHandler) {
                sectionContent.removeEventListener('scroll', userProfileScrollHandler);
            }

            // コンパクトモードをリセット
            profileSection.classList.remove('compact');
            let initialProfileHeight = profileSection.offsetHeight;
            let isCompact = false;

            // スクロールイベントハンドラ
            userProfileScrollHandler = function() {
                const scrollTop = sectionContent.scrollTop;
                const threshold = initialProfileHeight / 3;

                if (scrollTop > threshold && !isCompact) {
                    profileSection.classList.add('compact');
                    isCompact = true;
                } else if (scrollTop <= threshold && isCompact) {
                    profileSection.classList.remove('compact');
                    isCompact = false;
                }
            };

            sectionContent.addEventListener('scroll', userProfileScrollHandler);

            // スクロール位置をリセット
            sectionContent.scrollTop = 0;
        }

        // 閲覧中ユーザーの投稿を読み込む
        async function loadUserPosts(userId) {
            const container = document.getElementById('viewedUserPostsContainer');
            if (!container) return;

            container.innerHTML = `
                <div class="loading-posts">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>読み込み中...</p>
                </div>
            `;

            try {
                const response = await fetch(`/api/posts/user/${userId}`);
                const data = await response.json();

                if (data.success) {
                    renderUserPosts(data.posts, container);
                } else {
                    container.innerHTML = `
                        <div class="no-posts">
                            <i class="fas fa-exclamation-circle fa-3x mb-3"></i>
                            <p>${data.message || 'エラーが発生しました'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading user posts:', error);
                container.innerHTML = `
                    <div class="no-posts">
                        <i class="fas fa-exclamation-circle fa-3x mb-3"></i>
                        <p>投稿の読み込みに失敗しました</p>
                    </div>
                `;
            }
        }

        // 閲覧中ユーザーの投稿を描画
        function renderUserPosts(posts, container) {
            if (!posts || posts.length === 0) {
                container.innerHTML = `
                    <div class="no-posts">
                        <i class="fas fa-pen fa-3x mb-3"></i>
                        <p>まだ投稿がありません</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            posts.forEach(post => {
                const postCard = document.createElement('div');
                postCard.className = 'my-post-card';

                let mediaHtml = '';
                if (post.mediaPath) {
                    const isVideo = /\.(mp4|webm|mov)$/i.test(post.mediaPath);
                    if (isVideo) {
                        mediaHtml = `
                            <div class="my-post-media">
                                <video class="my-post-video" controls>
                                    <source src="${post.mediaPath}" type="video/mp4">
                                </video>
                            </div>
                        `;
                    } else {
                        mediaHtml = `
                            <div class="my-post-media">
                                <img src="${post.mediaPath}" class="my-post-image" alt="投稿画像">
                            </div>
                        `;
                    }
                }

                postCard.innerHTML = `
                    <div class="my-post-content">
                        <p>${post.content}</p>
                    </div>
                    ${mediaHtml}
                    <div class="my-post-time">${post.createdAt}</div>
                `;

                container.appendChild(postCard);
            });
        }

        // 自分の投稿を読み込む
        async function loadMyPosts() {
            const container = document.getElementById('myPostsContainer');
            if (!container) return;

            container.innerHTML = `
                <div class="loading-posts">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>読み込み中...</p>
                </div>
            `;

            try {
                const response = await fetch('/api/posts/my');
                const data = await response.json();

                if (data.success) {
                    renderMyPosts(data.posts);
                } else {
                    container.innerHTML = `
                        <div class="no-posts">
                            <i class="fas fa-exclamation-circle fa-3x mb-3"></i>
                            <p>${data.message || 'エラーが発生しました'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('自分の投稿の取得に失敗:', error);
                container.innerHTML = `
                    <div class="no-posts">
                        <i class="fas fa-exclamation-circle fa-3x mb-3"></i>
                        <p>投稿の取得に失敗しました</p>
                    </div>
                `;
            }
        }

        // 自分の投稿を描画
        function renderMyPosts(posts) {
            const container = document.getElementById('myPostsContainer');

            if (!posts || posts.length === 0) {
                container.innerHTML = `
                    <div class="no-posts">
                        <i class="fas fa-pen fa-3x mb-3"></i>
                        <p>まだ投稿がありません</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            posts.forEach(post => {
                const postCard = document.createElement('div');
                postCard.className = 'my-post-card';

                // メディアHTML
                let mediaHtml = '';
                if (post.mediaPath) {
                    const mediaUrls = post.mediaPath.split(',');
                    mediaHtml = '<div class="my-post-media">';
                    mediaUrls.forEach(url => {
                        if (url.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                            mediaHtml += `<img src="${url}" alt="投稿画像" class="my-post-image" onclick="openImageModal(this.src)">`;
                        } else if (url.match(/\.(mp4|webm|mov)$/i)) {
                            mediaHtml += `<video src="${url}" controls class="my-post-video" preload="metadata"></video>`;
                        }
                    });
                    mediaHtml += '</div>';
                }

                postCard.innerHTML = `
                    <div class="my-post-content">
                        <p>${post.content}</p>
                    </div>
                    ${mediaHtml}
                    <div class="my-post-time">${post.createdAt}</div>
                `;

                container.appendChild(postCard);
            });
        }

        // 新規投稿をDOMに追加
        function addNewPostToDOM(postData) {
            const postsContainer = document.querySelector('.posts-container');
            const noPosts = postsContainer.querySelector('.no-posts');
            
            // "まだ投稿がありません"メッセージを削除
            if (noPosts) {
                noPosts.remove();
            }
            
            // 投稿カードを作成
            const postCard = document.createElement('div');
            postCard.className = 'post-card';
            
            const user = postData.user;
            const displayName = user.displayName || user.username;
            const colorIndex = getUserColor(user.username);
            
            // アバターHTML
            let avatarHtml = '';
            if (user.avatarUrl) {
                avatarHtml = `<div class="post-avatar user-profile-link" style="background-image: url(${user.avatarUrl}); background-size: cover; background-position: center; cursor: pointer;" data-user-id="${user.id}" data-friend-code="${postData.userFriendCode || ''}"></div>`;
            } else {
                avatarHtml = `<div class="post-avatar default-avatar user-profile-link" data-username="${user.username}" data-color="${colorIndex}" data-user-id="${user.id}" data-friend-code="${postData.userFriendCode || ''}" style="cursor: pointer;"><i class="fas fa-user"></i></div>`;
            }
            
            // メディアHTML
            let mediaHtml = '';
            if (postData.mediaPath) {
                const mediaUrls = postData.mediaPath.split(',');
                mediaHtml = '<div class="post-media-grid">';
                mediaUrls.forEach(url => {
                    if (url.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                        mediaHtml += `<div class="post-media-item"><img src="${url}" alt="投稿画像" class="post-media-image" loading="lazy" onclick="openImageModal(this.src)"></div>`;
                    } else if (url.match(/\.(mp4|webm|mov)$/i)) {
                        mediaHtml += `<div class="post-media-item"><video src="${url}" class="post-media-video" preload="metadata" controls></video></div>`;
                        mediaHtml += `<div class="post-media-item"><video src="${url}" controls class="post-media-video"></video></div>`;
                    }
                });
                mediaHtml += '</div>';
            }
            
            // 日時フォーマット
            const createdAt = new Date(postData.createdAt);
            const formattedDate = `${createdAt.getFullYear()}年${String(createdAt.getMonth() + 1).padStart(2, '0')}月${String(createdAt.getDate()).padStart(2, '0')}日 ${String(createdAt.getHours()).padStart(2, '0')}:${String(createdAt.getMinutes()).padStart(2, '0')}`;
            
            postCard.innerHTML = `
                <div class="post-header">
                    <div class="post-user-info">
                        ${avatarHtml}
                        <div class="post-user-details">
                            <span class="post-username clickable-username user-profile-link" data-user-id="${user.id}" data-friend-code="${user.friendCode || ''}">${displayName}</span>
                            <span class="post-time">${formattedDate}</span>
                        </div>
                    </div>
                </div>
                <div class="post-content">
                    <p>${postData.content}</p>
                    ${mediaHtml}
                </div>
            `;
            
            // デフォルトアバターの色を設定
            const defaultAvatar = postCard.querySelector('.default-avatar');
            if (defaultAvatar) {
                setDefaultAvatarColor(defaultAvatar);
            }
            
            // クリックイベントを追加
            postCard.querySelectorAll('.user-profile-link').forEach(element => {
                element.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    const friendCode = this.getAttribute('data-friend-code');
                    console.log('ユーザークリック - ID:', userId, 'FriendCode:', friendCode);
                    if (userId) {
                        viewUserProfile(userId);
                    }
                });
            });
            
            // 先頭に追加（新しい投稿が一番上に表示される）
            postsContainer.insertBefore(postCard, postsContainer.firstChild);
            
            // アニメーション効果
            postCard.style.opacity = '0';
            postCard.style.transform = 'translateY(-20px)';
            setTimeout(() => {
                postCard.style.transition = 'all 0.5s ease';
                postCard.style.opacity = '1';
                postCard.style.transform = 'translateY(0)';
            }, 10);
        }
        
        // フォロー数をリアルタイム更新
        async function updateFollowCountsForUser(updateData) {
            const followedData = updateData.followedUserData;
            const followerData = updateData.followerUserData;
            
            // 現在のユーザーIDを取得
            const currentUserId = document.querySelector('.app-container').dataset.currentUserId;
            
            console.log('🔄 フォロー更新データ受信:', {
                followedUserId: followedData?.userId,
                followerUserId: followerData?.userId,
                currentUserId: currentUserId,
                currentViewedUserId: currentViewedUserId
            });
            
            console.log('型チェック:', {
                followedUserIdType: typeof followedData?.userId,
                followerUserIdType: typeof followerData?.userId,
                currentUserIdType: typeof currentUserId
            });
            
            // 自分がフォローされた場合（自分のマイページのフォロワー数を更新）
            const isFollowed = followedData && followedData.userId == currentUserId;
            console.log('自分がフォローされた？', isFollowed, 'followedData.userId:', followedData?.userId, 'currentUserId:', currentUserId);
            
            if (isFollowed) {
                console.log('✅ 自分がフォローされました！マイページを更新します');
                const myFollowerCount = document.getElementById('myFollowerCount');
                console.log('myFollowerCount要素:', myFollowerCount);
                if (myFollowerCount && followedData.followerCount !== undefined) {
                    console.log('📊 マイページのフォロワー数更新:', followedData.followerCount);
                    myFollowerCount.textContent = followedData.followerCount;
                } else {
                    console.warn('⚠️ フォロワー数を更新できません:', {
                        element: myFollowerCount,
                        count: followedData.followerCount
                    });
                }
                
                const myFriendCount = document.getElementById('myFriendCount');
                if (myFriendCount && followedData.friendCount !== undefined) {
                    console.log('📊 マイページのフレンド数更新:', followedData.friendCount);
                    myFriendCount.textContent = followedData.friendCount;
                }
            }
            
            // 自分がフォローした場合（自分のマイページのフォロー数を更新）
            const isFollowing = followerData && followerData.userId == currentUserId;
            console.log('自分がフォローした？', isFollowing, 'followerData.userId:', followerData?.userId, 'currentUserId:', currentUserId);
            
            if (isFollowing) {
                console.log('✅ 自分がフォローしました！マイページを更新します');
                const myFollowingCount = document.getElementById('myFollowingCount');
                console.log('myFollowingCount要素:', myFollowingCount);
                if (myFollowingCount && followerData.followingCount !== undefined) {
                    console.log('📊 マイページのフォロー数更新:', followerData.followingCount);
                    myFollowingCount.textContent = followerData.followingCount;
                } else {
                    console.warn('⚠️ フォロー数を更新できません:', {
                        element: myFollowingCount,
                        count: followerData.followingCount
                    });
                }
                
                const myFriendCount = document.getElementById('myFriendCount');
                if (myFriendCount && followerData.friendCount !== undefined) {
                    console.log('📊 マイページのフレンド数更新:', followerData.friendCount);
                    myFriendCount.textContent = followerData.friendCount;
                }
            }
            
            // フォローされた人のプロフィールを見ている場合
            if (followedData && currentViewedUserId && currentViewedUserId == followedData.userId) {
                const targetFollowerCount = document.getElementById('targetFollowerCount');
                if (targetFollowerCount && followedData.followerCount !== undefined) {
                    targetFollowerCount.textContent = followedData.followerCount;
                }
                
                // フォロー数とフレンド数も更新
                const profileStats = document.querySelector('#user-profile-view-section .profile-stats');
                if (profileStats) {
                    const statValues = profileStats.querySelectorAll('.stat-value');
                    if (statValues.length >= 3 && followedData.followingCount !== undefined) {
                        statValues[0].textContent = followedData.followingCount;
                    }
                    if (statValues.length >= 3 && followedData.friendCount !== undefined) {
                        statValues[2].textContent = followedData.friendCount;
                    }
                }
                
                // ボタンも更新
                await updateFollowButton(currentViewedUserId);
            }
            
            // フォローした人のプロフィールを見ている場合
            if (followerData && currentViewedUserId && currentViewedUserId == followerData.userId) {
                const targetFollowerCount = document.getElementById('targetFollowerCount');
                if (targetFollowerCount && followerData.followerCount !== undefined) {
                    targetFollowerCount.textContent = followerData.followerCount;
                }
                
                // フォロー数とフレンド数も更新
                const profileStats = document.querySelector('#user-profile-view-section .profile-stats');
                if (profileStats) {
                    const statValues = profileStats.querySelectorAll('.stat-value');
                    if (statValues.length >= 3 && followerData.followingCount !== undefined) {
                        statValues[0].textContent = followerData.followingCount;
                    }
                    if (statValues.length >= 3 && followerData.friendCount !== undefined) {
                        statValues[2].textContent = followerData.friendCount;
                    }
                }
                
                // ボタンも更新
                await updateFollowButton(currentViewedUserId);
            }
        }
        
        // 画像モーダル表示
        function openImageModal(src) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modalImg.src = src;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        // 画像モーダルを閉じる
        function closeImageModal(event) {
            // 画像自体をクリックした場合は閉じない
            if (event.target.classList.contains('image-modal-content')) {
                return;
            }
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // ログアウト処理
        function handleLogout(event) {
            // localStorageから記憶したログイン情報を削除
            localStorage.removeItem('rememberLogin');
            localStorage.removeItem('savedUsername');
            sessionStorage.clear();
            console.log('ログイン情報を削除しました');
            // ログアウト処理を続行（デフォルトのリンク動作）
        }
        
        // 星を生成
        function createStars() {
            const container = document.querySelector('.app-container');
            const starCount = 100; // 星の数
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = Math.random() > 0.8 ? 'star large' : 'star';
                
                // ランダムな位置
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                
                // ランダムなアニメーション遅延
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.animationDuration = (Math.random() * 2 + 2) + 's';
                
                container.appendChild(star);
            }
        }
        
        // ページ読み込み時に星を生成
        createStars();
        
        // ログイン成功時にlocalStorageに記憶
        const pendingUsername = sessionStorage.getItem('pendingUsername');
        if (pendingUsername) {
            localStorage.setItem('rememberLogin', 'true');
            localStorage.setItem('savedUsername', pendingUsername);
            sessionStorage.removeItem('pendingUsername');
            // リダイレクトカウンターをクリア（ログイン成功）
            sessionStorage.removeItem('loginRedirectCount');
            console.log('ログイン情報を記憶しました: ' + pendingUsername);
        } else {
            // ログインページからのリダイレクトでない場合もカウンターをクリア
            sessionStorage.removeItem('loginRedirectCount');
        }
        
        // セクション切り替え
        const navItems = document.querySelectorAll('.nav-item');
        const sections = document.querySelectorAll('.app-section');
        const createPostBtn = document.getElementById('btnCreatePost');
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const sectionName = item.dataset.section;

                // 全てのナビゲーションアイテムとセクションから active を削除
                navItems.forEach(nav => nav.classList.remove('active'));
                sections.forEach(section => section.classList.remove('active'));

                // クリックされたアイテムと対応するセクションに active を追加
                item.classList.add('active');
                document.getElementById(sectionName + '-section').classList.add('active');

                // ホーム画面の場合のみ＋ボタンを表示
                if (sectionName === 'home') {
                    createPostBtn.style.display = 'flex';
                } else {
                    createPostBtn.style.display = 'none';
                }
                
                // チャット画面に遷移した時にDM会話リストを読み込む
                if (sectionName === 'chat') {
                    loadDMConversations();
                }
                
                // ルーム画面に遷移した時にルームリストを読み込む
                if (sectionName === 'room') {
                    loadJoinedRooms();
                }

                // マイページに遷移した時に自分の投稿を読み込み、スクロールハンドラを設定
                if (sectionName === 'mypage') {
                    loadMyPosts();
                    setTimeout(setupMypageScroll, 100);
                }
            });
        });
        
        // チャットタブ切り替え（すべて/フレンド）
        const chatTabBtns = document.querySelectorAll('.chat-list-header .tab-btn');
        chatTabBtns.forEach(btn => {
            btn.addEventListener('click', async () => {
                const tabName = btn.dataset.tab;
                
                chatTabBtns.forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.chat-list-header + div, .chat-list-header + div + div').forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                const targetTab = document.getElementById(tabName + '-tab');
                if (targetTab) {
                    targetTab.classList.add('active');
                }
                
                // フレンドタブに切り替えた場合はフレンドのDMを読み込む
                if (tabName === 'friends-chat') {
                    await loadFriendsDMConversations();
                }
            });
        });
        
        // ルームタブ切り替え
        const roomTabBtns = document.querySelectorAll('#room-section .chat-list-header .tab-btn');
        
        if (roomTabBtns.length > 0) {
            console.log('ルームタブボタンが見つかりました:', roomTabBtns.length, '個');
            roomTabBtns.forEach(btn => {
                btn.addEventListener('click', async () => {
                    const tabName = btn.dataset.tab;
                    console.log('ルームタブクリック:', tabName);
                    
                    roomTabBtns.forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('#room-section .tab-content').forEach(c => c.classList.remove('active'));
                    
                    btn.classList.add('active');
                    const targetContent = document.getElementById(tabName + '-tab');
                    if (targetContent) {
                        targetContent.classList.add('active');
                        console.log('タブコンテンツを表示:', tabName);
                    }
                    
                    // ルームリストを読み込む
                    if (tabName === 'joined-rooms') {
                        await loadJoinedRooms();
                    } else if (tabName === 'available-rooms') {
                        await loadAvailableRooms();
                    }
                });
            });
        } else {
            console.warn('⚠️ ルームタブボタンが見つかりません');
        }
        
        // マッチ種類ボタン切り替え
        const matchTypeBtns = document.querySelectorAll('.match-type-btn');
        
        matchTypeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const matchType = btn.dataset.matchType;
                
                // 全てのボタンからactiveを削除
                matchTypeBtns.forEach(b => b.classList.remove('active'));
                
                // クリックされたボタンをアクティブに
                btn.classList.add('active');
                
                // マッチング処理をここに実装（例：ローディング表示やマッチング開始）
                console.log(`マッチングタイプ: ${matchType}`);
                startMatching(matchType);
            });
        });
        
        // ========================================
        // スワイプマッチングシステム
        // ========================================
        let swipeCandidates = [];
        let swipeIndex = 0;
        let currentMatchType = null;

        const swipeStack = document.getElementById('swipeCardStack');
        const swipeEmpty = document.getElementById('swipeEmpty');
        const swipeLoading = document.getElementById('swipeLoading');
        const swipeActions = document.getElementById('swipeActions');

        // マッチタイプ切り替え → カード読み込み
        function startMatching(matchType) {
            currentMatchType = matchType;
            swipeCandidates = [];
            swipeIndex = 0;

            swipeStack.innerHTML = '';
            swipeEmpty.style.display = 'none';
            swipeActions.style.display = 'none';
            swipeLoading.style.display = 'flex';

            fetch('/random-matching/api/candidates?type=' + matchType)
                .then(r => r.json())
                .then(data => {
                    swipeLoading.style.display = 'none';
                    if (data.success && data.candidates.length > 0) {
                        swipeCandidates = data.candidates;
                        swipeIndex = 0;
                        renderSwipeCards();
                        swipeActions.style.display = 'flex';
                    } else {
                        swipeEmpty.style.display = 'flex';
                    }
                })
                .catch(() => {
                    swipeLoading.style.display = 'none';
                    swipeEmpty.style.display = 'flex';
                });
        }

        // カードを最大2枚描画（現在 + 次）
        function renderSwipeCards() {
            swipeStack.innerHTML = '';
            for (let i = Math.min(swipeIndex + 1, swipeCandidates.length - 1); i >= swipeIndex; i--) {
                if (i >= swipeCandidates.length) continue;
                const card = createSwipeCard(swipeCandidates[i], i === swipeIndex);
                swipeStack.appendChild(card);
            }
        }

        // カードDOM生成
        function createSwipeCard(candidate, isTop) {
            const card = document.createElement('div');
            card.className = 'swipe-card';
            if (!isTop) {
                card.style.transform = 'scale(0.95) translateY(10px)';
                card.style.zIndex = '0';
            } else {
                card.style.zIndex = '1';
            }

            // タグHTML
            let tagsHtml = '';
            if (candidate.favoriteThings) {
                const tags = candidate.favoriteThings.split(',');
                tagsHtml = '<div class="swipe-card-tags">' +
                    tags.map(t => '<span class="swipe-card-tag">' + t.trim() + '</span>').join('') +
                    '</div>';
            }

            // 住所
            let locationHtml = '';
            if (candidate.location) {
                locationHtml = '<div class="swipe-card-location"><i class="fas fa-map-marker-alt"></i>' + candidate.location + '</div>';
            }

            card.innerHTML =
                '<div class="swipe-card-photo" style="background-image: url(\'' + candidate.photo + '\');"></div>' +
                '<div class="swipe-card-name">' + candidate.displayName + '</div>' +
                locationHtml +
                '<div class="swipe-stamp swipe-stamp-like">LIKE</div>' +
                '<div class="swipe-stamp swipe-stamp-skip">NOPE</div>' +
                '<div class="swipe-card-info">' +
                    tagsHtml +
                    '<div class="swipe-card-bio">' + (candidate.bio || '') + '</div>' +
                '</div>';

            if (isTop) {
                initSwipeGesture(card);
            }

            return card;
        }

        // スワイプジェスチャー
        function initSwipeGesture(card) {
            let startX = 0, startY = 0, currentX = 0, isDragging = false;
            const threshold = 100;

            function onStart(e) {
                isDragging = true;
                const point = e.touches ? e.touches[0] : e;
                startX = point.clientX;
                startY = point.clientY;
                card.style.transition = 'none';
            }

            function onMove(e) {
                if (!isDragging) return;
                const point = e.touches ? e.touches[0] : e;
                currentX = point.clientX - startX;
                const rotate = currentX * 0.08;
                card.style.transform = 'translateX(' + currentX + 'px) rotate(' + rotate + 'deg)';

                // スタンプ表示
                const likeStamp = card.querySelector('.swipe-stamp-like');
                const skipStamp = card.querySelector('.swipe-stamp-skip');
                const progress = Math.min(Math.abs(currentX) / threshold, 1);
                if (currentX > 0) {
                    likeStamp.style.opacity = progress;
                    skipStamp.style.opacity = 0;
                } else {
                    skipStamp.style.opacity = progress;
                    likeStamp.style.opacity = 0;
                }
            }

            function onEnd() {
                if (!isDragging) return;
                isDragging = false;

                if (currentX > threshold) {
                    animateOut(card, 'right');
                } else if (currentX < -threshold) {
                    animateOut(card, 'left');
                } else {
                    // 戻す
                    card.style.transition = 'transform 0.3s ease';
                    card.style.transform = '';
                    card.querySelector('.swipe-stamp-like').style.opacity = 0;
                    card.querySelector('.swipe-stamp-skip').style.opacity = 0;
                }
                currentX = 0;
            }

            card.addEventListener('pointerdown', onStart);
            card.addEventListener('pointermove', onMove);
            card.addEventListener('pointerup', onEnd);
            card.addEventListener('pointerleave', onEnd);
        }

        // カード飛ばしアニメーション
        function animateOut(card, direction) {
            card.classList.add('animating');
            const xOut = direction === 'right' ? 500 : -500;
            const rotate = direction === 'right' ? 30 : -30;
            card.style.transform = 'translateX(' + xOut + 'px) rotate(' + rotate + 'deg)';
            card.style.opacity = '0';

            const candidate = swipeCandidates[swipeIndex];
            if (direction === 'right' && candidate) {
                fetch('/random-matching/api/like', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'targetUserId=' + candidate.userId
                })
                .then(r => r.json())
                .then(data => {
                    if (data.mutual) {
                        showMatchNotification(candidate.displayName);
                    }
                    refreshMatchBadges();
                })
                .catch(err => console.error('Like送信エラー:', err));
            }

            setTimeout(() => {
                swipeIndex++;
                if (swipeIndex < swipeCandidates.length) {
                    renderSwipeCards();
                } else {
                    swipeStack.innerHTML = '';
                    swipeActions.style.display = 'none';
                    swipeEmpty.style.display = 'flex';
                    swipeEmpty.querySelector('p').textContent = '候補者を全て確認しました';
                }
            }, 400);
        }

        // ボタンでのスワイプ操作
        document.getElementById('btnSwipeSkip').addEventListener('click', function() {
            const topCard = swipeStack.querySelector('.swipe-card[style*="z-index: 1"]') ||
                            swipeStack.querySelector('.swipe-card:last-child');
            if (topCard) animateOut(topCard, 'left');
        });

        document.getElementById('btnSwipeLike').addEventListener('click', function() {
            const topCard = swipeStack.querySelector('.swipe-card[style*="z-index: 1"]') ||
                            swipeStack.querySelector('.swipe-card:last-child');
            if (topCard) animateOut(topCard, 'right');
        });

        // ========================================
        // マッチ サブフッター タブ切り替え
        // ========================================
        const matchContent = document.getElementById('matchContent');
        const matchLikePanel = document.getElementById('matchLikePanel');
        const matchLikeList = document.getElementById('matchLikeList');
        let currentLikeTab = 'swipe';
        let likeSwipeCandidates = [];
        let likeSwipeIndex = 0;

        document.querySelectorAll('.match-sub-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const likeTab = this.dataset.likeTab;
                if (likeTab === currentLikeTab) return;

                document.querySelectorAll('.match-sub-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentLikeTab = likeTab;

                if (likeTab === 'swipe') {
                    matchContent.style.display = 'flex';
                    matchLikePanel.style.display = 'none';
                } else if (likeTab === 'sent' || likeTab === 'received') {
                    matchContent.style.display = 'none';
                    matchLikePanel.style.display = 'block';
                    loadLikeSwipe(likeTab);
                } else {
                    matchContent.style.display = 'none';
                    matchLikePanel.style.display = 'block';
                    loadLikeList(likeTab);
                }
            });
        });

        // いいね/もらったをスワイプカードで表示
        function loadLikeSwipe(kind) {
            matchLikeList.innerHTML = '<div style="text-align:center;padding:40px 0;"><i class="fas fa-spinner fa-spin fa-2x" style="color:rgba(255,255,255,0.3);"></i></div>';

            fetch('/random-matching/api/likes/' + kind)
                .then(r => r.json())
                .then(data => {
                    if (!data.success || data.users.length === 0) {
                        const emptyMessages = {
                            sent: 'まだいいねしていません',
                            received: 'まだいいねをもらっていません'
                        };
                        matchLikeList.innerHTML =
                            '<div class="match-like-empty">' +
                            '<i class="fas fa-heart-broken"></i>' +
                            '<p>' + emptyMessages[kind] + '</p></div>';
                        return;
                    }

                    likeSwipeCandidates = data.users;
                    likeSwipeIndex = 0;
                    renderLikeSwipeCards(kind);
                })
                .catch(() => {
                    matchLikeList.innerHTML = '<div class="match-like-empty"><p>読み込みに失敗しました</p></div>';
                });
        }

        function renderLikeSwipeCards(kind) {
            matchLikeList.innerHTML = '';

            if (likeSwipeIndex >= likeSwipeCandidates.length) {
                const doneMsg = kind === 'sent' ? 'すべて確認しました' : 'すべて確認しました';
                matchLikeList.innerHTML =
                    '<div class="match-like-empty">' +
                    '<i class="fas fa-check-circle"></i>' +
                    '<p>' + doneMsg + '</p></div>';
                return;
            }

            // スワイプカードスタック
            const stack = document.createElement('div');
            stack.className = 'swipe-card-stack';
            stack.style.flex = '1';

            for (let i = Math.min(likeSwipeIndex + 1, likeSwipeCandidates.length - 1); i >= likeSwipeIndex; i--) {
                if (i >= likeSwipeCandidates.length) continue;
                const isTop = (i === likeSwipeIndex);
                const card = createSwipeCard(likeSwipeCandidates[i], isTop);

                // スワイプジェスチャーを上書き（方向制限付き）
                if (isTop) {
                    // 既存のジェスチャーを無効化してから制限付きを設定
                    card.replaceWith(card.cloneNode(true));
                    const freshCard = stack.querySelector('.swipe-card:last-child') || card;
                    initLikeSwipeGesture(freshCard, kind);
                }

                stack.appendChild(card);
            }

            matchLikeList.appendChild(stack);

            // アクションボタン
            const actions = document.createElement('div');
            actions.className = 'swipe-actions';

            if (kind === 'sent') {
                // いいねタブ: 左スワイプ（取り消し）のみ
                actions.innerHTML =
                    '<button class="swipe-btn swipe-btn-skip" id="btnLikeSwipeSkip">' +
                    '<i class="fas fa-times"></i></button>';
            } else {
                // もらったタブ: 左（拒否）+ 右（いいね返し）
                actions.innerHTML =
                    '<button class="swipe-btn swipe-btn-skip" id="btnLikeSwipeSkip">' +
                    '<i class="fas fa-times"></i></button>' +
                    '<button class="swipe-btn swipe-btn-like" id="btnLikeSwipeLike">' +
                    '<i class="fas fa-heart"></i></button>';
            }

            matchLikeList.appendChild(actions);

            // ボタンイベント
            const skipBtn = document.getElementById('btnLikeSwipeSkip');
            if (skipBtn) {
                skipBtn.addEventListener('click', function() {
                    const topCard = stack.querySelector('.swipe-card[style*="z-index: 1"]') ||
                                    stack.querySelector('.swipe-card:last-child');
                    if (topCard) animateLikeOut(topCard, 'left', kind);
                });
            }
            const likeBtn = document.getElementById('btnLikeSwipeLike');
            if (likeBtn) {
                likeBtn.addEventListener('click', function() {
                    const topCard = stack.querySelector('.swipe-card[style*="z-index: 1"]') ||
                                    stack.querySelector('.swipe-card:last-child');
                    if (topCard) animateLikeOut(topCard, 'right', kind);
                });
            }
        }

        // 方向制限付きスワイプジェスチャー
        function initLikeSwipeGesture(card, kind) {
            let startX = 0, currentX = 0, isDragging = false;
            const threshold = 100;

            function onStart(e) {
                isDragging = true;
                const point = e.touches ? e.touches[0] : e;
                startX = point.clientX;
                card.style.transition = 'none';
            }

            function onMove(e) {
                if (!isDragging) return;
                const point = e.touches ? e.touches[0] : e;
                currentX = point.clientX - startX;

                // いいねタブ: 右スワイプを制限
                if (kind === 'sent' && currentX > 0) {
                    currentX = currentX * 0.2; // 抵抗感を出す
                }

                const rotate = currentX * 0.08;
                card.style.transform = 'translateX(' + currentX + 'px) rotate(' + rotate + 'deg)';

                const likeStamp = card.querySelector('.swipe-stamp-like');
                const skipStamp = card.querySelector('.swipe-stamp-skip');
                const progress = Math.min(Math.abs(currentX) / threshold, 1);

                if (currentX > 0 && kind !== 'sent') {
                    likeStamp.style.opacity = progress;
                    skipStamp.style.opacity = 0;
                } else if (currentX < 0) {
                    skipStamp.style.opacity = progress;
                    likeStamp.style.opacity = 0;
                } else {
                    likeStamp.style.opacity = 0;
                    skipStamp.style.opacity = 0;
                }
            }

            function onEnd() {
                if (!isDragging) return;
                isDragging = false;

                if (currentX > threshold && kind !== 'sent') {
                    animateLikeOut(card, 'right', kind);
                } else if (currentX < -threshold) {
                    animateLikeOut(card, 'left', kind);
                } else {
                    card.style.transition = 'transform 0.3s ease';
                    card.style.transform = '';
                    card.querySelector('.swipe-stamp-like').style.opacity = 0;
                    card.querySelector('.swipe-stamp-skip').style.opacity = 0;
                }
                currentX = 0;
            }

            card.addEventListener('pointerdown', onStart);
            card.addEventListener('pointermove', onMove);
            card.addEventListener('pointerup', onEnd);
            card.addEventListener('pointerleave', onEnd);
        }

        // いいね/もらったカードのアニメーション飛ばし
        function animateLikeOut(card, direction, kind) {
            card.classList.add('animating');
            const xOut = direction === 'right' ? 500 : -500;
            const rotate = direction === 'right' ? 30 : -30;
            card.style.transition = 'transform 0.4s ease, opacity 0.4s ease';
            card.style.transform = 'translateX(' + xOut + 'px) rotate(' + rotate + 'deg)';
            card.style.opacity = '0';

            const user = likeSwipeCandidates[likeSwipeIndex];
            if (!user) return;

            if (kind === 'sent' && direction === 'left') {
                // いいねタブ: 左スワイプ → いいね取り消し
                fetch('/random-matching/api/unlike', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'targetUserId=' + user.userId
                }).then(() => refreshMatchBadges()).catch(err => console.error('Unlike error:', err));
            } else if (kind === 'received' && direction === 'right') {
                // もらったタブ: 右スワイプ → いいね返し
                fetch('/random-matching/api/like', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'targetUserId=' + user.userId
                })
                .then(r => r.json())
                .then(data => {
                    if (data.mutual) {
                        showMatchNotification(user.displayName);
                    }
                    refreshMatchBadges();
                })
                .catch(err => console.error('Like error:', err));
            } else if (kind === 'received' && direction === 'left') {
                // もらったタブ: 左スワイプ → 拒否
                fetch('/random-matching/api/reject', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'fromUserId=' + user.userId
                }).then(() => refreshMatchBadges()).catch(err => console.error('Reject error:', err));
            }

            setTimeout(() => {
                likeSwipeIndex++;
                renderLikeSwipeCards(kind);
            }, 400);
        }

        // マッチ一覧をリスト表示（mutualタブ用）
        function loadLikeList(kind) {
            matchLikeList.innerHTML = '<div style="text-align:center;padding:40px 0;"><i class="fas fa-spinner fa-spin fa-2x" style="color:rgba(255,255,255,0.3);"></i></div>';

            fetch('/random-matching/api/likes/' + kind)
                .then(r => r.json())
                .then(data => {
                    if (!data.success || data.users.length === 0) {
                        matchLikeList.innerHTML =
                            '<div class="match-like-empty">' +
                            '<i class="fas fa-heart-broken"></i>' +
                            '<p>まだマッチが成立していません</p></div>';
                        return;
                    }
                    matchLikeList.innerHTML = '';
                    data.users.forEach(u => {
                        const item = document.createElement('div');
                        item.className = 'match-like-item';
                        item.dataset.userId = u.userId;

                        let avatarHtml;
                        if (u.photo) {
                            avatarHtml = '<img src="' + u.photo + '" alt="">';
                        } else {
                            avatarHtml = '<i class="fas fa-user"></i>';
                        }

                        item.innerHTML =
                            '<div class="match-like-avatar">' + avatarHtml + '</div>' +
                            '<div class="match-like-info">' +
                                '<div class="match-like-name">' + u.displayName + '</div>' +
                                '<div class="match-like-bio">' + (u.bio || '') + '</div>' +
                            '</div>';

                        item.addEventListener('click', function() {
                            viewUserProfile(u.userId);
                        });

                        matchLikeList.appendChild(item);
                    });
                })
                .catch(() => {
                    matchLikeList.innerHTML = '<div class="match-like-empty"><p>読み込みに失敗しました</p></div>';
                });
        }

        // バッジ更新
        function refreshMatchBadges() {
            ['sent', 'received', 'mutual'].forEach(kind => {
                fetch('/random-matching/api/likes/' + kind)
                    .then(r => r.json())
                    .then(data => {
                        if (!data.success) return;
                        const badge = document.getElementById('badgeLike' + kind.charAt(0).toUpperCase() + kind.slice(1));
                        if (data.count > 0) {
                            badge.textContent = data.count;
                            badge.style.display = 'flex';
                        } else {
                            badge.style.display = 'none';
                        }
                    })
                    .catch(() => {});
            });
        }

        // マッチ成立通知
        function showMatchNotification(name) {
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s;';
            overlay.innerHTML =
                '<div style="text-align:center;color:white;">' +
                '<i class="fas fa-heart" style="font-size:4rem;color:#ff6b6b;margin-bottom:16px;"></i>' +
                '<h2 style="margin:0 0 8px;">マッチ成立!</h2>' +
                '<p style="color:rgba(255,255,255,0.7);">' + name + ' さんとマッチしました</p>' +
                '</div>';
            overlay.addEventListener('click', () => overlay.remove());
            document.body.appendChild(overlay);
            setTimeout(() => overlay.remove(), 3000);
        }

        // 参加ボタン
        document.querySelectorAll('.btn-join').forEach(btn => {
            btn.addEventListener('click', async function(e) {
                e.stopPropagation();
                const roomId = this.dataset.roomId;
                
                try {
                    const response = await fetch(`/rooms/${roomId}/join`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        window.location.href = data.redirectUrl;
                    } else {
                        alert(data.message);
                    }
                } catch (error) {
                    alert('エラーが発生しました');
                }
            });
        });
        
        // 投稿ボタン - 投稿画面へ遷移
        const btnCreatePost = document.getElementById('btnCreatePost');
        const btnBackFromPost = document.getElementById('btnBackFromPost');
        const createPostSection = document.getElementById('create-post-section');
        const homeSection = document.getElementById('home-section');
        
        if (btnCreatePost) {
            btnCreatePost.addEventListener('click', () => {
                sections.forEach(section => section.classList.remove('active'));
                createPostSection.classList.add('active');
            });
        }
        
        if (btnBackFromPost) {
            btnBackFromPost.addEventListener('click', () => {
                createPostSection.classList.remove('active');
                homeSection.classList.add('active');
                navItems.forEach(nav => nav.classList.remove('active'));
                navItems[0].classList.add('active');
            });
        }

        // ルーム作成ボタン - ルーム作成画面へ遷移
        const btnCreateRoom = document.getElementById('btnCreateRoom');
        const btnBackFromRoom = document.getElementById('btnBackFromRoom');
        const createRoomSection = document.getElementById('create-room-section');
        const roomSection = document.getElementById('room-section');

        if (btnCreateRoom) {
            btnCreateRoom.addEventListener('click', async () => {
                sections.forEach(section => section.classList.remove('active'));
                createRoomSection.classList.add('active');
                // フレンドリストを読み込み
                await loadFriendsForInvite();
            });
        }

        if (btnBackFromRoom) {
            btnBackFromRoom.addEventListener('click', () => {
                createRoomSection.classList.remove('active');
                roomSection.classList.add('active');
                navItems.forEach(nav => nav.classList.remove('active'));
                navItems[1].classList.add('active'); // ルームタブをアクティブに
            });
        }

        // ルームタブの切り替え（5つ全て）- キャッシュを使わず常に最新データを取得
        const roomTabButtons = document.querySelectorAll('#room-section .tab-btn');
        const roomTabContents = document.querySelectorAll('#room-section .tab-content');

        roomTabButtons.forEach(button => {
            button.addEventListener('click', async () => {
                // 全てのタブボタンとコンテンツの active を削除
                roomTabButtons.forEach(btn => btn.classList.remove('active'));
                roomTabContents.forEach(content => content.classList.remove('active'));

                // クリックされたタブボタンを active に
                button.classList.add('active');

                // data-tab属性があれば対応するコンテンツを表示
                const targetTab = button.getAttribute('data-tab');
                if (targetTab) {
                    const targetContent = document.getElementById(targetTab + '-tab');
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                }

                // タブに応じてデータを再読み込み（キャッシュクリア効果）
                console.log('🔄 ルームタブ切り替え - データ再読み込み:', targetTab || button.id);

                if (targetTab === 'joined-rooms') {
                    await loadJoinedRooms();
                } else if (targetTab === 'available-rooms') {
                    await loadAvailableRooms();
                } else if (button.id === 'btnRoomRequests') {
                    console.log('📥 申請タブがクリックされました');
                    document.getElementById('requests-tab').classList.add('active');
                    await loadRequestedRooms();
                } else if (button.id === 'btnRoomApprovals') {
                    console.log('✅ 承認タブがクリックされました');
                    document.getElementById('approvals-tab').classList.add('active');
                    await loadPendingApprovals();
                } else if (button.id === 'btnRoomInvite') {
                    console.log('👥 招待タブがクリックされました');
                    document.getElementById('invite-tab').classList.add('active');
                    await loadReceivedInvitations();
                }
            });
        });

        // ルーム作成フォーム送信
        const createRoomForm = document.getElementById('createRoomForm');
        if (createRoomForm) {
            createRoomForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = new FormData(createRoomForm);

                // 選択されたフレンドのusernameを取得
                const selectedFriends = Array.from(document.querySelectorAll('.friend-checkbox:checked'))
                    .map(checkbox => checkbox.dataset.username);

                const roomData = {
                    name: formData.get('name'),
                    description: formData.get('description'),
                    type: 'GROUP',
                    isPublic: formData.get('isPublic') === 'true',
                    invitedUsernames: selectedFriends.join(',')  // カンマ区切りで送信
                };

                try {
                    console.log('🚀 ルーム作成開始:', roomData);
                    const response = await fetch('/rooms/api/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams(roomData)
                    });

                    const data = await response.json();
                    console.log('📦 ルーム作成レスポンス:', data);

                    if (data.success) {
                        // フォームをリセット
                        createRoomForm.reset();
                        // チェックボックスもリセット
                        document.querySelectorAll('.friend-checkbox').forEach(cb => cb.checked = false);

                        // ルーム画面に戻る
                        createRoomSection.classList.remove('active');
                        roomSection.classList.add('active');

                        // ルームリストを再読み込み
                        await loadJoinedRooms();

                        alert('ルームを作成しました!');
                        console.log('✅ ルーム作成成功 - ID:', data.roomId);
                    } else {
                        alert(data.message || 'ルームの作成に失敗しました');
                        console.error('❌ ルーム作成失敗:', data.message);
                    }
                } catch (error) {
                    console.error('❌ ルーム作成エラー:', error);
                    alert('ルームの作成中にエラーが発生しました');
                }
            });
        }

        // 文字カウンター
        const postContent = document.getElementById('postContent');
        const charCounter = document.getElementById('charCounter');
        
        if (postContent && charCounter) {
            postContent.addEventListener('input', function() {
                const length = this.value.length;
                charCounter.textContent = length + ' / 1000';
                
                if (length > 900) {
                    charCounter.style.color = '#dc3545';
                } else if (length > 800) {
                    charCounter.style.color = '#ffc107';
                } else {
                    charCounter.style.color = '#6c757d';
                }
            });
        }
        
        // ファイルアップロード - プレビュー機能
        const mediaUpload = document.getElementById('mediaUpload');
        const uploadArea = document.getElementById('uploadArea');
        const previewContainer = document.getElementById('previewContainer');
        
        if (mediaUpload && previewContainer) {
            mediaUpload.addEventListener('change', function(e) {
                previewFiles(e.target.files);
            });
            
            // ドラッグ＆ドロップ
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                previewFiles(e.dataTransfer.files);
                mediaUpload.files = e.dataTransfer.files;
            });
        }
        
        function previewFiles(files) {
            previewContainer.innerHTML = '';
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    
                    if (file.type.startsWith('image/')) {
                        previewItem.innerHTML = `
                            <img src="${e.target.result}" alt="プレビュー">
                            <button type="button" class="btn-remove-preview" onclick="this.parentElement.remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                    } else if (file.type.startsWith('video/')) {
                        previewItem.innerHTML = `
                            <video src="${e.target.result}" controls></video>
                            <button type="button" class="btn-remove-preview" onclick="this.parentElement.remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                    }
                    
                    previewContainer.appendChild(previewItem);
                };
                
                reader.readAsDataURL(file);
            });
        }
        
        // ユーザー名から色を決定する関数
        function getUserColor(username) {
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            return Math.abs(hash) % 10;
        }
        
        // デフォルトアイコンに色を設定
        document.addEventListener('DOMContentLoaded', function() {
            // すべてのデフォルトアバターに色を設定
            document.querySelectorAll('.default-avatar').forEach(avatar => {
                setDefaultAvatarColor(avatar);
            });
            
            // マイページのアバターにも色を設定
            document.querySelectorAll('.profile-avatar').forEach(avatar => {
                setDefaultAvatarColor(avatar);
            });
            
            // スライドメニューの制御
            const mypageMenuBtn = document.getElementById('mypageMenuBtn');
            const slideMenu = document.getElementById('slideMenu');
            const slideMenuOverlay = document.getElementById('slideMenuOverlay');
            const slideMenuClose = document.getElementById('slideMenuClose');
            
            if (mypageMenuBtn && slideMenu && slideMenuOverlay) {
                // メニューを開く
                mypageMenuBtn.addEventListener('click', () => {
                    slideMenu.classList.add('active');
                    slideMenuOverlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                });
                
                // メニューを閉じる（オーバーレイクリック）
                slideMenuOverlay.addEventListener('click', () => {
                    slideMenu.classList.remove('active');
                    slideMenuOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                });
                
                // メニューを閉じる（×ボタン）
                if (slideMenuClose) {
                    slideMenuClose.addEventListener('click', () => {
                        slideMenu.classList.remove('active');
                        slideMenuOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                    });
                }
            }
        });
        
        // ユーザープロフィール閲覧機能
        let currentViewedUserId = null; // 閲覧中のユーザーID
        
        async function viewUserProfile(userId) {
            // 現在のログインユーザーのIDを取得
            const currentUserId = document.querySelector('.app-container').dataset.currentUserId;
            
            // 閲覧中のユーザーIDを保存
            currentViewedUserId = userId;
            
            // 自分のプロフィールをクリックした場合はマイページに遷移
            if (userId === currentUserId) {
                // マイページに遷移
                sections.forEach(section => section.classList.remove('active'));
                document.getElementById('mypage-section').classList.add('active');
                navItems.forEach(nav => nav.classList.remove('active'));
                // マイページのナビゲーションアイテムをアクティブにする（最後のアイテム）
                navItems[navItems.length - 1].classList.add('active');
                createPostBtn.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/users/${userId}/profile`);
                const data = await response.json();
                
                console.log('===== プロフィール取得 =====');
                console.log('UserID:', userId);
                console.log('APIレスポンス:', data);
                console.log('Following:', data.followingCount);
                console.log('Follower:', data.followerCount);
                console.log('Friend:', data.friendCount);
                
                if (data.success) {
                    // プロフィール情報を表示
                    const viewedProfileContent = document.getElementById('viewedProfileContent');
                    const user = data.user;
                    const profile = data.profile;
                    
                    // アイコンのHTML
                    let avatarHtml = '';
                    if (profile && profile.avatarUrl) {
                        avatarHtml = `<div class="profile-avatar" style="background-image: url(${profile.avatarUrl}); background-size: cover; background-position: center;"></div>`;
                    } else {
                        const colorIndex = getUserColor(user.username);
                        avatarHtml = `<div class="profile-avatar default-avatar" data-username="${user.username}" data-color="${colorIndex}"><i class="fas fa-user"></i></div>`;
                    }
                    
                    // タグのHTML
                    let tagsHtml = '';
                    if (profile && profile.favoriteThings) {
                        const tags = profile.favoriteThings.split(',').map(tag => tag.trim()).filter(tag => tag);
                        if (tags.length > 0) {
                            tagsHtml = `
                                <div class="profile-tags-container">
                                    <div class="profile-tags-scroll">
                                        ${tags.map(tag => `<span class="profile-tag">${tag}</span>`).join('')}
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    viewedProfileContent.innerHTML = `
                        <div class="profile-main-top">
                            ${avatarHtml}
                            <div class="profile-info-top">
                                <h2 class="profile-username">${profile && profile.displayName ? profile.displayName : user.username}</h2>
                                <p class="profile-friendcode">${user.friendCode ? 'FC: ' + user.friendCode : 'FC: 未設定'}</p>
                            </div>
                        </div>
                        <div class="profile-info-bottom" style="text-align: left;">
                            <p class="profile-bio ${!profile || !profile.bio ? 'text-muted' : ''}" style="text-align: left !important;">${profile && profile.bio ? profile.bio : '自己紹介が未設定です'}</p>
                            ${tagsHtml}
                            <div class="profile-stats">
                                <div class="stat-item">
                                    <span class="stat-label">フォロー</span>
                                    <span class="stat-value">${data.followingCount || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">フォロワー</span>
                                    <span class="stat-value" id="targetFollowerCount">${data.followerCount || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">フレンド</span>
                                    <span class="stat-value">${data.friendCount || 0}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // フォロー状態を取得してボタンを更新
                    await updateFollowButton(userId);
                    
                    // チャットボタンにユーザーIDを設定
                    const btnStartChat = document.getElementById('btnStartChat');
                    btnStartChat.dataset.userId = userId;
                    
                    // 画面切り替え
                    sections.forEach(section => section.classList.remove('active'));
                    document.getElementById('user-profile-view-section').classList.add('active');
                    navItems.forEach(nav => nav.classList.remove('active'));
                    
                    // DM画面を確実に非表示
                    const dmSection = document.getElementById('dm-section');
                    if (dmSection) {
                        dmSection.style.display = 'none';
                        dmSection.classList.remove('active');
                    }
                    
                    // プロフィールアクションボタンを表示、フッターを非表示
                    const profileActions = document.getElementById('profileActions');
                    if (profileActions) {
                        profileActions.style.cssText = 'display: flex;';
                    }
                    const bottomNav = document.querySelector('.bottom-nav');
                    if (bottomNav) {
                        bottomNav.style.display = 'none';
                    }
                    createPostBtn.style.display = 'none';

                    // そのユーザーの投稿を読み込む
                    loadUserPosts(userId);

                    // スクロールハンドラを設定
                    setTimeout(() => setupUserProfileScroll(), 100);
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                alert('プロフィールの読み込みに失敗しました');
            }
        }
        
        // フォローボタンの状態を更新
        async function updateFollowButton(userId) {
            try {
                const response = await fetch(`/api/users/${userId}/relationship`);
                const data = await response.json();
                
                if (data.success) {
                    const followBtn = document.getElementById('btnFollowUser');
                    const relationship = data.relationship;
                    
                    // relationship: "friend" (相互フォロー), "following" (フォロー中), "follower" (フォローされている), "none" (関係なし)
                    if (relationship === 'friend') {
                        followBtn.innerHTML = '<i class="fas fa-user-check me-2"></i>フレンド';
                        followBtn.classList.add('following');
                        followBtn.dataset.relationship = 'friend'; // データ属性に関係性を保存
                    } else if (relationship === 'following') {
                        followBtn.innerHTML = '<i class="fas fa-user-check me-2"></i>フォロー中';
                        followBtn.classList.add('following');
                        followBtn.dataset.relationship = 'following'; // データ属性に関係性を保存
                    } else if (relationship === 'follower') {
                        followBtn.innerHTML = '<i class="fas fa-user-plus me-2"></i>フォローバック';
                        followBtn.classList.remove('following');
                        followBtn.dataset.relationship = 'follower';
                    } else {
                        followBtn.innerHTML = '<i class="fas fa-user-plus me-2"></i>フォロー';
                        followBtn.classList.remove('following');
                        followBtn.dataset.relationship = 'none';
                    }
                }
            } catch (error) {
                console.error('Error getting relationship:', error);
            }
        }
        
        // フォローボタンのクリックイベント
        const btnFollowUser = document.getElementById('btnFollowUser');
        if (btnFollowUser) {
            btnFollowUser.addEventListener('click', async () => {
                if (!currentViewedUserId) {
                    return;
                }
                
                const isFollowing = btnFollowUser.classList.contains('following');
                const relationship = btnFollowUser.dataset.relationship;
                
                // フォロー済み・フレンドの場合は確認ダイアログを表示
                if (isFollowing) {
                    let confirmMessage = 'フォローを解除しますか？';
                    
                    // フレンドの場合は明示的にメッセージを変更
                    if (relationship === 'friend') {
                        confirmMessage = 'フレンド関係を解除しますか？\n（相互フォローが解除されます）';
                    }
                    
                    const confirmUnfollow = confirm(confirmMessage);
                    if (!confirmUnfollow) {
                        return; // キャンセルされた場合は何もしない
                    }
                }
                
                const endpoint = isFollowing ? 'unfollow' : 'follow';
                
                // ボタンを一時的に無効化
                btnFollowUser.disabled = true;
                const originalText = btnFollowUser.innerHTML;
                btnFollowUser.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>処理中...';
                
                try {
                    const response = await fetch(`/api/users/${currentViewedUserId}/${endpoint}`, {
                        method: 'POST'
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        // ボタンの状態を即座に更新
                        await updateFollowButton(currentViewedUserId);
                        
                        console.log('Follow response data:', data); // デバッグログ
                        
                        // 閲覧中のプロフィールのフォロワー数を更新
                        const followerCountElement = document.getElementById('targetFollowerCount');
                        if (followerCountElement && data.targetFollowerCount !== undefined) {
                            console.log('Updating targetFollowerCount to:', data.targetFollowerCount); // デバッグログ
                            followerCountElement.textContent = data.targetFollowerCount;
                        } else {
                            console.warn('targetFollowerCount element not found or data missing'); // デバッグログ
                        }
                        
                        // マイページのフォロー/フォロワー/フレンド数を更新
                        const myFollowingCount = document.getElementById('myFollowingCount');
                        if (myFollowingCount && data.followingCount !== undefined) {
                            myFollowingCount.textContent = data.followingCount;
                        }
                        
                        const myFollowerCount = document.getElementById('myFollowerCount');
                        if (myFollowerCount && data.followerCount !== undefined) {
                            myFollowerCount.textContent = data.followerCount;
                        }
                        
                        const myFriendCount = document.getElementById('myFriendCount');
                        if (myFriendCount && data.friendCount !== undefined) {
                            myFriendCount.textContent = data.friendCount;
                        }
                        
                        // 成功メッセージを表示（オプション）
                        // alert(data.message);
                    } else {
                        alert(data.message || 'エラーが発生しました');
                        btnFollowUser.innerHTML = originalText; // エラー時は元に戻す
                    }
                } catch (error) {
                    console.error('Error toggling follow:', error);
                    alert('エラーが発生しました');
                    btnFollowUser.innerHTML = originalText; // エラー時は元に戻す
                } finally {
                    // ボタンを再度有効化
                    btnFollowUser.disabled = false;
                }
            });
        }
        
        // ユーザープロファイルリンクのクリックイベント
        document.addEventListener('click', function(e) {
            const target = e.target.closest('.user-profile-link');
            if (target && target.dataset.userId) {
                const userId = target.dataset.userId;
                const friendCode = target.dataset.friendCode;
                const username = target.dataset.username;
                console.log('===== プロフィールクリック =====');
                console.log('クリックされた要素:', target);
                console.log('User ID:', userId);
                console.log('Friend Code:', friendCode);
                console.log('Username:', username);
                console.log('================================');
                viewUserProfile(userId);
            }
        });
        
        // 戻るボタン
        const backToHomeBtn = document.getElementById('backToHomeBtn');
        if (backToHomeBtn) {
            backToHomeBtn.addEventListener('click', () => {
                sections.forEach(section => section.classList.remove('active'));
                homeSection.classList.add('active');
                navItems.forEach(nav => nav.classList.remove('active'));
                navItems[0].classList.add('active');
                createPostBtn.style.display = 'flex';
                
                // プロフィールアクションボタンを非表示、フッターを再表示
                document.getElementById('profileActions').style.display = 'none';
                document.querySelector('.bottom-nav').style.display = 'flex';
            });
        }
        
        // スワイプジェスチャーで戻る
        const userProfileViewSection = document.getElementById('user-profile-view-section');
        if (userProfileViewSection) {
            let touchStartX = 0;
            let touchEndX = 0;
            
            userProfileViewSection.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });
            
            userProfileViewSection.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });
            
            function handleSwipe() {
                if (touchEndX - touchStartX > 100) { // 右スワイプ
                    backToHomeBtn.click();
                }
            }
        }
        
        // ========================================
        // ルーム機能
        // ========================================
        
        // 参加中のルームリストを読み込む
        async function loadJoinedRooms() {
            try {
                console.log('📋 参加中のルームリストを読み込み中...');
                const response = await fetch('/rooms/api/joined', {
                    credentials: 'same-origin',
                    cache: 'no-store',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    console.error('❌ API呼び出し失敗:', response.status);
                    return;
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('❌ JSONではないレスポンスを受信:', contentType);
                    return;
                }

                const data = await response.json();

                if (!data.success) {
                    console.error('❌ ルームリスト取得失敗:', data.message);
                    return;
                }

                const rooms = data.rooms || [];
                console.log('✅ 参加中のルーム取得:', rooms.length, '件');

                displayRoomList(rooms, 'joined-rooms-tab');
            } catch (error) {
                console.error('❌ 参加中のルームリスト読み込みエラー:', error);
            }
        }
        
        // 参加可能なルームリストを読み込む
        async function loadAvailableRooms() {
            try {
                // 先に申請済みルームIDを取得（表示時に必要）
                await fetchRequestedRoomIds();

                console.log('📋 参加可能なルームリストを読み込み中...');
                const response = await fetch('/rooms/api/available', {
                    credentials: 'same-origin',
                    cache: 'no-store',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    console.error('❌ API呼び出し失敗:', response.status);
                    return;
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('❌ JSONではないレスポンスを受信:', contentType);
                    return;
                }

                const data = await response.json();

                if (!data.success) {
                    console.error('❌ ルームリスト取得失敗:', data.message);
                    return;
                }

                const rooms = data.rooms || [];
                console.log('✅ 参加可能なルーム取得:', rooms.length, '件');

                displayAvailableRoomList(rooms, 'available-rooms-tab');
            } catch (error) {
                console.error('❌ 参加可能なルームリスト読み込みエラー:', error);
            }
        }

        // 申請済みルームIDのみを取得（UIは更新しない）
        async function fetchRequestedRoomIds() {
            try {
                const response = await fetch('/rooms/api/my-requests', {
                    credentials: 'same-origin',
                    cache: 'no-store',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) return;

                const data = await response.json();
                if (data.success) {
                    const rooms = data.rooms || [];
                    window.requestedRoomIds = new Set(rooms.map(room => room.id));
                }
            } catch (error) {
                console.error('❌ 申請済みルームID取得エラー:', error);
            }
        }

        // 申請中のルームリストを読み込む
        async function loadRequestedRooms() {
            try {
                console.log('📋 申請中のルームリストを読み込み中...');
                const response = await fetch('/rooms/api/my-requests', {
                    credentials: 'same-origin',
                    cache: 'no-store',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    console.error('❌ API呼び出し失敗:', response.status);
                    return;
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('❌ JSONではないレスポンスを受信:', contentType);
                    return;
                }

                const data = await response.json();

                if (!data.success) {
                    console.error('❌ 申請中のルームリスト取得失敗:', data.message);
                    return;
                }

                const rooms = data.rooms || [];
                console.log('✅ 申請中のルーム取得:', rooms.length, '件');

                // 申請中のルームIDをグローバル変数に保存
                window.requestedRoomIds = new Set(rooms.map(room => room.id));
                console.log('📝 申請中のルームID:', [...window.requestedRoomIds]);

                displayRequestedRoomList(rooms);

                // バッジを更新
                updateRequestBadge(rooms.length);
            } catch (error) {
                console.error('❌ 申請中のルームリスト読み込みエラー:', error);
            }
        }

        // ルーム作成時のフレンド招待リストを読み込む
        async function loadFriendsForInvite() {
            const container = document.getElementById('friendSelectionContainer');
            if (!container) return;

            try {
                console.log('👥 フレンドリストを読み込み中...');
                const response = await fetch('/friends/api/list', {
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    container.innerHTML = '<p class="error-text">フレンドリストの読み込みに失敗しました</p>';
                    return;
                }

                const friends = await response.json();
                console.log('✅ フレンド取得:', friends.length, '人');

                if (friends.length === 0) {
                    container.innerHTML = '<p class="empty-text">フレンドがいません</p>';
                    return;
                }

                // フレンドリストを表示
                let html = '<div class="friend-select-list">';
                friends.forEach(friend => {
                    const avatarUrl = friend.avatarUrl || '/images/default-avatar.png';
                    html += `
                        <label class="friend-select-item">
                            <input type="checkbox" class="friend-checkbox" data-username="${escapeHtml(friend.username)}">
                            <img src="${escapeHtml(avatarUrl)}" class="friend-avatar" alt="${escapeHtml(friend.displayName)}">
                            <span class="friend-name">${escapeHtml(friend.displayName)}</span>
                        </label>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                console.error('❌ フレンドリスト読み込みエラー:', error);
                container.innerHTML = '<p class="error-text">エラーが発生しました</p>';
            }
        }

        // 申請中のルームリストを表示
        function displayRequestedRoomList(rooms) {
            const requestsTab = document.getElementById('requests-tab');
            const roomListContainer = requestsTab.querySelector('.room-list');
            const noRoomsElement = roomListContainer.querySelector('.no-chats');

            if (!roomListContainer) {
                console.error('❌ 申請中ルームリストコンテナが見つかりません');
                return;
            }

            // 既存のルームアイテムを削除
            const existingItems = roomListContainer.querySelectorAll('.chat-item');
            existingItems.forEach(item => item.remove());

            if (rooms.length === 0) {
                if (noRoomsElement) {
                    noRoomsElement.style.display = 'block';
                }
                console.log('📋 申請中のルームなし');
                return;
            }

            if (noRoomsElement) {
                noRoomsElement.style.display = 'none';
            }

            console.log('📋 申請中のルームを表示:', rooms.length, '件');

            rooms.forEach(room => {
                const roomItem = document.createElement('div');
                roomItem.className = 'chat-item';
                roomItem.dataset.roomId = room.id;

                // 最終メッセージ時刻のフォーマット
                const lastActivityTime = room.lastActivityAt ? formatTime(new Date(room.lastActivityAt)) : '';

                // ルーム説明の最初の1行だけを取得（最大10文字）
                let descriptionPreview = room.description || '';
                if (descriptionPreview) {
                    const firstLine = descriptionPreview.split('\n')[0];
                    descriptionPreview = firstLine.length > 10 ? firstLine.substring(0, 10) + '...' : firstLine;
                } else {
                    descriptionPreview = '説明なし';
                }

                // 参加人数の表示
                const memberCountText = `メンバー${room.memberCount || 0}人`;

                // ルームアイコン（グループチャット風）
                const roomIcon = '<div class="chat-avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><i class="fas fa-users"></i></div>';

                roomItem.innerHTML = `
                    ${roomIcon}
                    <div class="chat-info" style="flex: 1;">
                        <div class="chat-name-row">
                            <span class="chat-name">${escapeHtml(room.name)} <span style="font-size: 0.85em; color: #888;">(${memberCountText})</span></span>
                            <span class="chat-time">${lastActivityTime}</span>
                        </div>
                        <div class="chat-message-preview">
                            ${escapeHtml(descriptionPreview)}
                        </div>
                    </div>
                    <button class="cancel-request-btn" data-room-id="${room.id}" data-room-name="${escapeHtml(room.name)}" style="margin-left: 10px; white-space: nowrap; background: #ffa500; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 500;">
                        承認待ち
                    </button>
                `;

                // キャンセルボタンのイベント
                const cancelBtn = roomItem.querySelector('.cancel-request-btn');
                cancelBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const roomId = cancelBtn.dataset.roomId;
                    const roomName = cancelBtn.dataset.roomName;

                    if (confirm(`「${roomName}」への参加申請をキャンセルしますか?`)) {
                        await cancelJoinRequest(roomId);
                    }
                });

                roomListContainer.appendChild(roomItem);
            });
        }

        // 申請バッジを更新
        function updateRequestBadge(count) {
            const badge = document.getElementById('requestBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // ルーム参加申請をキャンセル
        async function cancelJoinRequest(roomId) {
            try {
                console.log('🚫 ルーム参加申請をキャンセル中... roomId:', roomId);
                const response = await fetch(`/rooms/${roomId}/cancel-request`, {
                    method: 'DELETE',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('❌ 申請キャンセル失敗:', response.status);
                    alert('申請のキャンセルに失敗しました');
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    console.log('✅ 申請をキャンセルしました');
                    alert(data.message || '参加申請をキャンセルしました');

                    // 申請中のルームリストを再読み込み
                    await loadRequestedRooms();
                } else {
                    console.error('❌ 申請キャンセル失敗:', data.message);
                    alert(data.message || '申請のキャンセルに失敗しました');
                }
            } catch (error) {
                console.error('❌ 申請キャンセルエラー:', error);
                alert('申請のキャンセル中にエラーが発生しました');
            }
        }

        // 承認待ち一覧を読み込む
        async function loadPendingApprovals() {
            try {
                console.log('📋 承認待ち一覧を読み込み中...');
                const response = await fetch('/rooms/api/pending-approvals', {
                    credentials: 'same-origin',
                    cache: 'no-store',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    console.error('❌ API呼び出し失敗:', response.status);
                    return;
                }

                const data = await response.json();

                if (!data.success) {
                    console.error('❌ 承認待ち一覧取得失敗:', data.message);
                    return;
                }

                const approvals = data.approvals || [];
                console.log('✅ 承認待ち一覧取得:', approvals.length, '件');

                displayApprovalsList(approvals);
                updateApprovalBadge(approvals.length);
            } catch (error) {
                console.error('❌ 承認待ち一覧読み込みエラー:', error);
            }
        }

        // 承認待ち一覧を表示
        function displayApprovalsList(approvals) {
            const approvalsTab = document.getElementById('approvals-tab');
            const roomListContainer = approvalsTab.querySelector('.room-list');
            const noRoomsElement = roomListContainer.querySelector('.no-chats');

            if (!roomListContainer) {
                console.error('❌ 承認待ちリストコンテナが見つかりません');
                return;
            }

            // 既存のアイテムを削除
            const existingItems = roomListContainer.querySelectorAll('.chat-item');
            existingItems.forEach(item => item.remove());

            if (approvals.length === 0) {
                if (noRoomsElement) {
                    noRoomsElement.style.display = 'block';
                }
                console.log('📋 承認待ちなし');
                return;
            }

            if (noRoomsElement) {
                noRoomsElement.style.display = 'none';
            }

            console.log('📋 承認待ちを表示:', approvals.length, '件');

            approvals.forEach(approval => {
                const approvalItem = document.createElement('div');
                approvalItem.className = 'chat-item';
                approvalItem.dataset.requestId = approval.requestId;

                // 自己紹介文の最初の1行を取得（最大10文字）
                let bioPreview = approval.bio || '';
                if (bioPreview) {
                    const firstLine = bioPreview.split('\n')[0];
                    bioPreview = firstLine.length > 10 ? firstLine.substring(0, 10) + '...' : firstLine;
                } else {
                    bioPreview = '自己紹介なし';
                }

                // ユーザーアバター
                const avatarUrl = approval.avatarUrl || '/images/default-avatar.png';
                const userAvatar = `<div class="chat-avatar"><img src="${escapeHtml(avatarUrl)}" alt="avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"></div>`;

                approvalItem.innerHTML = `
                    ${userAvatar}
                    <div class="chat-info" style="flex: 1;">
                        <div class="chat-name-row">
                            <span class="chat-name">${escapeHtml(approval.displayName)}</span>
                            <span class="chat-time" style="font-size: 0.75rem; color: #888;">${escapeHtml(approval.roomName)}</span>
                        </div>
                        <div class="chat-message-preview">
                            ${escapeHtml(bioPreview)}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-left: 10px;">
                        <button class="approve-btn" data-room-id="${approval.roomId}" data-username="${escapeHtml(approval.username)}" style="white-space: nowrap; background: #4CAF50; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 500;">
                            承認
                        </button>
                        <button class="reject-btn" data-room-id="${approval.roomId}" data-username="${escapeHtml(approval.username)}" style="white-space: nowrap; background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 500;">
                            拒否
                        </button>
                    </div>
                `;

                // 承認ボタンのイベント
                const approveBtn = approvalItem.querySelector('.approve-btn');
                approveBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const roomId = approveBtn.dataset.roomId;
                    const username = approveBtn.dataset.username;

                    if (confirm(`${approval.displayName}さんの申請を承認しますか?`)) {
                        await approveJoinRequest(roomId, username);
                    }
                });

                // 拒否ボタンのイベント
                const rejectBtn = approvalItem.querySelector('.reject-btn');
                rejectBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const roomId = rejectBtn.dataset.roomId;
                    const username = rejectBtn.dataset.username;

                    if (confirm(`${approval.displayName}さんの申請を拒否しますか?`)) {
                        await rejectJoinRequest(roomId, username);
                    }
                });

                roomListContainer.appendChild(approvalItem);
            });
        }

        // 承認バッジを更新
        function updateApprovalBadge(count) {
            const badge = document.getElementById('approvalBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // 参加申請を承認
        async function approveJoinRequest(roomId, username) {
            try {
                console.log('✅ 参加申請を承認中... roomId:', roomId, 'username:', username);
                const response = await fetch(`/rooms/${roomId}/approve-request?username=${encodeURIComponent(username)}`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('❌ 承認失敗:', response.status);
                    alert('承認に失敗しました');
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    console.log('✅ 申請を承認しました');
                    alert(data.message || '参加申請を承認しました');

                    // 承認待ち一覧を再読み込み
                    await loadPendingApprovals();
                } else {
                    console.error('❌ 承認失敗:', data.message);
                    alert(data.message || '承認に失敗しました');
                }
            } catch (error) {
                console.error('❌ 承認エラー:', error);
                alert('承認中にエラーが発生しました');
            }
        }

        // 参加申請を拒否
        async function rejectJoinRequest(roomId, username) {
            try {
                console.log('❌ 参加申請を拒否中... roomId:', roomId, 'username:', username);
                const response = await fetch(`/rooms/${roomId}/reject-request?username=${encodeURIComponent(username)}`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('❌ 拒否失敗:', response.status);
                    alert('拒否に失敗しました');
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    console.log('✅ 申請を拒否しました');
                    alert(data.message || '参加申請を拒否しました');

                    // 承認待ち一覧を再読み込み
                    await loadPendingApprovals();
                } else {
                    console.error('❌ 拒否失敗:', data.message);
                    alert(data.message || '拒否に失敗しました');
                }
            } catch (error) {
                console.error('❌ 拒否エラー:', error);
                alert('拒否中にエラーが発生しました');
            }
        }

        // 受け取った招待一覧を読み込む
        async function loadReceivedInvitations() {
            try {
                console.log('📬 招待一覧を読み込み中...');
                const response = await fetch('/rooms/api/invitations', {
                    credentials: 'same-origin',
                    cache: 'no-store',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    console.error('❌ API呼び出し失敗:', response.status);
                    return;
                }

                const data = await response.json();

                if (!data.success) {
                    console.error('❌ 招待一覧取得失敗:', data.message);
                    return;
                }

                const invitations = data.invitations || [];
                console.log('✅ 招待一覧取得:', invitations.length, '件');

                displayInvitationsList(invitations);
                updateInviteBadge(invitations.length);
            } catch (error) {
                console.error('❌ 招待一覧読み込みエラー:', error);
            }
        }

        // 招待一覧を表示
        function displayInvitationsList(invitations) {
            const inviteTab = document.getElementById('invite-tab');
            const listContainer = document.getElementById('invitations-list');
            const noItemsElement = listContainer.querySelector('.no-chats');

            if (!listContainer) {
                console.error('❌ 招待リストコンテナが見つかりません');
                return;
            }

            // 既存のアイテムを削除
            const existingItems = listContainer.querySelectorAll('.chat-item');
            existingItems.forEach(item => item.remove());

            if (invitations.length === 0) {
                if (noItemsElement) {
                    noItemsElement.style.display = 'block';
                }
                console.log('📬 招待なし');
                return;
            }

            if (noItemsElement) {
                noItemsElement.style.display = 'none';
            }

            console.log('📬 招待を表示:', invitations.length, '件');

            invitations.forEach(invitation => {
                const invitationItem = document.createElement('div');
                invitationItem.className = 'chat-item';
                invitationItem.dataset.invitationId = invitation.invitationId;

                // 招待者アバター
                const avatarUrl = invitation.inviterAvatarUrl || '/images/default-avatar.png';
                const inviterAvatar = `<div class="chat-avatar"><img src="${escapeHtml(avatarUrl)}" alt="avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"></div>`;

                invitationItem.innerHTML = `
                    ${inviterAvatar}
                    <div class="chat-info" style="flex: 1;">
                        <div class="chat-name-row">
                            <span class="chat-name">${escapeHtml(invitation.roomName)}</span>
                        </div>
                        <div class="chat-message-preview">
                            ${escapeHtml(invitation.inviterDisplayName)}さんからの招待
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-left: 10px;">
                        <button class="accept-invite-btn" data-invitation-id="${invitation.invitationId}" style="white-space: nowrap; background: #4CAF50; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 500;">
                            承認
                        </button>
                        <button class="reject-invite-btn" data-invitation-id="${invitation.invitationId}" style="white-space: nowrap; background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 500;">
                            拒否
                        </button>
                    </div>
                `;

                // 承認ボタンのイベント
                const acceptBtn = invitationItem.querySelector('.accept-invite-btn');
                acceptBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const invitationId = acceptBtn.dataset.invitationId;

                    if (confirm(`${invitation.roomName}への招待を承認しますか?`)) {
                        await acceptRoomInvitation(invitationId);
                    }
                });

                // 拒否ボタンのイベント
                const rejectBtn = invitationItem.querySelector('.reject-invite-btn');
                rejectBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const invitationId = rejectBtn.dataset.invitationId;

                    if (confirm(`${invitation.roomName}への招待を拒否しますか?`)) {
                        await rejectRoomInvitation(invitationId);
                    }
                });

                listContainer.appendChild(invitationItem);
            });
        }

        // 招待バッジを更新
        function updateInviteBadge(count) {
            const badge = document.getElementById('inviteBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // 招待を承認
        async function acceptRoomInvitation(invitationId) {
            try {
                console.log('✅ 招待を承認中... invitationId:', invitationId);
                const response = await fetch(`/rooms/invitation/${invitationId}/accept`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('❌ 承認失敗:', response.status);
                    alert('承認に失敗しました');
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    console.log('✅ 招待を承認しました');
                    alert(data.message || '招待を承認しました');

                    // 招待一覧を再読み込み
                    await loadReceivedInvitations();
                    // 参加中ルームも再読み込み
                    await loadJoinedRooms();
                } else {
                    console.error('❌ 承認失敗:', data.message);
                    alert(data.message || '承認に失敗しました');
                }
            } catch (error) {
                console.error('❌ 承認エラー:', error);
                alert('承認中にエラーが発生しました');
            }
        }

        // 招待を拒否
        async function rejectRoomInvitation(invitationId) {
            try {
                console.log('❌ 招待を拒否中... invitationId:', invitationId);
                const response = await fetch(`/rooms/invitation/${invitationId}/reject`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('❌ 拒否失敗:', response.status);
                    alert('拒否に失敗しました');
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    console.log('✅ 招待を拒否しました');
                    alert(data.message || '招待を拒否しました');

                    // 招待一覧を再読み込み
                    await loadReceivedInvitations();
                } else {
                    console.error('❌ 拒否失敗:', data.message);
                    alert(data.message || '拒否に失敗しました');
                }
            } catch (error) {
                console.error('❌ 拒否エラー:', error);
                alert('拒否中にエラーが発生しました');
            }
        }

        // 参加可能ルームリストを表示（申請ボタン付き）
        function displayAvailableRoomList(rooms, tabId) {
            const tabElement = document.getElementById(tabId);
            const roomListContainer = tabElement.querySelector('.room-list');
            const noRoomsElement = roomListContainer.querySelector('.no-chats');

            if (!roomListContainer) {
                console.error('❌ ルームリストコンテナが見つかりません');
                return;
            }

            // 既存のルームアイテムを削除
            const existingItems = roomListContainer.querySelectorAll('.chat-item');
            existingItems.forEach(item => item.remove());

            if (rooms.length === 0) {
                if (noRoomsElement) {
                    noRoomsElement.style.display = 'block';
                }
                console.log('📋 参加可能なルームなし');
                return;
            }

            if (noRoomsElement) {
                noRoomsElement.style.display = 'none';
            }

            console.log('📋 参加可能なルームを表示:', rooms.length, '件');

            rooms.forEach(room => {
                const roomItem = document.createElement('div');
                roomItem.className = 'chat-item';
                roomItem.dataset.roomId = room.id;

                // 最終メッセージ時刻のフォーマット
                const lastActivityTime = room.lastActivityAt ? formatTime(new Date(room.lastActivityAt)) : '';

                // ルーム説明の最初の1行だけを取得（最大10文字）
                let descriptionPreview = room.description || '';
                if (descriptionPreview) {
                    const firstLine = descriptionPreview.split('\n')[0];
                    descriptionPreview = firstLine.length > 10 ? firstLine.substring(0, 10) + '...' : firstLine;
                } else {
                    descriptionPreview = '説明なし';
                }

                // 参加人数の表示
                const memberCountText = `メンバー${room.memberCount || 0}人`;

                // ルームアイコン（グループチャット風）
                const roomIcon = '<div class="chat-avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><i class="fas fa-users"></i></div>';

                // 既に申請中かどうかをチェック
                const isRequested = window.requestedRoomIds && window.requestedRoomIds.has(room.id);
                const buttonClass = isRequested ? 'btn btn-sm btn-secondary room-join-btn' : 'btn btn-sm btn-primary room-join-btn';
                const buttonIcon = isRequested ? '<i class="fas fa-clock"></i> 申請中' : '<i class="fas fa-sign-in-alt"></i> 申請';
                const buttonDisabled = isRequested ? 'disabled' : '';

                roomItem.innerHTML = `
                    ${roomIcon}
                    <div class="chat-info" style="flex: 1;">
                        <div class="chat-name-row">
                            <span class="chat-name">${escapeHtml(room.name)} <span style="font-size: 0.85em; color: #888;">(${memberCountText})</span></span>
                            <span class="chat-time">${lastActivityTime}</span>
                        </div>
                        <div class="chat-message-preview">${escapeHtml(descriptionPreview)}</div>
                    </div>
                    <button class="${buttonClass}" data-room-id="${room.id}" style="margin-left: 10px; white-space: nowrap;" ${buttonDisabled}>
                        ${buttonIcon}
                    </button>
                `;

                // 申請ボタンのクリックイベント（申請中でない場合のみ）
                const joinBtn = roomItem.querySelector('.room-join-btn');
                if (!isRequested) {
                    joinBtn.addEventListener('click', async (e) => {
                        e.stopPropagation(); // 親要素のクリックイベントを防止
                        await requestJoinRoom(room.id, joinBtn);
                    });
                }

                roomListContainer.appendChild(roomItem);
            });
        }

        // ルームリストを表示（参加中タブ用）
        function displayRoomList(rooms, tabId) {
            const tabElement = document.getElementById(tabId);
            const roomListContainer = tabElement.querySelector('.room-list');
            const noRoomsElement = roomListContainer.querySelector('.no-chats');

            if (!roomListContainer) {
                console.error('❌ ルームリストコンテナが見つかりません');
                return;
            }

            // 既存のルームアイテムを削除（スワイプコンテナも含む）
            const existingItems = roomListContainer.querySelectorAll('.chat-item, .swipe-container');
            existingItems.forEach(item => item.remove());

            if (rooms.length === 0) {
                if (noRoomsElement) {
                    noRoomsElement.style.display = 'block';
                }
                console.log('📋 ルームなし');
                return;
            }

            if (noRoomsElement) {
                noRoomsElement.style.display = 'none';
            }

            console.log('📋 ルームを表示:', rooms.length, '件');

            const currentUsername = window.currentUser || '';

            rooms.forEach(room => {
                // メインルーム(ID=1)はスワイプ不可
                const isMainRoom = room.id === 1;
                const isCreator = room.createdByUsername === currentUsername;

                // 最終メッセージ時刻のフォーマット
                const lastActivityTime = room.lastActivityAt ? formatTime(new Date(room.lastActivityAt)) : '';

                // ルーム説明の最初の1行だけを取得（最大10文字）
                let descriptionPreview = room.description || '';
                if (descriptionPreview) {
                    const firstLine = descriptionPreview.split('\n')[0];
                    descriptionPreview = firstLine.length > 10 ? firstLine.substring(0, 10) + '...' : firstLine;
                } else {
                    descriptionPreview = '説明なし';
                }

                // 参加人数の表示
                const memberCountText = `メンバー${room.memberCount || 0}人`;

                // ルームアイコン（グループチャット風）
                const roomIcon = '<div class="chat-avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><i class="fas fa-users"></i></div>';

                if (isMainRoom) {
                    // メインルームはスワイプなし
                    const roomItem = document.createElement('div');
                    roomItem.className = 'chat-item';
                    roomItem.dataset.roomId = room.id;
                    roomItem.innerHTML = `
                        ${roomIcon}
                        <div class="chat-info">
                            <div class="chat-name-row">
                                <span class="chat-name">${escapeHtml(room.name)} <span style="font-size: 0.85em; color: #888;">(${memberCountText})</span></span>
                                <span class="chat-time">${lastActivityTime}</span>
                            </div>
                            <div class="chat-message-preview">${escapeHtml(descriptionPreview)}</div>
                        </div>
                    `;
                    roomItem.addEventListener('click', () => openRoomChat(room));
                    roomListContainer.appendChild(roomItem);
                } else {
                    // スワイプ可能なコンテナを作成
                    const swipeContainer = document.createElement('div');
                    swipeContainer.className = 'swipe-container';
                    swipeContainer.dataset.roomId = room.id;
                    swipeContainer.dataset.roomName = room.name;
                    swipeContainer.dataset.isCreator = isCreator ? 'true' : 'false';

                    // アクションボタン（退室 or 解散）
                    const actionBtn = isCreator
                        ? `<button class="swipe-action-btn dissolve-btn" data-room-id="${room.id}">
                               <i class="fas fa-trash-alt"></i>解散
                           </button>`
                        : `<button class="swipe-action-btn leave-btn" data-room-id="${room.id}">
                               <i class="fas fa-sign-out-alt"></i>退室
                           </button>`;

                    swipeContainer.innerHTML = `
                        <div class="swipe-actions">
                            ${actionBtn}
                        </div>
                        <div class="swipe-content">
                            ${roomIcon}
                            <div class="chat-info">
                                <div class="chat-name-row">
                                    <span class="chat-name">${escapeHtml(room.name)} <span style="font-size: 0.85em; color: #888;">(${memberCountText})</span></span>
                                    <span class="chat-time">${lastActivityTime}</span>
                                </div>
                                <div class="chat-message-preview">${escapeHtml(descriptionPreview)}</div>
                            </div>
                        </div>
                    `;

                    // スワイプコンテンツのクリックでルームを開く
                    const swipeContent = swipeContainer.querySelector('.swipe-content');
                    swipeContent.addEventListener('click', (e) => {
                        // スワイプ中でなければルームを開く
                        if (!swipeContainer.classList.contains('swiped')) {
                            openRoomChat(room);
                        }
                    });

                    // スワイプイベントを設定
                    setupSwipeEvents(swipeContainer);

                    // アクションボタンのクリックイベント
                    const actionButton = swipeContainer.querySelector('.swipe-action-btn');
                    actionButton.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const roomId = parseInt(actionButton.dataset.roomId);
                        const roomName = swipeContainer.dataset.roomName;
                        const isCreatorRoom = swipeContainer.dataset.isCreator === 'true';

                        if (isCreatorRoom) {
                            // 解散確認
                            if (confirm(`「${roomName}」を解散しますか？\nこの操作は取り消せません。`)) {
                                await dissolveRoom(roomId);
                            }
                        } else {
                            // 退室確認
                            if (confirm(`「${roomName}」から退室しますか？`)) {
                                await leaveRoom(roomId);
                            }
                        }
                    });

                    roomListContainer.appendChild(swipeContainer);
                }
            });
        }

        // スワイプイベントのセットアップ
        function setupSwipeEvents(container) {
            let startX = 0;
            let currentX = 0;
            let isDragging = false;
            const swipeContent = container.querySelector('.swipe-content');
            const threshold = 50; // スワイプ判定の閾値

            // タッチイベント
            container.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                currentX = startX; // タップ時にcurrentXも初期化（タップでスワイプ判定されないように）
                isDragging = true;
                swipeContent.style.transition = 'none';
            }, { passive: true });

            container.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                currentX = e.touches[0].clientX;
                const diff = startX - currentX;

                // スワイプ開始時にswipingクラスを追加
                if (diff > 5) {
                    container.classList.add('swiping');
                }

                // 左方向のみスワイプ可能（-80pxまで）
                if (diff > 0) {
                    const translateX = Math.min(diff, 80);
                    swipeContent.style.transform = `translateX(-${translateX}px)`;
                } else if (container.classList.contains('swiped')) {
                    // 閉じる方向のスワイプ
                    const translateX = Math.max(80 + diff, 0);
                    swipeContent.style.transform = `translateX(-${translateX}px)`;
                }
            }, { passive: true });

            container.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;
                swipeContent.style.transition = 'transform 0.3s ease';
                container.classList.remove('swiping');

                const diff = startX - currentX;

                if (container.classList.contains('swiped')) {
                    // 既に開いている場合
                    if (diff < -threshold) {
                        // 閉じる
                        container.classList.remove('swiped');
                        swipeContent.style.transform = 'translateX(0)';
                    } else {
                        // 開いたままにする
                        swipeContent.style.transform = 'translateX(-80px)';
                    }
                } else {
                    // 閉じている場合
                    if (diff > threshold) {
                        // 開く
                        container.classList.add('swiped');
                        swipeContent.style.transform = 'translateX(-80px)';
                        // 他のスワイプコンテナを閉じる
                        closeOtherSwipeContainers(container);
                    } else {
                        // 閉じたままにする
                        swipeContent.style.transform = 'translateX(0)';
                    }
                }
            });

            // マウスイベント（PC対応）
            container.addEventListener('mousedown', (e) => {
                startX = e.clientX;
                currentX = startX; // クリック時にcurrentXも初期化
                isDragging = true;
                swipeContent.style.transition = 'none';
            });

            container.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                currentX = e.clientX;
                const diff = startX - currentX;

                // スワイプ開始時にswipingクラスを追加
                if (diff > 5) {
                    container.classList.add('swiping');
                }

                if (diff > 0) {
                    const translateX = Math.min(diff, 80);
                    swipeContent.style.transform = `translateX(-${translateX}px)`;
                } else if (container.classList.contains('swiped')) {
                    const translateX = Math.max(80 + diff, 0);
                    swipeContent.style.transform = `translateX(-${translateX}px)`;
                }
            });

            container.addEventListener('mouseup', (e) => {
                if (!isDragging) return;
                isDragging = false;
                swipeContent.style.transition = 'transform 0.3s ease';
                container.classList.remove('swiping');

                const diff = startX - currentX;

                if (container.classList.contains('swiped')) {
                    if (diff < -threshold) {
                        container.classList.remove('swiped');
                        swipeContent.style.transform = 'translateX(0)';
                    } else {
                        swipeContent.style.transform = 'translateX(-80px)';
                    }
                } else {
                    if (diff > threshold) {
                        container.classList.add('swiped');
                        swipeContent.style.transform = 'translateX(-80px)';
                        closeOtherSwipeContainers(container);
                    } else {
                        swipeContent.style.transform = 'translateX(0)';
                    }
                }
            });

            container.addEventListener('mouseleave', () => {
                if (isDragging) {
                    isDragging = false;
                    swipeContent.style.transition = 'transform 0.3s ease';
                    container.classList.remove('swiping');
                    if (!container.classList.contains('swiped')) {
                        swipeContent.style.transform = 'translateX(0)';
                    }
                }
            });
        }

        // 他のスワイプコンテナを閉じる
        function closeOtherSwipeContainers(currentContainer) {
            document.querySelectorAll('.swipe-container.swiped').forEach(container => {
                if (container !== currentContainer) {
                    container.classList.remove('swiped');
                    const content = container.querySelector('.swipe-content');
                    if (content) {
                        content.style.transform = 'translateX(0)';
                    }
                }
            });
        }

        // ルームから退室
        async function leaveRoom(roomId) {
            try {
                const response = await fetch(`/rooms/${roomId}/leave`, {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                const data = await response.json();

                if (data.success) {
                    alert('ルームから退室しました');
                    loadJoinedRooms();
                    loadAvailableRooms();
                } else {
                    alert('退室に失敗しました: ' + data.message);
                }
            } catch (error) {
                console.error('❌ 退室エラー:', error);
                alert('退室中にエラーが発生しました');
            }
        }

        // ルームを解散
        async function dissolveRoom(roomId) {
            try {
                const response = await fetch(`/rooms/${roomId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });

                const data = await response.json();

                if (data.success) {
                    alert('ルームを解散しました');
                    loadJoinedRooms();
                } else {
                    alert('解散に失敗しました: ' + data.message);
                }
            } catch (error) {
                console.error('❌ 解散エラー:', error);
                alert('解散中にエラーが発生しました');
            }
        }

        // ルーム参加申請
        async function requestJoinRoom(roomId, buttonElement) {
            try {
                console.log('📝 ルーム参加申請:', roomId);

                // ボタンを無効化して処理中表示
                if (buttonElement) {
                    buttonElement.disabled = true;
                    buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 送信中...';
                }

                const response = await fetch(`/rooms/${roomId}/request-join`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    console.log('✅ 参加申請成功');

                    // ボタンを「申請中」表示に変更
                    if (buttonElement) {
                        buttonElement.innerHTML = '<i class="fas fa-clock"></i> 申請中';
                        buttonElement.classList.remove('btn-primary');
                        buttonElement.classList.add('btn-secondary');
                        buttonElement.disabled = true;
                    }

                    // 申請中のルームリストを更新
                    await loadRequestedRooms();

                    alert('参加申請を送信しました。ルーム作成者の承認をお待ちください。');
                } else {
                    // エラー時はボタンを元に戻す
                    if (buttonElement) {
                        buttonElement.disabled = false;
                        buttonElement.innerHTML = '<i class="fas fa-sign-in-alt"></i> 申請';
                    }
                    alert(data.message || '参加申請に失敗しました');
                    console.error('❌ 参加申請失敗:', data.message);
                }
            } catch (error) {
                console.error('❌ 参加申請エラー:', error);
                // エラー時はボタンを元に戻す
                if (buttonElement) {
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = '<i class="fas fa-sign-in-alt"></i> 申請';
                }
                alert('参加申請中にエラーが発生しました');
            }
        }

        // WebSocketからのルーム更新を処理
        function handleRoomUpdate(roomData) {
            console.log('🏠 ルーム更新処理:', roomData);

            if (roomData.type === 'room_created') {
                // 新しいルームが作成された
                console.log('✨ 新規ルーム作成:', roomData.room.name);

                // 現在表示中のタブを確認して適切なリストを更新
                // 参加中ルームと参加可能ルームの両方を再読み込み
                loadJoinedRooms();
                loadAvailableRooms();
            } else if (roomData.type === 'room_updated') {
                // ルーム情報が更新された
                console.log('🔄 ルーム更新:', roomData.room.name);

                // 両方のリストを再読み込み
                loadJoinedRooms();
                loadAvailableRooms();
            } else if (roomData.type === 'user_joined') {
                // ユーザーがルームに参加した
                console.log('👤 ユーザー参加:', roomData.username, 'がルーム', roomData.room.name, 'に参加');

                // 自分が参加した場合は両方のリストを更新
                loadJoinedRooms();
                loadAvailableRooms();
            } else if (roomData.type === 'user_left') {
                // ユーザーがルームから退出した
                console.log('👋 ユーザー退出:', roomData.username, 'がルーム', roomData.room.name, 'から退出');

                // メンバー数が更新されるのでリストを再読み込み
                loadJoinedRooms();
                loadAvailableRooms();
            } else if (roomData.type === 'join_request') {
                // ルーム参加申請があった
                console.log('📥 参加申請:', roomData.applicantDisplayName, 'が', roomData.roomName, 'に申請');

                // 自分が作成したルームへの申請の場合、承認タブを更新
                const currentUsername = window.currentUser || '';
                if (roomData.creatorUsername === currentUsername) {
                    console.log('✅ 自分が作成したルームへの申請 - 承認タブを更新');
                    loadPendingApprovals();
                }
            } else if (roomData.type === 'request_approved') {
                // 参加申請が承認された
                console.log('✅ 申請承認:', roomData.applicantUsername, 'の', roomData.roomName, 'への申請が承認');

                const currentUsername = window.currentUser || '';
                console.log('📌 現在のユーザー:', currentUsername, ', 申請者:', roomData.applicantUsername, ', 作成者:', roomData.creatorUsername);

                // ルーム作成者の場合：承認タブを更新（自分で承認した場合は既に更新済みなのでスキップ可）
                if (roomData.creatorUsername === currentUsername) {
                    console.log('📋 承認タブを更新（作成者）');
                    loadPendingApprovals();
                }

                // 申請者の場合：申請中から消え、参加可能から消え、参加中に表示
                if (roomData.applicantUsername === currentUsername) {
                    console.log('🎉 自分の申請が承認された！リストを更新します');
                    // 申請中のルームIDから削除
                    if (window.requestedRoomIds) {
                        window.requestedRoomIds.delete(roomData.roomId);
                    }
                    // 各リストを更新
                    loadRequestedRooms();     // 申請中タブを更新
                    loadAvailableRooms();     // 参加可能タブを更新
                    loadJoinedRooms();        // 参加中タブを更新
                    alert('🎉 「' + roomData.roomName + '」への参加が承認されました！');
                }
            } else if (roomData.type === 'request_rejected') {
                // 参加申請が拒否された
                console.log('❌ 申請拒否:', roomData.applicantUsername, 'の', roomData.roomName, 'への申請が拒否');

                const currentUsername = window.currentUser || '';
                console.log('📌 現在のユーザー:', currentUsername, ', 申請者:', roomData.applicantUsername, ', 作成者:', roomData.creatorUsername);

                // ルーム作成者の場合：承認タブを更新
                if (roomData.creatorUsername === currentUsername) {
                    console.log('📋 承認タブを更新（作成者）');
                    loadPendingApprovals();
                }

                // 申請者の場合：申請中から消え、参加可能に戻る
                if (roomData.applicantUsername === currentUsername) {
                    console.log('😢 自分の申請が拒否された！リストを更新します');
                    // 申請中のルームIDから削除
                    if (window.requestedRoomIds) {
                        window.requestedRoomIds.delete(roomData.roomId);
                    }
                    // 各リストを更新
                    loadRequestedRooms();     // 申請中タブを更新
                    loadAvailableRooms();     // 参加可能タブを更新（申請ボタンに戻る）
                    alert('😢 「' + roomData.roomName + '」への参加が拒否されました');
                }
            } else if (roomData.type === 'room_invitation') {
                // ルーム招待が届いた
                console.log('📬 招待受信:', roomData.inviterUsername, 'が', roomData.inviteeUsername, 'を', roomData.roomName, 'に招待');

                const currentUsername = window.currentUser || '';

                // 招待されたユーザー本人の場合：招待タブを更新
                if (roomData.inviteeUsername === currentUsername) {
                    console.log('🎉 自分に招待が届いた！');
                    loadReceivedInvitations();
                    alert('📬 「' + roomData.roomName + '」への招待が届きました！');
                }
            } else if (roomData.type === 'member_kicked') {
                // メンバーが退会させられた
                console.log('👢 メンバー退会:', roomData.kickedUsername, 'が', roomData.roomName, 'から退会させられた');

                const currentUsername = window.currentUser || '';

                // 自分が退会させられた場合
                if (roomData.kickedUsername === currentUsername) {
                    console.log('😢 自分が退会させられた！');

                    // メンバーパネルが開いている場合は閉じる
                    const membersSection = document.getElementById('room-members-section');
                    if (membersSection && membersSection.style.display !== 'none') {
                        membersSection.style.display = 'none';
                        membersSection.classList.remove('active');
                    }

                    // ルーム一覧を更新
                    loadJoinedRooms();
                    loadAvailableRooms();

                    // もし現在そのルームのチャット画面にいる場合は退出
                    if (currentRoomId === roomData.roomId) {
                        alert('😢 「' + roomData.roomName + '」から退会させられました');
                        // ルームチャット画面を閉じてルーム一覧に戻る
                        document.getElementById('backFromRoomChatBtn').click();
                    } else {
                        alert('😢 「' + roomData.roomName + '」から退会させられました');
                    }
                }

                // メンバー一覧画面が開いている場合は更新
                const membersSection = document.getElementById('room-members-section');
                if (membersSection && membersSection.style.display !== 'none' && currentRoomId === roomData.roomId) {
                    loadRoomMembers(roomData.roomId);
                }
            }
        }

        // ========================================
        // DM機能
        // ========================================
        
        let currentConversationId = null;
        let currentDMUser = null;
        
        // DM会話リストを読み込む
        async function loadDMConversations() {
            try {
                console.log('📋 DM会話リストを読み込み中...');
                const response = await fetch('/api/dm/conversations');
                console.log('📡 API Response Status:', response.status);
                
                const data = await response.json();
                console.log('📦 API Response Data:', data);
                
                if (!data.success) {
                    console.error('❌ DM会話リストの取得に失敗しました');
                    return;
                }
                
                const conversations = data.conversations;
                console.log('✅ DM会話リスト取得:', conversations.length, '件');
                console.log('📋 Conversations Detail:', conversations);
                
                displayConversationList(conversations);
            } catch (error) {
                console.error('❌ DM会話リスト読み込みエラー:', error);
            }
        }
        
        // DM会話リストを表示
        function displayConversationList(conversations) {
            const chatListContainer = document.querySelector('#all-chat-tab .chat-list');
            const noChatsElement = chatListContainer.querySelector('.no-chats');
            
            if (!chatListContainer) {
                console.error('❌ チャットリストコンテナが見つかりません');
                return;
            }
            
            // 既存のチャットアイテムを削除
            const existingItems = chatListContainer.querySelectorAll('.chat-item');
            existingItems.forEach(item => item.remove());
            
            if (conversations.length === 0) {
                // 会話がない場合は「チャットがありません」を表示
                if (noChatsElement) {
                    noChatsElement.style.display = 'flex';
                }
                console.log('📋 DM会話なし');
                return;
            }
            
            // 会話がある場合は「チャットがありません」を非表示
            if (noChatsElement) {
                noChatsElement.style.display = 'none';
            }
            
            console.log('📋 DM会話を表示:', conversations.length, '件');
            
            // 会話リストを表示
            conversations.forEach(conv => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.dataset.conversationId = conv.conversationId;
                chatItem.dataset.userId = conv.userId;
                
                // 最終メッセージ時刻のフォーマット
                const lastMessageTime = conv.lastMessageAt ? formatTime(new Date(conv.lastMessageAt)) : '';
                
                // メッセージの最初の1行だけを取得（最大10文字）
                let messagePreview = conv.lastMessage || '';
                const firstLine = messagePreview.split('\n')[0]; // 最初の1行
                const truncatedMessage = firstLine.length > 10 ? firstLine.substring(0, 10) + '...' : firstLine;
                
                // アバターのスタイル
                const avatarStyle = conv.avatarUrl 
                    ? `background-image: url(${conv.avatarUrl}); background-size: cover; background-position: center;` 
                    : '';
                
                chatItem.innerHTML = `
                    <div class="chat-avatar" style="${avatarStyle}">
                        ${!conv.avatarUrl ? '<i class="fas fa-user"></i>' : ''}
                    </div>
                    <div class="chat-content">
                        <div class="chat-top">
                            <span class="chat-name">${escapeHtml(conv.displayName || conv.username)}</span>
                            <span class="chat-time">${lastMessageTime}</span>
                        </div>
                        <div class="chat-bottom">
                            <p class="chat-message">${escapeHtml(truncatedMessage)}</p>
                            ${conv.unreadCount > 0 ? `<span class="chat-badge">${conv.unreadCount}</span>` : ''}
                        </div>
                    </div>
                `;
                
                // クリックイベント
                chatItem.addEventListener('click', async () => {
                    await startConversationFromList(conv.conversationId, conv.userId, conv.displayName || conv.username, conv.avatarUrl);
                });
                
                chatListContainer.appendChild(chatItem);
            });
        }
        
        // 時刻のフォーマット関数
        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            const hours = Math.floor(diff / 1000 / 60 / 60);
            
            if (hours < 1) {
                const minutes = Math.floor(diff / 1000 / 60);
                return minutes < 1 ? 'たった今' : `${minutes}分前`;
            } else if (hours < 24) {
                return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            } else if (hours < 48) {
                return '昨日';
            } else {
                return date.toLocaleDateString('ja-JP', { month: '2-digit', day: '2-digit' });
            }
        }
        
        // フレンドのDM会話リストを読み込む
        async function loadFriendsDMConversations() {
            try {
                console.log('📋 フレンドのDM会話リストを読み込み中...');
                const response = await fetch('/api/dm/conversations/friends');
                console.log('📡 Friends API Response Status:', response.status);
                
                const data = await response.json();
                console.log('📦 Friends API Response Data:', data);
                
                if (!data.success) {
                    console.error('❌ フレンドのDM会話リストの取得に失敗しました');
                    return;
                }
                
                const conversations = data.conversations;
                console.log('✅ フレンドのDM会話リスト取得:', conversations.length, '件');
                console.log('📋 Friends Conversations Detail:', conversations);
                
                displayFriendsConversationList(conversations);
            } catch (error) {
                console.error('❌ フレンドのDM会話リスト読み込みエラー:', error);
            }
        }
        
        // フレンドのDM会話リストを表示
        function displayFriendsConversationList(conversations) {
            const chatListContainer = document.querySelector('#friends-chat-tab .chat-list');
            const noChatsElement = chatListContainer.querySelector('.no-chats');
            
            if (!chatListContainer) {
                console.error('❌ フレンドチャットリストコンテナが見つかりません');
                return;
            }
            
            // 既存のチャットアイテムを削除
            const existingItems = chatListContainer.querySelectorAll('.chat-item');
            existingItems.forEach(item => item.remove());
            
            if (conversations.length === 0) {
                // 会話がない場合は「フレンドとのチャットがありません」を表示
                if (noChatsElement) {
                    noChatsElement.style.display = 'flex';
                }
                console.log('📋 フレンドのDM会話なし');
                return;
            }
            
            // 会話がある場合は「フレンドとのチャットがありません」を非表示
            if (noChatsElement) {
                noChatsElement.style.display = 'none';
            }
            
            console.log('📋 フレンドのDM会話を表示:', conversations.length, '件');
            
            // 会話リストを表示（displayConversationListと同じ処理）
            conversations.forEach(conv => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.dataset.conversationId = conv.conversationId;
                chatItem.dataset.userId = conv.userId;
                
                // 最終メッセージ時刻のフォーマット
                const lastMessageTime = conv.lastMessageAt ? formatTime(new Date(conv.lastMessageAt)) : '';
                
                // メッセージの最初の1行だけを取得（最大10文字）
                let messagePreview = conv.lastMessage || '';
                const firstLine = messagePreview.split('\n')[0]; // 最初の1行
                const truncatedMessage = firstLine.length > 10 ? firstLine.substring(0, 10) + '...' : firstLine;
                
                // アバターのスタイル
                const avatarStyle = conv.avatarUrl 
                    ? `background-image: url(${conv.avatarUrl}); background-size: cover; background-position: center;` 
                    : '';
                
                chatItem.innerHTML = `
                    <div class="chat-avatar" style="${avatarStyle}">
                        ${!conv.avatarUrl ? '<i class="fas fa-user"></i>' : ''}
                    </div>
                    <div class="chat-content">
                        <div class="chat-top">
                            <span class="chat-name">${escapeHtml(conv.displayName || conv.username)}</span>
                            <span class="chat-time">${lastMessageTime}</span>
                        </div>
                        <div class="chat-bottom">
                            <p class="chat-message">${escapeHtml(truncatedMessage)}</p>
                            ${conv.unreadCount > 0 ? `<span class="chat-badge">${conv.unreadCount}</span>` : ''}
                        </div>
                    </div>
                `;
                
                // クリックイベント
                chatItem.addEventListener('click', async () => {
                    await startConversationFromList(conv.conversationId, conv.userId, conv.displayName || conv.username, conv.avatarUrl);
                });
                
                chatListContainer.appendChild(chatItem);
            });
        }
        
        // 会話リストからDMを開始
        async function startConversationFromList(conversationId, userId, displayName, avatarUrl) {
            currentConversationId = conversationId;
            currentDMUser = {
                userId: userId,
                username: displayName,
                displayName: displayName,
                avatarUrl: avatarUrl
            };
            await openDMScreen(conversationId);
        }
        
        // 閲覧用マイページの「チャット」ボタン
        document.getElementById('btnStartChat').addEventListener('click', async function() {
            const viewedUserId = this.dataset.userId;
            if (!viewedUserId) {
                console.error('ユーザーIDが設定されていません');
                return;
            }
            
            try {
                console.log('🚀 DM会話を開始:', viewedUserId);
                
                const response = await fetch('/api/dm/conversations/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targetUserId: parseInt(viewedUserId) })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const conversation = data.conversation;
                    currentConversationId = conversation.conversationId;
                    currentDMUser = {
                        userId: conversation.userId,
                        username: conversation.username,
                        displayName: conversation.displayName,
                        avatarUrl: conversation.avatarUrl
                    };
                    await openDMScreen(currentConversationId);
                } else {
                    alert('DMの開始に失敗しました');
                }
            } catch (error) {
                console.error('DM開始エラー:', error);
                alert('DMの開始に失敗しました');
            }
        });
        
        async function openDMScreen(conversationId) {
            try {
                const response = await fetch(`/api/dm/conversations/${conversationId}/messages`);
                const data = await response.json();
                
                if (!data.success) throw new Error('メッセージの取得に失敗');
                
                // 会話IDを明示的に数値として設定
                currentConversationId = parseInt(conversationId);
                console.log('🔧 DM画面オープン - 会話ID設定:', currentConversationId);
                
                const dmHeader = document.querySelector('.dm-header .dm-user-info');
                const conversation = data.conversation;
                const avatarStyle = conversation.avatarUrl 
                    ? `background-image: url(${conversation.avatarUrl})` 
                    : '';
                dmHeader.innerHTML = `
                    <div class="dm-avatar" style="${avatarStyle}"></div>
                    <span class="dm-username">${conversation.displayName || conversation.username}</span>
                `;
                
                // ヘッダークリックで相手のプロフィールに遷移
                dmHeader.onclick = () => {
                    viewUserProfile(currentDMUser.userId);
                };
                
                displayDMMessages(data.messages);
                
                const sections = document.querySelectorAll('.app-section');
                sections.forEach(section => section.classList.remove('active'));
                document.getElementById('dm-section').style.display = 'block';
                document.getElementById('dm-section').classList.add('active');
                
                // フッターナビゲーションを非表示
                const bottomNav = document.querySelector('.bottom-nav');
                if (bottomNav) {
                    bottomNav.style.display = 'none';
                }
                
                // プロフィールアクションボタン（チャット・フォローボタン）を非表示
                const profileActions = document.getElementById('profileActions');
                if (profileActions) {
                    profileActions.style.display = 'none';
                }
                
                // 投稿ボタンも非表示
                const createPostBtn = document.getElementById('btnCreatePost');
                if (createPostBtn) {
                    createPostBtn.style.display = 'none';
                }
                
                console.log('✅ DM画面を開きました - WebSocket接続状態:', isWebSocketConnected);
                
                // WebSocketが接続されていない場合は接続を試みる
                if (!isWebSocketConnected) {
                    console.warn('⚠️ WebSocketが未接続です。再接続を試みます...');
                    connectWebSocket();
                }
            } catch (error) {
                console.error('DM画面オープンエラー:', error);
                alert('DMの読み込みに失敗しました');
            }
        }
        
        function displayDMMessages(messages) {
            console.log('📜 メッセージ履歴を表示:', messages.length, '件');
            const messagesContainer = document.getElementById('dmMessages');
            messagesContainer.innerHTML = '';
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `dm-message ${msg.isOwn ? 'own' : 'other'}`;
                
                const time = new Date(msg.sentAt).toLocaleTimeString('ja-JP', { 
                    hour: '2-digit', minute: '2-digit' 
                });
                
                const avatarStyle = msg.senderAvatarUrl 
                    ? `background-image: url(${msg.senderAvatarUrl})` 
                    : '';
                
                messageDiv.innerHTML = `
                    ${!msg.isOwn ? `<div class="dm-message-avatar" style="${avatarStyle}"></div>` : ''}
                    <div class="dm-message-bubble">
                        <div class="dm-message-content">${escapeHtml(msg.content)}</div>
                        <div class="dm-message-time">${time}</div>
                    </div>
                    ${msg.isOwn ? `<div class="dm-message-avatar" style="${avatarStyle}"></div>` : ''}
                `;
                
                messagesContainer.appendChild(messageDiv);
            });
            
            scrollDMToBottom();
            console.log('✅ メッセージ履歴の表示完了');
        }
        
        document.getElementById('dmSendBtn').addEventListener('click', sendDM);
        document.getElementById('dmInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendDM();
            }
        });
        
        async function sendDM() {
            const input = document.getElementById('dmInput');
            const content = input.value.trim();
            
            console.log('📤 DM送信試行:', {
                content: content,
                conversationId: currentConversationId,
                connected: isWebSocketConnected
            });
            
            if (!content || !currentConversationId) {
                console.warn('⚠️ メッセージが空または会話IDがありません');
                return;
            }
            
            if (stompClient && isWebSocketConnected) {
                const payload = {
                    conversationId: currentConversationId,
                    content: content
                };
                console.log('📨 WebSocketで送信:', payload);
                stompClient.send('/app/dm.send', {}, JSON.stringify(payload));
                
                input.value = '';
                input.style.height = 'auto';
                console.log('✅ DMメッセージ送信完了');
            } else {
                console.error('❌ WebSocket未接続');
                alert('接続が切断されています');
            }
        }
        
        function handleIncomingDM(dmData) {
            console.log('📨 DM受信:', dmData);
            console.log('現在の会話ID:', currentConversationId, '(型:', typeof currentConversationId + ')');
            console.log('受信したメッセージの会話ID:', dmData.conversationId, '(型:', typeof dmData.conversationId + ')');
            console.log('現在のユーザーID:', currentUserId);
            console.log('送信者ID:', dmData.senderId);
            
            // 会話IDを明示的に数値として比較
            const receivedConversationId = parseInt(dmData.conversationId);
            const currentConvId = parseInt(currentConversationId);
            
            console.log('比較: ', receivedConversationId, '===', currentConvId, '?', receivedConversationId === currentConvId);
            
            // DM画面が開いている場合はメッセージを追加
            if (receivedConversationId === currentConvId) {
                console.log('✅ 現在の会話のメッセージです。表示します。');
                const messagesContainer = document.getElementById('dmMessages');
                if (!messagesContainer) {
                    console.error('❌ dmMessagesコンテナが見つかりません');
                    return;
                }
                
                const messageDiv = document.createElement('div');
                const isOwn = parseInt(dmData.senderId) === parseInt(currentUserId);
                console.log('自分のメッセージか？:', isOwn);
                messageDiv.className = `dm-message ${isOwn ? 'own' : 'other'}`;
                
                const time = new Date(dmData.sentAt).toLocaleTimeString('ja-JP', { 
                    hour: '2-digit', minute: '2-digit' 
                });
                
                const avatarStyle = dmData.senderAvatarUrl 
                    ? `background-image: url(${dmData.senderAvatarUrl})` 
                    : '';
                
                messageDiv.innerHTML = `
                    ${!isOwn ? `<div class="dm-message-avatar" style="${avatarStyle}"></div>` : ''}
                    <div class="dm-message-bubble">
                        <div class="dm-message-content">${escapeHtml(dmData.content)}</div>
                        <div class="dm-message-time">${time}</div>
                    </div>
                    ${isOwn ? `<div class="dm-message-avatar" style="${avatarStyle}"></div>` : ''}
                `;
                
                messagesContainer.appendChild(messageDiv);
                scrollDMToBottom();
                console.log('📝 メッセージをDOMに追加しました');
                
                if (!isOwn && stompClient && isWebSocketConnected) {
                    stompClient.send('/app/dm.read', {}, JSON.stringify({
                        conversationId: currentConversationId
                    }));
                }
            } else {
                console.log('⚠️ 別の会話のメッセージです。DM画面には表示しません。');
            }
            
            // チャット画面が表示されている場合は会話リストを更新（リアルタイム）
            const chatSection = document.getElementById('chat-section');
            if (chatSection && chatSection.classList.contains('active')) {
                console.log('🔄 チャット画面が表示中なので会話リストを更新します');
                loadDMConversations();
            }
        }
        
        function handleDMReadNotification(readData) {
            console.log('✅ 既読通知:', readData);
        }
        
        function scrollDMToBottom() {
            const container = document.getElementById('dmMessagesContainer');
            container.scrollTop = container.scrollHeight;
        }
        
        document.getElementById('backFromDmBtn').addEventListener('click', function() {
            document.getElementById('dm-section').style.display = 'none';
            document.getElementById('dm-section').classList.remove('active');
            
            const sections = document.querySelectorAll('.app-section');
            sections.forEach(section => section.classList.remove('active'));
            document.getElementById('home-section').classList.add('active');
            
            // フッターナビゲーションを再表示
            const bottomNav = document.querySelector('.bottom-nav');
            if (bottomNav) {
                bottomNav.style.display = 'flex';
            }
            
            // プロフィールアクションボタンを非表示のまま（元の画面に戻るだけなので）
            const profileActions = document.getElementById('profileActions');
            if (profileActions) {
                profileActions.style.display = 'none';
            }
            
            // 投稿ボタンを再表示
            const createPostBtn = document.getElementById('btnCreatePost');
            if (createPostBtn) {
                createPostBtn.style.display = 'flex';
            }
            
            currentConversationId = null;
            currentDMUser = null;
        });

        // ========================================
        // ルームチャット関連
        // ========================================

        let currentRoomId = null;
        let currentRoomName = null;
        let currentRoomCreator = null;
        let roomStompClient = null;
        let roomSubscription = null;

        // ルームチャット画面を開く
        function openRoomChat(room) {
            console.log('🚪 ルームチャット画面を開く:', room);

            currentRoomId = room.id;
            currentRoomName = room.name;
            currentRoomCreator = room.creatorUsername;

            // ルームチャット画面を表示
            const sections = document.querySelectorAll('.app-section');
            sections.forEach(section => section.classList.remove('active'));

            const roomChatSection = document.getElementById('room-chat-section');
            roomChatSection.style.display = 'block';
            roomChatSection.classList.add('active');

            // ヘッダー情報を設定
            document.getElementById('roomChatName').textContent = room.name;
            document.getElementById('roomChatMemberCount').textContent = `メンバー${room.memberCount || 0}人`;

            // ルームアイコンを設定
            const roomAvatar = document.getElementById('roomChatAvatar');
            if (roomAvatar) {
                if (room.iconUrl) {
                    roomAvatar.style.backgroundImage = `url(${room.iconUrl})`;
                    roomAvatar.style.backgroundSize = 'cover';
                    roomAvatar.style.backgroundPosition = 'center';
                    roomAvatar.innerHTML = '';
                } else {
                    roomAvatar.style.backgroundImage = '';
                    roomAvatar.innerHTML = '<i class="fas fa-users"></i>';
                }
            }

            // 招待ボタン・アイコン変更はルーム作成者のみ
            const inviteBtn = document.getElementById('roomInviteBtn');
            const currentUsername = document.querySelector('.app-container').dataset.currentUsername;
            const isCreator = room.createdByUsername && room.createdByUsername === currentUsername;

            if (inviteBtn) {
                inviteBtn.style.display = isCreator ? 'flex' : 'none';
            }

            // 作成者ならアイコンタップで変更可能（メンバー一覧への遷移を止める）
            if (roomAvatar) {
                roomAvatar.style.cursor = isCreator ? 'pointer' : 'default';
                roomAvatar.onclick = isCreator ? (e) => {
                    e.stopPropagation();
                    document.getElementById('roomIconInput').click();
                } : null;
            }

            // フッターナビゲーションを非表示
            const bottomNav = document.querySelector('.bottom-nav');
            if (bottomNav) {
                bottomNav.style.display = 'none';
            }

            // 投稿ボタンを非表示
            const createPostBtn = document.getElementById('btnCreatePost');
            if (createPostBtn) {
                createPostBtn.style.display = 'none';
            }

            // ルーム作成ボタンを非表示
            const btnCreateRoom = document.getElementById('btnCreateRoom');
            if (btnCreateRoom) {
                btnCreateRoom.style.display = 'none';
            }

            // メッセージをクリア
            document.getElementById('roomMessages').innerHTML = '';
            document.getElementById('roomInput').value = '';

            // WebSocket接続してメッセージを読み込む
            connectToRoomWebSocket(room.id);
            loadRoomMessages(room.id);
        }

        // ルームチャット画面の戻るボタン
        document.getElementById('backFromRoomChatBtn').addEventListener('click', function() {
            // WebSocket切断
            if (roomSubscription) {
                roomSubscription.unsubscribe();
                roomSubscription = null;
            }

            const roomChatSection = document.getElementById('room-chat-section');
            roomChatSection.style.display = 'none';
            roomChatSection.classList.remove('active');

            const sections = document.querySelectorAll('.app-section');
            sections.forEach(section => section.classList.remove('active'));

            // ルームセクションに戻る
            const roomSection = document.getElementById('room-section');
            roomSection.classList.add('active');

            // フッターナビゲーションを再表示
            const bottomNav = document.querySelector('.bottom-nav');
            if (bottomNav) {
                bottomNav.style.display = 'flex';
            }

            // ルーム作成ボタンを再表示
            const btnCreateRoom = document.getElementById('btnCreateRoom');
            if (btnCreateRoom) {
                btnCreateRoom.style.display = 'flex';
            }

            currentRoomId = null;
        });

        // ルームヘッダークリックでメンバー一覧を表示
        document.getElementById('roomChatInfo').addEventListener('click', function() {
            if (currentRoomId && currentRoomId !== 1) {
                // メインルーム(ID=1)以外の場合のみメンバー一覧を表示
                showMembersPanel(currentRoomId);
            }
        });

        // メンバー一覧パネルの戻るボタン
        document.getElementById('backFromMembersBtn').addEventListener('click', function() {
            const membersSection = document.getElementById('room-members-section');
            membersSection.style.display = 'none';
            membersSection.classList.remove('active');

            // ルームチャット画面に戻る
            const roomChatSection = document.getElementById('room-chat-section');
            roomChatSection.style.display = 'block';
            roomChatSection.classList.add('active');
        });

        // ルームアイコンアップロード処理
        document.getElementById('roomIconInput').addEventListener('change', function() {
            const file = this.files[0];
            if (!file || !currentRoomId) return;
            const roomId = currentRoomId;

            CropModal.open(file, async function(blob) {
                const formData = new FormData();
                formData.append('icon', blob, 'icon.png');

                try {
                    const res = await fetch(`/rooms/${roomId}/upload-icon`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (data.success && data.iconUrl) {
                        const avatar = document.getElementById('roomChatAvatar');
                        avatar.style.backgroundImage = `url(${data.iconUrl})`;
                        avatar.style.backgroundSize = 'cover';
                        avatar.style.backgroundPosition = 'center';
                        avatar.innerHTML = '';
                    }
                } catch (e) {
                    console.error('アイコンアップロードエラー:', e);
                }
            });
            this.value = '';
        });

        // ルーム招待ボタンのクリックハンドラー
        const inviteBtn = document.getElementById('roomInviteBtn');
        if (inviteBtn) {
            inviteBtn.addEventListener('click', function() {
                if (currentRoomId) {
                    showRoomInviteScreen(currentRoomId);
                }
            });
        }

        // 招待画面の戻るボタン
        document.getElementById('backFromRoomInviteBtn').addEventListener('click', function() {
            const inviteSection = document.getElementById('room-invite-section');
            inviteSection.style.display = 'none';
            inviteSection.classList.remove('active');

            // ルームチャット画面に戻る
            const roomChatSection = document.getElementById('room-chat-section');
            roomChatSection.style.display = 'block';
            roomChatSection.classList.add('active');
        });

        // 招待画面を表示
        async function showRoomInviteScreen(roomId) {
            console.log('👥 招待画面を表示:', roomId);

            // ルームチャット画面を非表示
            const roomChatSection = document.getElementById('room-chat-section');
            roomChatSection.style.display = 'none';
            roomChatSection.classList.remove('active');

            // 招待画面を表示
            const inviteSection = document.getElementById('room-invite-section');
            inviteSection.style.display = 'block';
            inviteSection.classList.add('active');

            // ルーム名を設定
            document.getElementById('inviteRoomName').textContent = currentRoomName || '';

            // ローディング表示
            document.getElementById('followerInviteList').innerHTML = `
                <div class="members-loading" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.6);">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p style="margin-top: 1rem;">フォロワーを読み込み中...</p>
                </div>
            `;

            // フォロワーリストと現在のルームメンバー、招待状況を取得
            await loadFollowersForRoomInvite(roomId);
        }

        // 招待用フォロワーリストを読み込む
        async function loadFollowersForRoomInvite(roomId) {
            try {
                // フォロワー、ルームメンバー、招待状況を並行して取得
                const [followersRes, membersRes, invitationsRes] = await Promise.all([
                    fetch('/api/users/me/followers'),
                    fetch(`/rooms/${roomId}/api/members`),
                    fetch('/rooms/api/invitations-sent?roomId=' + roomId)
                ]);

                const followersData = await followersRes.json();
                const membersData = await membersRes.json();

                // 招待状況を取得（エラーの場合は空配列）
                let invitedUsernames = [];
                if (invitationsRes.ok) {
                    const invitationsData = await invitationsRes.json();
                    if (invitationsData.success && invitationsData.invitations) {
                        invitedUsernames = invitationsData.invitations.map(inv => inv.inviteeUsername);
                    }
                }

                if (!followersData.success) {
                    document.getElementById('followerInviteList').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.6);">
                            <i class="fas fa-exclamation-circle fa-2x"></i>
                            <p style="margin-top: 1rem;">フォロワーの取得に失敗しました</p>
                        </div>
                    `;
                    return;
                }

                const followers = followersData.users || [];

                // 現在のメンバーのusernameリストを作成
                const memberUsernames = membersData.success && membersData.members
                    ? membersData.members.map(m => m.username)
                    : [];

                displayFollowersForRoomInvite(followers, memberUsernames, invitedUsernames, roomId);
            } catch (error) {
                console.error('❌ フォロワー読み込みエラー:', error);
                document.getElementById('followerInviteList').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.6);">
                        <i class="fas fa-exclamation-circle fa-2x"></i>
                        <p style="margin-top: 1rem;">読み込み中にエラーが発生しました</p>
                    </div>
                `;
            }
        }

        // 招待用フォロワーリストを表示
        function displayFollowersForRoomInvite(followers, memberUsernames, invitedUsernames, roomId) {
            const listContainer = document.getElementById('followerInviteList');

            if (followers.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.6);">
                        <i class="fas fa-users fa-2x"></i>
                        <p style="margin-top: 1rem;">フォロワーがいません</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = '';

            followers.forEach(follower => {
                const item = document.createElement('div');
                item.className = 'invite-list-item';
                item.dataset.username = follower.username;

                // アバター
                let avatarHtml = '';
                if (follower.avatarUrl) {
                    avatarHtml = `<div class="invite-avatar" style="background-image: url(${escapeHtml(follower.avatarUrl)}); background-size: cover;"></div>`;
                } else {
                    avatarHtml = `<div class="invite-avatar"><i class="fas fa-user"></i></div>`;
                }

                // ボタン状態を判定
                const isMember = memberUsernames.includes(follower.username);
                const isInvited = invitedUsernames.includes(follower.username);

                let buttonHtml = '';
                if (isMember) {
                    buttonHtml = `<button class="invite-btn already-member" disabled>参加中</button>`;
                } else if (isInvited) {
                    buttonHtml = `<button class="invite-btn already-invited" disabled>招待済</button>`;
                } else {
                    buttonHtml = `<button class="invite-btn can-invite" data-username="${escapeHtml(follower.username)}">招待</button>`;
                }

                item.innerHTML = `
                    ${avatarHtml}
                    <div class="invite-info">
                        <div class="invite-name">${escapeHtml(follower.displayName || follower.username)}</div>
                    </div>
                    ${buttonHtml}
                `;

                // 招待ボタンのクリックハンドラー
                const inviteBtn = item.querySelector('.invite-btn.can-invite');
                if (inviteBtn) {
                    inviteBtn.addEventListener('click', async function() {
                        const username = this.dataset.username;
                        await sendRoomInvite(roomId, username, this);
                    });
                }

                listContainer.appendChild(item);
            });
        }

        // ルーム招待を送信
        async function sendRoomInvite(roomId, username, buttonElement) {
            try {
                // ボタンを無効化
                buttonElement.disabled = true;
                buttonElement.textContent = '送信中...';

                const response = await fetch(`/rooms/${roomId}/invite?username=${encodeURIComponent(username)}`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    console.log('✅ 招待送信成功:', username);
                    // ボタンを招待済みに変更
                    buttonElement.className = 'invite-btn already-invited';
                    buttonElement.textContent = '招待済';
                } else {
                    console.error('❌ 招待送信失敗:', data.message);
                    alert(data.message || '招待の送信に失敗しました');
                    // ボタンを元に戻す
                    buttonElement.disabled = false;
                    buttonElement.textContent = '招待';
                }
            } catch (error) {
                console.error('❌ 招待送信エラー:', error);
                alert('招待の送信中にエラーが発生しました');
                buttonElement.disabled = false;
                buttonElement.textContent = '招待';
            }
        }

        // メンバー一覧パネルを表示
        async function showMembersPanel(roomId) {
            // メンバー一覧パネルを表示
            const roomChatSection = document.getElementById('room-chat-section');
            roomChatSection.style.display = 'none';
            roomChatSection.classList.remove('active');

            const membersSection = document.getElementById('room-members-section');
            membersSection.style.display = 'block';
            membersSection.classList.add('active');

            // ローディング表示
            document.getElementById('membersList').innerHTML = `
                <div class="members-loading">
                    <i class="fas fa-spinner"></i>
                    <p>読み込み中...</p>
                </div>
            `;

            // メンバー情報を取得
            await loadRoomMembers(roomId);
        }

        // ルームメンバー一覧を読み込む
        async function loadRoomMembers(roomId) {
            try {
                const response = await fetch(`/rooms/${roomId}/api/members`, {
                    credentials: 'same-origin',
                    cache: 'no-store',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    console.error('❌ メンバー一覧取得失敗:', response.status);
                    return;
                }

                const data = await response.json();

                if (!data.success) {
                    console.error('❌ メンバー一覧取得失敗:', data.message);
                    document.getElementById('membersList').innerHTML = `
                        <div class="members-empty">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>${data.message || 'メンバー情報を取得できませんでした'}</p>
                        </div>
                    `;
                    return;
                }

                // ヘッダー情報を更新
                document.getElementById('membersPanelRoomName').textContent = data.roomName;
                document.getElementById('membersPanelCount').textContent = `${data.memberCount}人参加中`;

                // メンバー一覧を表示
                displayMembersList(data.members, data.isCreator, data.creatorUsername);

            } catch (error) {
                console.error('❌ メンバー一覧取得エラー:', error);
                document.getElementById('membersList').innerHTML = `
                    <div class="members-empty">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>エラーが発生しました</p>
                    </div>
                `;
            }
        }

        // メンバー一覧を表示
        function displayMembersList(members, isCreator, creatorUsername) {
            const container = document.getElementById('membersList');

            if (!members || members.length === 0) {
                container.innerHTML = `
                    <div class="members-empty">
                        <i class="fas fa-users-slash"></i>
                        <p>メンバーがいません</p>
                    </div>
                `;
                return;
            }

            // 作成者を先頭にソート
            const sortedMembers = [...members].sort((a, b) => {
                if (a.isCreator) return -1;
                if (b.isCreator) return 1;
                return 0;
            });

            let html = '';
            for (const member of sortedMembers) {
                const avatarHtml = member.avatarUrl
                    ? `<img src="${member.avatarUrl}" alt="${escapeHtml(member.displayName)}">`
                    : `<i class="fas fa-user"></i>`;

                const creatorBadge = member.isCreator
                    ? `<span class="creator-badge">作成者</span>`
                    : '';

                const bioText = member.shortBio || '';

                // 退会ボタン（作成者が見ている場合のみ、かつ自分自身と作成者以外）
                let kickButton = '';
                if (isCreator && !member.isCreator && member.username !== window.currentUser) {
                    kickButton = `
                        <div class="member-actions">
                            <button class="kick-btn" data-username="${escapeHtml(member.username)}" data-display-name="${escapeHtml(member.displayName)}">
                                退会
                            </button>
                        </div>
                    `;
                }

                html += `
                    <div class="member-item" data-username="${escapeHtml(member.username)}">
                        <div class="member-avatar">
                            ${avatarHtml}
                        </div>
                        <div class="member-info">
                            <div class="member-name">
                                ${escapeHtml(member.displayName)}
                                ${creatorBadge}
                            </div>
                            <div class="member-bio">${escapeHtml(bioText)}</div>
                        </div>
                        ${kickButton}
                    </div>
                `;
            }

            container.innerHTML = html;

            // 退会ボタンのイベントリスナーを追加
            container.querySelectorAll('.kick-btn').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    const username = this.dataset.username;
                    const displayName = this.dataset.displayName;
                    if (confirm(`${displayName}さんをルームから退会させますか？`)) {
                        await kickMember(currentRoomId, username);
                    }
                });
            });
        }

        // メンバーを退会させる
        async function kickMember(roomId, username) {
            try {
                const response = await fetch(`/rooms/${roomId}/kick-member?username=${encodeURIComponent(username)}`, {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    // メンバー一覧パネルを閉じてルームチャットに戻る
                    const membersSection = document.getElementById('room-members-section');
                    membersSection.style.display = 'none';
                    membersSection.classList.remove('active');

                    const roomChatSection = document.getElementById('room-chat-section');
                    roomChatSection.style.display = 'block';
                    roomChatSection.classList.add('active');
                } else {
                    alert('退会処理に失敗しました: ' + data.message);
                }
            } catch (error) {
                console.error('❌ 退会処理エラー:', error);
                alert('退会処理中にエラーが発生しました');
            }
        }

        // ルームのWebSocketに接続
        function connectToRoomWebSocket(roomId) {
            if (typeof SockJS === 'undefined' || typeof Stomp === 'undefined') {
                console.error('❌ SockJS または Stomp が読み込まれていません');
                return;
            }

            // 既存の接続があれば切断
            if (roomSubscription) {
                roomSubscription.unsubscribe();
            }

            // グローバルのstompClientを使用（既に接続済みと仮定）
            if (window.stompClient && window.stompClient.connected) {
                roomSubscription = window.stompClient.subscribe(`/topic/chatroom/${roomId}`, function(message) {
                    const chatMessage = JSON.parse(message.body);
                    displayRoomMessage(chatMessage);
                });
                console.log('✅ ルーム', roomId, 'のWebSocketに接続しました（/topic/chatroom/' + roomId + '）');
            } else {
                console.error('❌ WebSocketが接続されていません');
            }
        }

        // ルームメッセージを読み込む
        async function loadRoomMessages(roomId) {
            try {
                console.log('📨 ルームメッセージを読み込み中...', roomId);
                const response = await fetch(`/api/messages/${roomId}`, {
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('❌ メッセージ読み込み失敗:', response.status);
                    return;
                }

                const messages = await response.json();
                console.log('✅ メッセージ取得:', messages.length, '件');

                const messagesContainer = document.getElementById('roomMessages');
                messagesContainer.innerHTML = '';

                messages.forEach(msg => {
                    displayRoomMessage(msg);
                });

                // スクロールを最下部に
                scrollRoomMessagesToBottom();
            } catch (error) {
                console.error('❌ メッセージ読み込みエラー:', error);
            }
        }

        // ルームメッセージを表示
        function displayRoomMessage(message) {
            const messagesContainer = document.getElementById('roomMessages');
            const messageDiv = document.createElement('div');

            // 現在のユーザー名を取得（グローバル変数から）
            const currentUsername = window.currentUser || '';
            const isOwnMessage = message.senderUsername === currentUsername || message.sender === currentUsername || message.username === currentUsername;

            messageDiv.className = `dm-message ${isOwnMessage ? 'own' : 'other'}`;

            const timestamp = message.timestamp || message.createdAt;
            const timeStr = timestamp ? new Date(timestamp).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) : '';
            const senderName = message.senderDisplayName || message.senderUsername || message.sender || message.username || '不明';

            // アバターのスタイル
            const avatarUrl = message.senderAvatarUrl || '';
            const avatarStyle = avatarUrl ? `background-image: url(${avatarUrl})` : '';

            // ユーザーIDを取得
            console.log('📨 ルームメッセージ:', message);
            const userId = message.userId || null;
            console.log('👤 userId:', userId);

            messageDiv.innerHTML = `
                ${!isOwnMessage ? `<div class="dm-message-avatar room-avatar-clickable" style="${avatarStyle}" data-user-id="${userId}" data-username="${message.senderUsername || message.sender || ''}"></div>` : ''}
                <div class="dm-message-bubble">
                    ${!isOwnMessage ? `<div class="dm-message-sender">${escapeHtml(senderName)}</div>` : ''}
                    <div class="dm-message-content">${escapeHtml(message.content || message.message || '')}</div>
                    <div class="dm-message-time">${timeStr}</div>
                </div>
                ${isOwnMessage ? `<div class="dm-message-avatar" style="${avatarStyle}"></div>` : ''}
            `;

            // 他人のメッセージのアイコンにクリックイベントを追加
            if (!isOwnMessage) {
                const avatar = messageDiv.querySelector('.room-avatar-clickable');
                if (avatar && userId) {
                    avatar.style.cursor = 'pointer';
                    avatar.addEventListener('click', () => showProfilePopup(userId));
                }
            }

            messagesContainer.appendChild(messageDiv);
            scrollRoomMessagesToBottom();
        }

        // ルームメッセージを最下部にスクロール
        function scrollRoomMessagesToBottom() {
            const container = document.getElementById('roomMessagesContainer');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }

        // プロフィールポップアップを表示
        let currentPopupUserId = null;
        async function showProfilePopup(userId) {
            console.log('🔍 showProfilePopup呼び出し - userId:', userId, '型:', typeof userId);
            if (!userId) return;
            currentPopupUserId = userId;
            console.log('📌 currentPopupUserId設定:', currentPopupUserId, '型:', typeof currentPopupUserId);

            try {
                const response = await fetch(`/api/users/${userId}/profile`);
                const data = await response.json();

                if (data.success) {
                    const user = data.user;
                    const profile = data.profile;

                    // アバターのHTML
                    let avatarHtml = '';
                    if (profile && profile.avatarUrl) {
                        avatarHtml = `<div class="profile-popup-avatar" style="background-image: url(${profile.avatarUrl}); background-size: cover; background-position: center;"></div>`;
                    } else {
                        avatarHtml = `<div class="profile-popup-avatar"><i class="fas fa-user"></i></div>`;
                    }

                    // タグのHTML
                    let tagsHtml = '';
                    if (profile && profile.favoriteThings) {
                        const tags = profile.favoriteThings.split(',').map(tag => tag.trim()).filter(tag => tag);
                        if (tags.length > 0) {
                            tagsHtml = `
                                <div class="profile-popup-tags">
                                    ${tags.map(tag => `<span class="profile-popup-tag">${escapeHtml(tag)}</span>`).join('')}
                                </div>
                            `;
                        }
                    }

                    const popupContent = document.getElementById('profilePopupContent');
                    popupContent.innerHTML = `
                        ${avatarHtml}
                        <div class="profile-popup-name">${escapeHtml(profile && profile.displayName ? profile.displayName : user.username)}</div>
                        <div class="profile-popup-username">@${escapeHtml(user.username)}</div>
                        <div class="profile-popup-bio">${profile && profile.bio ? escapeHtml(profile.bio) : '自己紹介が未設定です'}</div>
                        ${tagsHtml}
                        <div class="profile-popup-stats">
                            <div class="profile-popup-stat">
                                <div class="profile-popup-stat-value">${data.followingCount || 0}</div>
                                <div class="profile-popup-stat-label">フォロー</div>
                            </div>
                            <div class="profile-popup-stat">
                                <div class="profile-popup-stat-value">${data.followerCount || 0}</div>
                                <div class="profile-popup-stat-label">フォロワー</div>
                            </div>
                            <div class="profile-popup-stat">
                                <div class="profile-popup-stat-value">${data.friendCount || 0}</div>
                                <div class="profile-popup-stat-label">フレンド</div>
                            </div>
                        </div>
                    `;

                    // ポップアップを表示
                    document.getElementById('profilePopupOverlay').classList.add('active');

                    // フォロー状態を取得してボタンを更新
                    await updatePopupFollowButton(userId);
                }
            } catch (error) {
                console.error('プロフィール取得エラー:', error);
            }
        }

        // ポップアップのフォローボタンの状態を更新
        async function updatePopupFollowButton(userId) {
            try {
                const response = await fetch(`/api/users/${userId}/relationship`);
                const data = await response.json();

                if (data.success) {
                    const followBtn = document.getElementById('btnPopupFollow');
                    const relationship = data.relationship;

                    if (relationship === 'friend') {
                        followBtn.innerHTML = '<i class="fas fa-user-check me-2"></i>フレンド';
                        followBtn.classList.add('following');
                        followBtn.dataset.relationship = 'friend';
                    } else if (relationship === 'following') {
                        followBtn.innerHTML = '<i class="fas fa-user-check me-2"></i>フォロー中';
                        followBtn.classList.add('following');
                        followBtn.dataset.relationship = 'following';
                    } else if (relationship === 'follower') {
                        followBtn.innerHTML = '<i class="fas fa-user-plus me-2"></i>フォローバック';
                        followBtn.classList.remove('following');
                        followBtn.dataset.relationship = 'follower';
                    } else {
                        followBtn.innerHTML = '<i class="fas fa-user-plus me-2"></i>フォロー';
                        followBtn.classList.remove('following');
                        followBtn.dataset.relationship = 'none';
                    }
                }
            } catch (error) {
                console.error('Error getting relationship:', error);
            }
        }

        // プロフィールポップアップを閉じる
        function closeProfilePopup(event) {
            if (event) event.stopPropagation();
            document.getElementById('profilePopupOverlay').classList.remove('active');
            currentPopupUserId = null;
        }

        // ポップアップのDMボタン
        document.getElementById('btnPopupChat').addEventListener('click', async function() {
            if (!currentPopupUserId) return;
            // closeProfilePopupの前にuserIdを保存（closeで nullにリセットされるため）
            const targetId = parseInt(currentPopupUserId);
            closeProfilePopup();
            // DM会話を開始または取得
            try {
                console.log('📤 DM開始リクエスト - targetUserId:', targetId);
                const response = await fetch('/api/dm/conversations/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ targetUserId: targetId })
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ DM開始エラーレスポンス:', response.status, errorText);
                    alert('DMの開始に失敗しました: ' + response.status);
                    return;
                }
                const data = await response.json();
                console.log('📥 DM開始レスポンス:', data);
                if (data.success && data.conversation) {
                    // ルームチャット画面を非表示
                    const roomChatSection = document.getElementById('room-chat-section');
                    if (roomChatSection) {
                        roomChatSection.style.display = 'none';
                        roomChatSection.classList.remove('active');
                    }
                    // メンバーパネルも閉じる
                    const membersSection = document.getElementById('room-members-section');
                    if (membersSection) {
                        membersSection.style.display = 'none';
                        membersSection.classList.remove('active');
                    }
                    // DM画面を開く
                    await openDMScreen(data.conversation.conversationId);
                }
            } catch (error) {
                console.error('DM開始エラー:', error);
                alert('DMの開始に失敗しました');
            }
        });

        // ポップアップのフォローボタン
        document.getElementById('btnPopupFollow').addEventListener('click', async function() {
            if (!currentPopupUserId) return;

            const followBtn = document.getElementById('btnPopupFollow');
            const isFollowing = followBtn.classList.contains('following');
            const relationship = followBtn.dataset.relationship;

            // フォロー済み・フレンドの場合は確認ダイアログを表示
            if (isFollowing) {
                let confirmMessage = 'フォローを解除しますか？';
                if (relationship === 'friend') {
                    confirmMessage = 'フレンド関係を解除しますか？\n（相互フォローが解除されます）';
                }
                if (!confirm(confirmMessage)) {
                    return;
                }
            }

            const endpoint = isFollowing ? 'unfollow' : 'follow';

            // ボタンを一時的に無効化
            followBtn.disabled = true;
            const originalText = followBtn.innerHTML;
            followBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>処理中...';

            try {
                const response = await fetch(`/api/users/${currentPopupUserId}/${endpoint}`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    // ボタンの状態を即座に更新
                    await updatePopupFollowButton(currentPopupUserId);

                    // ポップアップ内のフォロワー数を更新
                    const statsContainer = document.querySelector('.profile-popup-stats');
                    if (statsContainer && data.targetFollowerCount !== undefined) {
                        const followerStat = statsContainer.querySelectorAll('.profile-popup-stat')[1];
                        if (followerStat) {
                            const valueEl = followerStat.querySelector('.profile-popup-stat-value');
                            if (valueEl) {
                                valueEl.textContent = data.targetFollowerCount;
                            }
                        }
                    }
                } else {
                    alert(data.message || 'エラーが発生しました');
                    followBtn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Error toggling follow:', error);
                alert('エラーが発生しました');
                followBtn.innerHTML = originalText;
            } finally {
                followBtn.disabled = false;
            }
        });

        // ルームメッセージ送信
        document.getElementById('roomSendBtn').addEventListener('click', function() {
            sendRoomMessage();
        });

        document.getElementById('roomInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendRoomMessage();
            }
        });

        function sendRoomMessage() {
            const input = document.getElementById('roomInput');
            const message = input.value.trim();

            if (!message || !currentRoomId) {
                return;
            }

            if (!window.stompClient || !window.stompClient.connected) {
                alert('WebSocketが接続されていません');
                return;
            }

            const chatMessage = {
                chatRoomId: currentRoomId,
                content: message,
                type: 'CHAT'
            };

            try {
                window.stompClient.send('/app/chat.sendMessage', {}, JSON.stringify(chatMessage));
                input.value = '';

                // 自動でサイズをリセット
                input.style.height = 'auto';
            } catch (error) {
                console.error('❌ メッセージ送信エラー:', error);
                alert('メッセージの送信に失敗しました');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========================================
        // フォロー/フォロワー/フレンド一覧機能
        // ========================================
        let currentRelationsTab = 'following';

        // マイページの統計をクリック可能にする
        document.querySelectorAll('.stat-clickable').forEach(stat => {
            stat.style.cursor = 'pointer';
            stat.addEventListener('click', function() {
                const tab = this.dataset.tab;
                openRelationsSection(tab);
            });
        });

        // 一覧画面を開く
        function openRelationsSection(tab) {
            currentRelationsTab = tab;

            // セクションを切り替え
            const sections = document.querySelectorAll('.app-section');
            sections.forEach(section => section.classList.remove('active'));

            const relationsSection = document.getElementById('relations-section');
            relationsSection.style.display = 'block';
            relationsSection.classList.add('active');

            // フッターを非表示
            const bottomNav = document.querySelector('.bottom-nav');
            if (bottomNav) bottomNav.style.display = 'none';
            const createPostBtn = document.getElementById('btnCreatePost');
            if (createPostBtn) createPostBtn.style.display = 'none';

            // タブをアクティブにする
            document.querySelectorAll('.relations-tab').forEach(t => {
                t.classList.remove('active');
                if (t.dataset.tab === tab) t.classList.add('active');
            });

            // 一覧を読み込む
            loadRelationsList(tab);
        }

        // 戻るボタン
        document.getElementById('backFromRelationsBtn').addEventListener('click', function() {
            const relationsSection = document.getElementById('relations-section');
            relationsSection.style.display = 'none';
            relationsSection.classList.remove('active');

            // マイページに戻る
            const sections = document.querySelectorAll('.app-section');
            sections.forEach(section => section.classList.remove('active'));
            document.getElementById('mypage-section').classList.add('active');

            // フッターを表示
            const bottomNav = document.querySelector('.bottom-nav');
            if (bottomNav) bottomNav.style.display = 'flex';
        });

        // タブ切り替え
        document.querySelectorAll('.relations-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                currentRelationsTab = tabName;

                // タブをアクティブにする
                document.querySelectorAll('.relations-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // 一覧を読み込む
                loadRelationsList(tabName);
            });
        });

        // 一覧を読み込む
        async function loadRelationsList(tab) {
            const listContainer = document.getElementById('relationsList');
            listContainer.innerHTML = '<div class="relations-empty"><i class="fas fa-spinner fa-spin"></i><p>読み込み中...</p></div>';

            try {
                const response = await fetch(`/api/users/me/${tab}`);
                const data = await response.json();

                if (data.success) {
                    displayRelationsList(data.users, tab);
                } else {
                    listContainer.innerHTML = '<div class="relations-empty"><i class="fas fa-exclamation-circle"></i><p>読み込みに失敗しました</p></div>';
                }
            } catch (error) {
                console.error('一覧読み込みエラー:', error);
                listContainer.innerHTML = '<div class="relations-empty"><i class="fas fa-exclamation-circle"></i><p>読み込みに失敗しました</p></div>';
            }
        }

        // 一覧を表示
        async function displayRelationsList(users, tab) {
            const listContainer = document.getElementById('relationsList');

            if (!users || users.length === 0) {
                const emptyMessages = {
                    following: 'フォローしているユーザーはいません',
                    followers: 'フォロワーはいません',
                    friends: 'フレンドはいません'
                };
                listContainer.innerHTML = `<div class="relations-empty"><i class="fas fa-user-friends"></i><p>${emptyMessages[tab]}</p></div>`;
                return;
            }

            listContainer.innerHTML = users.map(user => {
                const avatarStyle = user.avatarUrl
                    ? `background-image: url(${user.avatarUrl}); background-size: cover; background-position: center;`
                    : '';
                const displayName = user.displayName || user.username;

                return `
                    <div class="relation-item" data-user-id="${user.id}">
                        <div class="relation-avatar-clickable" style="${avatarStyle}" data-user-id="${user.id}">
                            ${!user.avatarUrl ? '<i class="fas fa-user"></i>' : ''}
                        </div>
                        <div class="relation-info">
                            <div class="relation-name">${escapeHtml(displayName)}</div>
                        </div>
                        <div class="relation-actions">
                            <button class="relation-dm-btn" data-user-id="${user.id}">
                                <i class="fas fa-comment"></i>
                            </button>
                            <button class="relation-follow-btn" data-user-id="${user.id}" data-relationship="">
                                <i class="fas fa-user-plus"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // 各ユーザーの関係性を取得してフォローボタンを更新
            for (const user of users) {
                await updateRelationFollowButton(user.id);
            }

            // アバタークリックでプロフィール表示
            listContainer.querySelectorAll('.relation-avatar-clickable').forEach(avatar => {
                avatar.style.cursor = 'pointer';
                avatar.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const userId = this.dataset.userId;
                    document.getElementById('relations-section').style.display = 'none';
                    document.getElementById('relations-section').classList.remove('active');
                    viewUserProfile(parseInt(userId));
                });
            });

            // DMボタン
            listContainer.querySelectorAll('.relation-dm-btn').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    const userId = parseInt(this.dataset.userId);
                    try {
                        const response = await fetch('/api/dm/conversations/start', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ targetUserId: userId })
                        });
                        const data = await response.json();
                        if (data.success && data.conversation) {
                            document.getElementById('relations-section').style.display = 'none';
                            document.getElementById('relations-section').classList.remove('active');
                            await openDMScreen(data.conversation.conversationId);
                        }
                    } catch (error) {
                        console.error('DM開始エラー:', error);
                    }
                });
            });

            // フォローボタン
            listContainer.querySelectorAll('.relation-follow-btn').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    const userId = parseInt(this.dataset.userId);
                    const isFollowing = this.classList.contains('following');
                    const relationship = this.dataset.relationship;

                    if (isFollowing) {
                        let confirmMessage = 'フォローを解除しますか？';
                        if (relationship === 'friend') {
                            confirmMessage = 'フレンド関係を解除しますか？\n（相互フォローが解除されます）';
                        }
                        if (!confirm(confirmMessage)) return;
                    }

                    const endpoint = isFollowing ? 'unfollow' : 'follow';
                    this.disabled = true;

                    try {
                        const response = await fetch(`/api/users/${userId}/${endpoint}`, { method: 'POST' });
                        const data = await response.json();
                        if (data.success) {
                            await updateRelationFollowButton(userId);
                            // マイページの数値も更新
                            if (data.followingCount !== undefined) {
                                document.getElementById('myFollowingCount').textContent = data.followingCount;
                            }
                            if (data.followerCount !== undefined) {
                                document.getElementById('myFollowerCount').textContent = data.followerCount;
                            }
                            if (data.friendCount !== undefined) {
                                document.getElementById('myFriendCount').textContent = data.friendCount;
                            }
                        }
                    } catch (error) {
                        console.error('フォロー切り替えエラー:', error);
                    } finally {
                        this.disabled = false;
                    }
                });
            });
        }

        // 一覧のフォローボタンを更新
        async function updateRelationFollowButton(userId) {
            try {
                const response = await fetch(`/api/users/${userId}/relationship`);
                const data = await response.json();
                if (data.success) {
                    const btn = document.querySelector(`.relation-follow-btn[data-user-id="${userId}"]`);
                    if (!btn) return;

                    const relationship = data.relationship;
                    btn.dataset.relationship = relationship;

                    if (relationship === 'friend') {
                        btn.innerHTML = '<i class="fas fa-user-check"></i>';
                        btn.classList.add('following');
                        btn.title = 'フレンド';
                    } else if (relationship === 'following') {
                        btn.innerHTML = '<i class="fas fa-user-check"></i>';
                        btn.classList.add('following');
                        btn.title = 'フォロー中';
                    } else if (relationship === 'follower') {
                        btn.innerHTML = '<i class="fas fa-user-plus"></i>';
                        btn.classList.remove('following');
                        btn.title = 'フォローバック';
                    } else {
                        btn.innerHTML = '<i class="fas fa-user-plus"></i>';
                        btn.classList.remove('following');
                        btn.title = 'フォロー';
                    }
                }
            } catch (error) {
                console.error('関係性取得エラー:', error);
            }
        }
    </script>
</body>
</html>
