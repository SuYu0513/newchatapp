<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, interactive-widget=resizes-visual-viewport">
    <title>ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª</title>
    
    <!-- PWAè¨­å®š -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/common.css(v=${@appVersion})}" rel="stylesheet">
    <link th:href="@{/css/main-app.css(v=${@appVersion})}" rel="stylesheet">
</head>
<body>
    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="app-container" th:attr="data-current-user-id=${user != null ? user.id : ''}">
        
        <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
        <section class="app-section active" id="home-section">
            <div class="section-content">
                <!-- æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-1"></i>
                    <span th:text="${success}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                
                <!-- æŠ•ç¨¿ãƒªã‚¹ãƒˆ -->
                <div class="posts-container">
                    <div th:if="${posts == null or posts.isEmpty()}" class="no-posts">
                        <i class="fas fa-inbox fa-3x mb-3 text-muted"></i>
                        <p class="text-muted">ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                    
                    <div th:each="post : ${posts}" class="post-card">
                        <div class="post-header">
                            <div class="post-user-info">
                                <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒãŒã‚ã‚‹å ´åˆ -->
                                <div class="post-avatar user-profile-link" 
                                     th:if="${post.user.profile != null and post.user.profile.avatarUrl != null and !post.user.profile.avatarUrl.isEmpty()}"
                                     th:style="'background-image: url(' + ${post.user.profile.avatarUrl} + '); background-size: cover; background-position: center; cursor: pointer;'"
                                     th:attr="data-user-id=${post.user.id}, data-friend-code=${post.userFriendCode}">
                                </div>
                                <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³ -->
                                <div class="post-avatar default-avatar user-profile-link" 
                                     th:if="${post.user.profile == null or post.user.profile.avatarUrl == null or post.user.profile.avatarUrl.isEmpty()}"
                                     th:attr="data-username=${post.user.username}, data-user-id=${post.user.id}, data-friend-code=${post.userFriendCode}"
                                     style="cursor: pointer;">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="post-user-details">
                                    <span class="post-username clickable-username user-profile-link" 
                                          th:text="${post.user.profile != null and post.user.profile.displayName != null and !post.user.profile.displayName.isEmpty() ? post.user.profile.displayName : post.user.username}"
                                          th:attr="data-user-id=${post.user.id}, data-friend-code=${post.userFriendCode}">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</span>
                                    <span class="post-time" th:text="${#temporals.format(post.createdAt, 'yyyyå¹´MMæœˆddæ—¥ HH:mm')}">æŠ•ç¨¿æ—¥æ™‚</span>
                                </div>
                            </div>
                        </div>
                        <div class="post-content">
                            <p th:text="${post.content}">æŠ•ç¨¿å†…å®¹</p>
                            
                            <!-- ãƒ¡ãƒ‡ã‚£ã‚¢è¡¨ç¤º -->
                            <div th:if="${post.mediaPath != null and !post.mediaPath.isEmpty()}" class="post-media-grid">
                                <div th:each="mediaUrl : ${#strings.arraySplit(post.mediaPath, ',')}" class="post-media-item">
                                    <!-- ç”»åƒã®å ´åˆ -->
                                    <img th:if="${#strings.endsWith(mediaUrl, '.jpg') or #strings.endsWith(mediaUrl, '.jpeg') or #strings.endsWith(mediaUrl, '.png') or #strings.endsWith(mediaUrl, '.gif') or #strings.endsWith(mediaUrl, '.webp')}"
                                         th:src="${mediaUrl}" 
                                         alt="æŠ•ç¨¿ç”»åƒ"
                                         class="post-media-image"
                                         loading="lazy"
                                         onclick="openImageModal(this.src)">
                                    <!-- å‹•ç”»ã®å ´åˆ -->
                                    <video th:if="${#strings.endsWith(mediaUrl, '.mp4') or #strings.endsWith(mediaUrl, '.webm') or #strings.endsWith(mediaUrl, '.mov')}"
                                           th:src="${mediaUrl}" 
                                           preload="metadata"
                                           controls
                                           class="post-media-video"></video>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- æŠ•ç¨¿ä½œæˆç”»é¢ -->
        <section class="app-section" id="create-post-section">
            <div class="section-content">
                <div class="create-post-header">
                    <button class="btn-back" id="btnBackFromPost">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h1>æ–°è¦æŠ•ç¨¿</h1>
                    <div></div>
                </div>
                
                <form th:action="@{/home/post}" method="post" enctype="multipart/form-data" class="create-post-form" id="createPostForm">
                    <div class="form-group">
                        <label for="postContent" class="form-label">
                            <i class="fas fa-pen me-2"></i>æŠ•ç¨¿å†…å®¹
                        </label>
                        <textarea id="postContent" name="content" class="form-textarea" 
                                  placeholder="ä»Šä½•ã—ã¦ã‚‹ï¼Ÿ" 
                                  maxlength="1000" 
                                  rows="8"
                                  required></textarea>
                        <div class="char-counter-container">
                            <span class="char-counter" id="charCounter">0 / 1000</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="mediaUpload" class="form-label">
                            <i class="fas fa-image me-2"></i>å†™çœŸãƒ»å‹•ç”»
                        </label>
                        <div class="upload-area" id="uploadArea">
                            <input type="file" id="mediaUpload" name="media" 
                                   accept="image/*,video/*" 
                                   multiple 
                                   class="file-input">
                            <label for="mediaUpload" class="upload-label">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                                <p class="mb-0">ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸãƒ»å‹•ç”»ã‚’é¸æŠ</p>
                                <small class="text-muted">ã¾ãŸã¯ã€ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</small>
                            </label>
                        </div>
                        <div class="preview-container" id="previewContainer"></div>
                    </div>
                    
                    <button type="submit" class="btn-submit-post">
                        <i class="fas fa-paper-plane me-2"></i>æŠ•ç¨¿ã™ã‚‹
                    </button>
                </form>
            </div>
        </section>
        
        <!-- ãƒ«ãƒ¼ãƒ ç”»é¢ -->
        <section class="app-section" id="room-section">
            <div class="section-content">
                <div class="rooms-header">
                    <h1>ğŸšª ãƒ«ãƒ¼ãƒ </h1>
                    <div class="header-tabs">
                        <button class="tab-btn active" data-tab="joined">
                            <i class="fas fa-door-open me-1"></i>å‚åŠ ä¸­
                        </button>
                        <button class="tab-btn" data-tab="available">
                            <i class="fas fa-search me-1"></i>å‚åŠ å¯èƒ½
                        </button>
                    </div>
                </div>
                
                <!-- å‚åŠ ä¸­ã®ãƒ«ãƒ¼ãƒ  -->
                <div class="tab-content active" id="joined-tab">
                    <div class="rooms-list">
                        <div th:if="${userRooms == null or userRooms.isEmpty()}" class="no-rooms">
                            <i class="fas fa-door-closed fa-3x mb-3 text-muted"></i>
                            <p class="text-muted">å‚åŠ ã—ã¦ã„ã‚‹ãƒ«ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                        
                        <div th:each="room : ${userRooms}" class="room-card" th:onclick="'location.href=\'/chat?room=' + ${room.id} + '\''">
                            <div class="room-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="room-info">
                                <h3 class="room-name" th:text="${room.name}">ãƒ«ãƒ¼ãƒ å</h3>
                                <p class="room-type" th:text="${room.type.name() == 'GROUP' ? 'ã‚°ãƒ«ãƒ¼ãƒ—' : 'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ'}">ã‚¿ã‚¤ãƒ—</p>
                            </div>
                            <div class="room-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å‚åŠ å¯èƒ½ãªãƒ«ãƒ¼ãƒ  -->
                <div class="tab-content" id="available-tab">
                    <div class="rooms-list">
                        <div th:if="${availableRooms == null or availableRooms.isEmpty()}" class="no-rooms">
                            <i class="fas fa-inbox fa-3x mb-3 text-muted"></i>
                            <p class="text-muted">å‚åŠ å¯èƒ½ãªãƒ«ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                        
                        <div th:each="room : ${availableRooms}" class="room-card">
                            <div class="room-icon">
                                <i class="fas fa-door-open"></i>
                            </div>
                            <div class="room-info">
                                <h3 class="room-name" th:text="${room.name}">ãƒ«ãƒ¼ãƒ å</h3>
                                <p class="room-type" th:text="${room.type.name() == 'GROUP' ? 'ã‚°ãƒ«ãƒ¼ãƒ—' : 'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ'}">ã‚¿ã‚¤ãƒ—</p>
                            </div>
                            <button class="btn-join" th:data-room-id="${room.id}">
                                <i class="fas fa-sign-in-alt me-1"></i>å‚åŠ 
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ãƒ«ãƒ¼ãƒ ä½œæˆãƒœã‚¿ãƒ³ -->
                <a href="/rooms/create" class="btn-create-room">
                    <i class="fas fa-plus"></i>
                </a>
            </div>
        </section>
        
        <!-- ãƒãƒƒãƒç”»é¢ -->
        <section class="app-section" id="match-section">
            <div class="section-content">
                <div class="welcome-section">
                    <h1>ğŸ² ãƒãƒƒãƒ</h1>
                    <p class="text-white-50">æº–å‚™ä¸­...</p>
                </div>
            </div>
        </section>
        
        <!-- ãƒãƒ£ãƒƒãƒˆç”»é¢ -->
        <section class="app-section" id="chat-section">
            <div class="section-content">
                <div class="chat-list-header">
                    <div class="header-tabs">
                        <button class="tab-btn active" data-tab="all-chat">ã™ã¹ã¦</button>
                        <button class="tab-btn" data-tab="friends-chat">å‹é”</button>
                    </div>
                </div>
                
                <!-- ã™ã¹ã¦ã®ãƒãƒ£ãƒƒãƒˆ -->
                <div class="tab-content active" id="all-chat-tab">
                    <div class="chat-list">
                        <div class="no-chats">
                            <i class="fas fa-comments fa-3x mb-3 text-muted"></i>
                            <p class="text-muted">ãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                        
                        <!-- ãƒãƒ£ãƒƒãƒˆã‚¢ã‚¤ãƒ†ãƒ ä¾‹ï¼ˆå‹•çš„ã«ç”Ÿæˆäºˆå®šï¼‰ -->
                        <!-- 
                        <div class="chat-item">
                            <div class="chat-avatar">
                                <img src="/images/avatar.png" alt="ã‚¢ãƒã‚¿ãƒ¼">
                            </div>
                            <div class="chat-content">
                                <div class="chat-top">
                                    <span class="chat-name">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</span>
                                    <span class="chat-time">09:38</span>
                                </div>
                                <div class="chat-bottom">
                                    <p class="chat-message">æœ€æ–°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                                    <span class="chat-badge">1</span>
                                </div>
                            </div>
                        </div>
                        -->
                    </div>
                </div>
                
                <!-- å‹é”ã®ãƒãƒ£ãƒƒãƒˆ -->
                <div class="tab-content" id="friends-chat-tab">
                    <div class="chat-list">
                        <div class="no-chats">
                            <i class="fas fa-user-friends fa-3x mb-3 text-muted"></i>
                            <p class="text-muted">å‹é”ã¨ã®ãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- DMç”»é¢ -->
        <section class="app-section" id="dm-section" style="display: none;">
            <div class="section-content">
                <!-- DMãƒ˜ãƒƒãƒ€ãƒ¼ -->
                <div class="dm-header">
                    <button class="back-btn" id="backFromDmBtn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="dm-user-info" id="dmUserInfo" style="cursor: pointer;">
                        <div class="dm-avatar"></div>
                        <span class="dm-username"></span>
                    </div>
                </div>
                
                <!-- DMãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
                <div class="dm-messages-container" id="dmMessagesContainer">
                    <div class="dm-messages" id="dmMessages">
                        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>
                
                <!-- DMå…¥åŠ›ã‚¨ãƒªã‚¢ -->
                <div class="dm-input-area">
                    <textarea 
                        class="dm-input" 
                        id="dmInput" 
                        placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." 
                        rows="1"></textarea>
                    <button class="dm-send-btn" id="dmSendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </section>
        
        <!-- ãƒã‚¤ãƒšãƒ¼ã‚¸ç”»é¢ -->
        <section class="app-section" id="mypage-section">
            <div class="section-content">
                <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="profile-section">
                    <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ -->
                    <button class="hamburger-btn" type="button" id="mypageMenuBtn">
                        <i class="fas fa-bars" style="font-size: 1.5rem;"></i>
                    </button>
                    <div class="profile-main">
                        <div class="profile-main-top">
                            <!-- ã‚¢ã‚¤ã‚³ãƒ³ -->
                            <div class="profile-avatar" 
                                 th:if="${profile != null and profile.avatarUrl != null and !profile.avatarUrl.isEmpty()}"
                                 th:style="'background-image: url(' + ${profile.avatarUrl} + '); background-size: cover; background-position: center;'">
                            </div>
                            <div class="profile-avatar default-avatar" 
                                 th:if="${profile == null or profile.avatarUrl == null or profile.avatarUrl.isEmpty()}"
                                 th:attr="data-username=${user != null ? user.username : 'unknown'}">
                                <i class="fas fa-user"></i>
                            </div>
                            
                            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ± -->
                            <div class="profile-info-top">
                                <h2 class="profile-username" th:text="${profile != null and profile.displayName != null ? profile.displayName : (user != null ? user.username : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å')}">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</h2>
                                <p class="profile-friendcode" th:text="${user != null and user.friendCode != null ? 'FC: ' + user.friendCode : 'FC: æœªè¨­å®š'}">FC: XXXX-XXXX</p>
                            </div>
                        </div>
                        
                        <!-- è‡ªå·±ç´¹ä»‹æ–‡ã¨ã‚¿ã‚°ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã®ä¸‹ï¼‰ -->
                        <div class="profile-info-bottom">
                            <!-- è‡ªå·±ç´¹ä»‹æ–‡ -->
                            <p class="profile-bio" th:if="${profile != null and profile.bio != null and !profile.bio.isEmpty()}" th:text="${profile.bio}">è‡ªå·±ç´¹ä»‹æ–‡ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                            <p class="profile-bio text-muted" th:if="${profile == null or profile.bio == null or profile.bio.isEmpty()}">è‡ªå·±ç´¹ä»‹ãŒæœªè¨­å®šã§ã™</p>
                            
                            <!-- å¥½ããªã‚‚ã®ã‚¿ã‚°ï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ -->
                            <div class="profile-tags-container" th:if="${profile != null and profile.favoriteThings != null and !profile.favoriteThings.isEmpty()}">
                                <div class="profile-tags-scroll">
                                    <span class="profile-tag" th:each="tag : ${#strings.arraySplit(profile.favoriteThings, ',')}" 
                                          th:text="${tag.trim()}">ã‚¿ã‚°</span>
                                </div>
                            </div>
                            
                            <!-- ãƒ•ã‚©ãƒ­ãƒ¼/ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼/ãƒ•ãƒ¬ãƒ³ãƒ‰æ•° -->
                            <div class="profile-stats">
                                <div class="stat-item">
                                    <span class="stat-label">ãƒ•ã‚©ãƒ­ãƒ¼</span>
                                    <span class="stat-value" id="myFollowingCount" th:text="${followingCount != null ? followingCount : 0}">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</span>
                                    <span class="stat-value" id="myFollowerCount" th:text="${followerCount != null ? followerCount : 0}">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å‹é”</span>
                                    <span class="stat-value" id="myFriendCount" th:text="${friendCount != null ? friendCount : 0}">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é–²è¦§ç”»é¢ -->
        <section class="app-section" id="user-profile-view-section">
            <div class="section-content">
                <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="profile-section profile-view-mode">
                    <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
                    <button class="back-btn" type="button" id="backToHomeBtn">
                        <i class="fas fa-chevron-left" style="font-size: 1.2rem;"></i>
                    </button>
                    <div class="profile-main" id="viewedProfileContent">
                        <!-- JavaScriptã§å‹•çš„ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ -->
                    </div>
                </div>
            </div>
        </section>
        
    </div>
    
    <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆé–²è¦§ç”¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢å°‚ç”¨ï¼‰ -->
    <div class="profile-actions" id="profileActions" style="display: none;">
        <button class="btn-action btn-chat" id="btnStartChat">
            <i class="fas fa-comment me-2"></i>ãƒãƒ£ãƒƒãƒˆ
        </button>
        <button class="btn-action btn-follow" id="btnFollowUser">
            <i class="fas fa-user-plus me-2"></i>ãƒ•ã‚©ãƒ­ãƒ¼
        </button>
    </div>
    
    <!-- ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal(event)">
        <button class="image-modal-close" onclick="closeImageModal(event)">
            <i class="fas fa-times"></i>
        </button>
        <img class="image-modal-content" id="modalImage" src="" alt="æ‹¡å¤§ç”»åƒ">
    </div>
    
    <!-- ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="slide-menu-overlay" id="slideMenuOverlay"></div>
    
    <!-- ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="slide-menu" id="slideMenu">
        <button class="slide-menu-close" id="slideMenuClose">
            <i class="fas fa-times"></i>
        </button>
        
        <!-- ã‚¢ã‚¤ã‚³ãƒ³ -->
        <div class="slide-menu-avatar-container">
            <div class="slide-menu-avatar" 
                 th:if="${profile != null and profile.avatarUrl != null and !profile.avatarUrl.isEmpty()}"
                 th:style="'background-image: url(' + ${profile.avatarUrl} + '); background-size: cover; background-position: center;'">
            </div>
            <div class="slide-menu-avatar default-avatar" 
                 th:if="${profile == null or profile.avatarUrl == null or profile.avatarUrl.isEmpty()}"
                 th:attr="data-username=${user.username}">
                <i class="fas fa-user"></i>
            </div>
        </div>
        
        <!-- ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  -->
        <div class="slide-menu-nickname">
            <span th:text="${profile != null and profile.displayName != null ? profile.displayName : (user != null ? user.username : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å')}">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</span>
        </div>
        
        <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <nav class="slide-menu-nav">
            <a href="/profile/edit" class="slide-menu-item">
                <i class="fas fa-user-edit me-3"></i>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
            </a>
        </nav>
        
        <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼ˆæœ€ä¸‹éƒ¨ï¼‰ -->
        <div class="slide-menu-footer">
            <a href="/logout" class="slide-menu-item logout-item" onclick="handleLogout(event)">
                <i class="fas fa-sign-out-alt me-3"></i>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </a>
        </div>
    </div>
    
    <!-- æŠ•ç¨¿ãƒœã‚¿ãƒ³ï¼ˆãƒ•ãƒƒã‚¿ãƒ¼ã®ä¸Šï¼‰ -->
    <button class="btn-create-post" id="btnCreatePost">
        <i class="fas fa-plus"></i>
    </button>
    
    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <footer class="bottom-nav">
        <button class="nav-item active" data-section="home">
            <i class="fas fa-home"></i>
            <span>ãƒ›ãƒ¼ãƒ </span>
        </button>
        <button class="nav-item" data-section="room">
            <i class="fas fa-door-open"></i>
            <span>ãƒ«ãƒ¼ãƒ </span>
        </button>
        <button class="nav-item" data-section="match">
            <i class="fas fa-random"></i>
            <span>ãƒãƒƒãƒ</span>
        </button>
        <button class="nav-item" data-section="chat">
            <i class="fas fa-comments"></i>
            <span>ãƒãƒ£ãƒƒãƒˆ</span>
        </button>
        <button class="nav-item" data-section="mypage">
            <i class="fas fa-user"></i>
            <span>ãƒã‚¤ãƒšãƒ¼ã‚¸</span>
        </button>
    </footer>

    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script>
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒã‚¿ãƒ¼ã®è‰²è¨­å®šé–¢æ•°
        function setDefaultAvatarColor(avatarElement) {
            if (!avatarElement) return;
            
            // data-usernameå±æ€§ã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‹ã‚‰å–å¾—
            const username = avatarElement.getAttribute('data-username') || 
                           avatarElement.textContent.trim() ||
                           'default';
            
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
                '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B88B', '#AAB7B8'
            ];
            
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            const color = colors[Math.abs(hash) % colors.length];
            avatarElement.style.backgroundColor = color;
        }
        
        // WebSocketæ¥ç¶š
        let stompClient = null;
        let isWebSocketConnected = false;
        
        // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼‰
        let currentUserId = null;
        
        // åˆæœŸåŒ–é–¢æ•°ï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œï¼‰
        function initializeApp() {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
            const appContainer = document.querySelector('.app-container');
            if (appContainer && appContainer.dataset.currentUserId) {
                currentUserId = parseInt(appContainer.dataset.currentUserId);
                console.log('ğŸ‘¤ ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:', currentUserId);
            } else {
                console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“');
            }
            
            // WebSocketæ¥ç¶šã‚’é–‹å§‹
            connectWebSocket();
            
            // æ¥ç¶šçŠ¶æ…‹ã‚’å®šæœŸçš„ã«ç¢ºèª
            setInterval(function() {
                if (!isWebSocketConnected) {
                    connectWebSocket();
                }
            }, 60000); // 60ç§’ã”ã¨
        }
        
        function connectWebSocket() {
            console.log('===== WebSocketæ¥ç¶šé–‹å§‹ =====');
            console.log('æ¥ç¶šå…ˆ:', window.location.origin + '/ws');
            
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’ç„¡åŠ¹åŒ–ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯æœ‰åŠ¹ã«ã™ã‚‹ã¨æƒ…å ±ãŒå¤šã™ãã‚‹ï¼‰
            stompClient.debug = null;
            
            stompClient.connect({}, function(frame) {
                isWebSocketConnected = true;
                console.log('âœ… WebSocketæ¥ç¶šæˆåŠŸ');
                console.log('æ¥ç¶šæƒ…å ±:', frame);
                
                // æ–°è¦æŠ•ç¨¿ã®è³¼èª­
                stompClient.subscribe('/topic/posts', function(message) {
                    console.log('ğŸ“¨ æ–°è¦æŠ•ç¨¿ã‚’å—ä¿¡:', message.body);
                    const postData = JSON.parse(message.body);
                    addNewPostToDOM(postData);
                });
                
                // ãƒ•ã‚©ãƒ­ãƒ¼æ•°æ›´æ–°ã®è³¼èª­
                stompClient.subscribe('/topic/follow-updates', function(message) {
                    console.log('ğŸ“Š ãƒ•ã‚©ãƒ­ãƒ¼æ›´æ–°ã‚’å—ä¿¡:', message.body);
                    const updateData = JSON.parse(message.body);
                    updateFollowCountsForUser(updateData);
                });
                
                // DMãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è³¼èª­
                stompClient.subscribe('/user/queue/dm', function(message) {
                    console.log('ï¿½ WebSocketã‹ã‚‰DMãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡:', message.body);
                    try {
                        const dmData = JSON.parse(message.body);
                        handleIncomingDM(dmData);
                    } catch (error) {
                        console.error('âŒ DMãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
                    }
                });
                
                // DMæ—¢èª­é€šçŸ¥ã®è³¼èª­
                stompClient.subscribe('/user/queue/dm-read', function(message) {
                    console.log('âœ… DMæ—¢èª­é€šçŸ¥ã‚’å—ä¿¡:', message.body);
                    try {
                        const readData = JSON.parse(message.body);
                        handleDMReadNotification(readData);
                    } catch (error) {
                        console.error('âŒ DMæ—¢èª­é€šçŸ¥ã®ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
                    }
                });
                
                console.log('ğŸ“¡ WebSocketã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å®Œäº†');
            }, function(error) {
                isWebSocketConnected = false;
                console.error('âŒ WebSocketæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                console.log('â° 5ç§’å¾Œã«å†æ¥ç¶šã‚’è©¦è¡Œã—ã¾ã™...');
                // 5ç§’å¾Œã«å†æ¥ç¶š
                setTimeout(connectWebSocket, 5000);
            });
            
            // æ¥ç¶šçŠ¶æ…‹ã®ç›£è¦–
            socket.onclose = function() {
                isWebSocketConnected = false;
                console.warn('âš ï¸ WebSocketæ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
            };
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ ã‚¢ãƒ—ãƒªåˆæœŸåŒ–é–‹å§‹');
            initializeApp();
        });
        
        // æ–°è¦æŠ•ç¨¿ã‚’DOMã«è¿½åŠ 
        function addNewPostToDOM(postData) {
            const postsContainer = document.querySelector('.posts-container');
            const noPosts = postsContainer.querySelector('.no-posts');
            
            // "ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
            if (noPosts) {
                noPosts.remove();
            }
            
            // æŠ•ç¨¿ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
            const postCard = document.createElement('div');
            postCard.className = 'post-card';
            
            const user = postData.user;
            const displayName = user.displayName || user.username;
            const colorIndex = getUserColor(user.username);
            
            // ã‚¢ãƒã‚¿ãƒ¼HTML
            let avatarHtml = '';
            if (user.avatarUrl) {
                avatarHtml = `<div class="post-avatar user-profile-link" style="background-image: url(${user.avatarUrl}); background-size: cover; background-position: center; cursor: pointer;" data-user-id="${user.id}" data-friend-code="${postData.userFriendCode || ''}"></div>`;
            } else {
                avatarHtml = `<div class="post-avatar default-avatar user-profile-link" data-username="${user.username}" data-color="${colorIndex}" data-user-id="${user.id}" data-friend-code="${postData.userFriendCode || ''}" style="cursor: pointer;"><i class="fas fa-user"></i></div>`;
            }
            
            // ãƒ¡ãƒ‡ã‚£ã‚¢HTML
            let mediaHtml = '';
            if (postData.mediaPath) {
                const mediaUrls = postData.mediaPath.split(',');
                mediaHtml = '<div class="post-media-grid">';
                mediaUrls.forEach(url => {
                    if (url.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                        mediaHtml += `<div class="post-media-item"><img src="${url}" alt="æŠ•ç¨¿ç”»åƒ" class="post-media-image" loading="lazy" onclick="openImageModal(this.src)"></div>`;
                    } else if (url.match(/\.(mp4|webm|mov)$/i)) {
                        mediaHtml += `<div class="post-media-item"><video src="${url}" class="post-media-video" preload="metadata" controls></video></div>`;
                        mediaHtml += `<div class="post-media-item"><video src="${url}" controls class="post-media-video"></video></div>`;
                    }
                });
                mediaHtml += '</div>';
            }
            
            // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const createdAt = new Date(postData.createdAt);
            const formattedDate = `${createdAt.getFullYear()}å¹´${String(createdAt.getMonth() + 1).padStart(2, '0')}æœˆ${String(createdAt.getDate()).padStart(2, '0')}æ—¥ ${String(createdAt.getHours()).padStart(2, '0')}:${String(createdAt.getMinutes()).padStart(2, '0')}`;
            
            postCard.innerHTML = `
                <div class="post-header">
                    <div class="post-user-info">
                        ${avatarHtml}
                        <div class="post-user-details">
                            <span class="post-username clickable-username user-profile-link" data-user-id="${user.id}" data-friend-code="${user.friendCode || ''}">${displayName}</span>
                            <span class="post-time">${formattedDate}</span>
                        </div>
                    </div>
                </div>
                <div class="post-content">
                    <p>${postData.content}</p>
                    ${mediaHtml}
                </div>
            `;
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒã‚¿ãƒ¼ã®è‰²ã‚’è¨­å®š
            const defaultAvatar = postCard.querySelector('.default-avatar');
            if (defaultAvatar) {
                setDefaultAvatarColor(defaultAvatar);
            }
            
            // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
            postCard.querySelectorAll('.user-profile-link').forEach(element => {
                element.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    const friendCode = this.getAttribute('data-friend-code');
                    console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ãƒªãƒƒã‚¯ - ID:', userId, 'FriendCode:', friendCode);
                    if (userId) {
                        viewUserProfile(userId);
                    }
                });
            });
            
            // å…ˆé ­ã«è¿½åŠ ï¼ˆæ–°ã—ã„æŠ•ç¨¿ãŒä¸€ç•ªä¸Šã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
            postsContainer.insertBefore(postCard, postsContainer.firstChild);
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
            postCard.style.opacity = '0';
            postCard.style.transform = 'translateY(-20px)';
            setTimeout(() => {
                postCard.style.transition = 'all 0.5s ease';
                postCard.style.opacity = '1';
                postCard.style.transform = 'translateY(0)';
            }, 10);
        }
        
        // ãƒ•ã‚©ãƒ­ãƒ¼æ•°ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
        async function updateFollowCountsForUser(updateData) {
            const followedData = updateData.followedUserData;
            const followerData = updateData.followerUserData;
            
            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
            const currentUserId = document.querySelector('.app-container').dataset.currentUserId;
            
            console.log('ğŸ”„ ãƒ•ã‚©ãƒ­ãƒ¼æ›´æ–°ãƒ‡ãƒ¼ã‚¿å—ä¿¡:', {
                followedUserId: followedData?.userId,
                followerUserId: followerData?.userId,
                currentUserId: currentUserId,
                currentViewedUserId: currentViewedUserId
            });
            
            console.log('å‹ãƒã‚§ãƒƒã‚¯:', {
                followedUserIdType: typeof followedData?.userId,
                followerUserIdType: typeof followerData?.userId,
                currentUserIdType: typeof currentUserId
            });
            
            // è‡ªåˆ†ãŒãƒ•ã‚©ãƒ­ãƒ¼ã•ã‚ŒãŸå ´åˆï¼ˆè‡ªåˆ†ã®ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°ã‚’æ›´æ–°ï¼‰
            const isFollowed = followedData && followedData.userId == currentUserId;
            console.log('è‡ªåˆ†ãŒãƒ•ã‚©ãƒ­ãƒ¼ã•ã‚ŒãŸï¼Ÿ', isFollowed, 'followedData.userId:', followedData?.userId, 'currentUserId:', currentUserId);
            
            if (isFollowed) {
                console.log('âœ… è‡ªåˆ†ãŒãƒ•ã‚©ãƒ­ãƒ¼ã•ã‚Œã¾ã—ãŸï¼ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¾ã™');
                const myFollowerCount = document.getElementById('myFollowerCount');
                console.log('myFollowerCountè¦ç´ :', myFollowerCount);
                if (myFollowerCount && followedData.followerCount !== undefined) {
                    console.log('ğŸ“Š ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°æ›´æ–°:', followedData.followerCount);
                    myFollowerCount.textContent = followedData.followerCount;
                } else {
                    console.warn('âš ï¸ ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°ã‚’æ›´æ–°ã§ãã¾ã›ã‚“:', {
                        element: myFollowerCount,
                        count: followedData.followerCount
                    });
                }
                
                const myFriendCount = document.getElementById('myFriendCount');
                if (myFriendCount && followedData.friendCount !== undefined) {
                    console.log('ğŸ“Š ãƒã‚¤ãƒšãƒ¼ã‚¸ã®å‹é”æ•°æ›´æ–°:', followedData.friendCount);
                    myFriendCount.textContent = followedData.friendCount;
                }
            }
            
            // è‡ªåˆ†ãŒãƒ•ã‚©ãƒ­ãƒ¼ã—ãŸå ´åˆï¼ˆè‡ªåˆ†ã®ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚©ãƒ­ãƒ¼æ•°ã‚’æ›´æ–°ï¼‰
            const isFollowing = followerData && followerData.userId == currentUserId;
            console.log('è‡ªåˆ†ãŒãƒ•ã‚©ãƒ­ãƒ¼ã—ãŸï¼Ÿ', isFollowing, 'followerData.userId:', followerData?.userId, 'currentUserId:', currentUserId);
            
            if (isFollowing) {
                console.log('âœ… è‡ªåˆ†ãŒãƒ•ã‚©ãƒ­ãƒ¼ã—ã¾ã—ãŸï¼ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¾ã™');
                const myFollowingCount = document.getElementById('myFollowingCount');
                console.log('myFollowingCountè¦ç´ :', myFollowingCount);
                if (myFollowingCount && followerData.followingCount !== undefined) {
                    console.log('ğŸ“Š ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚©ãƒ­ãƒ¼æ•°æ›´æ–°:', followerData.followingCount);
                    myFollowingCount.textContent = followerData.followingCount;
                } else {
                    console.warn('âš ï¸ ãƒ•ã‚©ãƒ­ãƒ¼æ•°ã‚’æ›´æ–°ã§ãã¾ã›ã‚“:', {
                        element: myFollowingCount,
                        count: followerData.followingCount
                    });
                }
                
                const myFriendCount = document.getElementById('myFriendCount');
                if (myFriendCount && followerData.friendCount !== undefined) {
                    console.log('ğŸ“Š ãƒã‚¤ãƒšãƒ¼ã‚¸ã®å‹é”æ•°æ›´æ–°:', followerData.friendCount);
                    myFriendCount.textContent = followerData.friendCount;
                }
            }
            
            // ãƒ•ã‚©ãƒ­ãƒ¼ã•ã‚ŒãŸäººã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¦‹ã¦ã„ã‚‹å ´åˆ
            if (followedData && currentViewedUserId && currentViewedUserId == followedData.userId) {
                const targetFollowerCount = document.getElementById('targetFollowerCount');
                if (targetFollowerCount && followedData.followerCount !== undefined) {
                    targetFollowerCount.textContent = followedData.followerCount;
                }
                
                // ãƒ•ã‚©ãƒ­ãƒ¼æ•°ã¨å‹é”æ•°ã‚‚æ›´æ–°
                const profileStats = document.querySelector('#user-profile-view-section .profile-stats');
                if (profileStats) {
                    const statValues = profileStats.querySelectorAll('.stat-value');
                    if (statValues.length >= 3 && followedData.followingCount !== undefined) {
                        statValues[0].textContent = followedData.followingCount;
                    }
                    if (statValues.length >= 3 && followedData.friendCount !== undefined) {
                        statValues[2].textContent = followedData.friendCount;
                    }
                }
                
                // ãƒœã‚¿ãƒ³ã‚‚æ›´æ–°
                await updateFollowButton(currentViewedUserId);
            }
            
            // ãƒ•ã‚©ãƒ­ãƒ¼ã—ãŸäººã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¦‹ã¦ã„ã‚‹å ´åˆ
            if (followerData && currentViewedUserId && currentViewedUserId == followerData.userId) {
                const targetFollowerCount = document.getElementById('targetFollowerCount');
                if (targetFollowerCount && followerData.followerCount !== undefined) {
                    targetFollowerCount.textContent = followerData.followerCount;
                }
                
                // ãƒ•ã‚©ãƒ­ãƒ¼æ•°ã¨å‹é”æ•°ã‚‚æ›´æ–°
                const profileStats = document.querySelector('#user-profile-view-section .profile-stats');
                if (profileStats) {
                    const statValues = profileStats.querySelectorAll('.stat-value');
                    if (statValues.length >= 3 && followerData.followingCount !== undefined) {
                        statValues[0].textContent = followerData.followingCount;
                    }
                    if (statValues.length >= 3 && followerData.friendCount !== undefined) {
                        statValues[2].textContent = followerData.friendCount;
                    }
                }
                
                // ãƒœã‚¿ãƒ³ã‚‚æ›´æ–°
                await updateFollowButton(currentViewedUserId);
            }
        }
        
        // ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function openImageModal(src) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modalImg.src = src;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        // ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeImageModal(event) {
            // ç”»åƒè‡ªä½“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯é–‰ã˜ãªã„
            if (event.target.classList.contains('image-modal-content')) {
                return;
            }
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        function handleLogout(event) {
            // localStorageã‹ã‚‰è¨˜æ†¶ã—ãŸãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’å‰Šé™¤
            localStorage.removeItem('rememberLogin');
            localStorage.removeItem('savedUsername');
            sessionStorage.clear();
            console.log('ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’ç¶šè¡Œï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒªãƒ³ã‚¯å‹•ä½œï¼‰
        }
        
        // æ˜Ÿã‚’ç”Ÿæˆ
        function createStars() {
            const container = document.querySelector('.app-container');
            const starCount = 100; // æ˜Ÿã®æ•°
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = Math.random() > 0.8 ? 'star large' : 'star';
                
                // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                
                // ãƒ©ãƒ³ãƒ€ãƒ ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é…å»¶
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.animationDuration = (Math.random() * 2 + 2) + 's';
                
                container.appendChild(star);
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ˜Ÿã‚’ç”Ÿæˆ
        createStars();
        
        // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã«localStorageã«è¨˜æ†¶
        const pendingUsername = sessionStorage.getItem('pendingUsername');
        if (pendingUsername) {
            localStorage.setItem('rememberLogin', 'true');
            localStorage.setItem('savedUsername', pendingUsername);
            sessionStorage.removeItem('pendingUsername');
            // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼‰
            sessionStorage.removeItem('loginRedirectCount');
            console.log('ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’è¨˜æ†¶ã—ã¾ã—ãŸ: ' + pendingUsername);
        } else {
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‹ã‚‰ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã§ãªã„å ´åˆã‚‚ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            sessionStorage.removeItem('loginRedirectCount');
        }
        
        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆ
        const navItems = document.querySelectorAll('.nav-item');
        const sections = document.querySelectorAll('.app-section');
        const createPostBtn = document.getElementById('btnCreatePost');
        
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const sectionName = item.dataset.section;
                
                // å…¨ã¦ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ active ã‚’å‰Šé™¤
                navItems.forEach(nav => nav.classList.remove('active'));
                sections.forEach(section => section.classList.remove('active'));
                
                // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã¨å¯¾å¿œã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã« active ã‚’è¿½åŠ 
                item.classList.add('active');
                document.getElementById(sectionName + '-section').classList.add('active');
                
                // ãƒ›ãƒ¼ãƒ ç”»é¢ã®å ´åˆã®ã¿ï¼‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                if (sectionName === 'home') {
                    createPostBtn.style.display = 'flex';
                } else {
                    createPostBtn.style.display = 'none';
                }
                
                // ãƒãƒ£ãƒƒãƒˆç”»é¢ã«é·ç§»ã—ãŸæ™‚ã«DMä¼šè©±ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
                if (sectionName === 'chat') {
                    loadDMConversations();
                }
            });
        });
        
        // ãƒãƒ£ãƒƒãƒˆã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆï¼ˆã™ã¹ã¦/å‹é”ï¼‰
        const chatTabBtns = document.querySelectorAll('.chat-list-header .tab-btn');
        chatTabBtns.forEach(btn => {
            btn.addEventListener('click', async () => {
                const tabName = btn.dataset.tab;
                
                chatTabBtns.forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.chat-list-header + div, .chat-list-header + div + div').forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                const targetTab = document.getElementById(tabName + '-tab');
                targetTab.classList.add('active');
                
                // å‹é”ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆãŸå ´åˆã¯å‹é”ã®DMã‚’èª­ã¿è¾¼ã‚€
                if (tabName === 'friends-chat') {
                    await loadFriendsDMConversations();
                }
            });
        });
        
        // ãƒ«ãƒ¼ãƒ ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        const roomTabBtns = document.querySelectorAll('.room-list-header .tab-btn');
        const tabContents = document.querySelectorAll('.room-list-header + .tab-content, .room-list-header + .tab-content + .tab-content');
        
        roomTabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                
                roomTabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                const targetContent = document.getElementById(tabName + '-tab');
                if (targetContent) {
                    targetContent.classList.add('active');
                }
            });
        });
        
        // å‚åŠ ãƒœã‚¿ãƒ³
        document.querySelectorAll('.btn-join').forEach(btn => {
            btn.addEventListener('click', async function(e) {
                e.stopPropagation();
                const roomId = this.dataset.roomId;
                
                try {
                    const response = await fetch(`/rooms/${roomId}/join`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        window.location.href = data.redirectUrl;
                    } else {
                        alert(data.message);
                    }
                } catch (error) {
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            });
        });
        
        // æŠ•ç¨¿ãƒœã‚¿ãƒ³ - æŠ•ç¨¿ç”»é¢ã¸é·ç§»
        const btnCreatePost = document.getElementById('btnCreatePost');
        const btnBackFromPost = document.getElementById('btnBackFromPost');
        const createPostSection = document.getElementById('create-post-section');
        const homeSection = document.getElementById('home-section');
        
        if (btnCreatePost) {
            btnCreatePost.addEventListener('click', () => {
                sections.forEach(section => section.classList.remove('active'));
                createPostSection.classList.add('active');
            });
        }
        
        if (btnBackFromPost) {
            btnBackFromPost.addEventListener('click', () => {
                createPostSection.classList.remove('active');
                homeSection.classList.add('active');
                navItems.forEach(nav => nav.classList.remove('active'));
                navItems[0].classList.add('active');
            });
        }
        
        // æ–‡å­—ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
        const postContent = document.getElementById('postContent');
        const charCounter = document.getElementById('charCounter');
        
        if (postContent && charCounter) {
            postContent.addEventListener('input', function() {
                const length = this.value.length;
                charCounter.textContent = length + ' / 1000';
                
                if (length > 900) {
                    charCounter.style.color = '#dc3545';
                } else if (length > 800) {
                    charCounter.style.color = '#ffc107';
                } else {
                    charCounter.style.color = '#6c757d';
                }
            });
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
        const mediaUpload = document.getElementById('mediaUpload');
        const uploadArea = document.getElementById('uploadArea');
        const previewContainer = document.getElementById('previewContainer');
        
        if (mediaUpload && previewContainer) {
            mediaUpload.addEventListener('change', function(e) {
                previewFiles(e.target.files);
            });
            
            // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                previewFiles(e.dataTransfer.files);
                mediaUpload.files = e.dataTransfer.files;
            });
        }
        
        function previewFiles(files) {
            previewContainer.innerHTML = '';
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    
                    if (file.type.startsWith('image/')) {
                        previewItem.innerHTML = `
                            <img src="${e.target.result}" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                            <button type="button" class="btn-remove-preview" onclick="this.parentElement.remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                    } else if (file.type.startsWith('video/')) {
                        previewItem.innerHTML = `
                            <video src="${e.target.result}" controls></video>
                            <button type="button" class="btn-remove-preview" onclick="this.parentElement.remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                    }
                    
                    previewContainer.appendChild(previewItem);
                };
                
                reader.readAsDataURL(file);
            });
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‹ã‚‰è‰²ã‚’æ±ºå®šã™ã‚‹é–¢æ•°
        function getUserColor(username) {
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            return Math.abs(hash) % 10;
        }
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã«è‰²ã‚’è¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            // ã™ã¹ã¦ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒã‚¿ãƒ¼ã«è‰²ã‚’è¨­å®š
            document.querySelectorAll('.default-avatar').forEach(avatar => {
                setDefaultAvatarColor(avatar);
            });
            
            // ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ã‚¢ãƒã‚¿ãƒ¼ã«ã‚‚è‰²ã‚’è¨­å®š
            document.querySelectorAll('.profile-avatar').forEach(avatar => {
                setDefaultAvatarColor(avatar);
            });
            
            // ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åˆ¶å¾¡
            const mypageMenuBtn = document.getElementById('mypageMenuBtn');
            const slideMenu = document.getElementById('slideMenu');
            const slideMenuOverlay = document.getElementById('slideMenuOverlay');
            const slideMenuClose = document.getElementById('slideMenuClose');
            
            if (mypageMenuBtn && slideMenu && slideMenuOverlay) {
                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã
                mypageMenuBtn.addEventListener('click', () => {
                    slideMenu.classList.add('active');
                    slideMenuOverlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                });
                
                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ï¼‰
                slideMenuOverlay.addEventListener('click', () => {
                    slideMenu.classList.remove('active');
                    slideMenuOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                });
                
                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹ï¼ˆÃ—ãƒœã‚¿ãƒ³ï¼‰
                if (slideMenuClose) {
                    slideMenuClose.addEventListener('click', () => {
                        slideMenu.classList.remove('active');
                        slideMenuOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                    });
                }
            }
        });
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é–²è¦§æ©Ÿèƒ½
        let currentViewedUserId = null; // é–²è¦§ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
        
        async function viewUserProfile(userId) {
            // ç¾åœ¨ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®IDã‚’å–å¾—
            const currentUserId = document.querySelector('.app-container').dataset.currentUserId;
            
            // é–²è¦§ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ä¿å­˜
            currentViewedUserId = userId;
            
            // è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯ãƒã‚¤ãƒšãƒ¼ã‚¸ã«é·ç§»
            if (userId === currentUserId) {
                // ãƒã‚¤ãƒšãƒ¼ã‚¸ã«é·ç§»
                sections.forEach(section => section.classList.remove('active'));
                document.getElementById('mypage-section').classList.add('active');
                navItems.forEach(nav => nav.classList.remove('active'));
                // ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹ï¼ˆæœ€å¾Œã®ã‚¢ã‚¤ãƒ†ãƒ ï¼‰
                navItems[navItems.length - 1].classList.add('active');
                createPostBtn.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/users/${userId}/profile`);
                const data = await response.json();
                
                console.log('===== ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾— =====');
                console.log('UserID:', userId);
                console.log('APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', data);
                console.log('Following:', data.followingCount);
                console.log('Follower:', data.followerCount);
                console.log('Friend:', data.friendCount);
                
                if (data.success) {
                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’è¡¨ç¤º
                    const viewedProfileContent = document.getElementById('viewedProfileContent');
                    const user = data.user;
                    const profile = data.profile;
                    
                    // ã‚¢ã‚¤ã‚³ãƒ³ã®HTML
                    let avatarHtml = '';
                    if (profile && profile.avatarUrl) {
                        avatarHtml = `<div class="profile-avatar" style="background-image: url(${profile.avatarUrl}); background-size: cover; background-position: center;"></div>`;
                    } else {
                        const colorIndex = getUserColor(user.username);
                        avatarHtml = `<div class="profile-avatar default-avatar" data-username="${user.username}" data-color="${colorIndex}"><i class="fas fa-user"></i></div>`;
                    }
                    
                    // ã‚¿ã‚°ã®HTML
                    let tagsHtml = '';
                    if (profile && profile.favoriteThings) {
                        const tags = profile.favoriteThings.split(',').map(tag => tag.trim()).filter(tag => tag);
                        if (tags.length > 0) {
                            tagsHtml = `
                                <div class="profile-tags-container">
                                    <div class="profile-tags-scroll">
                                        ${tags.map(tag => `<span class="profile-tag">${tag}</span>`).join('')}
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    viewedProfileContent.innerHTML = `
                        <div class="profile-main-top">
                            ${avatarHtml}
                            <div class="profile-info-top">
                                <h2 class="profile-username">${profile && profile.displayName ? profile.displayName : user.username}</h2>
                                <p class="profile-friendcode">${user.friendCode ? 'FC: ' + user.friendCode : 'FC: æœªè¨­å®š'}</p>
                            </div>
                        </div>
                        <div class="profile-info-bottom" style="text-align: left;">
                            <p class="profile-bio ${!profile || !profile.bio ? 'text-muted' : ''}" style="text-align: left !important;">${profile && profile.bio ? profile.bio : 'è‡ªå·±ç´¹ä»‹ãŒæœªè¨­å®šã§ã™'}</p>
                            ${tagsHtml}
                            <div class="profile-stats">
                                <div class="stat-item">
                                    <span class="stat-label">ãƒ•ã‚©ãƒ­ãƒ¼</span>
                                    <span class="stat-value">${data.followingCount || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</span>
                                    <span class="stat-value" id="targetFollowerCount">${data.followerCount || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å‹é”</span>
                                    <span class="stat-value">${data.friendCount || 0}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // ãƒ•ã‚©ãƒ­ãƒ¼çŠ¶æ…‹ã‚’å–å¾—ã—ã¦ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
                    await updateFollowButton(userId);
                    
                    // ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’è¨­å®š
                    const btnStartChat = document.getElementById('btnStartChat');
                    btnStartChat.dataset.userId = userId;
                    
                    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
                    sections.forEach(section => section.classList.remove('active'));
                    document.getElementById('user-profile-view-section').classList.add('active');
                    navItems.forEach(nav => nav.classList.remove('active'));
                    
                    // DMç”»é¢ã‚’ç¢ºå®Ÿã«éè¡¨ç¤º
                    const dmSection = document.getElementById('dm-section');
                    if (dmSection) {
                        dmSection.style.display = 'none';
                        dmSection.classList.remove('active');
                    }
                    
                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã€ãƒ•ãƒƒã‚¿ãƒ¼ã‚’éè¡¨ç¤º
                    const profileActions = document.getElementById('profileActions');
                    if (profileActions) {
                        profileActions.style.cssText = 'display: flex;';
                    }
                    const bottomNav = document.querySelector('.bottom-nav');
                    if (bottomNav) {
                        bottomNav.style.display = 'none';
                    }
                    createPostBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // ãƒ•ã‚©ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        async function updateFollowButton(userId) {
            try {
                const response = await fetch(`/api/users/${userId}/relationship`);
                const data = await response.json();
                
                if (data.success) {
                    const followBtn = document.getElementById('btnFollowUser');
                    const relationship = data.relationship;
                    
                    // relationship: "friend" (ç›¸äº’ãƒ•ã‚©ãƒ­ãƒ¼), "following" (ãƒ•ã‚©ãƒ­ãƒ¼ä¸­), "follower" (ãƒ•ã‚©ãƒ­ãƒ¼ã•ã‚Œã¦ã„ã‚‹), "none" (é–¢ä¿‚ãªã—)
                    if (relationship === 'friend') {
                        followBtn.innerHTML = '<i class="fas fa-user-check me-2"></i>å‹é”';
                        followBtn.classList.add('following');
                        followBtn.dataset.relationship = 'friend'; // ãƒ‡ãƒ¼ã‚¿å±æ€§ã«é–¢ä¿‚æ€§ã‚’ä¿å­˜
                    } else if (relationship === 'following') {
                        followBtn.innerHTML = '<i class="fas fa-user-check me-2"></i>ãƒ•ã‚©ãƒ­ãƒ¼ä¸­';
                        followBtn.classList.add('following');
                        followBtn.dataset.relationship = 'following'; // ãƒ‡ãƒ¼ã‚¿å±æ€§ã«é–¢ä¿‚æ€§ã‚’ä¿å­˜
                    } else if (relationship === 'follower') {
                        followBtn.innerHTML = '<i class="fas fa-user-plus me-2"></i>ãƒ•ã‚©ãƒ­ãƒ¼ãƒãƒƒã‚¯';
                        followBtn.classList.remove('following');
                        followBtn.dataset.relationship = 'follower';
                    } else {
                        followBtn.innerHTML = '<i class="fas fa-user-plus me-2"></i>ãƒ•ã‚©ãƒ­ãƒ¼';
                        followBtn.classList.remove('following');
                        followBtn.dataset.relationship = 'none';
                    }
                }
            } catch (error) {
                console.error('Error getting relationship:', error);
            }
        }
        
        // ãƒ•ã‚©ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        const btnFollowUser = document.getElementById('btnFollowUser');
        if (btnFollowUser) {
            btnFollowUser.addEventListener('click', async () => {
                if (!currentViewedUserId) {
                    return;
                }
                
                const isFollowing = btnFollowUser.classList.contains('following');
                const relationship = btnFollowUser.dataset.relationship;
                
                // ãƒ•ã‚©ãƒ­ãƒ¼æ¸ˆã¿ãƒ»å‹é”ã®å ´åˆã¯ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
                if (isFollowing) {
                    let confirmMessage = 'ãƒ•ã‚©ãƒ­ãƒ¼ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ';
                    
                    // å‹é”ã®å ´åˆã¯æ˜ç¤ºçš„ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰æ›´
                    if (relationship === 'friend') {
                        confirmMessage = 'å‹é”é–¢ä¿‚ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆç›¸äº’ãƒ•ã‚©ãƒ­ãƒ¼ãŒè§£é™¤ã•ã‚Œã¾ã™ï¼‰';
                    }
                    
                    const confirmUnfollow = confirm(confirmMessage);
                    if (!confirmUnfollow) {
                        return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„
                    }
                }
                
                const endpoint = isFollowing ? 'unfollow' : 'follow';
                
                // ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
                btnFollowUser.disabled = true;
                const originalText = btnFollowUser.innerHTML;
                btnFollowUser.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>å‡¦ç†ä¸­...';
                
                try {
                    const response = await fetch(`/api/users/${currentViewedUserId}/${endpoint}`, {
                        method: 'POST'
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’å³åº§ã«æ›´æ–°
                        await updateFollowButton(currentViewedUserId);
                        
                        console.log('Follow response data:', data); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
                        
                        // é–²è¦§ä¸­ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°ã‚’æ›´æ–°
                        const followerCountElement = document.getElementById('targetFollowerCount');
                        if (followerCountElement && data.targetFollowerCount !== undefined) {
                            console.log('Updating targetFollowerCount to:', data.targetFollowerCount); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
                            followerCountElement.textContent = data.targetFollowerCount;
                        } else {
                            console.warn('targetFollowerCount element not found or data missing'); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
                        }
                        
                        // ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚©ãƒ­ãƒ¼/ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼/å‹é”æ•°ã‚’æ›´æ–°
                        const myFollowingCount = document.getElementById('myFollowingCount');
                        if (myFollowingCount && data.followingCount !== undefined) {
                            myFollowingCount.textContent = data.followingCount;
                        }
                        
                        const myFollowerCount = document.getElementById('myFollowerCount');
                        if (myFollowerCount && data.followerCount !== undefined) {
                            myFollowerCount.textContent = data.followerCount;
                        }
                        
                        const myFriendCount = document.getElementById('myFriendCount');
                        if (myFriendCount && data.friendCount !== undefined) {
                            myFriendCount.textContent = data.friendCount;
                        }
                        
                        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                        // alert(data.message);
                    } else {
                        alert(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                        btnFollowUser.innerHTML = originalText; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã«æˆ»ã™
                    }
                } catch (error) {
                    console.error('Error toggling follow:', error);
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                    btnFollowUser.innerHTML = originalText; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã«æˆ»ã™
                } finally {
                    // ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
                    btnFollowUser.disabled = false;
                }
            });
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒªãƒ³ã‚¯ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        document.addEventListener('click', function(e) {
            const target = e.target.closest('.user-profile-link');
            if (target && target.dataset.userId) {
                const userId = target.dataset.userId;
                const friendCode = target.dataset.friendCode;
                const username = target.dataset.username;
                console.log('===== ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¯ãƒªãƒƒã‚¯ =====');
                console.log('ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ :', target);
                console.log('User ID:', userId);
                console.log('Friend Code:', friendCode);
                console.log('Username:', username);
                console.log('================================');
                viewUserProfile(userId);
            }
        });
        
        // æˆ»ã‚‹ãƒœã‚¿ãƒ³
        const backToHomeBtn = document.getElementById('backToHomeBtn');
        if (backToHomeBtn) {
            backToHomeBtn.addEventListener('click', () => {
                sections.forEach(section => section.classList.remove('active'));
                homeSection.classList.add('active');
                navItems.forEach(nav => nav.classList.remove('active'));
                navItems[0].classList.add('active');
                createPostBtn.style.display = 'flex';
                
                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã€ãƒ•ãƒƒã‚¿ãƒ¼ã‚’å†è¡¨ç¤º
                document.getElementById('profileActions').style.display = 'none';
                document.querySelector('.bottom-nav').style.display = 'flex';
            });
        }
        
        // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã§æˆ»ã‚‹
        const userProfileViewSection = document.getElementById('user-profile-view-section');
        if (userProfileViewSection) {
            let touchStartX = 0;
            let touchEndX = 0;
            
            userProfileViewSection.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });
            
            userProfileViewSection.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });
            
            function handleSwipe() {
                if (touchEndX - touchStartX > 100) { // å³ã‚¹ãƒ¯ã‚¤ãƒ—
                    backToHomeBtn.click();
                }
            }
        }
        
        // ========================================
        // DMæ©Ÿèƒ½
        // ========================================
        
        let currentConversationId = null;
        let currentDMUser = null;
        
        // DMä¼šè©±ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
        async function loadDMConversations() {
            try {
                console.log('ğŸ“‹ DMä¼šè©±ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const response = await fetch('/api/dm/conversations');
                console.log('ğŸ“¡ API Response Status:', response.status);
                
                const data = await response.json();
                console.log('ğŸ“¦ API Response Data:', data);
                
                if (!data.success) {
                    console.error('âŒ DMä¼šè©±ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }
                
                const conversations = data.conversations;
                console.log('âœ… DMä¼šè©±ãƒªã‚¹ãƒˆå–å¾—:', conversations.length, 'ä»¶');
                console.log('ğŸ“‹ Conversations Detail:', conversations);
                
                displayConversationList(conversations);
            } catch (error) {
                console.error('âŒ DMä¼šè©±ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // DMä¼šè©±ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        function displayConversationList(conversations) {
            const chatListContainer = document.querySelector('#all-chat-tab .chat-list');
            const noChatsElement = chatListContainer.querySelector('.no-chats');
            
            if (!chatListContainer) {
                console.error('âŒ ãƒãƒ£ãƒƒãƒˆãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒƒãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤
            const existingItems = chatListContainer.querySelectorAll('.chat-item');
            existingItems.forEach(item => item.remove());
            
            if (conversations.length === 0) {
                // ä¼šè©±ãŒãªã„å ´åˆã¯ã€Œãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€ã‚’è¡¨ç¤º
                if (noChatsElement) {
                    noChatsElement.style.display = 'flex';
                }
                console.log('ğŸ“‹ DMä¼šè©±ãªã—');
                return;
            }
            
            // ä¼šè©±ãŒã‚ã‚‹å ´åˆã¯ã€Œãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€ã‚’éè¡¨ç¤º
            if (noChatsElement) {
                noChatsElement.style.display = 'none';
            }
            
            console.log('ğŸ“‹ DMä¼šè©±ã‚’è¡¨ç¤º:', conversations.length, 'ä»¶');
            
            // ä¼šè©±ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
            conversations.forEach(conv => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.dataset.conversationId = conv.conversationId;
                chatItem.dataset.userId = conv.userId;
                
                // æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ™‚åˆ»ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const lastMessageTime = conv.lastMessageAt ? formatTime(new Date(conv.lastMessageAt)) : '';
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æœ€åˆã®1è¡Œã ã‘ã‚’å–å¾—ï¼ˆæœ€å¤§10æ–‡å­—ï¼‰
                let messagePreview = conv.lastMessage || '';
                const firstLine = messagePreview.split('\n')[0]; // æœ€åˆã®1è¡Œ
                const truncatedMessage = firstLine.length > 10 ? firstLine.substring(0, 10) + '...' : firstLine;
                
                // ã‚¢ãƒã‚¿ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«
                const avatarStyle = conv.avatarUrl 
                    ? `background-image: url(${conv.avatarUrl}); background-size: cover; background-position: center;` 
                    : '';
                
                chatItem.innerHTML = `
                    <div class="chat-avatar" style="${avatarStyle}">
                        ${!conv.avatarUrl ? '<i class="fas fa-user"></i>' : ''}
                    </div>
                    <div class="chat-content">
                        <div class="chat-top">
                            <span class="chat-name">${escapeHtml(conv.displayName || conv.username)}</span>
                            <span class="chat-time">${lastMessageTime}</span>
                        </div>
                        <div class="chat-bottom">
                            <p class="chat-message">${escapeHtml(truncatedMessage)}</p>
                            ${conv.unreadCount > 0 ? `<span class="chat-badge">${conv.unreadCount}</span>` : ''}
                        </div>
                    </div>
                `;
                
                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                chatItem.addEventListener('click', async () => {
                    await startConversationFromList(conv.conversationId, conv.userId, conv.displayName || conv.username, conv.avatarUrl);
                });
                
                chatListContainer.appendChild(chatItem);
            });
        }
        
        // æ™‚åˆ»ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            const hours = Math.floor(diff / 1000 / 60 / 60);
            
            if (hours < 1) {
                const minutes = Math.floor(diff / 1000 / 60);
                return minutes < 1 ? 'ãŸã£ãŸä»Š' : `${minutes}åˆ†å‰`;
            } else if (hours < 24) {
                return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            } else if (hours < 48) {
                return 'æ˜¨æ—¥';
            } else {
                return date.toLocaleDateString('ja-JP', { month: '2-digit', day: '2-digit' });
            }
        }
        
        // å‹é”ã®DMä¼šè©±ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
        async function loadFriendsDMConversations() {
            try {
                console.log('ğŸ“‹ å‹é”ã®DMä¼šè©±ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const response = await fetch('/api/dm/conversations/friends');
                console.log('ğŸ“¡ Friends API Response Status:', response.status);
                
                const data = await response.json();
                console.log('ğŸ“¦ Friends API Response Data:', data);
                
                if (!data.success) {
                    console.error('âŒ å‹é”ã®DMä¼šè©±ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }
                
                const conversations = data.conversations;
                console.log('âœ… å‹é”ã®DMä¼šè©±ãƒªã‚¹ãƒˆå–å¾—:', conversations.length, 'ä»¶');
                console.log('ğŸ“‹ Friends Conversations Detail:', conversations);
                
                displayFriendsConversationList(conversations);
            } catch (error) {
                console.error('âŒ å‹é”ã®DMä¼šè©±ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // å‹é”ã®DMä¼šè©±ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        function displayFriendsConversationList(conversations) {
            const chatListContainer = document.querySelector('#friends-chat-tab .chat-list');
            const noChatsElement = chatListContainer.querySelector('.no-chats');
            
            if (!chatListContainer) {
                console.error('âŒ å‹é”ãƒãƒ£ãƒƒãƒˆãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒƒãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤
            const existingItems = chatListContainer.querySelectorAll('.chat-item');
            existingItems.forEach(item => item.remove());
            
            if (conversations.length === 0) {
                // ä¼šè©±ãŒãªã„å ´åˆã¯ã€Œå‹é”ã¨ã®ãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€ã‚’è¡¨ç¤º
                if (noChatsElement) {
                    noChatsElement.style.display = 'flex';
                }
                console.log('ğŸ“‹ å‹é”ã®DMä¼šè©±ãªã—');
                return;
            }
            
            // ä¼šè©±ãŒã‚ã‚‹å ´åˆã¯ã€Œå‹é”ã¨ã®ãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€ã‚’éè¡¨ç¤º
            if (noChatsElement) {
                noChatsElement.style.display = 'none';
            }
            
            console.log('ğŸ“‹ å‹é”ã®DMä¼šè©±ã‚’è¡¨ç¤º:', conversations.length, 'ä»¶');
            
            // ä¼šè©±ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºï¼ˆdisplayConversationListã¨åŒã˜å‡¦ç†ï¼‰
            conversations.forEach(conv => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.dataset.conversationId = conv.conversationId;
                chatItem.dataset.userId = conv.userId;
                
                // æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ™‚åˆ»ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const lastMessageTime = conv.lastMessageAt ? formatTime(new Date(conv.lastMessageAt)) : '';
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æœ€åˆã®1è¡Œã ã‘ã‚’å–å¾—ï¼ˆæœ€å¤§10æ–‡å­—ï¼‰
                let messagePreview = conv.lastMessage || '';
                const firstLine = messagePreview.split('\n')[0]; // æœ€åˆã®1è¡Œ
                const truncatedMessage = firstLine.length > 10 ? firstLine.substring(0, 10) + '...' : firstLine;
                
                // ã‚¢ãƒã‚¿ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«
                const avatarStyle = conv.avatarUrl 
                    ? `background-image: url(${conv.avatarUrl}); background-size: cover; background-position: center;` 
                    : '';
                
                chatItem.innerHTML = `
                    <div class="chat-avatar" style="${avatarStyle}">
                        ${!conv.avatarUrl ? '<i class="fas fa-user"></i>' : ''}
                    </div>
                    <div class="chat-content">
                        <div class="chat-top">
                            <span class="chat-name">${escapeHtml(conv.displayName || conv.username)}</span>
                            <span class="chat-time">${lastMessageTime}</span>
                        </div>
                        <div class="chat-bottom">
                            <p class="chat-message">${escapeHtml(truncatedMessage)}</p>
                            ${conv.unreadCount > 0 ? `<span class="chat-badge">${conv.unreadCount}</span>` : ''}
                        </div>
                    </div>
                `;
                
                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                chatItem.addEventListener('click', async () => {
                    await startConversationFromList(conv.conversationId, conv.userId, conv.displayName || conv.username, conv.avatarUrl);
                });
                
                chatListContainer.appendChild(chatItem);
            });
        }
        
        // ä¼šè©±ãƒªã‚¹ãƒˆã‹ã‚‰DMã‚’é–‹å§‹
        async function startConversationFromList(conversationId, userId, displayName, avatarUrl) {
            currentConversationId = conversationId;
            currentDMUser = {
                userId: userId,
                username: displayName,
                displayName: displayName,
                avatarUrl: avatarUrl
            };
            await openDMScreen(conversationId);
        }
        
        // é–²è¦§ç”¨ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ã€Œãƒãƒ£ãƒƒãƒˆã€ãƒœã‚¿ãƒ³
        document.getElementById('btnStartChat').addEventListener('click', async function() {
            const viewedUserId = this.dataset.userId;
            if (!viewedUserId) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            try {
                console.log('ğŸš€ DMä¼šè©±ã‚’é–‹å§‹:', viewedUserId);
                
                const response = await fetch('/api/dm/conversations/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targetUserId: parseInt(viewedUserId) })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const conversation = data.conversation;
                    currentConversationId = conversation.conversationId;
                    currentDMUser = {
                        userId: conversation.userId,
                        username: conversation.username,
                        displayName: conversation.displayName,
                        avatarUrl: conversation.avatarUrl
                    };
                    await openDMScreen(currentConversationId);
                } else {
                    alert('DMã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('DMé–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                alert('DMã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });
        
        async function openDMScreen(conversationId) {
            try {
                const response = await fetch(`/api/dm/conversations/${conversationId}/messages`);
                const data = await response.json();
                
                if (!data.success) throw new Error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å–å¾—ã«å¤±æ•—');
                
                // ä¼šè©±IDã‚’æ˜ç¤ºçš„ã«æ•°å€¤ã¨ã—ã¦è¨­å®š
                currentConversationId = parseInt(conversationId);
                console.log('ğŸ”§ DMç”»é¢ã‚ªãƒ¼ãƒ—ãƒ³ - ä¼šè©±IDè¨­å®š:', currentConversationId);
                
                const dmHeader = document.querySelector('.dm-header .dm-user-info');
                const conversation = data.conversation;
                const avatarStyle = conversation.avatarUrl 
                    ? `background-image: url(${conversation.avatarUrl})` 
                    : '';
                dmHeader.innerHTML = `
                    <div class="dm-avatar" style="${avatarStyle}"></div>
                    <span class="dm-username">${conversation.displayName || conversation.username}</span>
                `;
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã§ç›¸æ‰‹ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«é·ç§»
                dmHeader.onclick = () => {
                    viewUserProfile(currentDMUser.userId);
                };
                
                displayDMMessages(data.messages);
                
                const sections = document.querySelectorAll('.app-section');
                sections.forEach(section => section.classList.remove('active'));
                document.getElementById('dm-section').style.display = 'block';
                document.getElementById('dm-section').classList.add('active');
                
                // ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
                const bottomNav = document.querySelector('.bottom-nav');
                if (bottomNav) {
                    bottomNav.style.display = 'none';
                }
                
                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆãƒãƒ£ãƒƒãƒˆãƒ»ãƒ•ã‚©ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ï¼‰ã‚’éè¡¨ç¤º
                const profileActions = document.getElementById('profileActions');
                if (profileActions) {
                    profileActions.style.display = 'none';
                }
                
                // æŠ•ç¨¿ãƒœã‚¿ãƒ³ã‚‚éè¡¨ç¤º
                const createPostBtn = document.getElementById('btnCreatePost');
                if (createPostBtn) {
                    createPostBtn.style.display = 'none';
                }
                
                console.log('âœ… DMç”»é¢ã‚’é–‹ãã¾ã—ãŸ - WebSocketæ¥ç¶šçŠ¶æ…‹:', isWebSocketConnected);
                
                // WebSocketãŒæ¥ç¶šã•ã‚Œã¦ã„ãªã„å ´åˆã¯æ¥ç¶šã‚’è©¦ã¿ã‚‹
                if (!isWebSocketConnected) {
                    console.warn('âš ï¸ WebSocketãŒæœªæ¥ç¶šã§ã™ã€‚å†æ¥ç¶šã‚’è©¦ã¿ã¾ã™...');
                    connectWebSocket();
                }
            } catch (error) {
                console.error('DMç”»é¢ã‚ªãƒ¼ãƒ—ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                alert('DMã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        function displayDMMessages(messages) {
            console.log('ğŸ“œ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã‚’è¡¨ç¤º:', messages.length, 'ä»¶');
            const messagesContainer = document.getElementById('dmMessages');
            messagesContainer.innerHTML = '';
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `dm-message ${msg.isOwn ? 'own' : 'other'}`;
                
                const time = new Date(msg.sentAt).toLocaleTimeString('ja-JP', { 
                    hour: '2-digit', minute: '2-digit' 
                });
                
                const avatarStyle = msg.senderAvatarUrl 
                    ? `background-image: url(${msg.senderAvatarUrl})` 
                    : '';
                
                messageDiv.innerHTML = `
                    ${!msg.isOwn ? `<div class="dm-message-avatar" style="${avatarStyle}"></div>` : ''}
                    <div class="dm-message-bubble">
                        <div class="dm-message-content">${escapeHtml(msg.content)}</div>
                        <div class="dm-message-time">${time}</div>
                    </div>
                    ${msg.isOwn ? `<div class="dm-message-avatar" style="${avatarStyle}"></div>` : ''}
                `;
                
                messagesContainer.appendChild(messageDiv);
            });
            
            scrollDMToBottom();
            console.log('âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã®è¡¨ç¤ºå®Œäº†');
        }
        
        document.getElementById('dmSendBtn').addEventListener('click', sendDM);
        document.getElementById('dmInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendDM();
            }
        });
        
        async function sendDM() {
            const input = document.getElementById('dmInput');
            const content = input.value.trim();
            
            console.log('ğŸ“¤ DMé€ä¿¡è©¦è¡Œ:', {
                content: content,
                conversationId: currentConversationId,
                connected: isWebSocketConnected
            });
            
            if (!content || !currentConversationId) {
                console.warn('âš ï¸ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©ºã¾ãŸã¯ä¼šè©±IDãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (stompClient && isWebSocketConnected) {
                const payload = {
                    conversationId: currentConversationId,
                    content: content
                };
                console.log('ğŸ“¨ WebSocketã§é€ä¿¡:', payload);
                stompClient.send('/app/dm.send', {}, JSON.stringify(payload));
                
                input.value = '';
                input.style.height = 'auto';
                console.log('âœ… DMãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å®Œäº†');
            } else {
                console.error('âŒ WebSocketæœªæ¥ç¶š');
                alert('æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¦ã„ã¾ã™');
            }
        }
        
        function handleIncomingDM(dmData) {
            console.log('ğŸ“¨ DMå—ä¿¡:', dmData);
            console.log('ç¾åœ¨ã®ä¼šè©±ID:', currentConversationId, '(å‹:', typeof currentConversationId + ')');
            console.log('å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¼šè©±ID:', dmData.conversationId, '(å‹:', typeof dmData.conversationId + ')');
            console.log('ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:', currentUserId);
            console.log('é€ä¿¡è€…ID:', dmData.senderId);
            
            // ä¼šè©±IDã‚’æ˜ç¤ºçš„ã«æ•°å€¤ã¨ã—ã¦æ¯”è¼ƒ
            const receivedConversationId = parseInt(dmData.conversationId);
            const currentConvId = parseInt(currentConversationId);
            
            console.log('æ¯”è¼ƒ: ', receivedConversationId, '===', currentConvId, '?', receivedConversationId === currentConvId);
            
            // DMç”»é¢ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
            if (receivedConversationId === currentConvId) {
                console.log('âœ… ç¾åœ¨ã®ä¼šè©±ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™ã€‚è¡¨ç¤ºã—ã¾ã™ã€‚');
                const messagesContainer = document.getElementById('dmMessages');
                if (!messagesContainer) {
                    console.error('âŒ dmMessagesã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const messageDiv = document.createElement('div');
                const isOwn = parseInt(dmData.senderId) === parseInt(currentUserId);
                console.log('è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ï¼Ÿ:', isOwn);
                messageDiv.className = `dm-message ${isOwn ? 'own' : 'other'}`;
                
                const time = new Date(dmData.sentAt).toLocaleTimeString('ja-JP', { 
                    hour: '2-digit', minute: '2-digit' 
                });
                
                const avatarStyle = dmData.senderAvatarUrl 
                    ? `background-image: url(${dmData.senderAvatarUrl})` 
                    : '';
                
                messageDiv.innerHTML = `
                    ${!isOwn ? `<div class="dm-message-avatar" style="${avatarStyle}"></div>` : ''}
                    <div class="dm-message-bubble">
                        <div class="dm-message-content">${escapeHtml(dmData.content)}</div>
                        <div class="dm-message-time">${time}</div>
                    </div>
                    ${isOwn ? `<div class="dm-message-avatar" style="${avatarStyle}"></div>` : ''}
                `;
                
                messagesContainer.appendChild(messageDiv);
                scrollDMToBottom();
                console.log('ğŸ“ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’DOMã«è¿½åŠ ã—ã¾ã—ãŸ');
                
                if (!isOwn && stompClient && isWebSocketConnected) {
                    stompClient.send('/app/dm.read', {}, JSON.stringify({
                        conversationId: currentConversationId
                    }));
                }
            } else {
                console.log('âš ï¸ åˆ¥ã®ä¼šè©±ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™ã€‚DMç”»é¢ã«ã¯è¡¨ç¤ºã—ã¾ã›ã‚“ã€‚');
            }
            
            // ãƒãƒ£ãƒƒãƒˆç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ä¼šè©±ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
            const chatSection = document.getElementById('chat-section');
            if (chatSection && chatSection.classList.contains('active')) {
                console.log('ğŸ”„ ãƒãƒ£ãƒƒãƒˆç”»é¢ãŒè¡¨ç¤ºä¸­ãªã®ã§ä¼šè©±ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã™');
                loadDMConversations();
            }
        }
        
        function handleDMReadNotification(readData) {
            console.log('âœ… æ—¢èª­é€šçŸ¥:', readData);
        }
        
        function scrollDMToBottom() {
            const container = document.getElementById('dmMessagesContainer');
            container.scrollTop = container.scrollHeight;
        }
        
        document.getElementById('backFromDmBtn').addEventListener('click', function() {
            document.getElementById('dm-section').style.display = 'none';
            document.getElementById('dm-section').classList.remove('active');
            
            const sections = document.querySelectorAll('.app-section');
            sections.forEach(section => section.classList.remove('active'));
            document.getElementById('home-section').classList.add('active');
            
            // ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†è¡¨ç¤º
            const bottomNav = document.querySelector('.bottom-nav');
            if (bottomNav) {
                bottomNav.style.display = 'flex';
            }
            
            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã®ã¾ã¾ï¼ˆå…ƒã®ç”»é¢ã«æˆ»ã‚‹ã ã‘ãªã®ã§ï¼‰
            const profileActions = document.getElementById('profileActions');
            if (profileActions) {
                profileActions.style.display = 'none';
            }
            
            // æŠ•ç¨¿ãƒœã‚¿ãƒ³ã‚’å†è¡¨ç¤º
            const createPostBtn = document.getElementById('btnCreatePost');
            if (createPostBtn) {
                createPostBtn.style.display = 'flex';
            }
            
            currentConversationId = null;
            currentDMUser = null;
        });
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
