<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ - ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª</title>
    
    <!-- PWAè¨­å®š -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#FF69B4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª">
    <link rel="apple-touch-icon" href="/images/default-avatar.svg">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/chat-style.css" rel="stylesheet">
    <link href="/css/kawaii-theme.css" rel="stylesheet">
    <link href="/css/mobile.css" rel="stylesheet">
    <style>
        /* ãƒãƒ£ãƒƒãƒˆå°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .chat-sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            height: calc(100vh - 150px);
            overflow-y: auto;
        }
        
        .chat-main {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            height: calc(100vh - 150px);
            display: flex;
            flex-direction: column;
        }
        
        .room-item {
            padding: 1rem;
            border-radius: 15px;
            margin: 0.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .room-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .room-item:hover::before {
            left: 100%;
        }
        
        .room-item:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            transform: translateX(10px);
        }
        
        .room-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }
        
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px 20px 0 0;
            padding: 1.5rem;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(247, 248, 252, 0.5) 0%, rgba(236, 240, 251, 0.5) 100%);
        }
        
        .chat-input-area {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 0 0 20px 20px;
            border-top: 1px solid rgba(102, 126, 234, 0.1);
        }
        
        .message-bubble {
            border-radius: 20px;
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            position: relative;
            animation: messageSlide 0.3s ease-out;
            max-width: 70%;
        }
        
        .message-bubble.own {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .message-bubble.other {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .user-avatar:hover {
            transform: scale(1.1) rotate(10deg);
            border-color: #764ba2;
        }
        
        .online-users-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        
        .user-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 1rem;
            margin: 0.5rem 0;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .user-card:hover {
            background: rgba(102, 126, 234, 0.1);
            border-left-color: #667eea;
            transform: translateX(5px);
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            margin: 0.5rem 0;
            max-width: 100px;
        }
        
        .typing-dots {
            display: flex;
            gap: 3px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: typingPulse 1.5s ease-in-out infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typingPulse {
            0%, 60%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            30% {
                transform: scale(1.2);
                opacity: 1;
            }
        }
        
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .switching {
            opacity: 0.6;
            pointer-events: none;
        }
        
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* èª­ã¿è¾¼ã¿ä¸­ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .chat-sidebar,
            .chat-main,
            .online-users-panel {
                height: auto;
                margin-bottom: 1rem;
            }
            
            .message-bubble {
                max-width: 85%;
            }
        }
        
        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã¨ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®z-indexä¿®æ­£ */
        .navbar {
            z-index: 1030 !important;
            position: relative;
        }
        
        .dropdown-menu {
            z-index: 1040 !important;
            position: absolute !important;
        }
        
        .dropdown {
            z-index: 1035 !important;
        }
        
        /* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ã®z-indexèª¿æ•´ */
        .chat-main {
            z-index: 1020;
            position: relative;
        }
        
        .chat-sidebar {
            z-index: 1020;
            position: relative;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-comments me-2"></i>ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª
            </a>
            <div class="navbar-nav ms-auto">
                <!-- ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
                <div class="nav-item dropdown mobile-hamburger d-md-none">
                    <button class="dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-bars"></i>
                        ãƒ¡ãƒ‹ãƒ¥ãƒ¼
                    </button>
                    <ul class="dropdown-menu">
                        <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« -->
                        <li>
                            <a class="dropdown-item" href="/profile">
                                <i class="fas fa-user"></i>
                                ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
                            </a>
                        </li>
                        <!-- ãƒ•ãƒ¬ãƒ³ãƒ‰ -->
                        <li>
                            <a class="dropdown-item" href="/friends">
                                <i class="fas fa-user-friends"></i>
                                ãƒ•ãƒ¬ãƒ³ãƒ‰
                                <span class="badge bg-danger ms-auto" id="mobileNotificationBadge" style="display: none;">0</span>
                            </a>
                        </li>
                        <!-- ãƒ«ãƒ¼ãƒ ä¸€è¦§ -->
                        <li>
                            <a class="dropdown-item" href="/rooms">
                                <i class="fas fa-list"></i>
                                ãƒ«ãƒ¼ãƒ ä¸€è¦§
                            </a>
                        </li>
                        <!-- ãƒ«ãƒ¼ãƒ ä½œæˆ -->
                        <li>
                            <a class="dropdown-item" href="/rooms/create">
                                <i class="fas fa-plus"></i>
                                ãƒ«ãƒ¼ãƒ ä½œæˆ
                            </a>
                        </li>
                        <!-- ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒƒãƒãƒ³ã‚° -->
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <a class="dropdown-item" href="/random-matching">
                                <i class="fas fa-dice"></i>
                                ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒƒãƒãƒ³ã‚°
                            </a>
                        </li>
                        <!-- ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿è¡¨ç¤º -->
                        <li th:if="${debugMode}">
                            <a class="dropdown-item" href="#" onclick="showUserSearchModal()">
                                <i class="fas fa-search"></i>
                                IDæ¤œç´¢
                            </a>
                        </li>
                        <li th:if="${debugMode}">
                            <a class="dropdown-item" href="/login/offdbg">
                                <i class="fas fa-bug"></i>
                                ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰è§£é™¤
                            </a>
                        </li>
                        <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ -->
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-danger" href="/logout" style="color: #dc3545 !important; font-weight: 600;">
                                <i class="fas fa-sign-out-alt"></i>
                                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                            </a>
                        </li>
                    </ul>
                </div>
                
                <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ï¼ˆå¾“æ¥é€šã‚Šï¼‰ -->
                <span class="navbar-text me-3 d-none d-md-inline" sec:authorize="isAuthenticated()">
                    <i class="fas fa-user me-1"></i>
                    ã‚ˆã†ã“ãã€<span sec:authentication="name"></span>ã•ã‚“
                </span>
                <!-- ãƒ•ãƒ¬ãƒ³ãƒ‰ç®¡ç†ãƒœã‚¿ãƒ³ -->
                <div class="nav-item position-relative me-3 d-none d-md-block">
                    <a class="nav-link d-flex align-items-center" href="/friends" id="friendsButton" style="padding: 8px 16px; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transition: all 0.3s ease;">
                        <i class="fas fa-user-friends me-2" style="font-size: 1.1rem;"></i>
                        <span style="font-weight: 500;">ãƒ•ãƒ¬ãƒ³ãƒ‰</span>
                        <span class="position-absolute translate-middle badge rounded-pill" 
                              id="friendNotificationBadge" 
                              style="display: none; top: -5px; left: 100%; background: linear-gradient(135deg, #ff4757, #ff3838); color: white; font-size: 0.7rem; font-weight: bold; min-width: 20px; height: 20px; line-height: 20px; border: 2px solid white; box-shadow: 0 2px 8px rgba(255, 71, 87, 0.4);">
                            <span id="friendNotificationCount">0</span>
                        </span>
                    </a>
                </div>
                <!-- ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒƒãƒãƒ³ã‚°ãƒœã‚¿ãƒ³ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿ï¼‰ -->
                <div th:if="${debugMode}" class="nav-item me-3 d-none d-md-block">
                    <a class="nav-link d-flex align-items-center" href="/random-matching" style="padding: 8px 16px; border-radius: 12px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; transition: all 0.3s ease;">
                        <i class="fas fa-dice me-2" style="font-size: 1.1rem;"></i>
                        <span style="font-weight: 500;">ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒƒãƒãƒ³ã‚°</span>
                    </a>
                </div>
                <!-- IDæ¤œç´¢ãƒœã‚¿ãƒ³ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿ï¼‰ -->
                <div th:if="${debugMode}" class="nav-item me-3 d-none d-md-block">
                    <button class="nav-link btn btn-link" onclick="showUserSearchModal()" style="border: none; background: none;">
                        <i class="fas fa-search me-1"></i>IDæ¤œç´¢
                    </button>
                </div>
                <a class="nav-link d-none d-md-block" th:href="@{/rooms}">
                    <i class="fas fa-list me-1"></i>ãƒ«ãƒ¼ãƒ ä¸€è¦§
                </a>
                <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
                <div class="nav-item dropdown d-none d-md-block" style="z-index: 1040;">
                    <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-user-circle me-1"></i>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" style="z-index: 1050;">
                        <li><a class="dropdown-item" th:href="@{/profile}">
                            <i class="fas fa-user me-2"></i>ãƒã‚¤ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
                        </a></li>
                        <li><a class="dropdown-item" th:href="@{/profile/edit}">
                            <i class="fas fa-edit me-2"></i>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" th:href="@{/profile/search}">
                            <i class="fas fa-search me-2"></i>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
                        </a></li>
                        <!-- ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿è¡¨ç¤º -->
                        <li th:if="${debugMode}"><a class="dropdown-item" th:href="@{/profile/online}">
                            <i class="fas fa-circle text-success me-2"></i>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
                        </a></li>
                        <!-- ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒƒãƒãƒ³ã‚°ã¯ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿ -->
                        <li th:if="${debugMode}"><hr class="dropdown-divider"></li>
                        <li th:if="${debugMode}"><a class="dropdown-item" th:href="@{/random-matching}">
                            <i class="fas fa-dice me-2"></i>ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒƒãƒãƒ³ã‚°
                        </a></li>
                        <!-- ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿è¡¨ç¤º -->
                        <li th:if="${debugMode}"><hr class="dropdown-divider"></li>
                        <li th:if="${debugMode}"><a class="dropdown-item" href="#" onclick="toggleOnlineStatus()">
                            <i class="fas fa-power-off me-2"></i>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´
                        </a></li>
                        <li th:if="${debugMode}"><a class="dropdown-item" href="/debug/session">
                            <i class="fas fa-bug me-2"></i>ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
                        </a></li>
                        <li th:if="${debugMode}"><a class="dropdown-item" href="#" onclick="openMultiSessionTab()">
                            <i class="fas fa-external-link-alt me-2"></i>æ–°ã—ã„ã‚¿ãƒ–ã§ãƒ­ã‚°ã‚¤ãƒ³
                        </a></li>
                    </ul>
                </div>
                <a class="nav-link d-none d-md-block" th:href="@{/logout}">
                    <i class="fas fa-sign-out-alt me-1"></i>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼šãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ä¸€è¦§ -->
            <div class="col-md-3">
                <div class="card chat-sidebar" id="mobileSidebar">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-list me-1"></i>å‚åŠ ä¸­ã®ãƒ«ãƒ¼ãƒ 
                        </h6>
                        <div>
                            <a href="/rooms/create" class="btn btn-sm btn-light">
                                <i class="fas fa-plus"></i>
                            </a>
                            <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ -->
                            <button class="btn btn-sm btn-light d-md-none ms-1" onclick="toggleMobileSidebar()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div th:if="${userRooms != null and !userRooms.isEmpty()}">
                            <div th:each="room : ${userRooms}" 
                                 class="room-item list-group-item list-group-item-action d-flex justify-content-between align-items-center room-clickable"
                                 th:classappend="${room.id == currentRoom?.id} ? 'active' : ''"
                                 style="cursor: pointer;" 
                                 th:data-room-id="${room.id}"
                                 th:data-room-name="${room.name}">
                                <div>
                                    <div class="fw-bold" th:text="${room.name}">ãƒ«ãƒ¼ãƒ å</div>
                                    <small class="text-muted">
                                        <i class="fas fa-users me-1"></i>
                                        <span th:text="${room.users.size()}">0</span> äºº
                                    </small>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-success me-2" th:if="${room.type.name() == 'GROUP'}">
                                        <i class="fas fa-users"></i>
                                    </span>
                                    <span class="badge bg-info me-2" th:if="${room.type.name() == 'PRIVATE'}">
                                        <i class="fas fa-lock"></i>
                                    </span>
                                    <!-- ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ ã«ã¯ç‰¹åˆ¥ãªã‚¢ã‚¤ã‚³ãƒ³ -->
                                    <i class="fas fa-arrow-right text-primary" th:if="${room.id == currentRoom?.id}"></i>
                                </div>
                            </div>
                        </div>
                        <div th:if="${userRooms == null or userRooms.isEmpty()}" class="p-3 text-center text-muted">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p class="small mb-0">å‚åŠ ä¸­ã®ãƒ«ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>
                            <a href="/rooms" class="btn btn-sm btn-outline-primary mt-2">
                                ãƒ«ãƒ¼ãƒ ã‚’æ¢ã™
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒƒãƒãƒ³ã‚° ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ -->
                <div class="card mt-3 d-none d-md-block">
                    <div class="card-header text-white d-flex justify-content-between align-items-center" 
                         style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
                        <h6 class="mb-0">
                            <i class="fas fa-dice me-1"></i>ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒƒãƒãƒ³ã‚°
                        </h6>
                        <i class="fas fa-heart text-white"></i>
                    </div>
                    <div class="card-body p-3">
                        <div class="text-center">
                            <div class="mb-3">
                                <i class="fas fa-dice fa-2x mb-2" style="color: #ff6b6b;"></i>
                                <p class="small text-muted mb-2">æ–°ã—ã„å‡ºä¼šã„ã‚’è¦‹ã¤ã‘ã‚ˆã†</p>
                            </div>
                            <div class="d-grid gap-2">
                                <a href="/random-matching" class="btn btn-primary" 
                                   style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); border: none;">
                                    <i class="fas fa-dice me-1"></i>ãƒãƒƒãƒãƒ³ã‚°<br>é–‹å§‹
                                </a>
                                <button class="btn btn-outline-secondary btn-sm" onclick="showQuickMatchModal()">
                                    <i class="fas fa-bolt me-1"></i>ã‚¯ã‚¤ãƒƒã‚¯ãƒãƒƒãƒ
                                </button>
                            </div>
                            <div class="mt-3 pt-2 border-top">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <small class="text-muted d-block">ä»Šæ—¥ã®ãƒãƒƒãƒ</small>
                                        <strong class="text-primary" id="todayMatches">0</strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">ç·ãƒãƒƒãƒæ•°</small>
                                        <strong class="text-success" id="totalMatches">0</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ•ãƒ¬ãƒ³ãƒ‰ -->
                <div class="card mt-3 d-none d-md-block">
                    <div class="card-header text-white d-flex justify-content-between align-items-center" 
                         style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <h6 class="mb-0">
                            <i class="fas fa-circle text-success me-1"></i>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ•ãƒ¬ãƒ³ãƒ‰
                        </h6>
                        <span class="badge bg-light text-dark" id="onlineFriendsCount">0</span>
                    </div>
                    <div class="card-body p-0">
                        <div id="onlineFriendsList" class="list-group list-group-flush">
                            <div class="text-center py-3 text-muted" id="noOnlineFriends">
                                <i class="fas fa-user-slash mb-2"></i>
                                <div>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®ãƒ•ãƒ¬ãƒ³ãƒ‰ã¯ã„ã¾ã›ã‚“</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
            <div class="col-md-9">
                <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ -->
                <button class="mobile-sidebar-toggle d-md-none" onclick="toggleMobileSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="card chat-main">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0" th:text="${currentRoom?.name ?: 'ãƒãƒ£ãƒƒãƒˆ'}">ãƒãƒ£ãƒƒãƒˆ</h5>
                            <small th:if="${currentRoom != null}">
                                <i class="fas fa-users me-1"></i>
                                <span th:text="${currentRoom?.users?.size() ?: 0}">0</span> äººãŒå‚åŠ ä¸­
                            </small>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿ï¼‰ -->
                        <div th:if="${debugMode and debugEnabled}" class="alert alert-info" style="font-size: 12px;">
                            <strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br>
                            chatHistory is null: <span th:text="${chatHistory == null}"></span><br>
                            chatHistory size: <span th:text="${chatHistory != null ? chatHistory.size() : 'N/A'}"></span><br>
                            chatRoomId: <span th:text="${chatRoomId}"></span>
                        </div>
                        
                        <div id="chat-container">
                            <!-- æ—¢å­˜ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’è¡¨ç¤º -->
                            <div th:if="${chatHistory != null and !chatHistory.isEmpty()}">
                                <div th:each="msg, iterStat : ${chatHistory}" class="message d-flex">
                                    <div class="message-bubble" 
                                         th:classappend="${msg.user.username == #authentication.name} ? 'own-message' : 'other-message'">
                                        <div class="message-header" th:if="${msg.user.username != #authentication.name}">
                                            <!-- ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã¯JavaScriptã§å‹•çš„ã«æ›´æ–°ã•ã‚Œã‚‹ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º -->
                                            <i class="fas fa-user-circle me-1 user-avatar-clickable" 
                                               style="cursor: pointer; color: #007bff;" 
                                               th:data-user-id="${msg.user.id}"
                                               th:data-username="${msg.user.username}"
                                               onclick="showUserContextMenu(event, this)"
                                               title="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º"></i>
                                            <span th:text="${msg.user.username}" 
                                                  class="username-clickable" 
                                                  style="cursor: pointer; color: #007bff;"
                                                  th:data-user-id="${msg.user.id}"
                                                  th:data-username="${msg.user.username}"
                                                  onclick="showUserContextMenu(event, this)"
                                                  title="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º"></span>
                                        </div>
                                        <div class="message-content" th:text="${msg.content}"></div>
                                        <div class="message-time mt-1" style="font-size: 0.75rem; opacity: 0.7;">
                                            <i class="fas fa-clock me-1"></i>
                                            <span th:text="${#temporals.format(msg.sentAt, 'HH:mm')}"></span>
                                        </div>
                                        <!-- ãƒ‡ãƒãƒƒã‚°ï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è©³ç´°ï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰ -->
                                        <small th:if="${debugEnabled}" style="color: #666;">
                                            Debug: index=<span th:text="${iterStat.index}"></span>, 
                                            msgId=<span th:text="${msg.id}"></span>, 
                                            userId=<span th:text="${msg.user.id}"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div th:if="${chatHistory == null or chatHistory.isEmpty()}" class="text-center text-muted py-5">
                                <div class="mb-4">
                                    <i class="fas fa-comments fa-3x" style="opacity: 0.3;"></i>
                                </div>
                                <h5 class="mb-3">ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</h5>
                                <p class="mb-0">æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
                                <!-- ãƒ‡ãƒãƒƒã‚°ï¼šå®Ÿéš›ã®å€¤ã‚’è¡¨ç¤ºï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰ -->
                                <small th:if="${debugEnabled}">
                                    chatHistory: <span th:text="${chatHistory}"></span>
                                </small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="input-group">
                                <input type="text" id="messageInput" class="form-control" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." autocomplete="off">
                                <button class="btn btn-primary pulse" type="button" id="sendButton">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-users me-2"></i>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
                        </h5>
                    </div>
                    <div class="card-body">
                        <ul id="users-list" class="list-unstyled">
                            <!-- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="/js/notifications.js"></script>
    <script>
        let stompClient = null;
        let currentUser = /*[[${username}]]*/ 'user';
        let currentRoomId = /*[[${currentRoom?.id ?: 1}]]*/ 1;
        let currentSubscription = null;
        let debugEnabled = true; // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’è¨­å®šï¼ˆé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã§ä½¿ç”¨ï¼‰
        window.currentUser = currentUser;
        window.currentRoomId = currentRoomId;

        function switchRoomFromElement(element) {
            console.log('switchRoomFromElement called:', element);
            
            if (!element || !element.dataset) {
                console.error('Invalid element passed to switchRoomFromElement:', element);
                return;
            }
            
            const roomId = parseInt(element.dataset.roomId);
            const roomName = element.dataset.roomName;
            
            console.log('Room data:', { roomId, roomName, dataset: element.dataset });
            
            if (!roomId || isNaN(roomId)) {
                console.error('Invalid room ID:', element.dataset.roomId);
                return;
            }
            
            if (!roomName) {
                console.error('Missing room name:', element.dataset.roomName);
                return;
            }
            
            console.log('Attempting to switch room:', roomId, roomName);
            
            // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            element.style.transform = 'scale(0.95)';
            setTimeout(() => {
                element.style.transform = '';
            }, 150);
            
            // å³åº§ã«UIã‚’æ›´æ–°ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–æ„Ÿã‚’å‘ä¸Šï¼‰
            updateActiveRoomInSidebar(roomId);
            
            switchRoomInternal(roomId, roomName);
        }

        function switchRoomInternal(roomId, roomName) {
            if (roomId == currentRoomId) {
                if (debugEnabled) {
                    console.log('åŒã˜ãƒ«ãƒ¼ãƒ ã®ãŸã‚åˆ‡ã‚Šæ›¿ãˆã‚’ã‚¹ã‚­ãƒƒãƒ—:', roomId);
                }
                return; // åŒã˜ãƒ«ãƒ¼ãƒ ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
            }
            
            if (debugEnabled) {
                console.log('ãƒ«ãƒ¼ãƒ åˆ‡ã‚Šæ›¿ãˆé–‹å§‹:', currentRoomId, '->', roomId, '(' + roomName + ')');
            }
            
            // åˆ‡ã‚Šæ›¿ãˆä¸­ã®UIè¡¨ç¤º
            showSwitchingState(true);
            
            // ç¾åœ¨ã®è³¼èª­ã‚’è§£é™¤
            if (stompClient && stompClient.connected && currentSubscription) {
                currentSubscription.unsubscribe();
                if (debugEnabled) {
                    console.log('å‰ã®ãƒ«ãƒ¼ãƒ ã®è³¼èª­ã‚’è§£é™¤ã—ã¾ã—ãŸ:', currentRoomId);
                }
            }
            
            // æ–°ã—ã„ãƒ«ãƒ¼ãƒ ã«åˆ‡ã‚Šæ›¿ãˆ
            const oldRoomId = currentRoomId;
            currentRoomId = roomId;
            
            // URLã‚’æ›´æ–°ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å±¥æ­´ã«è¿½åŠ ï¼‰
            const newUrl = `/chat?room=${roomId}`;
            if (window.location.href !== window.location.origin + newUrl) {
                window.history.pushState({roomId: roomId, roomName: roomName}, '', newUrl);
            }
            
            // UIã‚’æ›´æ–°
            updateCurrentRoomDisplay(roomName);
            updateActiveRoomInSidebar(roomId);
            clearChatArea();
            showLoadingInChat();
            
            // æ–°ã—ã„ãƒ«ãƒ¼ãƒ ã«è³¼èª­
            if (stompClient && stompClient.connected) {
                currentSubscription = stompClient.subscribe('/topic/chatroom/' + roomId, function(messageOutput) {
                    if (debugEnabled) {
                        console.log('æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ (room ' + roomId + '):', messageOutput.body);
                    }
                    const messageData = JSON.parse(messageOutput.body);
                    showMessage(messageData);
                    
                    // é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã¨çµ±åˆ
                    if (window.notificationManager && messageData.type === 'CHAT') {
                        window.notificationManager.notifyNewMessage(messageData, roomName, roomId);
                    } else if (window.notificationManager && messageData.type === 'JOIN') {
                        window.notificationManager.notifyUserJoined(messageData.senderUsername, roomName, currentRoomId, roomId);
                    } else if (window.notificationManager && messageData.type === 'LEAVE') {
                        window.notificationManager.notifyUserLeft(messageData.senderUsername, roomName, currentRoomId, roomId);
                    }
                });
                
                if (debugEnabled) {
                    console.log('æ–°ã—ã„ãƒ«ãƒ¼ãƒ ã«è³¼èª­ã—ã¾ã—ãŸ:', roomId);
                }
                
                // å‚åŠ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
                stompClient.send("/app/chat.addUser", {}, JSON.stringify({
                    senderUsername: currentUser,
                    chatRoomId: roomId,
                    type: 'JOIN'
                }));
            }
            
            // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’èª­ã¿è¾¼ã¿
            loadRoomHistory(roomId);
            
            // æœªèª­æ•°ã‚’ã‚¯ãƒªã‚¢
            if (window.notificationManager) {
                window.notificationManager.clearUnreadCount(roomId);
            }
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
            window.currentRoomId = roomId;
        }

        function showSwitchingState(switching) {
            const chatContainer = document.getElementById('chat-container');
            if (switching) {
                chatContainer.classList.add('switching');
            } else {
                chatContainer.classList.remove('switching');
            }
        }

        function showLoadingInChat() {
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = `
                <div class="text-center p-4">
                    <div class="loading"></div>
                    <p class="mt-2">ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            `;
        }

        function updateCurrentRoomDisplay(roomName) {
            const currentRoomElement = document.querySelector('h5.mb-0');
            if (currentRoomElement) {
                currentRoomElement.textContent = roomName;
            }
        }

        function updateActiveRoomInSidebar(roomId) {
            console.log('ãƒ«ãƒ¼ãƒ ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°:', roomId);
            
            // ã™ã¹ã¦ã®ãƒ«ãƒ¼ãƒ ã‚¢ã‚¤ãƒ†ãƒ ã‹ã‚‰activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            document.querySelectorAll('.room-item').forEach(item => {
                item.classList.remove('active');
                // çŸ¢å°ã‚¢ã‚¤ã‚³ãƒ³ã‚‚å‰Šé™¤
                const arrow = item.querySelector('.fas.fa-arrow-right');
                if (arrow) {
                    arrow.remove();
                }
                // å…ƒã®è‰²ã«æˆ»ã™
                item.style.removeProperty('background');
                item.style.removeProperty('color');
            });
            
            // æ–°ã—ã„ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ«ãƒ¼ãƒ ã‚’ data-room-id ã§æ¤œç´¢
            const activeRoomElement = document.querySelector(`[data-room-id="${roomId}"]`);
            console.log('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ«ãƒ¼ãƒ è¦ç´ :', activeRoomElement);
            
            if (activeRoomElement) {
                // activeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                activeRoomElement.classList.add('active');
                
                // æ˜ç¢ºãªè‰²å¤‰æ›´ã‚’é©ç”¨
                activeRoomElement.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                activeRoomElement.style.color = 'white';
                activeRoomElement.style.transform = 'scale(1.02)';
                activeRoomElement.style.boxShadow = '0 8px 16px rgba(102, 126, 234, 0.3)';
                
                // çŸ¢å°ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
                const badgeContainer = activeRoomElement.querySelector('.d-flex.align-items-center');
                if (badgeContainer && !badgeContainer.querySelector('.fa-arrow-right')) {
                    const arrow = document.createElement('i');
                    arrow.className = 'fas fa-arrow-right text-white ms-2';
                    arrow.style.animation = 'pulse 2s infinite';
                    badgeContainer.appendChild(arrow);
                }
                
                // å†…éƒ¨ã®ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚‚ç™½ã«å¤‰æ›´
                const textElements = activeRoomElement.querySelectorAll('*');
                textElements.forEach(el => {
                    if (el.classList.contains('text-muted')) {
                        el.style.color = 'rgba(255, 255, 255, 0.8)';
                    } else if (!el.classList.contains('badge')) {
                        el.style.color = 'white';
                    }
                });
                
                console.log('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ«ãƒ¼ãƒ è¨­å®šå®Œäº†:', roomId);
            } else {
                console.warn('ãƒ«ãƒ¼ãƒ è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', roomId);
            }
        }

        function clearChatArea() {
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer) {
                chatContainer.innerHTML = '';
            }
        }

        function loadRoomHistory(roomId) {
            if (debugEnabled) {
                console.log('å±¥æ­´èª­ã¿è¾¼ã¿é–‹å§‹ - ãƒ«ãƒ¼ãƒ ID:', roomId);
            }
            
            fetch(`/api/messages/${roomId}`)
                .then(response => {
                    if (debugEnabled) {
                        console.log('APIå¿œç­”ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
                    }
                    return response.json();
                })
                .then(messages => {
                    if (debugEnabled) {
                        console.log('å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', messages);
                        console.log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°:', messages.length);
                    }
                    
                    const messageArea = document.getElementById('chat-container');
                    messageArea.innerHTML = '';
                    
                    if (messages.length === 0) {
                        messageArea.innerHTML = `
                            <div class="text-center p-4 text-muted">
                                <i class="fas fa-comment fa-3x mb-3"></i>
                                <p>ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</p>
                                <p class="small">æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
                            </div>
                        `;
                    } else {
                        messages.forEach(message => {
                            if (debugEnabled) {
                                console.log('è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', message);
                            }
                            showMessage(message);
                        });
                    }
                    
                    // èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                    showSwitchingState(false);
                    
                    if (debugEnabled) {
                        console.log('å±¥æ­´èª­ã¿è¾¼ã¿å®Œäº† - ãƒ«ãƒ¼ãƒ ID:', roomId);
                    }
                })
                .catch(error => {
                    console.error('å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    const messageArea = document.getElementById('chat-container');
                    messageArea.innerHTML = `
                        <div class="text-center p-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p>å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadRoomHistory(${roomId})">
                                å†èª­ã¿è¾¼ã¿
                            </button>
                        </div>
                    `;
                    showSwitchingState(false);
                    
                    if (debugEnabled) {
                        console.error('è©³ç´°ã‚¨ãƒ©ãƒ¼:', error);
                    }
                });
        }

        function leaveRoom(roomId) {
            if (confirm('ã“ã®ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ')) {
                fetch(`/rooms/${roomId}/leave`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('é€€å‡ºã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                });
            }
        }

        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                
                // WebSocketæ¥ç¶šå®Œäº†æ™‚ã«ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã‚’é€ä¿¡ã—ã¦ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºå®Ÿã«ã™ã‚‹
                setTimeout(() => {
                    sendHeartbeat();
                }, 1000);
                
                // ç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã«å‚åŠ 
                currentSubscription = stompClient.subscribe(`/topic/chatroom/${currentRoomId}`, function (message) {
                    if (debugEnabled) {
                        console.log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ (room ' + currentRoomId + '):', message.body);
                    }
                    const messageData = JSON.parse(message.body);
                    showMessage(messageData);
                    
                    // é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã¨çµ±åˆ
                    if (window.notificationManager && messageData.type === 'CHAT') {
                        const roomName = getCurrentRoomName();
                        window.notificationManager.notifyNewMessage(messageData, roomName, currentRoomId);
                    }
                });
                
                // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®è³¼èª­
                stompClient.subscribe('/user/queue/status-updates', function (message) {
                    const statusUpdate = JSON.parse(message.body);
                    handleFriendStatusUpdate(statusUpdate);
                });
                
                // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã®è³¼èª­
                stompClient.subscribe('/topic/online-count', function (message) {
                    const countUpdate = JSON.parse(message.body);
                    updateOnlineUserCount(countUpdate);
                });
                
                if (debugEnabled) {
                    console.log('åˆæœŸãƒ«ãƒ¼ãƒ ã«è³¼èª­ã—ã¾ã—ãŸ:', currentRoomId);
                }
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‚åŠ é€šçŸ¥
                stompClient.send("/app/chat.addUser", {}, JSON.stringify({
                    senderUsername: currentUser,
                    chatRoomId: currentRoomId,
                    type: 'JOIN'
                }));
                
                // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ•ãƒ¬ãƒ³ãƒ‰ä¸€è¦§ã‚’åˆæœŸèª­ã¿è¾¼ã¿
                loadOnlineFriends();
                
                // å³åº§ã«ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã‚’é€ä¿¡ã—ã¦ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºå®Ÿã«ã™ã‚‹
                sendHeartbeat();
                
                // ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
                startHeartbeat();
                
                // URLæŒ‡å®šãƒ«ãƒ¼ãƒ ãŒã‚ã‚Œã°åˆ‡ã‚Šæ›¿ãˆ
                initializeRoomFromUrl();
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
            console.log("Disconnected");
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const messageContent = messageInput.value.trim();
            
            if (messageContent && stompClient) {
                // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«ã™ã‚‹
                sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                sendButton.disabled = true;
                
                const message = {
                    content: messageContent,
                    chatRoomId: currentRoomId,
                    senderUsername: currentUser,
                    timestamp: new Date().toISOString(),
                    type: 'CHAT'
                };
                
                if (debugEnabled) {
                    console.log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡:', message);
                }
                
                stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(message));
                messageInput.value = '';
                
                // 1ç§’å¾Œã«é€ä¿¡ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                setTimeout(() => {
                    sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    sendButton.disabled = false;
                    sendButton.classList.add('pulse'); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœã‚’å†é–‹
                }, 1000);
            }
        }

        function showMessage(message) {
            const chatContainer = document.getElementById('chat-container');
            const messageElement = document.createElement('div');
            
            if (message.type === 'JOIN' || message.type === 'LEAVE') {
                messageElement.innerHTML = `
                    <div class="alert alert-info small text-center mb-2" style="border: none; background: linear-gradient(135deg, #17a2b8, #138496); color: white;">
                        <i class="fas fa-info-circle me-1"></i>
                        ${message.content}
                    </div>
                `;
            } else {
                const isCurrentUser = message.senderUsername === currentUser;
                const time = new Date(message.timestamp).toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                const username = message.senderUsername || message.sender;
                const userId = message.userId || message.senderId;
                
                messageElement.className = `message d-flex ${isCurrentUser ? 'justify-content-end' : 'justify-content-start'}`;
                
                messageElement.innerHTML = `
                    <div class="message-bubble ${isCurrentUser ? 'own-message' : 'other-message'}">
                        ${!isCurrentUser ? `
                            <div class="message-header">
                                ${message.senderAvatarUrl ? `
                                    <img src="${message.senderAvatarUrl}" 
                                         class="rounded-circle me-2 user-avatar-clickable" 
                                         width="24" 
                                         height="24" 
                                         style="cursor: pointer; object-fit: cover;" 
                                         data-user-id="${userId}"
                                         data-username="${username}"
                                         onclick="showUserContextMenu(event, this)"
                                         title="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º"
                                         alt="ã‚¢ãƒã‚¿ãƒ¼">
                                ` : `
                                    <i class="fas fa-user-circle me-1 user-avatar-clickable" 
                                       style="cursor: pointer; color: #007bff;" 
                                       data-user-id="${userId}"
                                       data-username="${username}"
                                       onclick="showUserContextMenu(event, this)"
                                       title="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º"></i>
                                `}
                                <span class="username-clickable" 
                                      style="cursor: pointer; color: #007bff;"
                                      data-user-id="${userId}"
                                      data-username="${username}"
                                      onclick="showUserContextMenu(event, this)"
                                      title="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º">${message.senderDisplayName || username}</span>
                            </div>
                        ` : ''}
                        <div class="message-content">
                            ${message.content}
                        </div>
                        <div class="message-time mt-1" style="font-size: 0.75rem; opacity: 0.7;">
                            <i class="fas fa-clock me-1"></i>
                            <span>${time}</span>
                        </div>
                    </div>
                `;
            }
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getCurrentRoomName() {
            const activeRoomElement = document.querySelector('.room-item.active .fw-bold');
            return activeRoomElement ? activeRoomElement.textContent.trim() : 'ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ';
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦è¨­å®šï¼ˆé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã§ä½¿ç”¨ï¼‰
        window.switchRoom = function(roomId, roomName) {
            switchRoomInternal(roomId, roomName);
        };

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ä¸€ç•ªä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        window.addEventListener('load', function () {
            const chatContainer = document.getElementById('chat-container');
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            console.log('ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å®Œäº† - ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ ID:', currentRoomId);
            updateActiveRoomInSidebar(currentRoomId);
            
            // ãƒ«ãƒ¼ãƒ ã‚¢ã‚¤ãƒ†ãƒ ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆã‚ˆã‚Šç¢ºå®Ÿãªæ–¹æ³•ï¼‰
            addRoomClickListeners();
            
            connect();
            loadRoomHistory(currentRoomId);
        });
        
        // ãƒ«ãƒ¼ãƒ ã‚¯ãƒªãƒƒã‚¯ãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
        function addRoomClickListeners() {
            console.log('Adding room click listeners...');
            const roomElements = document.querySelectorAll('.room-clickable');
            console.log('Found room elements:', roomElements.length);
            
            roomElements.forEach((roomElement, index) => {
                console.log(`Setting up listener for room ${index}:`, roomElement.dataset);
                
                // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ï¼ˆé‡è¤‡ã‚’é˜²ãï¼‰
                roomElement.removeEventListener('click', handleRoomClick);
                
                // æ–°ã—ã„ãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                roomElement.addEventListener('click', handleRoomClick);
            });
        }
        
        // ãƒ«ãƒ¼ãƒ ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        function handleRoomClick(event) {
            console.log('Room clicked:', this);
            switchRoomFromElement(this);
        }
        
        // DOMãŒèª­ã¿è¾¼ã¾ã‚ŒãŸæ™‚ç‚¹ã§ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            setTimeout(addRoomClickListeners, 100); // å°‘ã—é…å»¶ã‚’å…¥ã‚Œã‚‹
            
            // ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ã§ãƒ«ãƒ¼ãƒ ã‚¯ãƒªãƒƒã‚¯ã‚’å‡¦ç†ï¼ˆã‚ˆã‚Šç¢ºå®Ÿï¼‰
            document.addEventListener('click', function(event) {
                const roomElement = event.target.closest('.room-clickable');
                if (roomElement) {
                    console.log('Room clicked via delegation:', roomElement);
                    event.preventDefault();
                    event.stopPropagation();
                    switchRoomFromElement(roomElement);
                }
            });
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // ãƒšãƒ¼ã‚¸ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚ã«åˆ‡æ–­
        window.addEventListener('beforeunload', function () {
            disconnect();
        });

        // ãƒ–ãƒ©ã‚¦ã‚¶ã®æˆ»ã‚‹/é€²ã‚€ãƒœã‚¿ãƒ³å¯¾å¿œ
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.roomId) {
                console.log('Handling popstate:', event.state);
                // URLã‹ã‚‰ãƒ«ãƒ¼ãƒ æƒ…å ±ã‚’å–å¾—ã—ã¦ãƒ«ãƒ¼ãƒ åˆ‡ã‚Šæ›¿ãˆ
                const roomId = event.state.roomId;
                const roomName = event.state.roomName || 'ãƒ«ãƒ¼ãƒ  ' + roomId;
                switchRoomInternal(roomId, roomName);
            } else {
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒ«ãƒ¼ãƒ æƒ…å ±ã‚’å–å¾—
                const urlParams = new URLSearchParams(window.location.search);
                const roomParam = urlParams.get('room');
                if (roomParam) {
                    const roomId = parseInt(roomParam);
                    if (!isNaN(roomId) && roomId !== currentRoomId) {
                        // ãƒ«ãƒ¼ãƒ è¦ç´ ã‚’æ¢ã—ã¦åˆ‡ã‚Šæ›¿ãˆ
                        const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
                        if (roomElement) {
                            switchRoomFromElement(roomElement);
                        }
                    }
                }
            }
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®ãƒ«ãƒ¼ãƒ é¸æŠå‡¦ç†
        function initializeRoomFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            
            if (roomParam) {
                const roomId = parseInt(roomParam);
                if (!isNaN(roomId)) {
                    console.log('URLæŒ‡å®šãƒ«ãƒ¼ãƒ :', roomId);
                    // å°‘ã—é…å»¶ã—ã¦ãƒ«ãƒ¼ãƒ è¦ç´ ãŒæç”»ã•ã‚Œã¦ã‹ã‚‰å®Ÿè¡Œ
                    setTimeout(() => {
                        const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
                        if (roomElement) {
                            console.log('URLæŒ‡å®šãƒ«ãƒ¼ãƒ ã«åˆ‡ã‚Šæ›¿ãˆ:', roomElement);
                            switchRoomFromElement(roomElement);
                        } else {
                            console.warn('æŒ‡å®šã•ã‚ŒãŸãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', roomId);
                        }
                    }, 500);
                }
            }
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ©Ÿèƒ½
        function toggleOnlineStatus() {
            const statuses = [
                { value: 'ONLINE', label: 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³', icon: 'fas fa-circle text-success' },
                { value: 'AWAY', label: 'é›¢å¸­ä¸­', icon: 'fas fa-circle text-warning' },
                { value: 'BUSY', label: 'å–ã‚Šè¾¼ã¿ä¸­', icon: 'fas fa-circle text-danger' },
                { value: 'OFFLINE', label: 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³', icon: 'fas fa-circle text-secondary' }
            ];
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«HTMLä½œæˆ
            const modalHtml = `
                <div class="modal fade" id="statusModal" tabindex="-1">
                    <div class="modal-dialog modal-sm">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h6 class="modal-title">
                                    <i class="fas fa-power-off me-2"></i>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´
                                </h6>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="list-group">
                                    ${statuses.map(status => `
                                        <button type="button" class="list-group-item list-group-item-action" 
                                                onclick="changeStatus('${status.value}')">
                                            <i class="${status.icon} me-2"></i>
                                            ${status.label}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‰Šé™¤
            const existingModal = document.getElementById('statusModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // æ–°ã—ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¿½åŠ 
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            const modal = new bootstrap.Modal(document.getElementById('statusModal'));
            modal.show();
        }
        
        function changeStatus(status) {
            fetch('/profile/status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: status })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    const modal = bootstrap.Modal.getInstance(document.getElementById('statusModal'));
                    modal.hide();
                    
                    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆä»»æ„ï¼‰
                    console.log('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ:', status);
                } else {
                    alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            });
        }
    </script>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="dropdown-menu" id="userContextMenu" style="display: none; position: absolute; z-index: 1050;">
        <a class="dropdown-item" href="#" onclick="viewUserProfile()">
            <i class="fas fa-user me-2"></i>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º
        </a>
        <a class="dropdown-item" href="#" onclick="sendFriendRequest()">
            <i class="fas fa-user-plus me-2"></i>ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹
        </a>
        <div class="dropdown-divider"></div>
        <a class="dropdown-item text-warning" href="#" onclick="blockUser()">
            <i class="fas fa-ban me-2"></i>ãƒ–ãƒ­ãƒƒã‚¯
        </a>
        <a class="dropdown-item text-danger" href="#" onclick="reportUser()">
            <i class="fas fa-exclamation-triangle me-2"></i>é€šå ±
        </a>
    </div>

    <!-- IDæ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="userSearchModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-search me-2"></i>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="searchInput" class="form-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ»ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ãƒ»IDã§æ¤œç´¢</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchInput" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€8æ¡ã®ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ã€ã¾ãŸã¯IDã‚’å…¥åŠ›...">
                            <button class="btn btn-primary" onclick="searchUsers()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ã¯8æ¡ã®è‹±æ•°å­—ã§ã™ï¼ˆä¾‹ï¼šAB12CD34ï¼‰
                        </div>
                    </div>
                    <div id="searchResults"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šå ±ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šå ±
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ<span id="reportTargetUsername"></span>ã€ã‚’é€šå ±ã—ã¾ã™ã€‚</p>
                    <div class="mb-3">
                        <label for="reportReason" class="form-label">é€šå ±ç†ç”±</label>
                        <select class="form-select" id="reportReason" required>
                            <option value="">ç†ç”±ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="SPAM">ã‚¹ãƒ‘ãƒ ãƒ»è¿·æƒ‘è¡Œç‚º</option>
                            <option value="HARASSMENT">ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆãƒ»å«ŒãŒã‚‰ã›</option>
                            <option value="INAPPROPRIATE_CONTENT">ä¸é©åˆ‡ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„</option>
                            <option value="HATE_SPEECH">ãƒ˜ã‚¤ãƒˆã‚¹ãƒ”ãƒ¼ãƒ</option>
                            <option value="IMPERSONATION">ãªã‚Šã™ã¾ã—</option>
                            <option value="VIOLENCE_THREAT">æš´åŠ›çš„ãªè„…è¿«</option>
                            <option value="PRIVACY_VIOLATION">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¾µå®³</option>
                            <option value="FRAUD">è©æ¬ºãƒ»ä¸æ­£è¡Œç‚º</option>
                            <option value="OTHER">ãã®ä»–</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="reportDescription" class="form-label">è©³ç´°èª¬æ˜ï¼ˆä»»æ„ï¼‰</label>
                        <textarea class="form-control" id="reportDescription" rows="3" placeholder="è©³ç´°ãªèª¬æ˜ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-danger" onclick="submitReport()">é€šå ±ã™ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼é–¢é€£ã®å¤‰æ•°
        let contextMenuTargetUserId = null;
        let contextMenuTargetUsername = null;

        // ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹é€šçŸ¥ã‚’ãƒã‚§ãƒƒã‚¯
        function checkFriendNotifications() {
            fetch('/friends/api/notification-count')
                .then(response => response.json())
                .then(data => {
                    const badge = document.getElementById('friendNotificationBadge');
                    const count = document.getElementById('friendNotificationCount');
                    
                    if (data.count > 0) {
                        badge.style.display = 'block';
                        count.textContent = data.count;
                    } else {
                        badge.style.display = 'none';
                    }
                })
                .catch(error => console.error('é€šçŸ¥ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error));
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤º
        function showUserContextMenu(event, element) {
            event.preventDefault();
            event.stopPropagation();
            
            contextMenuTargetUserId = element.dataset.userId;
            contextMenuTargetUsername = element.dataset.username;
            
            const menu = document.getElementById('userContextMenu');
            const rect = element.getBoundingClientRect();
            
            menu.style.display = 'block';
            menu.style.left = (rect.left + window.scrollX) + 'px';
            menu.style.top = (rect.bottom + window.scrollY + 5) + 'px';
            
            // ã‚¯ãƒªãƒƒã‚¯å¤–ã—ã§é–‰ã˜ã‚‹
            document.addEventListener('click', hideUserContextMenu, { once: true });
        }

        function hideUserContextMenu() {
            document.getElementById('userContextMenu').style.display = 'none';
        }

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º
        function viewUserProfile() {
            if (contextMenuTargetUserId) {
                window.open(`/profile/${contextMenuTargetUserId}`, '_blank');
            }
            hideUserContextMenu();
        }

        // ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹é€ä¿¡
        function sendFriendRequest() {
            if (!contextMenuTargetUserId) return;
            
            fetch('/friends/request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ targetUserId: contextMenuTargetUserId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`${contextMenuTargetUsername}ã«ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ã‚’é€ä¿¡ã—ã¾ã—ãŸ`);
                } else {
                    alert(data.message || 'ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            })
            .catch(error => {
                console.error('ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            });
            
            hideUserContextMenu();
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ–ãƒ­ãƒƒã‚¯
        function blockUser() {
            if (!contextMenuTargetUserId || !confirm(`${contextMenuTargetUsername}ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            
            fetch('/friends/block', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ targetUserId: contextMenuTargetUserId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`${contextMenuTargetUsername}ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸ`);
                } else {
                    alert(data.message || 'ãƒ–ãƒ­ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            })
            .catch(error => {
                console.error('ãƒ–ãƒ­ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            });
            
            hideUserContextMenu();
        }

        // é€šå ±ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function reportUser() {
            if (!contextMenuTargetUserId) return;
            
            document.getElementById('reportTargetUsername').textContent = contextMenuTargetUsername;
            const modal = new bootstrap.Modal(document.getElementById('reportModal'));
            modal.show();
            
            hideUserContextMenu();
        }

        // é€šå ±é€ä¿¡
        function submitReport() {
            const reason = document.getElementById('reportReason').value;
            const description = document.getElementById('reportDescription').value;
            
            if (!reason) {
                alert('é€šå ±ç†ç”±ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            fetch('/api/reports', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    reportedUserId: contextMenuTargetUserId,
                    reason: reason,
                    description: description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('é€šå ±ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
                    modal.hide();
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                    document.getElementById('reportReason').value = '';
                    document.getElementById('reportDescription').value = '';
                } else {
                    alert(data.message || 'é€šå ±ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            })
            .catch(error => {
                console.error('é€šå ±ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            });
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showUserSearchModal() {
            const modal = new bootstrap.Modal(document.getElementById('userSearchModal'));
            modal.show();
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢å®Ÿè¡Œ
        function searchUsers() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            fetch(`/api/users/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(users => {
                    displaySearchResults(users);
                })
                .catch(error => {
                    console.error('æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                    alert('æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                });
        }

        // æ¤œç´¢çµæœè¡¨ç¤º
        function displaySearchResults(users) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (users.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="text-center text-muted p-3">
                        <i class="fas fa-search fa-2x mb-2"></i>
                        <p>è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>
                    </div>
                `;
                return;
            }
            
            resultsContainer.innerHTML = users.map(user => `
                <div class="d-flex align-items-center p-3 border rounded mb-2" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                         style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;">
                        ${user.username.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold" style="color: #2d3748;">${escapeHtml(user.username)}</div>
                        <small class="text-muted d-block">
                            <i class="fas fa-hashtag me-1"></i>ID: ${user.id}
                        </small>
                        <small class="text-muted d-block">
                            <i class="fas fa-code me-1"></i>ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰: ${user.friendCode || 'ãªã—'}
                        </small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewUserProfileById(${user.id})" title="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º">
                            <i class="fas fa-user"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="sendFriendRequestById(${user.id}, '${escapeHtml(user.username)}')" title="ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹">
                            <i class="fas fa-user-plus"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // æ¤œç´¢çµæœã‹ã‚‰ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º
        function viewUserProfileById(userId) {
            window.open(`/profile/${userId}`, '_blank');
        }

        // æ¤œç´¢çµæœã‹ã‚‰ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹
        function sendFriendRequestById(userId, username) {
            fetch('/friends/request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ targetUserId: userId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`${username}ã«ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ã‚’é€ä¿¡ã—ã¾ã—ãŸ`);
                } else {
                    alert(data.message || 'ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            })
            .catch(error => {
                console.error('ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            });
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Enterã‚­ãƒ¼ã§ã®æ¤œç´¢
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchUsers();
                    }
                });
            }
            
            // ãƒ•ãƒ¬ãƒ³ãƒ‰é€šçŸ¥ã‚’å®šæœŸçš„ã«ãƒã‚§ãƒƒã‚¯
            checkFriendNotifications();
            setInterval(checkFriendNotifications, 30000); // 30ç§’ã”ã¨
            
            // ãƒãƒƒãƒãƒ³ã‚°çµ±è¨ˆã‚’èª­ã¿è¾¼ã¿
            loadMatchingStats();
        });

        // ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒƒãƒãƒ³ã‚°é–¢é€£ã®é–¢æ•°
        function showQuickMatchModal() {
            const modal = new bootstrap.Modal(document.getElementById('quickMatchModal'));
            modal.show();
            startQuickMatch();
        }

        function startQuickMatch() {
            // UI ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('quickMatchStatus').style.display = 'block';
            document.getElementById('quickMatchResult').style.display = 'none';
            document.getElementById('quickMatchNoResult').style.display = 'none';
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            const progressBar = document.getElementById('matchProgress');
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress > 90) progress = 90;
                progressBar.style.width = progress + '%';
            }, 200);

            // ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒƒãƒãƒ³ã‚° API å‘¼ã³å‡ºã—
            fetch('/api/random-matching/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                
                setTimeout(() => {
                    if (data.success && data.roomId) {
                        // ãƒãƒƒãƒæˆåŠŸ
                        currentMatchRoomId = data.roomId;
                        document.getElementById('compatibilityScore').textContent = data.compatibilityScore + '%';
                        document.getElementById('quickMatchStatus').style.display = 'none';
                        document.getElementById('quickMatchResult').style.display = 'block';
                    } else {
                        // ãƒãƒƒãƒå¤±æ•—
                        document.getElementById('quickMatchStatus').style.display = 'none';
                        document.getElementById('quickMatchNoResult').style.display = 'block';
                    }
                }, 500);
            })
            .catch(error => {
                clearInterval(progressInterval);
                console.error('Error:', error);
                document.getElementById('quickMatchStatus').style.display = 'none';
                document.getElementById('quickMatchNoResult').style.display = 'block';
            });
        }

        function startMatchedChat() {
            if (currentMatchRoomId) {
                bootstrap.Modal.getInstance(document.getElementById('quickMatchModal')).hide();
                switchRoom(currentMatchRoomId, 'ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒƒãƒãƒ³ã‚°');
            }
        }

        function findAnotherMatch() {
            startQuickMatch();
        }

        function loadMatchingStats() {
            fetch('/random-matching/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('todayMatches').textContent = data.todayMatches || 0;
                    document.getElementById('totalMatches').textContent = data.totalMatches || 0;
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                });
        }

        // CSS ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>

    <!-- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ç®¡ç†JavaScript -->
    <script>
        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ç®¡ç†ç”¨ã®å¤‰æ•°
        let heartbeatInterval = null;
        let onlineFriends = [];

        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ•ãƒ¬ãƒ³ãƒ‰ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        function loadOnlineFriends() {
            fetch('/api/online/friends')
                .then(response => response.json())
                .then(friends => {
                    onlineFriends = friends;
                    updateOnlineFriendsDisplay();
                })
                .catch(error => {
                    console.error('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ•ãƒ¬ãƒ³ãƒ‰å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                });
        }

        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ•ãƒ¬ãƒ³ãƒ‰è¡¨ç¤ºã‚’æ›´æ–°
        function updateOnlineFriendsDisplay() {
            const friendsList = document.getElementById('onlineFriendsList');
            const friendsCount = document.getElementById('onlineFriendsCount');
            const noOnlineFriends = document.getElementById('noOnlineFriends');

            friendsCount.textContent = onlineFriends.length;

            if (onlineFriends.length === 0) {
                friendsList.innerHTML = `
                    <div class="text-center py-3 text-muted" id="noOnlineFriends">
                        <i class="fas fa-user-slash mb-2"></i>
                        <div>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®ãƒ•ãƒ¬ãƒ³ãƒ‰ã¯ã„ã¾ã›ã‚“</div>
                    </div>
                `;
            } else {
                let friendsHtml = '';
                onlineFriends.forEach(friend => {
                    const statusIcon = getStatusIcon(friend.status);
                    const statusColor = getStatusColor(friend.status);
                    const statusText = getStatusText(friend.status);
                    
                    friendsHtml += `
                        <div class="list-group-item list-group-item-action d-flex align-items-center online-friend-item" 
                             data-user-id="${friend.userId}" 
                             style="cursor: pointer;"
                             onclick="openFriendChat('${friend.username}', '${friend.displayName}', ${friend.userId})">
                            <div class="me-3 position-relative">
                                <i class="fas fa-user-circle fa-2x text-secondary"></i>
                                <span class="position-absolute bottom-0 end-0 p-1 bg-white rounded-circle">
                                    <i class="fas ${statusIcon} fa-xs" style="color: ${statusColor};"></i>
                                </span>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-bold">${friend.displayName}</div>
                                <small class="text-muted">${statusText}</small>
                            </div>
                            <div class="text-muted">
                                <i class="fas fa-comment"></i>
                            </div>
                        </div>
                    `;
                });
                friendsList.innerHTML = friendsHtml;
            }
        }

        // ãƒ•ãƒ¬ãƒ³ãƒ‰ã®çŠ¶æ…‹æ›´æ–°ã‚’å‡¦ç†
        function handleFriendStatusUpdate(statusUpdate) {
            if (statusUpdate.type === 'friend_status_change') {
                console.log('ãƒ•ãƒ¬ãƒ³ãƒ‰çŠ¶æ…‹æ›´æ–°:', statusUpdate);
                
                // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ•ãƒ¬ãƒ³ãƒ‰ä¸€è¦§ã‚’æ›´æ–°
                if (statusUpdate.isOnline) {
                    // ãƒ•ãƒ¬ãƒ³ãƒ‰ãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ãªã£ãŸ
                    const existingFriend = onlineFriends.find(f => f.userId === statusUpdate.userId);
                    if (!existingFriend) {
                        onlineFriends.push({
                            userId: statusUpdate.userId,
                            username: statusUpdate.username,
                            displayName: statusUpdate.displayName,
                            status: statusUpdate.status || 'online'
                        });
                    } else {
                        // æ—¢å­˜ãƒ•ãƒ¬ãƒ³ãƒ‰ã®çŠ¶æ…‹ã‚’æ›´æ–°
                        existingFriend.status = statusUpdate.status || 'online';
                    }
                } else {
                    // ãƒ•ãƒ¬ãƒ³ãƒ‰ãŒã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã«ãªã£ãŸ
                    onlineFriends = onlineFriends.filter(f => f.userId !== statusUpdate.userId);
                }
                
                updateOnlineFriendsDisplay();
            }
        }

        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’æ›´æ–°
        function updateOnlineUserCount(countUpdate) {
            // ã“ã“ã§å…¨ä½“ã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°è¡¨ç¤ºã‚’æ›´æ–°ã§ãã¾ã™
            console.log('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°æ›´æ–°:', countUpdate);
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
        function getStatusIcon(status) {
            switch(status) {
                case 'online': return 'fa-circle';
                case 'away': return 'fa-clock';
                case 'busy': return 'fa-minus-circle';
                default: return 'fa-circle';
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸè‰²ã‚’å–å¾—
        function getStatusColor(status) {
            switch(status) {
                case 'online': return '#28a745';
                case 'away': return '#ffc107';
                case 'busy': return '#dc3545';
                default: return '#6c757d';
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
        function getStatusText(status) {
            switch(status) {
                case 'online': return 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³';
                case 'away': return 'é›¢å¸­ä¸­';
                case 'busy': return 'å–ã‚Šè¾¼ã¿ä¸­';
                default: return 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³';
            }
        }

        // ãƒ•ãƒ¬ãƒ³ãƒ‰ã¨ã®ãƒãƒ£ãƒƒãƒˆã‚’é–‹ã
        function openFriendChat(username, displayName, userId) {
            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤ºã¾ãŸã¯DMãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ä½œæˆã®å‡¦ç†
            window.open(`/profile/${userId}`, '_blank');
        }

        // ä¸€å›ã®ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã‚’é€ä¿¡
        function sendHeartbeat() {
            fetch('/api/online/heartbeat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆé€ä¿¡æˆåŠŸ - ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ç¢ºèª');
                } else {
                    console.warn('ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆå¤±æ•—:', data.message);
                }
            })
            .catch(error => {
                console.error('ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
            });
        }

        // ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã‚’é–‹å§‹
        function startHeartbeat() {
            // 30ç§’ã”ã¨ã«ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã‚’é€ä¿¡
            heartbeatInterval = setInterval(() => {
                fetch('/api/online/heartbeat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        console.warn('ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆå¤±æ•—:', data.message);
                    }
                })
                .catch(error => {
                    console.error('ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                });
            }, 30000);
        }

        // ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã‚’åœæ­¢
        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´
        function changeUserStatus(status) {
            fetch('/api/online/status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: status })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°æˆåŠŸ:', status);
                } else {
                    console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°å¤±æ•—:', data.message);
                }
            })
            .catch(error => {
                console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            });
        }

        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã‚’åœæ­¢
        window.addEventListener('beforeunload', function() {
            stopHeartbeat();
        });

        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹åˆ‡ã‚Šæ›¿ãˆï¼ˆæ—¢å­˜ã®toggleOnlineStatusé–¢æ•°ã‚’æ‹¡å¼µï¼‰
        function toggleOnlineStatus() {
            const options = [
                { value: 'online', text: 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³', icon: 'fa-circle', color: '#28a745' },
                { value: 'away', text: 'é›¢å¸­ä¸­', icon: 'fa-clock', color: '#ffc107' },
                { value: 'busy', text: 'å–ã‚Šè¾¼ã¿ä¸­', icon: 'fa-minus-circle', color: '#dc3545' }
            ];
            
            let optionsHtml = '';
            options.forEach(option => {
                optionsHtml += `
                    <button class="btn btn-outline-secondary w-100 mb-2 text-start" 
                            onclick="changeUserStatus('${option.value}')">
                        <i class="fas ${option.icon} me-2" style="color: ${option.color};"></i>
                        ${option.text}
                    </button>
                `;
            });
            
            const modalHtml = `
                <div class="modal fade" id="statusModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${optionsHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existingModal = document.getElementById('statusModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('statusModal'));
            modal.show();
        }

        // å®šæœŸçš„ã«ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ•ãƒ¬ãƒ³ãƒ‰ä¸€è¦§ã‚’æ›´æ–°
        setInterval(loadOnlineFriends, 60000); // 1åˆ†ã”ã¨

        // ãƒãƒ«ãƒã‚»ãƒƒã‚·ãƒ§ãƒ³æ©Ÿèƒ½
        function openMultiSessionTab() {
            // æ–°ã—ã„ã‚¿ãƒ–ã§ãƒãƒ«ãƒã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚’é–‹ã
            const newTabId = 'tab-' + Math.random().toString(36).substr(2, 8);
            const url = '/multi-session/login?tab=' + newTabId;
            window.open(url, '_blank');
        }
    </script>

    <!-- ã‚¯ã‚¤ãƒƒã‚¯ãƒãƒƒãƒãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="quickMatchModal" tabindex="-1" aria-labelledby="quickMatchModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header text-white" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
                    <h5 class="modal-title" id="quickMatchModalLabel">
                        <i class="fas fa-bolt me-2"></i>ã‚¯ã‚¤ãƒƒã‚¯ãƒãƒƒãƒ
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <div id="quickMatchStatus">
                            <i class="fas fa-dice fa-3x mb-3" style="color: #ff6b6b; animation: spin 2s linear infinite;"></i>
                            <h5>æœ€é©ãªãƒãƒƒãƒã‚’æ¤œç´¢ä¸­...</h5>
                            <p class="text-muted">ã‚ãªãŸã«æœ€é©ãªç›¸æ‰‹ã‚’æ¢ã—ã¦ã„ã¾ã™</p>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     style="width: 0%; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);"
                                     id="matchProgress"></div>
                            </div>
                        </div>
                        <div id="quickMatchResult" style="display: none;">
                            <i class="fas fa-heart fa-3x mb-3 text-success"></i>
                            <h5>ãƒãƒƒãƒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼</h5>
                            <p class="text-muted">ç›¸æ€§åº¦: <span id="compatibilityScore" class="text-primary fw-bold">0%</span></p>
                            <div class="d-grid gap-2 mt-4">
                                <button class="btn btn-success" onclick="startMatchedChat()">
                                    <i class="fas fa-comments me-2"></i>ãƒãƒ£ãƒƒãƒˆé–‹å§‹
                                </button>
                                <button class="btn btn-outline-secondary" onclick="findAnotherMatch()">
                                    <i class="fas fa-dice me-2"></i>ä»–ã®ç›¸æ‰‹ã‚’æ¢ã™
                                </button>
                            </div>
                        </div>
                        <div id="quickMatchNoResult" style="display: none;">
                            <i class="fas fa-search fa-3x mb-3 text-warning"></i>
                            <h5>ãƒãƒƒãƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</h5>
                            <p class="text-muted">ç¾åœ¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®é©åˆã™ã‚‹ç›¸æ‰‹ãŒã„ã¾ã›ã‚“</p>
                            <div class="d-grid gap-2 mt-4">
                                <button class="btn btn-primary" onclick="findAnotherMatch()">
                                    <i class="fas fa-redo me-2"></i>å†æ¤œç´¢
                                </button>
                                <a href="/random-matching" class="btn btn-outline-primary">
                                    <i class="fas fa-cog me-2"></i>è©³ç´°è¨­å®š
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kawaii Theme JavaScript -->
    <script src="/js/kawaii-theme.js"></script>
    <script>
        // ãƒãƒ£ãƒƒãƒˆå°‚ç”¨åˆæœŸåŒ–
        function initPageSpecific() {
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœã‚’è¿½åŠ 
            const messages = document.querySelectorAll('.message-bubble');
            messages.forEach((msg, index) => {
                msg.style.animationDelay = (index * 0.1) + 's';
            });
            
            // ãƒ«ãƒ¼ãƒ é …ç›®ã«ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœ
            document.querySelectorAll('.room-item').forEach(room => {
                KawaiiTheme.addSparkle(room);
            });
            
            // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã«ãƒãƒ¼ãƒˆåŠ¹æœ
            document.querySelectorAll('.user-card').forEach(user => {
                user.addEventListener('mouseenter', function() {
                    KawaiiTheme.addHeartBeat(this);
                });
            });
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–
        const originalSendMessage = sendMessage;
        sendMessage = function() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (message) {
                // ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœ
                const sparkle = document.createElement('div');
                sparkle.innerHTML = 'âœ¨ğŸ’«âœ¨';
                sparkle.style.position = 'absolute';
                sparkle.style.top = '50%';
                sparkle.style.left = '50%';
                sparkle.style.transform = 'translate(-50%, -50%)';
                sparkle.style.animation = 'sparkle 1s ease-out forwards';
                sparkle.style.pointerEvents = 'none';
                sparkle.style.zIndex = '1000';
                
                const sendButton = document.querySelector('button[onclick="sendMessage()"]');
                sendButton.style.position = 'relative';
                sendButton.appendChild(sparkle);
                
                setTimeout(() => sparkle.remove(), 1000);
            }
            
            originalSendMessage();
        };
    </script>
    
    <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨JavaScript -->
    <script>
        // ãƒ¢ãƒã‚¤ãƒ«ç”¨é€šçŸ¥ãƒãƒƒã‚¸åŒæœŸ
        function syncMobileNotifications() {
            const desktopBadge = document.getElementById('friendNotificationBadge');
            const mobileBadge = document.getElementById('mobileNotificationBadge');
            const desktopCount = document.getElementById('friendNotificationCount');
            
            if (desktopBadge && mobileBadge && desktopCount) {
                const count = desktopCount.textContent;
                if (desktopBadge.style.display !== 'none' && count > 0) {
                    mobileBadge.textContent = count;
                    mobileBadge.style.display = 'inline';
                } else {
                    mobileBadge.style.display = 'none';
                }
            }
        }
        
        // å®šæœŸçš„ã«é€šçŸ¥ãƒãƒƒã‚¸ã‚’åŒæœŸ
        setInterval(syncMobileNotifications, 1000);
        
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«åŒæœŸ
        document.addEventListener('DOMContentLoaded', syncMobileNotifications);
        
        // ç”»é¢ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã®å‡¦ç†
        window.addEventListener('resize', function() {
            // ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤ºã§ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã€é–‰ã˜ã‚‹
            if (window.innerWidth > 768) {
                const mobileDropdown = document.querySelector('.mobile-hamburger .dropdown-menu');
                if (mobileDropdown && mobileDropdown.classList.contains('show')) {
                    const dropdown = bootstrap.Dropdown.getInstance(document.querySelector('.mobile-hamburger .dropdown-toggle'));
                    if (dropdown) {
                        dropdown.hide();
                    }
                }
            }
        });
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›æ™‚ã®ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('messageInput');
            if (messageInput && window.innerWidth <= 768) {
                messageInput.addEventListener('focus', function() {
                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã‚’æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                    setTimeout(function() {
                        const messagesContainer = document.querySelector('.chat-messages');
                        if (messagesContainer) {
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }
                    }, 300);
                });
            }
        });
    </script>
    
    <!-- PWAæ©Ÿèƒ½ -->
    <script src="/js/pwa.js"></script>
</body>
</html>
