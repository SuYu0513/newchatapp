<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí¨ „ÉÅ„É£„ÉÉ„Éà - „ÉÅ„É£„ÉÉ„Éà„Ç¢„Éó„É™</title>
    
    <!-- PWAË®≠ÂÆö -->
    <link rel="manifest" href="/manifest.json?v=4">
    <meta name="theme-color" content="#f368e0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="üí´ChatApp">
    <link rel="apple-touch-icon" href="/images/app-icon-180.png?v=4">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/app-icon-180.png?v=4">
    <link rel="icon" type="image/png" href="/images/app-icon-180.png?v=4">
    <link rel="icon" type="image/svg+xml" href="/images/app-icon-180.svg?v=4">
    <link rel="shortcut icon" href="/images/app-icon-180.png?v=4">
    <link rel="mask-icon" href="/images/app-icon-180.svg?v=4" color="#f368e0">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/chat-style.css" rel="stylesheet">
    <link href="/css/kawaii-theme.css" rel="stylesheet">
    <link href="/css/mobile.css" rel="stylesheet">
    <link href="/css/pc.css" rel="stylesheet">
    <!-- „Åô„Åπ„Å¶„ÅÆ„ÉÅ„É£„ÉÉ„ÉàÂ∞ÇÁî®„Çπ„Çø„Ç§„É´„ÅØÂ§ñÈÉ®CSS„Éï„Ç°„Ç§„É´„Å´ÁßªÂãïÊ∏à„Åø -->
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top" 
         style="position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; z-index: 1030 !important; width: 100% !important;">
        <div class="container">
            <a class="navbar-brand" href="#" id="navbar-brand">
                <i class="fas fa-comments"></i>„ÉÅ„É£„ÉÉ„Éà„Ç¢„Éó„É™<span id="navbar-mark">‚ù§</span>
            </a>
            <div class="navbar-nav ms-auto">
                <!-- „É¢„Éê„Ç§„É´Â∞ÇÁî®„Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº -->
                <div class="nav-item dropdown mobile-hamburger d-md-none">
                    <button class="dropdown-toggle yokonarabi-auto" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-bars"></i>
                        „É°„Éã„É•„Éº
                    </button>
                    <ul class="dropdown-menu">
                        <!-- „Éó„É≠„Éï„Ç£„Éº„É´ -->
                        <li>
                            <a class="dropdown-item" href="/profile">
                                <i class="fas fa-user"></i>
                                „Éó„É≠„Éï„Ç£„Éº„É´
                            </a>
                        </li>
                        <!-- „Éï„É¨„É≥„Éâ -->
                        <li>
                            <a class="dropdown-item" href="/friends">
                                <i class="fas fa-user-friends"></i>
                                „Éï„É¨„É≥„Éâ
                                <span class="badge bg-danger ms-auto" id="mobileNotificationBadge" style="display: none;">0</span>
                            </a>
                        </li>
                        <!-- „É´„Éº„É†‰∏ÄË¶ß -->
                        <li>
                            <a class="dropdown-item" href="/rooms">
                                <i class="fas fa-list"></i>
                                „É´„Éº„É†‰∏ÄË¶ß
                            </a>
                        </li>
                        <!-- „É´„Éº„É†‰ΩúÊàê -->
                        <li>
                            <a class="dropdown-item" href="/rooms/create">
                                <i class="fas fa-plus"></i>
                                „É´„Éº„É†‰ΩúÊàê
                            </a>
                        </li>
                        <!-- „É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞ -->
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <a class="dropdown-item" href="/random-matching">
                                <i class="fas fa-dice"></i>
                                „É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞
                            </a>
                        </li>
                        <!-- „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÊôÇ„ÅÆ„ÅøË°®Á§∫ -->
                        <li th:if="${debugMode}">
                            <a class="dropdown-item" href="#" onclick="showUserSearchModal()">
                                <i class="fas fa-search"></i>
                                IDÊ§úÁ¥¢
                            </a>
                        </li>
                        <li th:if="${debugMode}">
                            <a class="dropdown-item" href="/login/offdbg">
                                <i class="fas fa-bug"></i>
                                „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâËß£Èô§
                            </a>
                        </li>
                        <!-- „É≠„Ç∞„Ç¢„Ç¶„Éà -->
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-danger" href="/logout" style="color: #dc3545 !important; font-weight: 600;">
                                <i class="fas fa-sign-out-alt"></i>
                                „É≠„Ç∞„Ç¢„Ç¶„Éà
                            </a>
                        </li>
                    </ul>
                </div>
                
                <!-- „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÁî®ÔºàÂæìÊù•ÈÄö„ÇäÔºâ -->
                <span class="navbar-text me-3 d-none d-md-inline" sec:authorize="isAuthenticated()">
                    <i class="fas fa-user me-1"></i>
                    „Çà„ÅÜ„Åì„Åù„ÄÅ<span sec:authentication="name"></span>„Åï„Çì
                </span>
                <!-- „Éï„É¨„É≥„ÉâÁÆ°ÁêÜ„Éú„Çø„É≥ -->
                <div class="nav-item position-relative me-3 d-none d-md-block">
                    <a class="nav-link d-flex align-items-center" href="/friends" id="friendsButton" style="padding: 8px 16px; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transition: all 0.3s ease;">
                        <i class="fas fa-user-friends me-2" style="font-size: 1.1rem;"></i>
                        <span style="font-weight: 500;">„Éï„É¨„É≥„Éâ</span>
                        <span class="position-absolute translate-middle badge rounded-pill" 
                              id="friendNotificationBadge" 
                              style="display: none; top: -5px; left: 100%; background: linear-gradient(135deg, #ff4757, #ff3838); color: white; font-size: 0.7rem; font-weight: bold; min-width: 20px; height: 20px; line-height: 20px; border: 2px solid white; box-shadow: 0 2px 8px rgba(255, 71, 87, 0.4);">
                            <span id="friendNotificationCount">0</span>
                        </span>
                    </a>
                </div>
                <!-- „É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Éú„Çø„É≥Ôºà„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÊôÇ„ÅÆ„ÅøÔºâ -->
                <div th:if="${debugMode}" class="nav-item me-3 d-none d-md-block">
                    <a class="nav-link d-flex align-items-center justify-content-center" href="/random-matching" style="padding: 12px 35px; border-radius: 8px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; transition: all 0.3s ease; min-width: 240px; text-decoration: none; white-space: nowrap;">
                        <i class="fas fa-dice me-2" style="font-size: 1.1rem;"></i>
                        <span style="font-weight: 500;">„É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞</span>
                    </a>
                </div>
                <!-- IDÊ§úÁ¥¢„Éú„Çø„É≥Ôºà„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÊôÇ„ÅÆ„ÅøÔºâ -->
                <div th:if="${debugMode}" class="nav-item me-3 d-none d-md-block">
                    <button class="nav-link btn btn-link" onclick="showUserSearchModal()" style="border: none; background: none;">
                        <i class="fas fa-search me-1"></i>IDÊ§úÁ¥¢
                    </button>
                </div>
                <a class="nav-link d-none d-md-block" th:href="@{/rooms}">
                    <i class="fas fa-list me-1"></i>„É´„Éº„É†‰∏ÄË¶ß
                </a>
                <!-- „Éó„É≠„Éï„Ç£„Éº„É´„É°„Éã„É•„Éº -->
                <div class="nav-item dropdown d-none d-md-block" style="z-index: 1040;">
                    <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-user-circle me-1"></i>„Éó„É≠„Éï„Ç£„Éº„É´
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" style="z-index: 1050;">
                        <li><a class="dropdown-item" th:href="@{/profile}">
                            <i class="fas fa-user me-2"></i>„Éû„Ç§„Éó„É≠„Éï„Ç£„Éº„É´
                        </a></li>
                        <li><a class="dropdown-item" th:href="@{/profile/edit}">
                            <i class="fas fa-edit me-2"></i>„Éó„É≠„Éï„Ç£„Éº„É´Á∑®ÈõÜ
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" th:href="@{/profile/search}">
                            <i class="fas fa-search me-2"></i>„É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢
                        </a></li>
                        <!-- „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÊôÇ„ÅÆ„ÅøË°®Á§∫ -->
                        <li th:if="${debugMode}"><a class="dropdown-item" th:href="@{/profile/online}">
                            <i class="fas fa-circle text-success me-2"></i>„Ç™„É≥„É©„Ç§„É≥„É¶„Éº„Ç∂„ÉºÊï∞
                        </a></li>
                        <!-- „É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞„ÅØ„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÊôÇ„ÅÆ„Åø -->
                        <li th:if="${debugMode}"><hr class="dropdown-divider"></li>
                        <li th:if="${debugMode}"><a class="dropdown-item" th:href="@{/random-matching}">
                            <i class="fas fa-dice me-2"></i>„É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞
                        </a></li>
                        <!-- „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÊôÇ„ÅÆ„ÅøË°®Á§∫ -->
                        <li th:if="${debugMode}"><hr class="dropdown-divider"></li>
                        <li th:if="${debugMode}"><a class="dropdown-item" href="#" onclick="toggleOnlineStatus()">
                            <i class="fas fa-power-off me-2"></i>„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥
                        </a></li>
                        <li th:if="${debugMode}"><a class="dropdown-item" href="/debug/session">
                            <i class="fas fa-bug me-2"></i>„Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±
                        </a></li>
                        <li th:if="${debugMode}"><a class="dropdown-item" href="#" onclick="openMultiSessionTab()">
                            <i class="fas fa-external-link-alt me-2"></i>Êñ∞„Åó„ÅÑ„Çø„Éñ„Åß„É≠„Ç∞„Ç§„É≥
                        </a></li>
                    </ul>
                </div>
                <a class="nav-link d-none d-md-block" th:href="@{/logout}">
                    <i class="fas fa-sign-out-alt me-1"></i>„É≠„Ç∞„Ç¢„Ç¶„Éà
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- „Çµ„Ç§„Éâ„Éê„ÉºÔºö„ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†‰∏ÄË¶ß -->
            <div class="col-md-3">
                <div class="card chat-sidebar" id="mobileSidebar">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-list me-1"></i>ÂèÇÂä†‰∏≠„ÅÆ„É´„Éº„É†
                        </h6>
                        <div>
                            <a href="/rooms/create" class="btn btn-sm btn-light">
                                <i class="fas fa-plus"></i>
                            </a>
                            <!-- „É¢„Éê„Ç§„É´Áî®Èñâ„Åò„Çã„Éú„Çø„É≥ -->
                            <button class="btn btn-sm btn-light d-md-none ms-1" onclick="toggleMobileSidebar()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div th:if="${userRooms != null and !userRooms.isEmpty()}">
                            <div th:each="room : ${userRooms}" 
                                 class="room-item list-group-item list-group-item-action d-flex justify-content-between align-items-center room-clickable"
                                 th:classappend="${room.id == currentRoom?.id} ? 'active' : ''"
                                 style="cursor: pointer;" 
                                 th:data-room-id="${room.id}"
                                 th:data-room-name="${room.name}">
                                <div>
                                    <div class="fw-bold" style="color: #333;" th:text="${room.name}">„É´„Éº„É†Âêç </div>
                                    <small class="text-muted">
                                        <i class="fas fa-users me-1"></i>
                                        <span th:text="${room.users.size()}">0</span> ‰∫∫
                                    </small>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-success me-2" th:if="${room.type.name() == 'GROUP'}">
                                        <i class="fas fa-users"></i>
                                    </span>
                                    <span class="badge bg-info me-2" th:if="${room.type.name() == 'PRIVATE'}">
                                        <i class="fas fa-lock"></i>
                                    </span>
                                    <!-- ÁèæÂú®„ÅÆ„É´„Éº„É†„Å´„ÅØÁâπÂà•„Å™„Ç¢„Ç§„Ç≥„É≥ -->
                                    <i class="fas fa-arrow-right text-primary" th:if="${room.id == currentRoom?.id}"></i>
                                </div>
                            </div>
                        </div>
                        <div th:if="${userRooms == null or userRooms.isEmpty()}" class="p-3 text-center text-muted">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p class="small mb-0">ÂèÇÂä†‰∏≠„ÅÆ„É´„Éº„É†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                            <a href="/rooms" class="btn btn-sm btn-outline-primary mt-2">
                                „É´„Éº„É†„ÇíÊé¢„Åô
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- „É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞ „ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Çª„Çπ -->
                <div class="card mt-3 d-none d-md-block">
                    <div class="card-header text-white d-flex justify-content-between align-items-center" 
                         style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
                        <h6 class="mb-0">
                            <i class="fas fa-dice me-1"></i>„É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞
                        </h6>
                        <i class="fas fa-heart text-white"></i>
                    </div>
                    <div class="card-body p-3">
                        <div class="text-center">
                            <div class="mb-3">
                                <i class="fas fa-dice fa-2x mb-2" style="color: #ff6b6b;"></i>
                                <p class="small text-muted mb-2">Êñ∞„Åó„ÅÑÂá∫‰ºö„ÅÑ„ÇíË¶ã„Å§„Åë„Çà„ÅÜ</p>
                            </div>
                            <div class="gap-2">
                                <a href="/random-matching" class="btn btn-primary d-flex align-items-center justify-content-center w-100 mb-2" 
                                   style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); border: none; border-radius: 8px; padding: 14px 20px; font-weight: 500; min-height: 50px; white-space: nowrap;">
                                    <i class="fas fa-dice me-2" style="font-size: 1.1rem;"></i>„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÈñãÂßã
                                </a>
                                <button class="btn btn-outline-secondary d-flex align-items-center justify-content-center w-100" onclick="showQuickMatchModal()"
                                        style="border-radius: 8px; padding: 12px 20px; font-weight: 500; min-height: 45px; white-space: nowrap;">
                                    <i class="fas fa-bolt me-2" style="font-size: 1rem;"></i>„ÇØ„Ç§„ÉÉ„ÇØ„Éû„ÉÉ„ÉÅ
                                </button>
                            </div>
                            <div class="mt-3 pt-2 border-top">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <small class="text-muted d-block">‰ªäÊó•„ÅÆ„Éû„ÉÉ„ÉÅ</small>
                                        <strong class="text-primary" id="todayMatches">0</strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">Á∑è„Éû„ÉÉ„ÉÅÊï∞</small>
                                        <strong class="text-success" id="totalMatches">0</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- „Ç™„É≥„É©„Ç§„É≥„Éï„É¨„É≥„Éâ -->
                <div class="card mt-3 d-none d-md-block ">
                    <div class="card-header text-white d-flex justify-content-between align-items-center" 
                         style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <h6 class="mb-0">
                            <i class="fas fa-circle text-success me-1"></i>„Ç™„É≥„É©„Ç§„É≥„Éï„É¨„É≥„Éâ
                        </h6>
                        <span class="badge bg-light text-dark" id="onlineFriendsCount">0</span>
                    </div>
                    <div class="card-body p-0">
                        <div id="onlineFriendsList" class="list-group list-group-flush">
                            <div class="text-center py-3 text-muted" id="noOnlineFriends">
                                <i class="fas fa-user-slash mb-2"></i>
                                <div>„Ç™„É≥„É©„Ç§„É≥„ÅÆ„Éï„É¨„É≥„Éâ„ÅØ„ÅÑ„Åæ„Åõ„Çì</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- „É°„Ç§„É≥„ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢ -->
            <div class="col-md-9">
                <!-- „É¢„Éê„Ç§„É´Áî®„Çµ„Ç§„Éâ„Éê„Éº„Éà„Ç∞„É´„Éú„Çø„É≥ -->
                <button class="mobile-sidebar-toggle d-md-none" onclick="toggleMobileSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="card chat-main">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0" th:text="${currentRoom?.name ?: '„ÉÅ„É£„ÉÉ„Éà'}">„ÉÅ„É£„ÉÉ„Éà</h5>
                            <small th:if="${currentRoom != null}">
                                <i class="fas fa-users me-1"></i>
                                <span th:text="${currentRoom?.users?.size() ?: 0}">0</span> ‰∫∫„ÅåÂèÇÂä†‰∏≠
                            </small>
                        </div>
                        <!-- „Ç™„É≥„É©„Ç§„É≥‰∫∫Êï∞Ë°®Á§∫ -->
                        <div class="text-center">
                            <div class="fw-bold" style="font-size: 0.9rem;">„Ç™„É≥„É©„Ç§„É≥</div>
                            <div class="badge bg-light text-primary px-3 py-1" style="font-size: 1.1rem; font-weight: 600;" id="onlineUserCount">1</div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±Ôºà„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÊôÇ„ÅÆ„ÅøÔºâ -->
                        <div th:if="${debugMode and debugEnabled}" class="alert alert-info" style="font-size: 12px;">
                            <strong>„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±:</strong><br>
                            chatHistory is null: <span th:text="${chatHistory == null}"></span><br>
                            chatHistory size: <span th:text="${chatHistory != null ? chatHistory.size() : 'N/A'}"></span><br>
                            chatRoomId: <span th:text="${chatRoomId}"></span>
                        </div>
                        
                        <div id="chat-container">
                            <!-- Êó¢Â≠ò„ÅÆ„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíË°®Á§∫ -->
                            <div th:if="${chatHistory != null and !chatHistory.isEmpty()}">
                                <div th:each="msg, iterStat : ${chatHistory}" class="message d-flex">
                                    <div class="message-bubble" 
                                         th:classappend="${msg.user.username == #authentication.name} ? 'own-message' : 'other-message'">
                                        <div class="message-header" th:if="${msg.user.username != #authentication.name}">
                                            <!-- „Ç¢„Éê„Çø„ÉºÁîªÂÉè„ÅØJavaScript„ÅßÂãïÁöÑ„Å´Êõ¥Êñ∞„Åï„Çå„Çã„Åü„ÇÅ„ÄÅ„Éá„Éï„Ç©„É´„Éà„ÅÆ„Ç¢„Ç§„Ç≥„É≥„ÇíË°®Á§∫ -->
                                            <i class="fas fa-user-circle me-1 user-avatar-clickable" 
                                               style="cursor: pointer; color: #007bff;" 
                                               th:data-user-id="${msg.user.id}"
                                               th:data-username="${msg.user.username}"
                                               onclick="showUserContextMenu(event, this)"
                                               title="„É¶„Éº„Ç∂„Éº„É°„Éã„É•„Éº„ÇíË°®Á§∫"></i>
                                            <span th:text="${msg.user.username}" 
                                                  class="username-clickable" 
                                                  style="cursor: pointer; color: #007bff;"
                                                  th:data-user-id="${msg.user.id}"
                                                  th:data-username="${msg.user.username}"
                                                  onclick="showUserContextMenu(event, this)"
                                                  title="„É¶„Éº„Ç∂„Éº„É°„Éã„É•„Éº„ÇíË°®Á§∫"></span>
                                        </div>
                                        <div class="message-content" th:text="${msg.content}"></div>
                                        <div class="message-time mt-1" style="font-size: 0.75rem; opacity: 0.7;">
                                            <i class="fas fa-clock me-1"></i>
                                            <span th:text="${#temporals.format(msg.sentAt, 'HH:mm')}"></span>
                                        </div>
                                        <!-- „Éá„Éê„ÉÉ„Ç∞Ôºö„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆË©≥Á¥∞ÔºàÈñãÁô∫ÊôÇ„ÅÆ„ÅøÔºâ -->
                                        <small th:if="${debugEnabled}" style="color: #666;">
                                            Debug: index=<span th:text="${iterStat.index}"></span>, 
                                            msgId=<span th:text="${msg.id}"></span>, 
                                            userId=<span th:text="${msg.user.id}"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div th:if="${chatHistory == null or chatHistory.isEmpty()}" class="text-center text-muted py-5">
                                <div class="mb-4">
                                    <i class="fas fa-comments fa-3x" style="opacity: 0.3;"></i>
                                </div>
                                <h5 class="mb-3">„Åæ„Å†„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</h5>
                                <p class="mb-0">ÊúÄÂàù„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºÅ</p>
                                <!-- „Éá„Éê„ÉÉ„Ç∞ÔºöÂÆüÈöõ„ÅÆÂÄ§„ÇíË°®Á§∫ÔºàÈñãÁô∫ÊôÇ„ÅÆ„ÅøÔºâ -->
                                <small th:if="${debugEnabled}">
                                    chatHistory: <span th:text="${chatHistory}"></span>
                                </small>
                            </div>
                        </div>
                        <div class="message-input-area nyuuryoku-eria">
                            <div class="input-group botan-guruupu">
                                <input type="text" id="messageInput" class="form-control nyuuryoku-fiirudo" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..." autocomplete="off">
                                <button class="btn btn-primary pulse soushin-btn" type="button" id="sendButton">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="/js/notifications.js"></script>
    <script>
        let stompClient = null;
        let currentUser = /*[[${username}]]*/ 'user';
        let currentRoomId = /*[[${currentRoom?.id ?: 1}]]*/ 1;
        let currentSubscription = null;
        let debugEnabled = true; // „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ„ÇíÊúâÂäπÂåñ
        let currentOnlineCount = 0; // ÁèæÂú®„ÅÆ„Ç™„É≥„É©„Ç§„É≥‰∫∫Êï∞ÔºàËá™ÂàÜ„ÇíÂê´„ÇÄÔºâ
        
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÇíË®≠ÂÆöÔºàÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†„Åß‰ΩøÁî®Ôºâ
        window.currentUser = currentUser;
        window.currentRoomId = currentRoomId;

        function switchRoomFromElement(element) {
            console.log('switchRoomFromElement called:', element);
            
            if (!element || !element.dataset) {
                console.error('Invalid element passed to switchRoomFromElement:', element);
                return;
            }
            
            const roomId = parseInt(element.dataset.roomId);
            const roomName = element.dataset.roomName;
            
            console.log('Room data:', { roomId, roomName, dataset: element.dataset });
            
            if (!roomId || isNaN(roomId)) {
                console.error('Invalid room ID:', element.dataset.roomId);
                return;
            }
            
            if (!roomName) {
                console.error('Missing room name:', element.dataset.roomName);
                return;
            }
            
            console.log('Attempting to switch room:', roomId, roomName);
            
            // „ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆË¶ñË¶öÁöÑ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
            element.style.transform = 'scale(0.95)';
            setTimeout(() => {
                element.style.transform = '';
            }, 150);
            
            // Âç≥Â∫ß„Å´UI„ÇíÊõ¥Êñ∞Ôºà„É¨„Çπ„Éù„É≥„Ç∑„ÉñÊÑü„ÇíÂêë‰∏äÔºâ
            updateActiveRoomInSidebar(roomId);
            
            switchRoomInternal(roomId, roomName);
        }

        function switchRoomInternal(roomId, roomName) {
            if (roomId == currentRoomId) {
                if (debugEnabled) {
                    console.log('Âêå„Åò„É´„Éº„É†„ÅÆ„Åü„ÇÅÂàá„ÇäÊõø„Åà„Çí„Çπ„Ç≠„ÉÉ„Éó:', roomId);
                }
                return; // Âêå„Åò„É´„Éº„É†„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            }
            
            if (debugEnabled) {
                console.log('„É´„Éº„É†Âàá„ÇäÊõø„ÅàÈñãÂßã:', currentRoomId, '->', roomId, '(' + roomName + ')');
            }
            
            // Âàá„ÇäÊõø„Åà‰∏≠„ÅÆUIË°®Á§∫
            showSwitchingState(true);
            
            // ÁèæÂú®„ÅÆË≥ºË™≠„ÇíËß£Èô§
            if (stompClient && stompClient.connected && currentSubscription) {
                currentSubscription.unsubscribe();
                if (debugEnabled) {
                    console.log('Ââç„ÅÆ„É´„Éº„É†„ÅÆË≥ºË™≠„ÇíËß£Èô§„Åó„Åæ„Åó„Åü:', currentRoomId);
                }
            }
            
            // Êñ∞„Åó„ÅÑ„É´„Éº„É†„Å´Âàá„ÇäÊõø„Åà
            const oldRoomId = currentRoomId;
            currentRoomId = roomId;
            
            // URL„ÇíÊõ¥Êñ∞Ôºà„Éñ„É©„Ç¶„Ç∂Â±•Ê≠¥„Å´ËøΩÂä†Ôºâ
            const newUrl = `/chat?room=${roomId}`;
            if (window.location.href !== window.location.origin + newUrl) {
                window.history.pushState({roomId: roomId, roomName: roomName}, '', newUrl);
            }
            
            // UI„ÇíÊõ¥Êñ∞
            updateCurrentRoomDisplay(roomName);
            updateActiveRoomInSidebar(roomId);
            clearChatArea();
            showLoadingInChat();
            
            // Êñ∞„Åó„ÅÑ„É´„Éº„É†„Å´Ë≥ºË™≠
            console.log('üîå WebSocketË≥ºË™≠Âá¶ÁêÜÈñãÂßã...');
            if (stompClient && stompClient.connected) {
                console.log('‚úÖ WebSocketÊé•Á∂öÊ∏à„Åø„ÄÅË≥ºË™≠‰∏≠...');
                try {
                    currentSubscription = stompClient.subscribe('/topic/chatroom/' + roomId, function(messageOutput) {
                        if (debugEnabled) {
                            console.log('Êñ∞„Åó„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏Âèó‰ø° (room ' + roomId + '):', messageOutput.body);
                        }
                        const messageData = JSON.parse(messageOutput.body);
                        showMessage(messageData);
                        
                        // ÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†„Å®Áµ±Âêà
                        if (window.notificationManager && messageData.type === 'CHAT') {
                            window.notificationManager.notifyNewMessage(messageData, roomName, roomId);
                        } else if (window.notificationManager && messageData.type === 'JOIN') {
                            window.notificationManager.notifyUserJoined(messageData.senderUsername, roomName, currentRoomId, roomId);
                        } else if (window.notificationManager && messageData.type === 'LEAVE') {
                            window.notificationManager.notifyUserLeft(messageData.senderUsername, roomName, currentRoomId, roomId);
                        }
                    });
                    
                    console.log('‚úÖ WebSocketË≥ºË™≠ÊàêÂäü:', roomId);
                    
                    if (debugEnabled) {
                        console.log('Êñ∞„Åó„ÅÑ„É´„Éº„É†„Å´Ë≥ºË™≠„Åó„Åæ„Åó„Åü:', roomId);
                    }
                    
                    // ÂèÇÂä†„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°
                    stompClient.send("/app/chat.addUser", {}, JSON.stringify({
                        senderUsername: currentUser,
                        chatRoomId: roomId,
                        type: 'JOIN'
                    }));
                    
                    console.log('‚úÖ ÂèÇÂä†„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°ÂÆå‰∫Ü');
                } catch (error) {
                    console.error('‚ùå WebSocketË≥ºË™≠„Ç®„É©„Éº:', error);
                }
            } else {
                console.warn('‚ö†Ô∏è  WebSocketÊú™Êé•Á∂ö„Åæ„Åü„ÅØstompClient„ÅåÁÑ°Âäπ');
            }
            
            // „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø
            console.log('üîÑ „É´„Éº„É†Âàá„ÇäÊõø„ÅàÂÆå‰∫Ü„ÄÅÂ±•Ê≠¥Ë™≠„ÅøËæº„ÅøÈñãÂßã:', roomId);
            console.log('üí° loadRoomHistoryÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó„Åæ„Åô...');
            loadRoomHistory(roomId);
            console.log('üí° loadRoomHistoryÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó„Åæ„Åó„Åü');
            
            // Êú™Ë™≠Êï∞„Çí„ÇØ„É™„Ç¢
            if (window.notificationManager) {
                window.notificationManager.clearUnreadCount(roomId);
            }
            
            // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÇíÊõ¥Êñ∞
            window.currentRoomId = roomId;
            
            // „Ç™„É≥„É©„Ç§„É≥‰∫∫Êï∞„ÇíÂÜçÂàùÊúüÂåñÔºà„É´„Éº„É†Âàá„ÇäÊõø„ÅàÊôÇÔºâ
            setTimeout(() => {
                currentOnlineCount = 1; // Ëá™ÂàÜ„Åå„Ç™„É≥„É©„Ç§„É≥„Å®„Åó„Å¶„É™„Çª„ÉÉ„Éà
                const onlineCountElement = document.getElementById('onlineUserCount');
                if (onlineCountElement) {
                    onlineCountElement.textContent = currentOnlineCount;
                    console.log('„É´„Éº„É†Âàá„ÇäÊõø„Åà - „Ç™„É≥„É©„Ç§„É≥‰∫∫Êï∞„É™„Çª„ÉÉ„Éà:', currentOnlineCount);
                }
            }, 500);
            
            console.log('‚úÖ switchRoomInternalÂÆå‰∫Ü:', roomId, roomName);
        }

        function showSwitchingState(switching) {
            const chatContainer = document.getElementById('chat-container');
            if (switching) {
                chatContainer.classList.add('switching');
            } else {
                chatContainer.classList.remove('switching');
            }
        }

        function showLoadingInChat() {
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = `
                <div class="text-center p-4">
                    <div class="loading"></div>
                    <p class="mt-2">„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
                </div>
            `;
        }

        function updateCurrentRoomDisplay(roomName) {
            const currentRoomElement = document.querySelector('h5.mb-0');
            if (currentRoomElement) {
                currentRoomElement.textContent = roomName;
            }
        }

        function updateActiveRoomInSidebar(roomId) {
            console.log('„É´„Éº„É†„Çµ„Ç§„Éâ„Éê„ÉºÊõ¥Êñ∞:', roomId);
            
            // „Åô„Åπ„Å¶„ÅÆ„É´„Éº„É†„Ç¢„Ç§„ÉÜ„É†„Åã„Çâactive„ÇØ„É©„Çπ„ÇíÂâäÈô§
            document.querySelectorAll('.room-item').forEach(item => {
                item.classList.remove('active');
                // Áü¢Âç∞„Ç¢„Ç§„Ç≥„É≥„ÇÇÂâäÈô§
                const arrow = item.querySelector('.fas.fa-arrow-right');
                if (arrow) {
                    arrow.remove();
                }
                // ÂÖÉ„ÅÆËâ≤„Å´Êàª„Åô
                item.style.removeProperty('background');
                item.style.removeProperty('color');
                item.style.removeProperty('transform');
                item.style.removeProperty('box-shadow');
                
                // Â≠êË¶ÅÁ¥†„ÅÆËâ≤„ÇÇ„É™„Çª„ÉÉ„Éà
                const childElements = item.querySelectorAll('*');
                childElements.forEach(el => {
                    el.style.removeProperty('color');
                });
            });
            
            // Êñ∞„Åó„ÅÑ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É´„Éº„É†„Çí data-room-id „ÅßÊ§úÁ¥¢
            const activeRoomElement = document.querySelector(`[data-room-id="${roomId}"]`);
            console.log('„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É´„Éº„É†Ë¶ÅÁ¥†:', activeRoomElement);
            
            if (activeRoomElement) {
                // active„ÇØ„É©„Çπ„ÇíËøΩÂä†
                activeRoomElement.classList.add('active');
                
                // ÊòéÁ¢∫„Å™Ëâ≤Â§âÊõ¥„ÇíÈÅ©Áî®
                activeRoomElement.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                activeRoomElement.style.color = 'white';
                activeRoomElement.style.transform = 'scale(1.02)';
                activeRoomElement.style.boxShadow = '0 8px 16px rgba(102, 126, 234, 0.3)';
                
                // Áü¢Âç∞„Ç¢„Ç§„Ç≥„É≥„ÇíËøΩÂä†
                const badgeContainer = activeRoomElement.querySelector('.d-flex.align-items-center');
                if (badgeContainer && !badgeContainer.querySelector('.fa-arrow-right')) {
                    const arrow = document.createElement('i');
                    arrow.className = 'fas fa-arrow-right text-white ms-2';
                    arrow.style.animation = 'pulse 2s infinite';
                    badgeContainer.appendChild(arrow);
                }
                
                // ÂÜÖÈÉ®„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàËâ≤„ÇíÈÅ©Âàá„Å´Ë®≠ÂÆö
                const textElements = activeRoomElement.querySelectorAll('*');
                textElements.forEach(el => {
                    if (el.classList.contains('text-muted')) {
                        el.style.color = 'rgba(255, 255, 255, 0.8)';
                    } else if (el.classList.contains('fw-bold')) {
                        // „É´„Éº„É†ÂêçÔºàÂ§™Â≠óÔºâ„ÅØÁôΩËâ≤„Å´„Åô„Çã
                        el.style.color = 'white';
                    } else if (!el.classList.contains('badge') && !el.style.color) {
                        // „Ç§„É≥„É©„Ç§„É≥„Çπ„Çø„Ç§„É´„ÅßËâ≤„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑË¶ÅÁ¥†„ÅÆ„ÅøÁôΩ„Å´Â§âÊõ¥
                        el.style.color = 'white';
                    }
                });
                
                console.log('„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É´„Éº„É†Ë®≠ÂÆöÂÆå‰∫Ü:', roomId);
            } else {
                console.warn('„É´„Éº„É†Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', roomId);
            }
        }

        function clearChatArea() {
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer) {
                chatContainer.innerHTML = '';
            }
        }

        // „É´„Éº„É†Âàá„ÇäÊõø„ÅàÊôÇ„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢Ê©üËÉΩ
        async function clearRoomCache(roomId) {
            console.log('üßπ „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢ÈñãÂßã: „É´„Éº„É†ID', roomId);
            
            try {
                // Service Worker „Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    const apiCachePattern = `/api/messages/${roomId}`;
                    
                    for (const cacheName of cacheNames) {
                        const cache = await caches.open(cacheName);
                        const keys = await cache.keys();
                        
                        for (const request of keys) {
                            if (request.url.includes(apiCachePattern)) {
                                await cache.delete(request);
                                console.log('üóëÔ∏è „Ç≠„É£„ÉÉ„Ç∑„É•ÂâäÈô§:', request.url);
                            }
                        }
                    }
                }
                
                // „Éñ„É©„Ç¶„Ç∂„Ç≠„É£„ÉÉ„Ç∑„É•„ÅÆ„Éê„Çπ„ÉàÁî®„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÇíÁîüÊàê
                window.roomCacheBuster = Date.now();
                console.log('‚úÖ „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢ÂÆå‰∫Ü');
                
            } catch (error) {
                console.warn('‚ö†Ô∏è „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢„Ç®„É©„ÉºÔºàÁ∂ôÁ∂öÔºâ:', error);
            }
        }

        async function loadRoomHistory(roomId) {
            console.log('üöÄüöÄüöÄ Â±•Ê≠¥Ë™≠„ÅøËæº„ÅøÈñ¢Êï∞„ÅåÂëº„Å≥Âá∫„Åï„Çå„Åæ„Åó„ÅüÔºÅ „É´„Éº„É†ID:', roomId);
            console.log('=== Â±•Ê≠¥Ë™≠„ÅøËæº„ÅøÈñãÂßã ===');
            console.log('„É´„Éº„É†ID:', roomId);
            
            // 1. „Åæ„Åö„Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢
            await clearRoomCache(roomId);
            
            // 2. „Ç≠„É£„ÉÉ„Ç∑„É•„Éê„Çπ„Çø„Éº„ÇíËøΩÂä†„Åó„ÅüAPI URL„ÇíÁîüÊàê
            const cacheBuster = window.roomCacheBuster || Date.now();
            const apiUrl = `/api/messages/${roomId}?_t=${cacheBuster}`;
            console.log('API URL:', apiUrl);
            
            // Âº∑Âäõ„Å™„Ç≠„É£„ÉÉ„Ç∑„É•ÁÑ°ÂäπÂåñ„Ç™„Éó„Ç∑„Éß„É≥
            const fetchOptions = {
                method: 'GET',
                cache: 'no-store',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate, max-age=0',
                    'Pragma': 'no-cache',
                    'Expires': '0',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            };
            
            fetch(apiUrl, fetchOptions)
                .then(response => {
                    console.log('APIÂøúÁ≠î„Çπ„ÉÜ„Éº„Çø„Çπ:', response.status);
                    console.log('APIÂøúÁ≠î„Éò„ÉÉ„ÉÄ„Éº:', response.headers);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    // „É¨„Çπ„Éù„É≥„Çπ„ÉÜ„Ç≠„Çπ„Éà„ÇíÁõ¥Êé•Á¢∫Ë™ç
                    return response.text().then(text => {
                        console.log('üîç RAW „É¨„Çπ„Éù„É≥„Çπ„ÉÜ„Ç≠„Çπ„Éà:', text);
                        try {
                            const parsed = JSON.parse(text);
                            console.log('üîç JSONËß£ÊûêÊàêÂäü:', parsed);
                            return parsed;
                        } catch (e) {
                            console.error('üö® JSONËß£Êûê„Ç®„É©„Éº:', e);
                            throw e;
                        }
                    });
                })
                .then(messages => {
                    console.log('=== APIÂøúÁ≠îÂèó‰ø° ===');
                    console.log('Âèó‰ø°„Åó„Åü„É°„ÉÉ„Çª„Éº„Ç∏:', messages);
                    console.log('„É°„ÉÉ„Çª„Éº„Ç∏Êï∞:', messages.length);
                    console.log('„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆË©≥Á¥∞:');
                    messages.forEach((msg, index) => {
                        console.log(`  [${index}] ${msg.senderUsername}: ${msg.content} (${msg.timestamp})`);
                    });
                    
                    const messageArea = document.getElementById('chat-container');
                    if (!messageArea) {
                        console.error('„ÉÅ„É£„ÉÉ„Éà„Ç≥„É≥„ÉÜ„Éä„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì!');
                        return;
                    }
                    
                    console.log('„ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢„Çí„ÇØ„É™„Ç¢‰∏≠...');
                    messageArea.innerHTML = '';
                    
                    if (messages.length === 0) {
                        console.log('„É°„ÉÉ„Çª„Éº„Ç∏„ÅåÁ©∫„ÅÆ„Åü„ÇÅ„ÄÅÁ©∫Áä∂ÊÖãË°®Á§∫');
                        messageArea.innerHTML = `
                            <div class="text-center p-4 text-muted">
                                <i class="fas fa-comment fa-3x mb-3"></i>
                                <p>„Åæ„Å†„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                                <p class="small">ÊúÄÂàù„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºÅ</p>
                            </div>
                        `;
                    } else {
                        console.log('„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ÈñãÂßã...');
                        messages.forEach((message, index) => {
                            console.log(`„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ [${index}]:`, message);
                            try {
                                showMessage(message);
                                console.log(`„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ÊàêÂäü [${index}]`);
                            } catch (error) {
                                console.error(`„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫„Ç®„É©„Éº [${index}]:`, error);
                            }
                        });
                        console.log('ÂÖ®„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ÂÆå‰∫Ü');
                    }
                    
                    // Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                    showSwitchingState(false);
                    
                    console.log('=== Â±•Ê≠¥Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü ===');
                    console.log('ÁèæÂú®„ÅÆ„ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢ÂÜÖÂÆπ:', messageArea.innerHTML);
                })
                .catch(error => {
                    console.error('=== Â±•Ê≠¥Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº ===');
                    console.error('„Ç®„É©„ÉºË©≥Á¥∞:', error);
                    console.error('„Ç®„É©„Éº„Çπ„Çø„ÉÉ„ÇØ:', error.stack);
                    
                    const messageArea = document.getElementById('chat-container');
                    if (messageArea) {
                        messageArea.innerHTML = `
                            <div class="text-center p-4 text-danger">
                                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                <p>Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>
                                <p class="small">„Ç®„É©„Éº: ${error.message}</p>
                                <button class="btn btn-sm btn-outline-primary" onclick="loadRoomHistory(${roomId})">
                                    ÂÜçË™≠„ÅøËæº„Åø
                                </button>
                            </div>
                        `;
                    }
                    showSwitchingState(false);
                });
        }

        function leaveRoom(roomId) {
            if (confirm('„Åì„ÅÆ„ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†„Åã„ÇâÈÄÄÂá∫„Åó„Åæ„Åô„ÅãÔºü')) {
                fetch(`/rooms/${roomId}/leave`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('ÈÄÄÂá∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                });
            }
        }

        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                
                // WebSocketÊé•Á∂öÂÆå‰∫ÜÊôÇ„Å´„Éè„Éº„Éà„Éì„Éº„Éà„ÇíÈÄÅ‰ø°„Åó„Å¶„Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖã„ÇíÁ¢∫ÂÆü„Å´„Åô„Çã
                setTimeout(() => {
                    sendHeartbeat();
                }, 1000);
                
                // ÁèæÂú®„ÅÆ„ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†„Å´ÂèÇÂä†
                currentSubscription = stompClient.subscribe(`/topic/chatroom/${currentRoomId}`, function (message) {
                    if (debugEnabled) {
                        console.log('„É°„ÉÉ„Çª„Éº„Ç∏Âèó‰ø° (room ' + currentRoomId + '):', message.body);
                    }
                    const messageData = JSON.parse(message.body);
                    showMessage(messageData);
                    
                    // ÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†„Å®Áµ±Âêà
                    if (window.notificationManager && messageData.type === 'CHAT') {
                        const roomName = getCurrentRoomName();
                        window.notificationManager.notifyNewMessage(messageData, roomName, currentRoomId);
                    }
                });
                
                // „Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖã„ÅÆË≥ºË™≠
                stompClient.subscribe('/user/queue/status-updates', function (message) {
                    const statusUpdate = JSON.parse(message.body);
                    handleFriendStatusUpdate(statusUpdate);
                });
                
                // „Ç™„É≥„É©„Ç§„É≥„É¶„Éº„Ç∂„ÉºÊï∞„ÅÆË≥ºË™≠
                stompClient.subscribe('/topic/online-count', function (message) {
                    const countUpdate = JSON.parse(message.body);
                    updateOnlineUserCount(countUpdate);
                });
                
                if (debugEnabled) {
                    console.log('ÂàùÊúü„É´„Éº„É†„Å´Ë≥ºË™≠„Åó„Åæ„Åó„Åü:', currentRoomId);
                }
                
                // „É¶„Éº„Ç∂„ÉºÂèÇÂä†ÈÄöÁü•
                stompClient.send("/app/chat.addUser", {}, JSON.stringify({
                    senderUsername: currentUser,
                    chatRoomId: currentRoomId,
                    type: 'JOIN'
                }));
                
                // „Ç™„É≥„É©„Ç§„É≥„Éï„É¨„É≥„Éâ‰∏ÄË¶ß„ÇíÂàùÊúüË™≠„ÅøËæº„Åø
                loadOnlineFriends();
                
                // Âç≥Â∫ß„Å´„Éè„Éº„Éà„Éì„Éº„Éà„ÇíÈÄÅ‰ø°„Åó„Å¶„Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖã„ÇíÁ¢∫ÂÆü„Å´„Åô„Çã
                sendHeartbeat();
                
                // „Éè„Éº„Éà„Éì„Éº„Éà„Çø„Ç§„Éû„Éº„ÇíÈñãÂßã
                startHeartbeat();
                
                // URLÊåáÂÆö„É´„Éº„É†„Åå„ÅÇ„Çå„Å∞Âàá„ÇäÊõø„Åà
                initializeRoomFromUrl();
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
            console.log("Disconnected");
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const messageContent = messageInput.value.trim();
            
            if (messageContent && stompClient) {
                // ÈÄÅ‰ø°„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ„Åó„Å¶„É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„Å´„Åô„Çã
                sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                sendButton.disabled = true;
                
                const message = {
                    content: messageContent,
                    chatRoomId: currentRoomId,
                    senderUsername: currentUser,
                    timestamp: new Date().toISOString(),
                    type: 'CHAT'
                };
                
                if (debugEnabled) {
                    console.log('„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°:', message);
                }
                
                stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(message));
                messageInput.value = '';
                
                // 1ÁßíÂæå„Å´ÈÄÅ‰ø°„Éú„Çø„É≥„ÇíÂÖÉ„Å´Êàª„Åô
                setTimeout(() => {
                    sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    sendButton.disabled = false;
                    sendButton.classList.add('pulse'); // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú„ÇíÂÜçÈñã
                }, 1000);
            }
        }

        function showMessage(message) {
            console.log('üéØ showMessageÂëº„Å≥Âá∫„Åó:', message);
            const chatContainer = document.getElementById('chat-container');
            const messageElement = document.createElement('div');
            
            // JOIN/LEAVE„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂá¶ÁêÜ
            if (message.type === 'JOIN' || message.type === 'LEAVE') {
                console.log('üì¢ „Ç∑„Çπ„ÉÜ„É†„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫:', message.type);
                messageElement.innerHTML = `
                    <div class="alert alert-info small text-center mb-2" style="border: none; background: linear-gradient(135deg, #17a2b8, #138496); color: white;">
                        <i class="fas fa-info-circle me-1"></i>
                        ${message.content}
                    </div>
                `;
                
                // „É™„Ç¢„É´„Çø„Ç§„É†„Åß„Ç™„É≥„É©„Ç§„É≥‰∫∫Êï∞„ÇíÊõ¥Êñ∞
                updateOnlineCountRealtime(message.type);
            } else {
                // ÈÄöÂ∏∏„ÅÆ„ÉÅ„É£„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂá¶ÁêÜÔºàtype„Åånull„Åæ„Åü„ÅØCHAT„ÅÆÂ†¥ÂêàÔºâ
                console.log('üí¨ „ÉÅ„É£„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫:', message.senderUsername, '-', message.content);
                const isCurrentUser = message.senderUsername === currentUser;
                const time = new Date(message.timestamp).toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                const username = message.senderUsername || message.sender;
                const userId = message.userId || message.senderId;
                
                messageElement.className = `message d-flex ${isCurrentUser ? 'justify-content-end' : 'justify-content-start'}`;
                
                messageElement.innerHTML = `
                    <div class="message-bubble ${isCurrentUser ? 'own-message' : 'other-message'}">
                        ${!isCurrentUser ? `
                            <div class="message-header">
                                ${message.senderAvatarUrl ? `
                                    <img src="${message.senderAvatarUrl}" 
                                         class="rounded-circle me-2 user-avatar-clickable" 
                                         width="24" 
                                         height="24" 
                                         style="cursor: pointer; object-fit: cover;" 
                                         data-user-id="${userId}"
                                         data-username="${username}"
                                         onclick="showUserContextMenu(event, this)"
                                         title="„É¶„Éº„Ç∂„Éº„É°„Éã„É•„Éº„ÇíË°®Á§∫"
                                         alt="„Ç¢„Éê„Çø„Éº">
                                ` : `
                                    <i class="fas fa-user-circle me-1 user-avatar-clickable" 
                                       style="cursor: pointer; color: #007bff;" 
                                       data-user-id="${userId}"
                                       data-username="${username}"
                                       onclick="showUserContextMenu(event, this)"
                                       title="„É¶„Éº„Ç∂„Éº„É°„Éã„É•„Éº„ÇíË°®Á§∫"></i>
                                `}
                                <span class="username-clickable" 
                                      style="cursor: pointer; color: #007bff;"
                                      data-user-id="${userId}"
                                      data-username="${username}"
                                      onclick="showUserContextMenu(event, this)"
                                      title="„É¶„Éº„Ç∂„Éº„É°„Éã„É•„Éº„ÇíË°®Á§∫">${message.senderDisplayName || username}</span>
                            </div>
                        ` : ''}
                        <div class="message-content">
                            ${message.content}
                        </div>
                        <div class="message-time mt-1" style="font-size: 0.75rem; opacity: 0.7;">
                            <i class="fas fa-clock me-1"></i>
                            <span>${time}</span>
                        </div>
                    </div>
                `;
            }
            
            console.log('‚úÖ „É°„ÉÉ„Çª„Éº„Ç∏Ë¶ÅÁ¥†‰ΩúÊàêÂÆå‰∫Ü„ÄÅDOM„Å´ËøΩÂä†‰∏≠...');
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            console.log('‚úÖ „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ÂÆå‰∫Ü');
        }

        // „Éò„É´„Éë„ÉºÈñ¢Êï∞
        function getCurrentRoomName() {
            const activeRoomElement = document.querySelector('.room-item.active .fw-bold');
            return activeRoomElement ? activeRoomElement.textContent.trim() : '„ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†';
        }
        
        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶Ë®≠ÂÆöÔºàÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†„Åß‰ΩøÁî®Ôºâ
        window.switchRoom = function(roomId, roomName) {
            switchRoomInternal(roomId, roomName);
        };

        // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„Å´„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅÆ‰∏ÄÁï™‰∏ã„Åæ„Åß„Çπ„ÇØ„É≠„Éº„É´
        window.addEventListener('load', function () {
            const chatContainer = document.getElementById('chat-container');
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éê„Éº„ÅÆ„Éû„Éº„ÇØ„Çí„É©„É≥„ÉÄ„É†„Å´Â§âÊõ¥
            const cardMarks = ['‚ù§', '‚òÖ', '‚ô¶', '‚ô†', '‚ô£'];
            const navbarMark = document.getElementById('navbar-mark');
            if (navbarMark) {
                const randomMark = cardMarks[Math.floor(Math.random() * cardMarks.length)];
                navbarMark.textContent = randomMark;
            }
            
            // ÁèæÂú®„ÅÆ„É´„Éº„É†„Çí„Éè„Ç§„É©„Ç§„Éà
            console.log('„Éö„Éº„Ç∏„É≠„Éº„ÉâÂÆå‰∫Ü - ÁèæÂú®„ÅÆ„É´„Éº„É†ID:', currentRoomId);
            updateActiveRoomInSidebar(currentRoomId);
            
            // „É´„Éº„É†„Ç¢„Ç§„ÉÜ„É†„Å´„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÇíËøΩÂä†Ôºà„Çà„ÇäÁ¢∫ÂÆü„Å™ÊñπÊ≥ïÔºâ
            addRoomClickListeners();
            
            // „Ç™„É≥„É©„Ç§„É≥‰∫∫Êï∞„ÅÆÂàùÊúüÂåñÔºàËá™ÂàÜ„Åå„Ç™„É≥„É©„Ç§„É≥Ôºâ
            currentOnlineCount = 1;
            const onlineCountElement = document.getElementById('onlineUserCount');
            if (onlineCountElement) {
                onlineCountElement.textContent = currentOnlineCount;
                console.log('„Éö„Éº„Ç∏„É≠„Éº„Éâ - „Ç™„É≥„É©„Ç§„É≥‰∫∫Êï∞ÂàùÊúüÂåñ:', currentOnlineCount);
            }
            
            connect();
            loadRoomHistory(currentRoomId);
        });
        
        // „É´„Éº„É†„ÇØ„É™„ÉÉ„ÇØ„É™„Çπ„Éä„Éº„ÇíËøΩÂä†„Åô„ÇãÈñ¢Êï∞
        function addRoomClickListeners() {
            console.log('Adding room click listeners...');
            const roomElements = document.querySelectorAll('.room-clickable');
            console.log('Found room elements:', roomElements.length);
            
            roomElements.forEach((roomElement, index) => {
                console.log(`Setting up listener for room ${index}:`, roomElement.dataset);
                
                // Êó¢Â≠ò„ÅÆ„É™„Çπ„Éä„Éº„ÇíÂâäÈô§ÔºàÈáçË§á„ÇíÈò≤„ÅêÔºâ
                roomElement.removeEventListener('click', handleRoomClick);
                
                // Êñ∞„Åó„ÅÑ„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
                roomElement.addEventListener('click', handleRoomClick);
            });
        }
        
        // „É´„Éº„É†„ÇØ„É™„ÉÉ„ÇØ„Éè„É≥„Éâ„É©„Éº
        function handleRoomClick(event) {
            console.log('üî• Room clicked via handler:', this);
            console.log('üî• Event details:', event);
            switchRoomFromElement(this);
        }
        
        // DOM„ÅåË™≠„ÅøËæº„Åæ„Çå„ÅüÊôÇÁÇπ„Åß„ÇÇ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            setTimeout(addRoomClickListeners, 100); // Â∞ë„ÅóÈÅÖÂª∂„ÇíÂÖ•„Çå„Çã
            
            // „Ç§„Éô„É≥„ÉàÂßîË≠≤„Åß„É´„Éº„É†„ÇØ„É™„ÉÉ„ÇØ„ÇíÂá¶ÁêÜÔºà„Çà„ÇäÁ¢∫ÂÆüÔºâ
            document.addEventListener('click', function(event) {
                const roomElement = event.target.closest('.room-clickable');
                if (roomElement) {
                    console.log('üî• Room clicked via delegation:', roomElement);
                    console.log('üî• Room data:', roomElement.dataset);
                    event.preventDefault();
                    event.stopPropagation();
                    switchRoomFromElement(roomElement);
                }
            });
        });

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // „Éö„Éº„Ç∏„Ç¢„É≥„É≠„Éº„ÉâÊôÇ„Å´ÂàáÊñ≠
        window.addEventListener('beforeunload', function () {
            disconnect();
        });

        // „Éñ„É©„Ç¶„Ç∂„ÅÆÊàª„Çã/ÈÄ≤„ÇÄ„Éú„Çø„É≥ÂØæÂøú
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.roomId) {
                console.log('Handling popstate:', event.state);
                // URL„Åã„Çâ„É´„Éº„É†ÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶„É´„Éº„É†Âàá„ÇäÊõø„Åà
                const roomId = event.state.roomId;
                const roomName = event.state.roomName || '„É´„Éº„É† ' + roomId;
                switchRoomInternal(roomId, roomName);
            } else {
                // URL„Éë„É©„É°„Éº„Çø„Åã„Çâ„É´„Éº„É†ÊÉÖÂ†±„ÇíÂèñÂæó
                const urlParams = new URLSearchParams(window.location.search);
                const roomParam = urlParams.get('room');
                if (roomParam) {
                    const roomId = parseInt(roomParam);
                    if (!isNaN(roomId) && roomId !== currentRoomId) {
                        // „É´„Éº„É†Ë¶ÅÁ¥†„ÇíÊé¢„Åó„Å¶Âàá„ÇäÊõø„Åà
                        const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
                        if (roomElement) {
                            switchRoomFromElement(roomElement);
                        }
                    }
                }
            }
        });

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆ„É´„Éº„É†ÈÅ∏ÊäûÂá¶ÁêÜ
        function initializeRoomFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            
            if (roomParam) {
                const roomId = parseInt(roomParam);
                if (!isNaN(roomId)) {
                    console.log('URLÊåáÂÆö„É´„Éº„É†:', roomId);
                    // Â∞ë„ÅóÈÅÖÂª∂„Åó„Å¶„É´„Éº„É†Ë¶ÅÁ¥†„ÅåÊèèÁîª„Åï„Çå„Å¶„Åã„ÇâÂÆüË°å
                    setTimeout(() => {
                        const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
                        if (roomElement) {
                            console.log('URLÊåáÂÆö„É´„Éº„É†„Å´Âàá„ÇäÊõø„Åà:', roomElement);
                            switchRoomFromElement(roomElement);
                        } else {
                            console.warn('ÊåáÂÆö„Åï„Çå„Åü„É´„Éº„É†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', roomId);
                        }
                    }, 500);
                }
            }
        }
        
        // „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥Ê©üËÉΩ
        function toggleOnlineStatus() {
            const statuses = [
                { value: 'ONLINE', label: '„Ç™„É≥„É©„Ç§„É≥', icon: 'fas fa-circle text-success' },
                { value: 'AWAY', label: 'Èõ¢Â∏≠‰∏≠', icon: 'fas fa-circle text-warning' },
                { value: 'BUSY', label: 'Âèñ„ÇäËæº„Åø‰∏≠', icon: 'fas fa-circle text-danger' },
                { value: 'OFFLINE', label: '„Ç™„Éï„É©„Ç§„É≥', icon: 'fas fa-circle text-secondary' }
            ];
            
            // „É¢„Éº„ÉÄ„É´HTML‰ΩúÊàê
            const modalHtml = `
                <div class="modal fade" id="statusModal" tabindex="-1">
                    <div class="modal-dialog modal-sm">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h6 class="modal-title">
                                    <i class="fas fa-power-off me-2"></i>„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥
                                </h6>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="list-group">
                                    ${statuses.map(status => `
                                        <button type="button" class="list-group-item list-group-item-action" 
                                                onclick="changeStatus('${status.value}')">
                                            <i class="${status.icon} me-2"></i>
                                            ${status.label}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Êó¢Â≠ò„ÅÆ„É¢„Éº„ÉÄ„É´„ÇíÂâäÈô§
            const existingModal = document.getElementById('statusModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Êñ∞„Åó„ÅÑ„É¢„Éº„ÉÄ„É´„ÇíËøΩÂä†
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            const modal = new bootstrap.Modal(document.getElementById('statusModal'));
            modal.show();
        }
        
        function changeStatus(status) {
            fetch('/profile/status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: status })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                    const modal = bootstrap.Modal.getInstance(document.getElementById('statusModal'));
                    modal.hide();
                    
                    // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫Ôºà‰ªªÊÑèÔºâ
                    console.log('„Çπ„ÉÜ„Éº„Çø„Çπ„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü:', status);
                } else {
                    alert('„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            });
        }
    </script>

    <!-- „É¶„Éº„Ç∂„Éº„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº -->
    <div class="dropdown-menu" id="userContextMenu" style="display: none; position: absolute; z-index: 1050;">
        <a class="dropdown-item" href="#" onclick="viewUserProfile()">
            <i class="fas fa-user me-2"></i>„Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫
        </a>
        <a class="dropdown-item" href="#" onclick="sendFriendRequest()">
            <i class="fas fa-user-plus me-2"></i>„Éï„É¨„É≥„ÉâÁî≥Ë´ã
        </a>
        <div class="dropdown-divider"></div>
        <a class="dropdown-item text-warning" href="#" onclick="blockUser()">
            <i class="fas fa-ban me-2"></i>„Éñ„É≠„ÉÉ„ÇØ
        </a>
        <a class="dropdown-item text-danger" href="#" onclick="reportUser()">
            <i class="fas fa-exclamation-triangle me-2"></i>ÈÄöÂ†±
        </a>
    </div>

    <!-- IDÊ§úÁ¥¢„É¢„Éº„ÉÄ„É´ -->
    <div class="modal fade" id="userSearchModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-search me-2"></i>„É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="searchInput" class="form-label">„É¶„Éº„Ç∂„ÉºÂêç„Éª„Éï„É¨„É≥„Éâ„Ç≥„Éº„Éâ„ÉªID„ÅßÊ§úÁ¥¢</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchInput" placeholder="„É¶„Éº„Ç∂„ÉºÂêç„ÄÅ8Ê°Å„ÅÆ„Éï„É¨„É≥„Éâ„Ç≥„Éº„Éâ„ÄÅ„Åæ„Åü„ÅØID„ÇíÂÖ•Âäõ...">
                            <button class="btn btn-primary" onclick="searchUsers()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            „Éï„É¨„É≥„Éâ„Ç≥„Éº„Éâ„ÅØ8Ê°Å„ÅÆËã±Êï∞Â≠ó„Åß„ÅôÔºà‰æãÔºöAB12CD34Ôºâ
                        </div>
                    </div>
                    <div id="searchResults"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÈÄöÂ†±„É¢„Éº„ÉÄ„É´ -->
    <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>„É¶„Éº„Ç∂„ÉºÈÄöÂ†±
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>„É¶„Éº„Ç∂„Éº„Äå<span id="reportTargetUsername"></span>„Äç„ÇíÈÄöÂ†±„Åó„Åæ„Åô„ÄÇ</p>
                    <div class="mb-3">
                        <label for="reportReason" class="form-label">ÈÄöÂ†±ÁêÜÁî±</label>
                        <select class="form-select" id="reportReason" required>
                            <option value="">ÁêÜÁî±„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="SPAM">„Çπ„Éë„É†„ÉªËø∑ÊÉëË°åÁÇ∫</option>
                            <option value="HARASSMENT">„Éè„É©„Çπ„É°„É≥„Éà„ÉªÂ´å„Åå„Çâ„Åõ</option>
                            <option value="INAPPROPRIATE_CONTENT">‰∏çÈÅ©Âàá„Å™„Ç≥„É≥„ÉÜ„É≥„ÉÑ</option>
                            <option value="HATE_SPEECH">„Éò„Ç§„Éà„Çπ„Éî„Éº„ÉÅ</option>
                            <option value="IMPERSONATION">„Å™„Çä„Åô„Åæ„Åó</option>
                            <option value="VIOLENCE_THREAT">Êö¥ÂäõÁöÑ„Å™ËÑÖËø´</option>
                            <option value="PRIVACY_VIOLATION">„Éó„É©„Ç§„Éê„Ç∑„Éº‰æµÂÆ≥</option>
                            <option value="FRAUD">Ë©êÊ¨∫„Éª‰∏çÊ≠£Ë°åÁÇ∫</option>
                            <option value="OTHER">„Åù„ÅÆ‰ªñ</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="reportDescription" class="form-label">Ë©≥Á¥∞Ë™¨ÊòéÔºà‰ªªÊÑèÔºâ</label>
                        <textarea class="form-control" id="reportDescription" rows="3" placeholder="Ë©≥Á¥∞„Å™Ë™¨Êòé„Åå„ÅÇ„Çå„Å∞ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="button" class="btn btn-danger" onclick="submitReport()">ÈÄöÂ†±„Åô„Çã</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // „É¶„Éº„Ç∂„Éº„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„ÉºÈñ¢ÈÄ£„ÅÆÂ§âÊï∞
        let contextMenuTargetUserId = null;
        let contextMenuTargetUsername = null;

        // „Éï„É¨„É≥„ÉâÁî≥Ë´ãÈÄöÁü•„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkFriendNotifications() {
            fetch('/friends/api/notification-count')
                .then(response => response.json())
                .then(data => {
                    const badge = document.getElementById('friendNotificationBadge');
                    const count = document.getElementById('friendNotificationCount');
                    
                    if (data.count > 0) {
                        badge.style.display = 'block';
                        count.textContent = data.count;
                    } else {
                        badge.style.display = 'none';
                    }
                })
                .catch(error => console.error('ÈÄöÁü•„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº:', error));
        }

        // „É¶„Éº„Ç∂„Éº„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº„ÅÆË°®Á§∫
        function showUserContextMenu(event, element) {
            event.preventDefault();
            event.stopPropagation();
            
            contextMenuTargetUserId = element.dataset.userId;
            contextMenuTargetUsername = element.dataset.username;
            
            const menu = document.getElementById('userContextMenu');
            const rect = element.getBoundingClientRect();
            
            menu.style.display = 'block';
            menu.style.left = (rect.left + window.scrollX) + 'px';
            menu.style.top = (rect.bottom + window.scrollY + 5) + 'px';
            
            // „ÇØ„É™„ÉÉ„ÇØÂ§ñ„Åó„ÅßÈñâ„Åò„Çã
            document.addEventListener('click', hideUserContextMenu, { once: true });
        }

        function hideUserContextMenu() {
            document.getElementById('userContextMenu').style.display = 'none';
        }

        // „Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫
        function viewUserProfile() {
            if (contextMenuTargetUserId) {
                window.open(`/profile/${contextMenuTargetUserId}`, '_blank');
            }
            hideUserContextMenu();
        }

        // „Éï„É¨„É≥„ÉâÁî≥Ë´ãÈÄÅ‰ø°
        function sendFriendRequest() {
            if (!contextMenuTargetUserId) return;
            
            fetch('/friends/request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ targetUserId: contextMenuTargetUserId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`${contextMenuTargetUsername}„Å´„Éï„É¨„É≥„ÉâÁî≥Ë´ã„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü`);
                } else {
                    alert(data.message || '„Éï„É¨„É≥„ÉâÁî≥Ë´ã„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            })
            .catch(error => {
                console.error('„Éï„É¨„É≥„ÉâÁî≥Ë´ã„Ç®„É©„Éº:', error);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            });
            
            hideUserContextMenu();
        }

        // „É¶„Éº„Ç∂„Éº„Éñ„É≠„ÉÉ„ÇØ
        function blockUser() {
            if (!contextMenuTargetUserId || !confirm(`${contextMenuTargetUsername}„Çí„Éñ„É≠„ÉÉ„ÇØ„Åó„Åæ„Åô„ÅãÔºü`)) return;
            
            fetch('/friends/block', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ targetUserId: contextMenuTargetUserId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`${contextMenuTargetUsername}„Çí„Éñ„É≠„ÉÉ„ÇØ„Åó„Åæ„Åó„Åü`);
                } else {
                    alert(data.message || '„Éñ„É≠„ÉÉ„ÇØ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            })
            .catch(error => {
                console.error('„Éñ„É≠„ÉÉ„ÇØ„Ç®„É©„Éº:', error);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            });
            
            hideUserContextMenu();
        }

        // ÈÄöÂ†±„É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function reportUser() {
            if (!contextMenuTargetUserId) return;
            
            document.getElementById('reportTargetUsername').textContent = contextMenuTargetUsername;
            const modal = new bootstrap.Modal(document.getElementById('reportModal'));
            modal.show();
            
            hideUserContextMenu();
        }

        // ÈÄöÂ†±ÈÄÅ‰ø°
        function submitReport() {
            const reason = document.getElementById('reportReason').value;
            const description = document.getElementById('reportDescription').value;
            
            if (!reason) {
                alert('ÈÄöÂ†±ÁêÜÁî±„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            fetch('/api/reports', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    reportedUserId: contextMenuTargetUserId,
                    reason: reason,
                    description: description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ÈÄöÂ†±„ÇíÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ„ÅîÂçîÂäõ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
                    modal.hide();
                    
                    // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
                    document.getElementById('reportReason').value = '';
                    document.getElementById('reportDescription').value = '';
                } else {
                    alert(data.message || 'ÈÄöÂ†±„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            })
            .catch(error => {
                console.error('ÈÄöÂ†±„Ç®„É©„Éº:', error);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            });
        }

        // „É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢„É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showUserSearchModal() {
            const modal = new bootstrap.Modal(document.getElementById('userSearchModal'));
            modal.show();
        }

        // „É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢ÂÆüË°å
        function searchUsers() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            fetch(`/api/users/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(users => {
                    displaySearchResults(users);
                })
                .catch(error => {
                    console.error('Ê§úÁ¥¢„Ç®„É©„Éº:', error);
                    alert('Ê§úÁ¥¢‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                });
        }

        // Ê§úÁ¥¢ÁµêÊûúË°®Á§∫
        function displaySearchResults(users) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (users.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="text-center text-muted p-3">
                        <i class="fas fa-search fa-2x mb-2"></i>
                        <p>Ë©≤ÂΩì„Åô„Çã„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</p>
                    </div>
                `;
                return;
            }
            
            resultsContainer.innerHTML = users.map(user => `
                <div class="d-flex align-items-center p-3 border rounded mb-2" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                         style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;">
                        ${user.username.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold" style="color: #2d3748;">${escapeHtml(user.username)}</div>
                        <small class="text-muted d-block">
                            <i class="fas fa-hashtag me-1"></i>ID: ${user.id}
                        </small>
                        <small class="text-muted d-block">
                            <i class="fas fa-code me-1"></i>„Éï„É¨„É≥„Éâ„Ç≥„Éº„Éâ: ${user.friendCode || '„Å™„Åó'}
                        </small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewUserProfileById(${user.id})" title="„Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫">
                            <i class="fas fa-user"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="sendFriendRequestById(${user.id}, '${escapeHtml(user.username)}')" title="„Éï„É¨„É≥„ÉâÁî≥Ë´ã">
                            <i class="fas fa-user-plus"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Ê§úÁ¥¢ÁµêÊûú„Åã„Çâ„Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫
        function viewUserProfileById(userId) {
            window.open(`/profile/${userId}`, '_blank');
        }

        // Ê§úÁ¥¢ÁµêÊûú„Åã„Çâ„Éï„É¨„É≥„ÉâÁî≥Ë´ã
        function sendFriendRequestById(userId, username) {
            fetch('/friends/request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ targetUserId: userId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`${username}„Å´„Éï„É¨„É≥„ÉâÁî≥Ë´ã„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü`);
                } else {
                    alert(data.message || '„Éï„É¨„É≥„ÉâÁî≥Ë´ã„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            })
            .catch(error => {
                console.error('„Éï„É¨„É≥„ÉâÁî≥Ë´ã„Ç®„É©„Éº:', error);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            });
        }

        // HTML„Ç®„Çπ„Ç±„Éº„Éó
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Enter„Ç≠„Éº„Åß„ÅÆÊ§úÁ¥¢
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchUsers();
                    }
                });
            }
            
            // „Éï„É¨„É≥„ÉâÈÄöÁü•„ÇíÂÆöÊúüÁöÑ„Å´„ÉÅ„Çß„ÉÉ„ÇØ
            checkFriendNotifications();
            setInterval(checkFriendNotifications, 30000); // 30Áßí„Åî„Å®
            
            // „Éû„ÉÉ„ÉÅ„É≥„Ç∞Áµ±Ë®à„ÇíË™≠„ÅøËæº„Åø
            loadMatchingStats();
        });

        // „É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞Èñ¢ÈÄ£„ÅÆÈñ¢Êï∞
        function showQuickMatchModal() {
            const modal = new bootstrap.Modal(document.getElementById('quickMatchModal'));
            modal.show();
            startQuickMatch();
            
            // ÊòüÁ©∫ËÉåÊôØ„ÅÆÂàùÊúüÂåñ
            initStarryBackground();
        }
        
        // ÊòüÁ©∫ËÉåÊôØ„ÅÆÂàùÊúüÂåñ
        function initStarryBackground() {
            const shootingStarsContainer = document.querySelector('#quickMatchModal .shooting-stars');
            if (!shootingStarsContainer) {
                console.log('ÊµÅ„ÇåÊòü„Ç≥„É≥„ÉÜ„Éä„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            console.log('ÊòüÁ©∫ËÉåÊôØ„ÇíÂàùÊúüÂåñ‰∏≠...');
            
            // Êó¢Â≠ò„ÅÆÊµÅ„ÇåÊòü„Çí„ÇØ„É™„Ç¢
            shootingStarsContainer.innerHTML = '';
            
            // ÊµÅ„ÇåÊòü„ÇíÂÆöÊúüÁöÑ„Å´ÁîüÊàê
            function createShootingStar() {
                const star = document.createElement('div');
                star.className = 'shooting-star';
                
                // „É©„É≥„ÉÄ„É†„Å™ÈñãÂßã‰ΩçÁΩÆÔºà„É¢„Éº„ÉÄ„É´„ÅÆÁØÑÂõ≤ÂÜÖÔºâ
                const startX = Math.random() * 100; // 0-100px
                const startY = Math.random() * 100; // 0-100px
                star.style.left = startX + 'px';
                star.style.top = startY + 'px';
                
                // „É©„É≥„ÉÄ„É†„Å™ÈÅÖÂª∂„Å®„Çµ„Ç§„Ç∫
                star.style.animationDelay = Math.random() * 2 + 's';
                star.style.animationDuration = (Math.random() * 2 + 3) + 's'; // 3-5Áßí
                
                shootingStarsContainer.appendChild(star);
                console.log('ÊµÅ„ÇåÊòü„Çí‰ΩúÊàê:', star);
                
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆå‰∫ÜÂæå„Å´ÂâäÈô§
                setTimeout(() => {
                    if (star.parentNode) {
                        star.remove();
                    }
                }, 8000);
            }
            
            // ÊúÄÂàù„ÅÆÊµÅ„ÇåÊòü„ÇíË§áÊï∞‰ΩúÊàê
            for(let i = 0; i < 3; i++) {
                setTimeout(() => createShootingStar(), i * 1000);
            }
            
            // „Åù„ÅÆÂæåÂÆöÊúüÁöÑ„Å´‰ΩúÊàê
            const shootingStarInterval = setInterval(() => {
                const modal = document.getElementById('quickMatchModal');
                if (modal && modal.classList.contains('show')) {
                    createShootingStar();
                } else {
                    clearInterval(shootingStarInterval);
                    console.log('ÊòüÁ©∫„Ç®„Éï„Çß„ÇØ„Éà„ÇíÂÅúÊ≠¢');
                }
            }, 1500); // 1.5Áßí„Åî„Å®
            
            // „Éá„Éê„ÉÉ„Ç∞Áî®ÔºöÊòü„ÅÆË¶ÅÁ¥†„ÇíÁ¢∫Ë™ç
            setTimeout(() => {
                const starsElement = document.querySelector('#quickMatchModal .stars');
                console.log('Êòü„ÅÆË¶ÅÁ¥†:', starsElement);
                if (starsElement) {
                    console.log('Êòü„ÅÆË¶ÅÁ¥†„ÅÆ„Çπ„Çø„Ç§„É´:', window.getComputedStyle(starsElement));
                }
            }, 1000);
        }

        function startQuickMatch() {
            // UI „Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('quickMatchStatus').style.display = 'block';
            document.getElementById('quickMatchResult').style.display = 'none';
            document.getElementById('quickMatchNoResult').style.display = 'none';
            
            // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            const progressBar = document.getElementById('matchProgress');
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress > 90) progress = 90;
                progressBar.style.width = progress + '%';
            }, 200);

            // „É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞ API Âëº„Å≥Âá∫„Åó
            fetch('/api/random-matching/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                
                setTimeout(() => {
                    if (data.success && data.roomId) {
                        // „Éû„ÉÉ„ÉÅÊàêÂäü
                        currentMatchRoomId = data.roomId;
                        document.getElementById('compatibilityScore').textContent = data.compatibilityScore + '%';
                        document.getElementById('quickMatchStatus').style.display = 'none';
                        document.getElementById('quickMatchResult').style.display = 'block';
                    } else {
                        // „Éû„ÉÉ„ÉÅÂ§±Êïó - „Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                        const noMatchMessage = document.getElementById('noMatchMessage');
                        if (data.message) {
                            noMatchMessage.textContent = data.message;
                        } else {
                            noMatchMessage.textContent = 'ÁèæÂú®„Ç™„É≥„É©„Ç§„É≥„ÅÆÈÅ©Âêà„Åô„ÇãÁõ∏Êâã„Åå„ÅÑ„Åæ„Åõ„Çì';
                        }
                        document.getElementById('quickMatchStatus').style.display = 'none';
                        document.getElementById('quickMatchNoResult').style.display = 'block';
                    }
                }, 500);
            })
            .catch(error => {
                clearInterval(progressInterval);
                console.error('Error:', error);
                
                // „Ç®„É©„ÉºÊôÇ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË®≠ÂÆö
                const noMatchMessage = document.getElementById('noMatchMessage');
                noMatchMessage.textContent = '„Éû„ÉÉ„ÉÅ„É≥„Ç∞‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
                
                document.getElementById('quickMatchStatus').style.display = 'none';
                document.getElementById('quickMatchNoResult').style.display = 'block';
            });
        }

        function startMatchedChat() {
            if (currentMatchRoomId) {
                bootstrap.Modal.getInstance(document.getElementById('quickMatchModal')).hide();
                switchRoom(currentMatchRoomId, '„É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞');
            }
        }

        function findAnotherMatch() {
            startQuickMatch();
        }

        function loadMatchingStats() {
            fetch('/random-matching/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('todayMatches').textContent = data.todayMatches || 0;
                    document.getElementById('totalMatches').textContent = data.totalMatches || 0;
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                });
        }

        // CSS „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
            
            /* ÊòüÁ©∫ËÉåÊôØ„ÅÆ„Çπ„Çø„Ç§„É´ - „Çà„ÇäË¶ã„ÇÑ„Åô„Åè */
            #quickMatchModal .stars::before {
                content: '';
                position: absolute;
                width: 3px;
                height: 3px;
                background: #ffffff;
                border-radius: 50%;
                box-shadow: 
                    20px 20px 0 0 #ffffff,
                    40px 10px 0 0 #ffccaa,
                    60px 40px 0 0 #ffffff,
                    80px 20px 0 0 #aaccff,
                    100px 60px 0 0 #ffffff,
                    120px 30px 0 0 #ffccaa,
                    140px 50px 0 0 #ffffff,
                    160px 15px 0 0 #aaccff,
                    180px 70px 0 0 #ffffff,
                    200px 35px 0 0 #ffccaa,
                    220px 55px 0 0 #ffffff,
                    240px 25px 0 0 #aaccff,
                    260px 45px 0 0 #ffffff,
                    280px 65px 0 0 #ffccaa,
                    300px 15px 0 0 #ffffff,
                    320px 35px 0 0 #aaccff,
                    340px 75px 0 0 #ffffff,
                    360px 25px 0 0 #ffccaa,
                    50px 80px 0 0 #ffffff,
                    90px 90px 0 0 #aaccff,
                    130px 85px 0 0 #ffffff,
                    170px 95px 0 0 #ffccaa,
                    210px 75px 0 0 #ffffff,
                    250px 85px 0 0 #aaccff,
                    290px 95px 0 0 #ffffff,
                    330px 85px 0 0 #ffccaa;
                animation: twinkle 2s infinite alternate;
            }
            
            #quickMatchModal .stars::after {
                content: '';
                position: absolute;
                width: 2px;
                height: 2px;
                background: #ffffff;
                border-radius: 50%;
                box-shadow: 
                    30px 15px 0 0 #ffffff,
                    70px 35px 0 0 #ffccaa,
                    110px 25px 0 0 #ffffff,
                    150px 45px 0 0 #aaccff,
                    190px 15px 0 0 #ffffff,
                    230px 55px 0 0 #ffccaa,
                    270px 35px 0 0 #ffffff,
                    310px 65px 0 0 #aaccff,
                    350px 45px 0 0 #ffffff,
                    15px 85px 0 0 #ffccaa,
                    75px 75px 0 0 #ffffff,
                    115px 95px 0 0 #aaccff,
                    155px 85px 0 0 #ffffff,
                    195px 95px 0 0 #ffccaa,
                    235px 75px 0 0 #ffffff,
                    275px 85px 0 0 #aaccff,
                    315px 95px 0 0 #ffffff,
                    355px 75px 0 0 #ffccaa;
                animation: twinkle 3s infinite alternate;
                animation-delay: 1s;
            }
            
            @keyframes twinkle {
                0% { 
                    opacity: 0.3; 
                    transform: scale(0.8);
                }
                50% { 
                    opacity: 1; 
                    transform: scale(1.2);
                }
                100% { 
                    opacity: 0.5; 
                    transform: scale(1);
                }
            }
            
            /* ÊµÅ„ÇåÊòü„ÅÆ„Çπ„Çø„Ç§„É´ */
            .shooting-star {
                position: absolute;
                width: 3px;
                height: 3px;
                background: linear-gradient(45deg, #ffffff, #ffcc00);
                border-radius: 50%;
                box-shadow: 0 0 6px #ffffff;
                animation: shooting 4s linear infinite;
            }
            
            .shooting-star::after {
                content: '';
                position: absolute;
                width: 30px;
                height: 2px;
                background: linear-gradient(90deg, rgba(255,255,255,0.8), transparent);
                transform: rotate(45deg);
                transform-origin: 0 0;
                top: 1px;
                left: 1px;
            }
            
            @keyframes shooting {
                0% {
                    transform: translateX(-50px) translateY(-50px);
                    opacity: 0;
                }
                10% {
                    opacity: 1;
                }
                80% {
                    opacity: 1;
                }
                100% {
                    transform: translateX(400px) translateY(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>

    <!-- „Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖãÁÆ°ÁêÜJavaScript -->
    <script>
        // „Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖãÁÆ°ÁêÜÁî®„ÅÆÂ§âÊï∞
        let heartbeatInterval = null;
        let onlineFriends = [];

        // „Ç™„É≥„É©„Ç§„É≥„Éï„É¨„É≥„Éâ‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„Åø
        function loadOnlineFriends() {
            fetch('/api/online/friends')
                .then(response => response.json())
                .then(friends => {
                    onlineFriends = friends;
                    updateOnlineFriendsDisplay();
                })
                .catch(error => {
                    console.error('„Ç™„É≥„É©„Ç§„É≥„Éï„É¨„É≥„ÉâÂèñÂæó„Ç®„É©„Éº:', error);
                });
        }

        // „Ç™„É≥„É©„Ç§„É≥„Éï„É¨„É≥„ÉâË°®Á§∫„ÇíÊõ¥Êñ∞
        function updateOnlineFriendsDisplay() {
            const friendsList = document.getElementById('onlineFriendsList');
            const friendsCount = document.getElementById('onlineFriendsCount');
            const noOnlineFriends = document.getElementById('noOnlineFriends');

            friendsCount.textContent = onlineFriends.length;

            if (onlineFriends.length === 0) {
                friendsList.innerHTML = `
                    <div class="text-center py-3 text-muted" id="noOnlineFriends">
                        <i class="fas fa-user-slash mb-2"></i>
                        <div>„Ç™„É≥„É©„Ç§„É≥„ÅÆ„Éï„É¨„É≥„Éâ„ÅØ„ÅÑ„Åæ„Åõ„Çì</div>
                    </div>
                `;
            } else {
                let friendsHtml = '';
                onlineFriends.forEach(friend => {
                    const statusIcon = getStatusIcon(friend.status);
                    const statusColor = getStatusColor(friend.status);
                    const statusText = getStatusText(friend.status);
                    
                    friendsHtml += `
                        <div class="list-group-item list-group-item-action d-flex align-items-center online-friend-item" 
                             data-user-id="${friend.userId}" 
                             style="cursor: pointer;"
                             onclick="openFriendChat('${friend.username}', '${friend.displayName}', ${friend.userId})">
                            <div class="me-3 position-relative">
                                <i class="fas fa-user-circle fa-2x text-secondary"></i>
                                <span class="position-absolute bottom-0 end-0 p-1 bg-white rounded-circle">
                                    <i class="fas ${statusIcon} fa-xs" style="color: ${statusColor};"></i>
                                </span>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-bold">${friend.displayName}</div>
                                <small class="text-muted">${statusText}</small>
                            </div>
                            <div class="text-muted">
                                <i class="fas fa-comment"></i>
                            </div>
                        </div>
                    `;
                });
                friendsList.innerHTML = friendsHtml;
            }
        }

        // „Éï„É¨„É≥„Éâ„ÅÆÁä∂ÊÖãÊõ¥Êñ∞„ÇíÂá¶ÁêÜ
        function handleFriendStatusUpdate(statusUpdate) {
            if (statusUpdate.type === 'friend_status_change') {
                console.log('„Éï„É¨„É≥„ÉâÁä∂ÊÖãÊõ¥Êñ∞:', statusUpdate);
                
                // „Ç™„É≥„É©„Ç§„É≥„Éï„É¨„É≥„Éâ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
                if (statusUpdate.isOnline) {
                    // „Éï„É¨„É≥„Éâ„Åå„Ç™„É≥„É©„Ç§„É≥„Å´„Å™„Å£„Åü
                    const existingFriend = onlineFriends.find(f => f.userId === statusUpdate.userId);
                    if (!existingFriend) {
                        onlineFriends.push({
                            userId: statusUpdate.userId,
                            username: statusUpdate.username,
                            displayName: statusUpdate.displayName,
                            status: statusUpdate.status || 'online'
                        });
                    } else {
                        // Êó¢Â≠ò„Éï„É¨„É≥„Éâ„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                        existingFriend.status = statusUpdate.status || 'online';
                    }
                } else {
                    // „Éï„É¨„É≥„Éâ„Åå„Ç™„Éï„É©„Ç§„É≥„Å´„Å™„Å£„Åü
                    onlineFriends = onlineFriends.filter(f => f.userId !== statusUpdate.userId);
                }
                
                updateOnlineFriendsDisplay();
            }
        }

        // „Ç™„É≥„É©„Ç§„É≥‰∫∫Êï∞„ÅÆÂàùÊúüÂåñ
        function initializeOnlineCount() {
            const onlineCountElement = document.getElementById('onlineUserCount');
            if (onlineCountElement) {
                // ÁèæÂú®„ÅÆ„É´„Éº„É†ÂèÇÂä†ËÄÖÊï∞„Åã„ÇâÈñãÂßãÔºàÊúÄ‰Ωé1‰∫∫„ÅØËá™ÂàÜÔºâ
                const roomUsersCount = parseInt(document.querySelector('small span')?.textContent || '1');
                currentOnlineCount = Math.max(roomUsersCount, 1);
                onlineCountElement.textContent = currentOnlineCount;
                console.log('„Ç™„É≥„É©„Ç§„É≥‰∫∫Êï∞ÂàùÊúüÂåñ:', currentOnlineCount);
            }
        }

        // „É™„Ç¢„É´„Çø„Ç§„É†„Åß„Ç™„É≥„É©„Ç§„É≥‰∫∫Êï∞„ÇíÊõ¥Êñ∞
        function updateOnlineCountRealtime(messageType) {
            const onlineCountElement = document.getElementById('onlineUserCount');
            if (!onlineCountElement) return;
            
            if (messageType === 'JOIN') {
                // „É¶„Éº„Ç∂„ÉºÂèÇÂä†ÊôÇÔºö‰∫∫Êï∞„ÇíÂ¢óÂä†
                currentOnlineCount++;
                console.log('üë• „É¶„Éº„Ç∂„ÉºÂèÇÂä†ÔºÅ„Ç™„É≥„É©„Ç§„É≥‰∫∫Êï∞:', currentOnlineCount);
            } else if (messageType === 'LEAVE') {
                // „É¶„Éº„Ç∂„ÉºÈÄÄÂá∫ÊôÇÔºö‰∫∫Êï∞„ÇíÊ∏õÂ∞ëÔºàÊúÄ‰Ωé1‰∫∫„ÅØËá™ÂàÜ„Çí‰øùË®ºÔºâ
                currentOnlineCount = Math.max(currentOnlineCount - 1, 1);
                console.log('üëã „É¶„Éº„Ç∂„ÉºÈÄÄÂá∫ÔºÅ„Ç™„É≥„É©„Ç§„É≥‰∫∫Êï∞:', currentOnlineCount);
            }
            
            // Ë°®Á§∫„ÇíÊõ¥Êñ∞
            onlineCountElement.textContent = currentOnlineCount;
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú
            onlineCountElement.style.transform = 'scale(1.3)';
            onlineCountElement.style.transition = 'all 0.3s ease';
            onlineCountElement.style.background = messageType === 'JOIN' ? '#28a745' : '#dc3545';
            onlineCountElement.style.color = 'white';
            
            setTimeout(() => {
                onlineCountElement.style.transform = 'scale(1)';
                onlineCountElement.style.background = '';
                onlineCountElement.style.color = '';
            }, 600);
        }

        // „Ç™„É≥„É©„Ç§„É≥„É¶„Éº„Ç∂„ÉºÊï∞„ÇíÊõ¥Êñ∞Ôºà„Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆÊõ¥Êñ∞Áî®Ôºâ
        function updateOnlineUserCount(countUpdate) {
            console.log('„Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆ„Ç™„É≥„É©„Ç§„É≥„É¶„Éº„Ç∂„ÉºÊï∞Êõ¥Êñ∞:', countUpdate);
            
            // „Éò„ÉÉ„ÉÄ„Éº„ÅÆ„Ç™„É≥„É©„Ç§„É≥‰∫∫Êï∞Ë°®Á§∫„ÇíÊõ¥Êñ∞
            const onlineCountElement = document.getElementById('onlineUserCount');
            if (onlineCountElement && countUpdate.onlineCount !== undefined) {
                // ÊúÄ‰Ωé1‰∫∫ÔºàËá™ÂàÜÔºâ„ÅØ‰øùË®º„Åô„Çã
                const actualCount = Math.max(countUpdate.onlineCount, 1);
                currentOnlineCount = actualCount; // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÇÇÂêåÊúü
                onlineCountElement.textContent = actualCount;
                
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú
                onlineCountElement.style.transform = 'scale(1.2)';
                onlineCountElement.style.transition = 'all 0.3s ease';
                onlineCountElement.style.background = '#007bff';
                onlineCountElement.style.color = 'white';
                setTimeout(() => {
                    onlineCountElement.style.transform = 'scale(1)';
                    onlineCountElement.style.background = '';
                    onlineCountElement.style.color = '';
                }, 300);
            }
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„Åü„Ç¢„Ç§„Ç≥„É≥„ÇíÂèñÂæó
        function getStatusIcon(status) {
            switch(status) {
                case 'online': return 'fa-circle';
                case 'away': return 'fa-clock';
                case 'busy': return 'fa-minus-circle';
                default: return 'fa-circle';
            }
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„ÅüËâ≤„ÇíÂèñÂæó
        function getStatusColor(status) {
            switch(status) {
                case 'online': return '#28a745';
                case 'away': return '#ffc107';
                case 'busy': return '#dc3545';
                default: return '#6c757d';
            }
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„Åü„ÉÜ„Ç≠„Çπ„Éà„ÇíÂèñÂæó
        function getStatusText(status) {
            switch(status) {
                case 'online': return '„Ç™„É≥„É©„Ç§„É≥';
                case 'away': return 'Èõ¢Â∏≠‰∏≠';
                case 'busy': return 'Âèñ„ÇäËæº„Åø‰∏≠';
                default: return '„Ç™„É≥„É©„Ç§„É≥';
            }
        }

        // „Éï„É¨„É≥„Éâ„Å®„ÅÆ„ÉÅ„É£„ÉÉ„Éà„ÇíÈñã„Åè
        function openFriendChat(username, displayName, userId) {
            // „Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫„Åæ„Åü„ÅØDM„ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†‰ΩúÊàê„ÅÆÂá¶ÁêÜ
            window.open(`/profile/${userId}`, '_blank');
        }

        // ‰∏ÄÂõû„ÅÆ„Éè„Éº„Éà„Éì„Éº„Éà„ÇíÈÄÅ‰ø°
        function sendHeartbeat() {
            fetch('/api/online/heartbeat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('„Éè„Éº„Éà„Éì„Éº„ÉàÈÄÅ‰ø°ÊàêÂäü - „Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖãÁ¢∫Ë™ç');
                } else {
                    console.warn('„Éè„Éº„Éà„Éì„Éº„ÉàÂ§±Êïó:', data.message);
                }
            })
            .catch(error => {
                console.error('„Éè„Éº„Éà„Éì„Éº„Éà„Ç®„É©„Éº:', error);
            });
        }

        // „Éè„Éº„Éà„Éì„Éº„Éà„ÇíÈñãÂßã
        function startHeartbeat() {
            // 30Áßí„Åî„Å®„Å´„Éè„Éº„Éà„Éì„Éº„Éà„ÇíÈÄÅ‰ø°
            heartbeatInterval = setInterval(() => {
                fetch('/api/online/heartbeat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        console.warn('„Éè„Éº„Éà„Éì„Éº„ÉàÂ§±Êïó:', data.message);
                    }
                })
                .catch(error => {
                    console.error('„Éè„Éº„Éà„Éì„Éº„Éà„Ç®„É©„Éº:', error);
                });
            }, 30000);
        }

        // „Éè„Éº„Éà„Éì„Éº„Éà„ÇíÂÅúÊ≠¢
        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }

        // „É¶„Éº„Ç∂„Éº„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂ§âÊõ¥
        function changeUserStatus(status) {
            fetch('/api/online/status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: status })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞ÊàêÂäü:', status);
                } else {
                    console.error('„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞Â§±Êïó:', data.message);
                }
            })
            .catch(error => {
                console.error('„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞„Ç®„É©„Éº:', error);
            });
        }

        // „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„Å´„Éè„Éº„Éà„Éì„Éº„Éà„ÇíÂÅúÊ≠¢
        window.addEventListener('beforeunload', function() {
            stopHeartbeat();
        });

        // „Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖãÂàá„ÇäÊõø„ÅàÔºàÊó¢Â≠ò„ÅÆtoggleOnlineStatusÈñ¢Êï∞„ÇíÊã°ÂºµÔºâ
        function toggleOnlineStatus() {
            const options = [
                { value: 'online', text: '„Ç™„É≥„É©„Ç§„É≥', icon: 'fa-circle', color: '#28a745' },
                { value: 'away', text: 'Èõ¢Â∏≠‰∏≠', icon: 'fa-clock', color: '#ffc107' },
                { value: 'busy', text: 'Âèñ„ÇäËæº„Åø‰∏≠', icon: 'fa-minus-circle', color: '#dc3545' }
            ];
            
            let optionsHtml = '';
            options.forEach(option => {
                optionsHtml += `
                    <button class="btn btn-outline-secondary w-100 mb-2 text-start" 
                            onclick="changeUserStatus('${option.value}')">
                        <i class="fas ${option.icon} me-2" style="color: ${option.color};"></i>
                        ${option.text}
                    </button>
                `;
            });
            
            const modalHtml = `
                <div class="modal fade" id="statusModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${optionsHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existingModal = document.getElementById('statusModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('statusModal'));
            modal.show();
        }

        // ÂÆöÊúüÁöÑ„Å´„Ç™„É≥„É©„Ç§„É≥„Éï„É¨„É≥„Éâ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
        setInterval(loadOnlineFriends, 60000); // 1ÂàÜ„Åî„Å®

        // „Éû„É´„ÉÅ„Çª„ÉÉ„Ç∑„Éß„É≥Ê©üËÉΩ
        function openMultiSessionTab() {
            // Êñ∞„Åó„ÅÑ„Çø„Éñ„Åß„Éû„É´„ÉÅ„Çª„ÉÉ„Ç∑„Éß„É≥„É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„ÇíÈñã„Åè
            const newTabId = 'tab-' + Math.random().toString(36).substr(2, 8);
            const url = '/multi-session/login?tab=' + newTabId;
            window.open(url, '_blank');
        }
    </script>

    <!-- „ÇØ„Ç§„ÉÉ„ÇØ„Éû„ÉÉ„ÉÅ„É¢„Éº„ÉÄ„É´ -->
    <div class="modal fade" id="quickMatchModal" tabindex="-1" aria-labelledby="quickMatchModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="position: relative; overflow: hidden; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%); border: none; border-radius: 15px;">
                <!-- ÊòüÁ©∫ËÉåÊôØ -->
                <div class="starry-background" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none;">
                    <div class="stars" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
                    <div class="shooting-stars" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
                </div>
                
                <div class="modal-header text-white" style="background: rgba(25, 25, 46, 0.9); backdrop-filter: blur(10px); position: relative; z-index: 100; border: none; border-radius: 15px 15px 0 0;">
                    <h5 class="modal-title" id="quickMatchModalLabel" style="text-shadow: 0 0 10px rgba(255,255,255,0.5);">
                        <i class="fas fa-bolt me-2" style="color: #ffcc00;"></i>‚ú® „ÇØ„Ç§„ÉÉ„ÇØ„Éû„ÉÉ„ÉÅ ‚ú®
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="position: relative; z-index: 100; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); color: #333; border-radius: 0 0 15px 15px;">
                    <div class="text-center">
                        <div id="quickMatchStatus">
                            <i class="fas fa-dice fa-3x mb-3" style="color: #ff6b6b; animation: spin 2s linear infinite;"></i>
                            <h5>ÊúÄÈÅ©„Å™„Éû„ÉÉ„ÉÅ„ÇíÊ§úÁ¥¢‰∏≠...</h5>
                            <p class="text-muted">„ÅÇ„Å™„Åü„Å´ÊúÄÈÅ©„Å™Áõ∏Êâã„ÇíÊé¢„Åó„Å¶„ÅÑ„Åæ„Åô</p>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     style="width: 0%; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);"
                                     id="matchProgress"></div>
                            </div>
                        </div>
                        <div id="quickMatchResult" style="display: none;">
                            <i class="fas fa-heart fa-3x mb-3 text-success"></i>
                            <h5>„Éû„ÉÉ„ÉÅ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„ÅüÔºÅ</h5>
                            <p class="text-muted">Áõ∏ÊÄßÂ∫¶: <span id="compatibilityScore" class="text-primary fw-bold">0%</span></p>
                            <div class="d-grid gap-2 mt-4">
                                <button class="btn btn-success" onclick="startMatchedChat()">
                                    <i class="fas fa-comments me-2"></i>„ÉÅ„É£„ÉÉ„ÉàÈñãÂßã
                                </button>
                                <button class="btn btn-outline-secondary" onclick="findAnotherMatch()">
                                    <i class="fas fa-dice me-2"></i>‰ªñ„ÅÆÁõ∏Êâã„ÇíÊé¢„Åô
                                </button>
                            </div>
                        </div>
                        <div id="quickMatchNoResult" style="display: none;">
                            <i class="fas fa-search fa-3x mb-3 text-warning"></i>
                            <h5>„Éû„ÉÉ„ÉÅ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</h5>
                            <p class="text-muted" id="noMatchMessage">ÁèæÂú®„Ç™„É≥„É©„Ç§„É≥„ÅÆÈÅ©Âêà„Åô„ÇãÁõ∏Êâã„Åå„ÅÑ„Åæ„Åõ„Çì</p>
                            <div class="d-flex justify-content-center gap-3 mt-4 flex-wrap">
                                <button class="btn btn-primary flex-fill" onclick="findAnotherMatch()" style="max-width: 200px;">
                                    <i class="fas fa-redo me-2"></i>ÂÜçÊ§úÁ¥¢
                                </button>
                                <a href="/random-matching" class="btn btn-outline-primary flex-fill" style="max-width: 200px;">
                                    <i class="fas fa-cog me-2"></i>Ë©≥Á¥∞Ë®≠ÂÆö
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kawaii Theme JavaScript -->
    <script src="/js/kawaii-theme.js"></script>
    <script>
        // „ÉÅ„É£„ÉÉ„ÉàÂ∞ÇÁî®ÂàùÊúüÂåñ
        function initPageSpecific() {
            // „É°„ÉÉ„Çª„Éº„Ç∏„Å´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú„ÇíËøΩÂä†
            const messages = document.querySelectorAll('.message-bubble');
            messages.forEach((msg, index) => {
                msg.style.animationDelay = (index * 0.1) + 's';
            });
            
            // „É´„Éº„É†È†ÖÁõÆ„Å´„Ç≠„É©„Ç≠„É©ÂäπÊûú
            document.querySelectorAll('.room-item').forEach(room => {
                KawaiiTheme.addSparkle(room);
            });
            
            // „Ç™„É≥„É©„Ç§„É≥„É¶„Éº„Ç∂„ÉºÊï∞„Å´„Éè„Éº„ÉàÂäπÊûú
            document.querySelectorAll('.user-card').forEach(user => {
                user.addEventListener('mouseenter', function() {
                    KawaiiTheme.addHeartBeat(this);
                });
            });
        }
        
        // „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°ÊôÇ„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Âº∑Âåñ
        const originalSendMessage = sendMessage;
        sendMessage = function() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (message) {
                // „Ç´„Éº„Éâ„Éû„Éº„ÇØ„ÅÆÈÖçÂàó
                const cardMarks = ['‚ù§', '‚òÖ', '‚ô¶', '‚ô†', '‚ô£'];
                
                // „Ç≠„É©„Ç≠„É©ÂäπÊûú
                const sparkle = document.createElement('div');
                // „É©„É≥„ÉÄ„É†„Å´3„Å§„ÅÆ„Ç´„Éº„Éâ„Éû„Éº„ÇØ„ÇíÈÅ∏Êäû
                const mark1 = cardMarks[Math.floor(Math.random() * cardMarks.length)];
                const mark2 = cardMarks[Math.floor(Math.random() * cardMarks.length)];
                const mark3 = cardMarks[Math.floor(Math.random() * cardMarks.length)];
                sparkle.innerHTML = mark1 + mark2 + mark3;
                sparkle.style.position = 'absolute';
                sparkle.style.top = '50%';
                sparkle.style.left = '50%';
                sparkle.style.transform = 'translate(-50%, -50%)';
                sparkle.style.animation = 'sparkle 1s ease-out forwards';
                sparkle.style.pointerEvents = 'none';
                sparkle.style.zIndex = '1000';
                
                const sendButton = document.querySelector('button[onclick="sendMessage()"]');
                sendButton.style.position = 'relative';
                sendButton.appendChild(sparkle);
                
                setTimeout(() => sparkle.remove(), 1000);
            }
            
            originalSendMessage();
        };
    </script>
    
    <!-- „É¢„Éê„Ç§„É´Áî®JavaScript -->
    <script>
        // „É¢„Éê„Ç§„É´Áî®ÈÄöÁü•„Éê„ÉÉ„Ç∏ÂêåÊúü
        function syncMobileNotifications() {
            const desktopBadge = document.getElementById('friendNotificationBadge');
            const mobileBadge = document.getElementById('mobileNotificationBadge');
            const desktopCount = document.getElementById('friendNotificationCount');
            
            if (desktopBadge && mobileBadge && desktopCount) {
                const count = desktopCount.textContent;
                if (desktopBadge.style.display !== 'none' && count > 0) {
                    mobileBadge.textContent = count;
                    mobileBadge.style.display = 'inline';
                } else {
                    mobileBadge.style.display = 'none';
                }
            }
        }
        
        // ÂÆöÊúüÁöÑ„Å´ÈÄöÁü•„Éê„ÉÉ„Ç∏„ÇíÂêåÊúü
        setInterval(syncMobileNotifications, 1000);
        
        // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„Å´ÂêåÊúü
        document.addEventListener('DOMContentLoaded', syncMobileNotifications);
        
        // ÁîªÈù¢„Çµ„Ç§„Ç∫Â§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜ
        window.addEventListener('resize', function() {
            // „É¢„Éê„Ç§„É´Ë°®Á§∫„Åß„Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅÈñâ„Åò„Çã
            if (window.innerWidth > 768) {
                const mobileDropdown = document.querySelector('.mobile-hamburger .dropdown-menu');
                if (mobileDropdown && mobileDropdown.classList.contains('show')) {
                    const dropdown = bootstrap.Dropdown.getInstance(document.querySelector('.mobile-hamburger .dropdown-toggle'));
                    if (dropdown) {
                        dropdown.hide();
                    }
                }
            }
        });
        
        // „É°„ÉÉ„Çª„Éº„Ç∏ÂÖ•ÂäõÊôÇ„ÅÆ„É¢„Éê„Ç§„É´ÊúÄÈÅ©Âåñ
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('messageInput');
            if (messageInput && window.innerWidth <= 768) {
                messageInput.addEventListener('focus', function() {
                    // „É°„ÉÉ„Çª„Éº„Ç∏„Ç®„É™„Ç¢„ÇíÊúÄ‰∏ãÈÉ®„Å´„Çπ„ÇØ„É≠„Éº„É´
                    setTimeout(function() {
                        const messagesContainer = document.querySelector('.chat-messages');
                        if (messagesContainer) {
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }
                    }, 300);
                });
            }
        });
    </script>
    
    <!-- PWAÊ©üËÉΩ -->
    <script src="/js/pwa.js"></script>
    
    <!-- „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÈÄèÊòéÂ∫¶ÁÆ°ÁêÜ„Çπ„ÇØ„É™„Éó„Éà -->
    <script>
        // „ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢„ÇíÈÄöÈÅé„Åô„Çã„Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÅÆÈÄèÊòéÂ∫¶„ÇíË™øÊï¥
        function manageParticleOpacity() {
            const particles = document.querySelectorAll('.particle');
            const shapes = document.querySelectorAll('.shape');
            
            // „ÉÅ„É£„ÉÉ„ÉàÁôΩ„Ç®„É™„Ç¢„ÅÆË¶ÅÁ¥†„ÇíÂÆöÁæ©Ôºà„Åì„Åì„Åß„ÅØËñÑ„Åè„Åô„ÇãÔºâ
            const lightChatAreas = [
                document.getElementById('chat-container'),
                document.querySelector('.message-input-area'),
                document.querySelector('.card-body'),
                document.querySelector('.card')
            ];
            
            // Ëµ§„ÅÑËÉåÊôØ„Ç®„É™„Ç¢Ôºà„Åì„Åì„Åß„ÅØÊøÉ„ÅèË°®Á§∫Ôºâ
            const redBackgroundAreas = [
                document.querySelector('.container-fluid'),
                document.querySelector('body')
            ];
            
            function checkParticlePosition() {
                particles.forEach(particle => {
                    const rect = particle.getBoundingClientRect();
                    let inLightChatArea = false;
                    let inRedArea = true; // „Éá„Éï„Ç©„É´„Éà„ÅßËµ§„Ç®„É™„Ç¢„Å´„ÅÑ„Çã„Å®‰ªÆÂÆö
                    
                    // ÁôΩ„ÅÑ„ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢„Å®„ÅÆÈáçË§á„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    lightChatAreas.forEach(area => {
                        if (area) {
                            const areaRect = area.getBoundingClientRect();
                            // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÅåÁôΩ„ÅÑ„ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢„Å®ÈáçË§á„Åó„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                            if (rect.left < areaRect.right && 
                                rect.right > areaRect.left && 
                                rect.top < areaRect.bottom && 
                                rect.bottom > areaRect.top) {
                                inLightChatArea = true;
                                inRedArea = false;
                            }
                        }
                    });
                    
                    if (inLightChatArea) {
                        // ÁôΩ„ÅÑ„ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢ÂÜÖÔºöËñÑ„ÅèË°®Á§∫
                        particle.classList.add('in-chat-area');
                        particle.classList.remove('out-chat-area');
                        particle.classList.remove('in-red-area');
                    } else if (inRedArea) {
                        // Ëµ§„ÅÑËÉåÊôØ„Ç®„É™„Ç¢ÂÜÖÔºöÊøÉ„ÅèÁæé„Åó„ÅèË°®Á§∫
                        particle.classList.remove('in-chat-area');
                        particle.classList.remove('out-chat-area');
                        particle.classList.add('in-red-area');
                    } else {
                        // „Åù„ÅÆ‰ªñ„ÅÆ„Ç®„É™„Ç¢ÔºöÈÄöÂ∏∏Ë°®Á§∫
                        particle.classList.remove('in-chat-area');
                        particle.classList.add('out-chat-area');
                        particle.classList.remove('in-red-area');
                    }
                });
                
                // ÊµÆÈÅäÂõ≥ÂΩ¢„ÇÇÂêåÊßò„Å´Âá¶ÁêÜ
                shapes.forEach(shape => {
                    const rect = shape.getBoundingClientRect();
                    let inLightChatArea = false;
                    let inRedArea = true;
                    
                    lightChatAreas.forEach(area => {
                        if (area) {
                            const areaRect = area.getBoundingClientRect();
                            if (rect.left < areaRect.right && 
                                rect.right > areaRect.left && 
                                rect.top < areaRect.bottom && 
                                rect.bottom > areaRect.top) {
                                inLightChatArea = true;
                                inRedArea = false;
                            }
                        }
                    });
                    
                    if (inLightChatArea) {
                        shape.classList.add('in-chat-area');
                        shape.classList.remove('out-chat-area');
                        shape.classList.remove('in-red-area');
                    } else if (inRedArea) {
                        shape.classList.remove('in-chat-area');
                        shape.classList.remove('out-chat-area');
                        shape.classList.add('in-red-area');
                    } else {
                        shape.classList.remove('in-chat-area');
                        shape.classList.add('out-chat-area');
                        shape.classList.remove('in-red-area');
                    }
                });
            }
            
            // ÂÆöÊúüÁöÑ„Å´„ÉÅ„Çß„ÉÉ„ÇØ
            setInterval(checkParticlePosition, 100);
        }
        
        // DOMË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´ÈñãÂßã
        document.addEventListener('DOMContentLoaded', function() {
            // Â∞ë„ÅóÈÅÖ„Çâ„Åõ„Å¶ÈñãÂßãÔºà„Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÅåÁîüÊàê„Åï„Çå„Çã„ÅÆ„ÇíÂæÖ„Å§Ôºâ
            setTimeout(manageParticleOpacity, 2000);
        });
    </script>
</body>
</html>
