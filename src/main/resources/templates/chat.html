<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí¨ „ÉÅ„É£„ÉÉ„Éà - „ÉÅ„É£„ÉÉ„Éà„Ç¢„Éó„É™</title>
    
    <!-- PWAË®≠ÂÆö -->
    <link rel="manifest" href="/manifest.json?v=4">
    <meta name="theme-color" content="#f368e0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="üí´ChatApp">
    <link rel="apple-touch-icon" href="/images/app-icon-180.png?v=4">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/app-icon-180.png?v=4">
    <link rel="icon" type="image/png" href="/images/app-icon-180.png?v=4">
    <link rel="icon" type="image/svg+xml" href="/images/app-icon-180.svg?v=4">
    <link rel="shortcut icon" href="/images/app-icon-180.png?v=4">
    <link rel="mask-icon" href="/images/app-icon-180.svg?v=4" color="#f368e0">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/chat-style.css" rel="stylesheet">
    <link href="/css/kawaii-theme.css" rel="stylesheet">
    <link href="/css/mobile.css" rel="stylesheet">
    <style>
        /* „ÉÅ„É£„ÉÉ„ÉàÂ∞ÇÁî®„Çπ„Çø„Ç§„É´ */
        .chat-sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            height: calc(100vh - 150px);
            overflow-y: auto;
        }
        
        .chat-main {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            height: calc(100vh - 150px);
            display: flex;
            flex-direction: column;
        }
        
        .room-item {
            padding: 1rem;
            border-radius: 15px;
            margin: 0.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .room-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .room-item:hover::before {
            left: 100%;
        }
        
        .room-item:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            transform: translateX(10px);
        }
        
        .room-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }
        
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px 20px 0 0;
            padding: 1.5rem;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(247, 248, 252, 0.5) 0%, rgba(236, 240, 251, 0.5) 100%);
        }
        
        .chat-input-area {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 0 0 20px 20px;
            border-top: 1px solid rgba(102, 126, 234, 0.1);
        }
        
        .message-bubble {
            border-radius: 20px;
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            position: relative;
            animation: messageSlide 0.3s ease-out;
            max-width: 70%;
        }
        
        .message-bubble.own {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .message-bubble.other {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .user-avatar:hover {
            transform: scale(1.1) rotate(10deg);
            border-color: #764ba2;
        }
        
        .online-users-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        
        .user-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 1rem;
            margin: 0.5rem 0;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .user-card:hover {
            background: rgba(102, 126, 234, 0.1);
            border-left-color: #667eea;
            transform: translateX(5px);
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            margin: 0.5rem 0;
            max-width: 100px;
        }
        
        .typing-dots {
            display: flex;
            gap: 3px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: typingPulse 1.5s ease-in-out infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typingPulse {
            0%, 60%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            30% {
                transform: scale(1.2);
                opacity: 1;
            }
        }
        
        /* „Ç´„Çπ„Çø„É†„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .switching {
            opacity: 0.6;
            pointer-events: none;
        }
        
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Ë™≠„ÅøËæº„Åø‰∏≠„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
        @media (max-width: 768px) {
            .chat-sidebar,
            .chat-main,
            .online-users-panel {
                height: auto;
                margin-bottom: 1rem;
            }
            
            .message-bubble {
                max-width: 85%;
            }
        }
        
        /* „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éê„Éº„Å®„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„É°„Éã„É•„Éº„ÅÆz-index‰øÆÊ≠£ */
        .navbar {
            z-index: 1030 !important;
            position: relative;
        }
        
        .dropdown-menu {
            z-index: 1040 !important;
            position: absolute !important;
        }
        
        .dropdown {
            z-index: 1035 !important;
        }
        
        /* „ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢„ÅÆz-indexË™øÊï¥ */
        .chat-main {
            z-index: 1020;
            position: relative;
        }
        
        .chat-sidebar {
            z-index: 1020;
            position: relative;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-comments me-2"></i>„ÉÅ„É£„ÉÉ„Éà„Ç¢„Éó„É™
            </a>
            <div class="navbar-nav ms-auto">
                <!-- „É¢„Éê„Ç§„É´Â∞ÇÁî®„Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº -->
                <div class="nav-item dropdown mobile-hamburger d-md-none">
                    <button class="dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-bars"></i>
                        „É°„Éã„É•„Éº
                    </button>
                    <ul class="dropdown-menu">
                        <!-- „Éó„É≠„Éï„Ç£„Éº„É´ -->
                        <li>
                            <a class="dropdown-item" href="/profile">
                                <i class="fas fa-user"></i>
                                „Éó„É≠„Éï„Ç£„Éº„É´
                            </a>
                        </li>
                        <!-- „Éï„É¨„É≥„Éâ -->
                        <li>
                            <a class="dropdown-item" href="/friends">
                                <i class="fas fa-user-friends"></i>
                                „Éï„É¨„É≥„Éâ
                                <span class="badge bg-danger ms-auto" id="mobileNotificationBadge" style="display: none;">0</span>
                            </a>
                        </li>
                        <!-- „É´„Éº„É†‰∏ÄË¶ß -->
                        <li>
                            <a class="dropdown-item" href="/rooms">
                                <i class="fas fa-list"></i>
                                „É´„Éº„É†‰∏ÄË¶ß
                            </a>
                        </li>
                        <!-- „É´„Éº„É†‰ΩúÊàê -->
                        <li>
                            <a class="dropdown-item" href="/rooms/create">
                                <i class="fas fa-plus"></i>
                                „É´„Éº„É†‰ΩúÊàê
                            </a>
                        </li>
                        <!-- „É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞ -->
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <a class="dropdown-item" href="/random-matching">
                                <i class="fas fa-dice"></i>
                                „É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞
                            </a>
                        </li>
                        <!-- „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÊôÇ„ÅÆ„ÅøË°®Á§∫ -->
                        <li th:if="${debugMode}">
                            <a class="dropdown-item" href="#" onclick="showUserSearchModal()">
                                <i class="fas fa-search"></i>
                                IDÊ§úÁ¥¢
                            </a>
                        </li>
                        <li th:if="${debugMode}">
                            <a class="dropdown-item" href="/login/offdbg">
                                <i class="fas fa-bug"></i>
                                „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâËß£Èô§
                            </a>
                        </li>
                        <!-- „É≠„Ç∞„Ç¢„Ç¶„Éà -->
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-danger" href="/logout" style="color: #dc3545 !important; font-weight: 600;">
                                <i class="fas fa-sign-out-alt"></i>
                                „É≠„Ç∞„Ç¢„Ç¶„Éà
                            </a>
                        </li>
                    </ul>
                </div>
                
                <!-- „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÁî®ÔºàÂæìÊù•ÈÄö„ÇäÔºâ -->
                <span class="navbar-text me-3 d-none d-md-inline" sec:authorize="isAuthenticated()">
                    <i class="fas fa-user me-1"></i>
                    „Çà„ÅÜ„Åì„Åù„ÄÅ<span sec:authentication="name"></span>„Åï„Çì
                </span>
                <!-- „Éï„É¨„É≥„ÉâÁÆ°ÁêÜ„Éú„Çø„É≥ -->
                <div class="nav-item position-relative me-3 d-none d-md-block">
                    <a class="nav-link d-flex align-items-center" href="/friends" id="friendsButton" style="padding: 8px 16px; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transition: all 0.3s ease;">
                        <i class="fas fa-user-friends me-2" style="font-size: 1.1rem;"></i>
                        <span style="font-weight: 500;">„Éï„É¨„É≥„Éâ</span>
                        <span class="position-absolute translate-middle badge rounded-pill" 
                              id="friendNotificationBadge" 
                              style="display: none; top: -5px; left: 100%; background: linear-gradient(135deg, #ff4757, #ff3838); color: white; font-size: 0.7rem; font-weight: bold; min-width: 20px; height: 20px; line-height: 20px; border: 2px solid white; box-shadow: 0 2px 8px rgba(255, 71, 87, 0.4);">
                            <span id="friendNotificationCount">0</span>
                        </span>
                    </a>
                </div>
                <!-- „É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Éú„Çø„É≥Ôºà„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÊôÇ„ÅÆ„ÅøÔºâ -->
                <div th:if="${debugMode}" class="nav-item me-3 d-none d-md-block">
                    <a class="nav-link d-flex align-items-center" href="/random-matching" style="padding: 8px 16px; border-radius: 12px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; transition: all 0.3s ease;">
                        <i class="fas fa-dice me-2" style="font-size: 1.1rem;"></i>
                        <span style="font-weight: 500;">„É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞</span>
                    </a>
                </div>
                <!-- IDÊ§úÁ¥¢„Éú„Çø„É≥Ôºà„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÊôÇ„ÅÆ„ÅøÔºâ -->
                <div th:if="${debugMode}" class="nav-item me-3 d-none d-md-block">
                    <button class="nav-link btn btn-link" onclick="showUserSearchModal()" style="border: none; background: none;">
                        <i class="fas fa-search me-1"></i>IDÊ§úÁ¥¢
                    </button>
                </div>
                <a class="nav-link d-none d-md-block" th:href="@{/rooms}">
                    <i class="fas fa-list me-1"></i>„É´„Éº„É†‰∏ÄË¶ß
                </a>
                <!-- „Éó„É≠„Éï„Ç£„Éº„É´„É°„Éã„É•„Éº -->
                <div class="nav-item dropdown d-none d-md-block" style="z-index: 1040;">
                    <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-user-circle me-1"></i>„Éó„É≠„Éï„Ç£„Éº„É´
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" style="z-index: 1050;">
                        <li><a class="dropdown-item" th:href="@{/profile}">
                            <i class="fas fa-user me-2"></i>„Éû„Ç§„Éó„É≠„Éï„Ç£„Éº„É´
                        </a></li>
                        <li><a class="dropdown-item" th:href="@{/profile/edit}">
                            <i class="fas fa-edit me-2"></i>„Éó„É≠„Éï„Ç£„Éº„É´Á∑®ÈõÜ
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" th:href="@{/profile/search}">
                            <i class="fas fa-search me-2"></i>„É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢
                        </a></li>
                        <!-- „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÊôÇ„ÅÆ„ÅøË°®Á§∫ -->
                        <li th:if="${debugMode}"><a class="dropdown-item" th:href="@{/profile/online}">
                            <i class="fas fa-circle text-success me-2"></i>„Ç™„É≥„É©„Ç§„É≥„É¶„Éº„Ç∂„ÉºÊï∞
                        </a></li>
                        <!-- „É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞„ÅØ„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÊôÇ„ÅÆ„Åø -->
                        <li th:if="${debugMode}"><hr class="dropdown-divider"></li>
                        <li th:if="${debugMode}"><a class="dropdown-item" th:href="@{/random-matching}">
                            <i class="fas fa-dice me-2"></i>„É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞
                        </a></li>
                        <!-- „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÊôÇ„ÅÆ„ÅøË°®Á§∫ -->
                        <li th:if="${debugMode}"><hr class="dropdown-divider"></li>
                        <li th:if="${debugMode}"><a class="dropdown-item" href="#" onclick="toggleOnlineStatus()">
                            <i class="fas fa-power-off me-2"></i>„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥
                        </a></li>
                        <li th:if="${debugMode}"><a class="dropdown-item" href="/debug/session">
                            <i class="fas fa-bug me-2"></i>„Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±
                        </a></li>
                        <li th:if="${debugMode}"><a class="dropdown-item" href="#" onclick="openMultiSessionTab()">
                            <i class="fas fa-external-link-alt me-2"></i>Êñ∞„Åó„ÅÑ„Çø„Éñ„Åß„É≠„Ç∞„Ç§„É≥
                        </a></li>
                    </ul>
                </div>
                <a class="nav-link d-none d-md-block" th:href="@{/logout}">
                    <i class="fas fa-sign-out-alt me-1"></i>„É≠„Ç∞„Ç¢„Ç¶„Éà
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- „Çµ„Ç§„Éâ„Éê„ÉºÔºö„ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†‰∏ÄË¶ß -->
            <div class="col-md-3">
                <div class="card chat-sidebar" id="mobileSidebar">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-list me-1"></i>ÂèÇÂä†‰∏≠„ÅÆ„É´„Éº„É†
                        </h6>
                        <div>
                            <a href="/rooms/create" class="btn btn-sm btn-light">
                                <i class="fas fa-plus"></i>
                            </a>
                            <!-- „É¢„Éê„Ç§„É´Áî®Èñâ„Åò„Çã„Éú„Çø„É≥ -->
                            <button class="btn btn-sm btn-light d-md-none ms-1" onclick="toggleMobileSidebar()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div th:if="${userRooms != null and !userRooms.isEmpty()}">
                            <div th:each="room : ${userRooms}" 
                                 class="room-item list-group-item list-group-item-action d-flex justify-content-between align-items-center room-clickable"
                                 th:classappend="${room.id == currentRoom?.id} ? 'active' : ''"
                                 style="cursor: pointer;" 
                                 th:data-room-id="${room.id}"
                                 th:data-room-name="${room.name}">
                                <div>
                                    <div class="fw-bold" th:text="${room.name}">„É´„Éº„É†Âêç</div>
                                    <small class="text-muted">
                                        <i class="fas fa-users me-1"></i>
                                        <span th:text="${room.users.size()}">0</span> ‰∫∫
                                    </small>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-success me-2" th:if="${room.type.name() == 'GROUP'}">
                                        <i class="fas fa-users"></i>
                                    </span>
                                    <span class="badge bg-info me-2" th:if="${room.type.name() == 'PRIVATE'}">
                                        <i class="fas fa-lock"></i>
                                    </span>
                                    <!-- ÁèæÂú®„ÅÆ„É´„Éº„É†„Å´„ÅØÁâπÂà•„Å™„Ç¢„Ç§„Ç≥„É≥ -->
                                    <i class="fas fa-arrow-right text-primary" th:if="${room.id == currentRoom?.id}"></i>
                                </div>
                            </div>
                        </div>
                        <div th:if="${userRooms == null or userRooms.isEmpty()}" class="p-3 text-center text-muted">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p class="small mb-0">ÂèÇÂä†‰∏≠„ÅÆ„É´„Éº„É†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                            <a href="/rooms" class="btn btn-sm btn-outline-primary mt-2">
                                „É´„Éº„É†„ÇíÊé¢„Åô
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- „É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞ „ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Çª„Çπ -->
                <div class="card mt-3 d-none d-md-block">
                    <div class="card-header text-white d-flex justify-content-between align-items-center" 
                         style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
                        <h6 class="mb-0">
                            <i class="fas fa-dice me-1"></i>„É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞
                        </h6>
                        <i class="fas fa-heart text-white"></i>
                    </div>
                    <div class="card-body p-3">
                        <div class="text-center">
                            <div class="mb-3">
                                <i class="fas fa-dice fa-2x mb-2" style="color: #ff6b6b;"></i>
                                <p class="small text-muted mb-2">Êñ∞„Åó„ÅÑÂá∫‰ºö„ÅÑ„ÇíË¶ã„Å§„Åë„Çà„ÅÜ</p>
                            </div>
                            <div class="d-grid gap-2">
                                <a href="/random-matching" class="btn btn-primary" 
                                   style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); border: none;">
                                    <i class="fas fa-dice me-1"></i>„Éû„ÉÉ„ÉÅ„É≥„Ç∞<br>ÈñãÂßã
                                </a>
                                <button class="btn btn-outline-secondary btn-sm" onclick="showQuickMatchModal()">
                                    <i class="fas fa-bolt me-1"></i>„ÇØ„Ç§„ÉÉ„ÇØ„Éû„ÉÉ„ÉÅ
                                </button>
                            </div>
                            <div class="mt-3 pt-2 border-top">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <small class="text-muted d-block">‰ªäÊó•„ÅÆ„Éû„ÉÉ„ÉÅ</small>
                                        <strong class="text-primary" id="todayMatches">0</strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">Á∑è„Éû„ÉÉ„ÉÅÊï∞</small>
                                        <strong class="text-success" id="totalMatches">0</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- „Ç™„É≥„É©„Ç§„É≥„Éï„É¨„É≥„Éâ -->
                <div class="card mt-3 d-none d-md-block">
                    <div class="card-header text-white d-flex justify-content-between align-items-center" 
                         style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <h6 class="mb-0">
                            <i class="fas fa-circle text-success me-1"></i>„Ç™„É≥„É©„Ç§„É≥„Éï„É¨„É≥„Éâ
                        </h6>
                        <span class="badge bg-light text-dark" id="onlineFriendsCount">0</span>
                    </div>
                    <div class="card-body p-0">
                        <div id="onlineFriendsList" class="list-group list-group-flush">
                            <div class="text-center py-3 text-muted" id="noOnlineFriends">
                                <i class="fas fa-user-slash mb-2"></i>
                                <div>„Ç™„É≥„É©„Ç§„É≥„ÅÆ„Éï„É¨„É≥„Éâ„ÅØ„ÅÑ„Åæ„Åõ„Çì</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- „É°„Ç§„É≥„ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢ -->
            <div class="col-md-9">
                <!-- „É¢„Éê„Ç§„É´Áî®„Çµ„Ç§„Éâ„Éê„Éº„Éà„Ç∞„É´„Éú„Çø„É≥ -->
                <button class="mobile-sidebar-toggle d-md-none" onclick="toggleMobileSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="card chat-main">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0" th:text="${currentRoom?.name ?: '„ÉÅ„É£„ÉÉ„Éà'}">„ÉÅ„É£„ÉÉ„Éà</h5>
                            <small th:if="${currentRoom != null}">
                                <i class="fas fa-users me-1"></i>
                                <span th:text="${currentRoom?.users?.size() ?: 0}">0</span> ‰∫∫„ÅåÂèÇÂä†‰∏≠
                            </small>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±Ôºà„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÊôÇ„ÅÆ„ÅøÔºâ -->
                        <div th:if="${debugMode and debugEnabled}" class="alert alert-info" style="font-size: 12px;">
                            <strong>„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±:</strong><br>
                            chatHistory is null: <span th:text="${chatHistory == null}"></span><br>
                            chatHistory size: <span th:text="${chatHistory != null ? chatHistory.size() : 'N/A'}"></span><br>
                            chatRoomId: <span th:text="${chatRoomId}"></span>
                        </div>
                        
                        <div id="chat-container">
                            <!-- Êó¢Â≠ò„ÅÆ„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíË°®Á§∫ -->
                            <div th:if="${chatHistory != null and !chatHistory.isEmpty()}">
                                <div th:each="msg, iterStat : ${chatHistory}" class="message d-flex">
                                    <div class="message-bubble" 
                                         th:classappend="${msg.user.username == #authentication.name} ? 'own-message' : 'other-message'">
                                        <div class="message-header" th:if="${msg.user.username != #authentication.name}">
                                            <!-- „Ç¢„Éê„Çø„ÉºÁîªÂÉè„ÅØJavaScript„ÅßÂãïÁöÑ„Å´Êõ¥Êñ∞„Åï„Çå„Çã„Åü„ÇÅ„ÄÅ„Éá„Éï„Ç©„É´„Éà„ÅÆ„Ç¢„Ç§„Ç≥„É≥„ÇíË°®Á§∫ -->
                                            <i class="fas fa-user-circle me-1 user-avatar-clickable" 
                                               style="cursor: pointer; color: #007bff;" 
                                               th:data-user-id="${msg.user.id}"
                                               th:data-username="${msg.user.username}"
                                               onclick="showUserContextMenu(event, this)"
                                               title="„É¶„Éº„Ç∂„Éº„É°„Éã„É•„Éº„ÇíË°®Á§∫"></i>
                                            <span th:text="${msg.user.username}" 
                                                  class="username-clickable" 
                                                  style="cursor: pointer; color: #007bff;"
                                                  th:data-user-id="${msg.user.id}"
                                                  th:data-username="${msg.user.username}"
                                                  onclick="showUserContextMenu(event, this)"
                                                  title="„É¶„Éº„Ç∂„Éº„É°„Éã„É•„Éº„ÇíË°®Á§∫"></span>
                                        </div>
                                        <div class="message-content" th:text="${msg.content}"></div>
                                        <div class="message-time mt-1" style="font-size: 0.75rem; opacity: 0.7;">
                                            <i class="fas fa-clock me-1"></i>
                                            <span th:text="${#temporals.format(msg.sentAt, 'HH:mm')}"></span>
                                        </div>
                                        <!-- „Éá„Éê„ÉÉ„Ç∞Ôºö„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆË©≥Á¥∞ÔºàÈñãÁô∫ÊôÇ„ÅÆ„ÅøÔºâ -->
                                        <small th:if="${debugEnabled}" style="color: #666;">
                                            Debug: index=<span th:text="${iterStat.index}"></span>, 
                                            msgId=<span th:text="${msg.id}"></span>, 
                                            userId=<span th:text="${msg.user.id}"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div th:if="${chatHistory == null or chatHistory.isEmpty()}" class="text-center text-muted py-5">
                                <div class="mb-4">
                                    <i class="fas fa-comments fa-3x" style="opacity: 0.3;"></i>
                                </div>
                                <h5 class="mb-3">„Åæ„Å†„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</h5>
                                <p class="mb-0">ÊúÄÂàù„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºÅ</p>
                                <!-- „Éá„Éê„ÉÉ„Ç∞ÔºöÂÆüÈöõ„ÅÆÂÄ§„ÇíË°®Á§∫ÔºàÈñãÁô∫ÊôÇ„ÅÆ„ÅøÔºâ -->
                                <small th:if="${debugEnabled}">
                                    chatHistory: <span th:text="${chatHistory}"></span>
                                </small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="input-group">
                                <input type="text" id="messageInput" class="form-control" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..." autocomplete="off">
                                <button class="btn btn-primary pulse" type="button" id="sendButton">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-users me-2"></i>„Ç™„É≥„É©„Ç§„É≥„É¶„Éº„Ç∂„ÉºÊï∞
                        </h5>
                    </div>
                    <div class="card-body">
                        <ul id="users-list" class="list-unstyled">
                            <!-- „Ç™„É≥„É©„Ç§„É≥„É¶„Éº„Ç∂„ÉºÊï∞„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="/js/notifications.js"></script>
    <script>
        let stompClient = null;
        let currentUser = /*[[${username}]]*/ 'user';
        let currentRoomId = /*[[${currentRoom?.id ?: 1}]]*/ 1;
        let currentSubscription = null;
        let debugEnabled = true; // „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ„ÇíÊúâÂäπÂåñ
        
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÇíË®≠ÂÆöÔºàÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†„Åß‰ΩøÁî®Ôºâ
        window.currentUser = currentUser;
        window.currentRoomId = currentRoomId;

        function switchRoomFromElement(element) {
            console.log('switchRoomFromElement called:', element);
            
            if (!element || !element.dataset) {
                console.error('Invalid element passed to switchRoomFromElement:', element);
                return;
            }
            
            const roomId = parseInt(element.dataset.roomId);
            const roomName = element.dataset.roomName;
            
            console.log('Room data:', { roomId, roomName, dataset: element.dataset });
            
            if (!roomId || isNaN(roomId)) {
                console.error('Invalid room ID:', element.dataset.roomId);
                return;
            }
            
            if (!roomName) {
                console.error('Missing room name:', element.dataset.roomName);
                return;
            }
            
            console.log('Attempting to switch room:', roomId, roomName);
            
            // „ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆË¶ñË¶öÁöÑ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
            element.style.transform = 'scale(0.95)';
            setTimeout(() => {
                element.style.transform = '';
            }, 150);
            
            // Âç≥Â∫ß„Å´UI„ÇíÊõ¥Êñ∞Ôºà„É¨„Çπ„Éù„É≥„Ç∑„ÉñÊÑü„ÇíÂêë‰∏äÔºâ
            updateActiveRoomInSidebar(roomId);
            
            switchRoomInternal(roomId, roomName);
        }

        function switchRoomInternal(roomId, roomName) {
            if (roomId == currentRoomId) {
                if (debugEnabled) {
                    console.log('Âêå„Åò„É´„Éº„É†„ÅÆ„Åü„ÇÅÂàá„ÇäÊõø„Åà„Çí„Çπ„Ç≠„ÉÉ„Éó:', roomId);
                }
                return; // Âêå„Åò„É´„Éº„É†„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            }
            
            if (debugEnabled) {
                console.log('„É´„Éº„É†Âàá„ÇäÊõø„ÅàÈñãÂßã:', currentRoomId, '->', roomId, '(' + roomName + ')');
            }
            
            // Âàá„ÇäÊõø„Åà‰∏≠„ÅÆUIË°®Á§∫
            showSwitchingState(true);
            
            // ÁèæÂú®„ÅÆË≥ºË™≠„ÇíËß£Èô§
            if (stompClient && stompClient.connected && currentSubscription) {
                currentSubscription.unsubscribe();
                if (debugEnabled) {
                    console.log('Ââç„ÅÆ„É´„Éº„É†„ÅÆË≥ºË™≠„ÇíËß£Èô§„Åó„Åæ„Åó„Åü:', currentRoomId);
                }
            }
            
            // Êñ∞„Åó„ÅÑ„É´„Éº„É†„Å´Âàá„ÇäÊõø„Åà
            const oldRoomId = currentRoomId;
            currentRoomId = roomId;
            
            // URL„ÇíÊõ¥Êñ∞Ôºà„Éñ„É©„Ç¶„Ç∂Â±•Ê≠¥„Å´ËøΩÂä†Ôºâ
            const newUrl = `/chat?room=${roomId}`;
            if (window.location.href !== window.location.origin + newUrl) {
                window.history.pushState({roomId: roomId, roomName: roomName}, '', newUrl);
            }
            
            // UI„ÇíÊõ¥Êñ∞
            updateCurrentRoomDisplay(roomName);
            updateActiveRoomInSidebar(roomId);
            clearChatArea();
            showLoadingInChat();
            
            // Êñ∞„Åó„ÅÑ„É´„Éº„É†„Å´Ë≥ºË™≠
            if (stompClient && stompClient.connected) {
                currentSubscription = stompClient.subscribe('/topic/chatroom/' + roomId, function(messageOutput) {
                    if (debugEnabled) {
                        console.log('Êñ∞„Åó„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏Âèó‰ø° (room ' + roomId + '):', messageOutput.body);
                    }
                    const messageData = JSON.parse(messageOutput.body);
                    showMessage(messageData);
                    
                    // ÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†„Å®Áµ±Âêà
                    if (window.notificationManager && messageData.type === 'CHAT') {
                        window.notificationManager.notifyNewMessage(messageData, roomName, roomId);
                    } else if (window.notificationManager && messageData.type === 'JOIN') {
                        window.notificationManager.notifyUserJoined(messageData.senderUsername, roomName, currentRoomId, roomId);
                    } else if (window.notificationManager && messageData.type === 'LEAVE') {
                        window.notificationManager.notifyUserLeft(messageData.senderUsername, roomName, currentRoomId, roomId);
                    }
                });
                
                if (debugEnabled) {
                    console.log('Êñ∞„Åó„ÅÑ„É´„Éº„É†„Å´Ë≥ºË™≠„Åó„Åæ„Åó„Åü:', roomId);
                }
                
                // ÂèÇÂä†„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°
                stompClient.send("/app/chat.addUser", {}, JSON.stringify({
                    senderUsername: currentUser,
                    chatRoomId: roomId,
                    type: 'JOIN'
                }));
            }
            
            // „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø
            loadRoomHistory(roomId);
            
            // Êú™Ë™≠Êï∞„Çí„ÇØ„É™„Ç¢
            if (window.notificationManager) {
                window.notificationManager.clearUnreadCount(roomId);
            }
            
            // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÇíÊõ¥Êñ∞
            window.currentRoomId = roomId;
        }

        function showSwitchingState(switching) {
            const chatContainer = document.getElementById('chat-container');
            if (switching) {
                chatContainer.classList.add('switching');
            } else {
                chatContainer.classList.remove('switching');
            }
        }

        function showLoadingInChat() {
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = `
                <div class="text-center p-4">
                    <div class="loading"></div>
                    <p class="mt-2">„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
                </div>
            `;
        }

        function updateCurrentRoomDisplay(roomName) {
            const currentRoomElement = document.querySelector('h5.mb-0');
            if (currentRoomElement) {
                currentRoomElement.textContent = roomName;
            }
        }

        function updateActiveRoomInSidebar(roomId) {
            console.log('„É´„Éº„É†„Çµ„Ç§„Éâ„Éê„ÉºÊõ¥Êñ∞:', roomId);
            
            // „Åô„Åπ„Å¶„ÅÆ„É´„Éº„É†„Ç¢„Ç§„ÉÜ„É†„Åã„Çâactive„ÇØ„É©„Çπ„ÇíÂâäÈô§
            document.querySelectorAll('.room-item').forEach(item => {
                item.classList.remove('active');
                // Áü¢Âç∞„Ç¢„Ç§„Ç≥„É≥„ÇÇÂâäÈô§
                const arrow = item.querySelector('.fas.fa-arrow-right');
                if (arrow) {
                    arrow.remove();
                }
                // ÂÖÉ„ÅÆËâ≤„Å´Êàª„Åô
                item.style.removeProperty('background');
                item.style.removeProperty('color');
            });
            
            // Êñ∞„Åó„ÅÑ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É´„Éº„É†„Çí data-room-id „ÅßÊ§úÁ¥¢
            const activeRoomElement = document.querySelector(`[data-room-id="${roomId}"]`);
            console.log('„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É´„Éº„É†Ë¶ÅÁ¥†:', activeRoomElement);
            
            if (activeRoomElement) {
                // active„ÇØ„É©„Çπ„ÇíËøΩÂä†
                activeRoomElement.classList.add('active');
                
                // ÊòéÁ¢∫„Å™Ëâ≤Â§âÊõ¥„ÇíÈÅ©Áî®
                activeRoomElement.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                activeRoomElement.style.color = 'white';
                activeRoomElement.style.transform = 'scale(1.02)';
                activeRoomElement.style.boxShadow = '0 8px 16px rgba(102, 126, 234, 0.3)';
                
                // Áü¢Âç∞„Ç¢„Ç§„Ç≥„É≥„ÇíËøΩÂä†
                const badgeContainer = activeRoomElement.querySelector('.d-flex.align-items-center');
                if (badgeContainer && !badgeContainer.querySelector('.fa-arrow-right')) {
                    const arrow = document.createElement('i');
                    arrow.className = 'fas fa-arrow-right text-white ms-2';
                    arrow.style.animation = 'pulse 2s infinite';
                    badgeContainer.appendChild(arrow);
                }
                
                // ÂÜÖÈÉ®„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàËâ≤„ÇÇÁôΩ„Å´Â§âÊõ¥
                const textElements = activeRoomElement.querySelectorAll('*');
                textElements.forEach(el => {
                    if (el.classList.contains('text-muted')) {
                        el.style.color = 'rgba(255, 255, 255, 0.8)';
                    } else if (!el.classList.contains('badge')) {
                        el.style.color = 'white';
                    }
                });
                
                console.log('„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É´„Éº„É†Ë®≠ÂÆöÂÆå‰∫Ü:', roomId);
            } else {
                console.warn('„É´„Éº„É†Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', roomId);
            }
        }

        function clearChatArea() {
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer) {
                chatContainer.innerHTML = '';
            }
        }

        function loadRoomHistory(roomId) {
            if (debugEnabled) {
                console.log('Â±•Ê≠¥Ë™≠„ÅøËæº„ÅøÈñãÂßã - „É´„Éº„É†ID:', roomId);
            }
            
            fetch(`/api/messages/${roomId}`)
                .then(response => {
                    if (debugEnabled) {
                        console.log('APIÂøúÁ≠î„Çπ„ÉÜ„Éº„Çø„Çπ:', response.status);
                    }
                    return response.json();
                })
                .then(messages => {
                    if (debugEnabled) {
                        console.log('Âèó‰ø°„Åó„Åü„É°„ÉÉ„Çª„Éº„Ç∏:', messages);
                        console.log('„É°„ÉÉ„Çª„Éº„Ç∏Êï∞:', messages.length);
                    }
                    
                    const messageArea = document.getElementById('chat-container');
                    messageArea.innerHTML = '';
                    
                    if (messages.length === 0) {
                        messageArea.innerHTML = `
                            <div class="text-center p-4 text-muted">
                                <i class="fas fa-comment fa-3x mb-3"></i>
                                <p>„Åæ„Å†„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                                <p class="small">ÊúÄÂàù„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºÅ</p>
                            </div>
                        `;
                    } else {
                        messages.forEach(message => {
                            if (debugEnabled) {
                                console.log('Ë°®Á§∫„Åô„Çã„É°„ÉÉ„Çª„Éº„Ç∏:', message);
                            }
                            showMessage(message);
                        });
                    }
                    
                    // Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                    showSwitchingState(false);
                    
                    if (debugEnabled) {
                        console.log('Â±•Ê≠¥Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü - „É´„Éº„É†ID:', roomId);
                    }
                })
                .catch(error => {
                    console.error('Â±•Ê≠¥Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                    const messageArea = document.getElementById('chat-container');
                    messageArea.innerHTML = `
                        <div class="text-center p-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p>Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadRoomHistory(${roomId})">
                                ÂÜçË™≠„ÅøËæº„Åø
                            </button>
                        </div>
                    `;
                    showSwitchingState(false);
                    
                    if (debugEnabled) {
                        console.error('Ë©≥Á¥∞„Ç®„É©„Éº:', error);
                    }
                });
        }

        function leaveRoom(roomId) {
            if (confirm('„Åì„ÅÆ„ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†„Åã„ÇâÈÄÄÂá∫„Åó„Åæ„Åô„ÅãÔºü')) {
                fetch(`/rooms/${roomId}/leave`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('ÈÄÄÂá∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                });
            }
        }

        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                
                // WebSocketÊé•Á∂öÂÆå‰∫ÜÊôÇ„Å´„Éè„Éº„Éà„Éì„Éº„Éà„ÇíÈÄÅ‰ø°„Åó„Å¶„Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖã„ÇíÁ¢∫ÂÆü„Å´„Åô„Çã
                setTimeout(() => {
                    sendHeartbeat();
                }, 1000);
                
                // ÁèæÂú®„ÅÆ„ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†„Å´ÂèÇÂä†
                currentSubscription = stompClient.subscribe(`/topic/chatroom/${currentRoomId}`, function (message) {
                    if (debugEnabled) {
                        console.log('„É°„ÉÉ„Çª„Éº„Ç∏Âèó‰ø° (room ' + currentRoomId + '):', message.body);
                    }
                    const messageData = JSON.parse(message.body);
                    showMessage(messageData);
                    
                    // ÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†„Å®Áµ±Âêà
                    if (window.notificationManager && messageData.type === 'CHAT') {
                        const roomName = getCurrentRoomName();
                        window.notificationManager.notifyNewMessage(messageData, roomName, currentRoomId);
                    }
                });
                
                // „Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖã„ÅÆË≥ºË™≠
                stompClient.subscribe('/user/queue/status-updates', function (message) {
                    const statusUpdate = JSON.parse(message.body);
                    handleFriendStatusUpdate(statusUpdate);
                });
                
                // „Ç™„É≥„É©„Ç§„É≥„É¶„Éº„Ç∂„ÉºÊï∞„ÅÆË≥ºË™≠
                stompClient.subscribe('/topic/online-count', function (message) {
                    const countUpdate = JSON.parse(message.body);
                    updateOnlineUserCount(countUpdate);
                });
                
                if (debugEnabled) {
                    console.log('ÂàùÊúü„É´„Éº„É†„Å´Ë≥ºË™≠„Åó„Åæ„Åó„Åü:', currentRoomId);
                }
                
                // „É¶„Éº„Ç∂„ÉºÂèÇÂä†ÈÄöÁü•
                stompClient.send("/app/chat.addUser", {}, JSON.stringify({
                    senderUsername: currentUser,
                    chatRoomId: currentRoomId,
                    type: 'JOIN'
                }));
                
                // „Ç™„É≥„É©„Ç§„É≥„Éï„É¨„É≥„Éâ‰∏ÄË¶ß„ÇíÂàùÊúüË™≠„ÅøËæº„Åø
                loadOnlineFriends();
                
                // Âç≥Â∫ß„Å´„Éè„Éº„Éà„Éì„Éº„Éà„ÇíÈÄÅ‰ø°„Åó„Å¶„Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖã„ÇíÁ¢∫ÂÆü„Å´„Åô„Çã
                sendHeartbeat();
                
                // „Éè„Éº„Éà„Éì„Éº„Éà„Çø„Ç§„Éû„Éº„ÇíÈñãÂßã
                startHeartbeat();
                
                // URLÊåáÂÆö„É´„Éº„É†„Åå„ÅÇ„Çå„Å∞Âàá„ÇäÊõø„Åà
                initializeRoomFromUrl();
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
            console.log("Disconnected");
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const messageContent = messageInput.value.trim();
            
            if (messageContent && stompClient) {
                // ÈÄÅ‰ø°„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ„Åó„Å¶„É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„Å´„Åô„Çã
                sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                sendButton.disabled = true;
                
                const message = {
                    content: messageContent,
                    chatRoomId: currentRoomId,
                    senderUsername: currentUser,
                    timestamp: new Date().toISOString(),
                    type: 'CHAT'
                };
                
                if (debugEnabled) {
                    console.log('„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°:', message);
                }
                
                stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(message));
                messageInput.value = '';
                
                // 1ÁßíÂæå„Å´ÈÄÅ‰ø°„Éú„Çø„É≥„ÇíÂÖÉ„Å´Êàª„Åô
                setTimeout(() => {
                    sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    sendButton.disabled = false;
                    sendButton.classList.add('pulse'); // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú„ÇíÂÜçÈñã
                }, 1000);
            }
        }

        function showMessage(message) {
            const chatContainer = document.getElementById('chat-container');
            const messageElement = document.createElement('div');
            
            if (message.type === 'JOIN' || message.type === 'LEAVE') {
                messageElement.innerHTML = `
                    <div class="alert alert-info small text-center mb-2" style="border: none; background: linear-gradient(135deg, #17a2b8, #138496); color: white;">
                        <i class="fas fa-info-circle me-1"></i>
                        ${message.content}
                    </div>
                `;
            } else {
                const isCurrentUser = message.senderUsername === currentUser;
                const time = new Date(message.timestamp).toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                const username = message.senderUsername || message.sender;
                const userId = message.userId || message.senderId;
                
                messageElement.className = `message d-flex ${isCurrentUser ? 'justify-content-end' : 'justify-content-start'}`;
                
                messageElement.innerHTML = `
                    <div class="message-bubble ${isCurrentUser ? 'own-message' : 'other-message'}">
                        ${!isCurrentUser ? `
                            <div class="message-header">
                                ${message.senderAvatarUrl ? `
                                    <img src="${message.senderAvatarUrl}" 
                                         class="rounded-circle me-2 user-avatar-clickable" 
                                         width="24" 
                                         height="24" 
                                         style="cursor: pointer; object-fit: cover;" 
                                         data-user-id="${userId}"
                                         data-username="${username}"
                                         onclick="showUserContextMenu(event, this)"
                                         title="„É¶„Éº„Ç∂„Éº„É°„Éã„É•„Éº„ÇíË°®Á§∫"
                                         alt="„Ç¢„Éê„Çø„Éº">
                                ` : `
                                    <i class="fas fa-user-circle me-1 user-avatar-clickable" 
                                       style="cursor: pointer; color: #007bff;" 
                                       data-user-id="${userId}"
                                       data-username="${username}"
                                       onclick="showUserContextMenu(event, this)"
                                       title="„É¶„Éº„Ç∂„Éº„É°„Éã„É•„Éº„ÇíË°®Á§∫"></i>
                                `}
                                <span class="username-clickable" 
                                      style="cursor: pointer; color: #007bff;"
                                      data-user-id="${userId}"
                                      data-username="${username}"
                                      onclick="showUserContextMenu(event, this)"
                                      title="„É¶„Éº„Ç∂„Éº„É°„Éã„É•„Éº„ÇíË°®Á§∫">${message.senderDisplayName || username}</span>
                            </div>
                        ` : ''}
                        <div class="message-content">
                            ${message.content}
                        </div>
                        <div class="message-time mt-1" style="font-size: 0.75rem; opacity: 0.7;">
                            <i class="fas fa-clock me-1"></i>
                            <span>${time}</span>
                        </div>
                    </div>
                `;
            }
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // „Éò„É´„Éë„ÉºÈñ¢Êï∞
        function getCurrentRoomName() {
            const activeRoomElement = document.querySelector('.room-item.active .fw-bold');
            return activeRoomElement ? activeRoomElement.textContent.trim() : '„ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†';
        }
        
        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶Ë®≠ÂÆöÔºàÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†„Åß‰ΩøÁî®Ôºâ
        window.switchRoom = function(roomId, roomName) {
            switchRoomInternal(roomId, roomName);
        };

        // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„Å´„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅÆ‰∏ÄÁï™‰∏ã„Åæ„Åß„Çπ„ÇØ„É≠„Éº„É´
        window.addEventListener('load', function () {
            const chatContainer = document.getElementById('chat-container');
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // ÁèæÂú®„ÅÆ„É´„Éº„É†„Çí„Éè„Ç§„É©„Ç§„Éà
            console.log('„Éö„Éº„Ç∏„É≠„Éº„ÉâÂÆå‰∫Ü - ÁèæÂú®„ÅÆ„É´„Éº„É†ID:', currentRoomId);
            updateActiveRoomInSidebar(currentRoomId);
            
            // „É´„Éº„É†„Ç¢„Ç§„ÉÜ„É†„Å´„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÇíËøΩÂä†Ôºà„Çà„ÇäÁ¢∫ÂÆü„Å™ÊñπÊ≥ïÔºâ
            addRoomClickListeners();
            
            connect();
            loadRoomHistory(currentRoomId);
        });
        
        // „É´„Éº„É†„ÇØ„É™„ÉÉ„ÇØ„É™„Çπ„Éä„Éº„ÇíËøΩÂä†„Åô„ÇãÈñ¢Êï∞
        function addRoomClickListeners() {
            console.log('Adding room click listeners...');
            const roomElements = document.querySelectorAll('.room-clickable');
            console.log('Found room elements:', roomElements.length);
            
            roomElements.forEach((roomElement, index) => {
                console.log(`Setting up listener for room ${index}:`, roomElement.dataset);
                
                // Êó¢Â≠ò„ÅÆ„É™„Çπ„Éä„Éº„ÇíÂâäÈô§ÔºàÈáçË§á„ÇíÈò≤„ÅêÔºâ
                roomElement.removeEventListener('click', handleRoomClick);
                
                // Êñ∞„Åó„ÅÑ„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
                roomElement.addEventListener('click', handleRoomClick);
            });
        }
        
        // „É´„Éº„É†„ÇØ„É™„ÉÉ„ÇØ„Éè„É≥„Éâ„É©„Éº
        function handleRoomClick(event) {
            console.log('Room clicked:', this);
            switchRoomFromElement(this);
        }
        
        // DOM„ÅåË™≠„ÅøËæº„Åæ„Çå„ÅüÊôÇÁÇπ„Åß„ÇÇ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            setTimeout(addRoomClickListeners, 100); // Â∞ë„ÅóÈÅÖÂª∂„ÇíÂÖ•„Çå„Çã
            
            // „Ç§„Éô„É≥„ÉàÂßîË≠≤„Åß„É´„Éº„É†„ÇØ„É™„ÉÉ„ÇØ„ÇíÂá¶ÁêÜÔºà„Çà„ÇäÁ¢∫ÂÆüÔºâ
            document.addEventListener('click', function(event) {
                const roomElement = event.target.closest('.room-clickable');
                if (roomElement) {
                    console.log('Room clicked via delegation:', roomElement);
                    event.preventDefault();
                    event.stopPropagation();
                    switchRoomFromElement(roomElement);
                }
            });
        });

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // „Éö„Éº„Ç∏„Ç¢„É≥„É≠„Éº„ÉâÊôÇ„Å´ÂàáÊñ≠
        window.addEventListener('beforeunload', function () {
            disconnect();
        });

        // „Éñ„É©„Ç¶„Ç∂„ÅÆÊàª„Çã/ÈÄ≤„ÇÄ„Éú„Çø„É≥ÂØæÂøú
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.roomId) {
                console.log('Handling popstate:', event.state);
                // URL„Åã„Çâ„É´„Éº„É†ÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶„É´„Éº„É†Âàá„ÇäÊõø„Åà
                const roomId = event.state.roomId;
                const roomName = event.state.roomName || '„É´„Éº„É† ' + roomId;
                switchRoomInternal(roomId, roomName);
            } else {
                // URL„Éë„É©„É°„Éº„Çø„Åã„Çâ„É´„Éº„É†ÊÉÖÂ†±„ÇíÂèñÂæó
                const urlParams = new URLSearchParams(window.location.search);
                const roomParam = urlParams.get('room');
                if (roomParam) {
                    const roomId = parseInt(roomParam);
                    if (!isNaN(roomId) && roomId !== currentRoomId) {
                        // „É´„Éº„É†Ë¶ÅÁ¥†„ÇíÊé¢„Åó„Å¶Âàá„ÇäÊõø„Åà
                        const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
                        if (roomElement) {
                            switchRoomFromElement(roomElement);
                        }
                    }
                }
            }
        });

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆ„É´„Éº„É†ÈÅ∏ÊäûÂá¶ÁêÜ
        function initializeRoomFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            
            if (roomParam) {
                const roomId = parseInt(roomParam);
                if (!isNaN(roomId)) {
                    console.log('URLÊåáÂÆö„É´„Éº„É†:', roomId);
                    // Â∞ë„ÅóÈÅÖÂª∂„Åó„Å¶„É´„Éº„É†Ë¶ÅÁ¥†„ÅåÊèèÁîª„Åï„Çå„Å¶„Åã„ÇâÂÆüË°å
                    setTimeout(() => {
                        const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
                        if (roomElement) {
                            console.log('URLÊåáÂÆö„É´„Éº„É†„Å´Âàá„ÇäÊõø„Åà:', roomElement);
                            switchRoomFromElement(roomElement);
                        } else {
                            console.warn('ÊåáÂÆö„Åï„Çå„Åü„É´„Éº„É†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', roomId);
                        }
                    }, 500);
                }
            }
        }
        
        // „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥Ê©üËÉΩ
        function toggleOnlineStatus() {
            const statuses = [
                { value: 'ONLINE', label: '„Ç™„É≥„É©„Ç§„É≥', icon: 'fas fa-circle text-success' },
                { value: 'AWAY', label: 'Èõ¢Â∏≠‰∏≠', icon: 'fas fa-circle text-warning' },
                { value: 'BUSY', label: 'Âèñ„ÇäËæº„Åø‰∏≠', icon: 'fas fa-circle text-danger' },
                { value: 'OFFLINE', label: '„Ç™„Éï„É©„Ç§„É≥', icon: 'fas fa-circle text-secondary' }
            ];
            
            // „É¢„Éº„ÉÄ„É´HTML‰ΩúÊàê
            const modalHtml = `
                <div class="modal fade" id="statusModal" tabindex="-1">
                    <div class="modal-dialog modal-sm">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h6 class="modal-title">
                                    <i class="fas fa-power-off me-2"></i>„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥
                                </h6>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="list-group">
                                    ${statuses.map(status => `
                                        <button type="button" class="list-group-item list-group-item-action" 
                                                onclick="changeStatus('${status.value}')">
                                            <i class="${status.icon} me-2"></i>
                                            ${status.label}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Êó¢Â≠ò„ÅÆ„É¢„Éº„ÉÄ„É´„ÇíÂâäÈô§
            const existingModal = document.getElementById('statusModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Êñ∞„Åó„ÅÑ„É¢„Éº„ÉÄ„É´„ÇíËøΩÂä†
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            const modal = new bootstrap.Modal(document.getElementById('statusModal'));
            modal.show();
        }
        
        function changeStatus(status) {
            fetch('/profile/status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: status })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                    const modal = bootstrap.Modal.getInstance(document.getElementById('statusModal'));
                    modal.hide();
                    
                    // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫Ôºà‰ªªÊÑèÔºâ
                    console.log('„Çπ„ÉÜ„Éº„Çø„Çπ„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü:', status);
                } else {
                    alert('„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            });
        }
    </script>

    <!-- „É¶„Éº„Ç∂„Éº„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº -->
    <div class="dropdown-menu" id="userContextMenu" style="display: none; position: absolute; z-index: 1050;">
        <a class="dropdown-item" href="#" onclick="viewUserProfile()">
            <i class="fas fa-user me-2"></i>„Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫
        </a>
        <a class="dropdown-item" href="#" onclick="sendFriendRequest()">
            <i class="fas fa-user-plus me-2"></i>„Éï„É¨„É≥„ÉâÁî≥Ë´ã
        </a>
        <div class="dropdown-divider"></div>
        <a class="dropdown-item text-warning" href="#" onclick="blockUser()">
            <i class="fas fa-ban me-2"></i>„Éñ„É≠„ÉÉ„ÇØ
        </a>
        <a class="dropdown-item text-danger" href="#" onclick="reportUser()">
            <i class="fas fa-exclamation-triangle me-2"></i>ÈÄöÂ†±
        </a>
    </div>

    <!-- IDÊ§úÁ¥¢„É¢„Éº„ÉÄ„É´ -->
    <div class="modal fade" id="userSearchModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-search me-2"></i>„É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="searchInput" class="form-label">„É¶„Éº„Ç∂„ÉºÂêç„Éª„Éï„É¨„É≥„Éâ„Ç≥„Éº„Éâ„ÉªID„ÅßÊ§úÁ¥¢</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchInput" placeholder="„É¶„Éº„Ç∂„ÉºÂêç„ÄÅ8Ê°Å„ÅÆ„Éï„É¨„É≥„Éâ„Ç≥„Éº„Éâ„ÄÅ„Åæ„Åü„ÅØID„ÇíÂÖ•Âäõ...">
                            <button class="btn btn-primary" onclick="searchUsers()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            „Éï„É¨„É≥„Éâ„Ç≥„Éº„Éâ„ÅØ8Ê°Å„ÅÆËã±Êï∞Â≠ó„Åß„ÅôÔºà‰æãÔºöAB12CD34Ôºâ
                        </div>
                    </div>
                    <div id="searchResults"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÈÄöÂ†±„É¢„Éº„ÉÄ„É´ -->
    <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>„É¶„Éº„Ç∂„ÉºÈÄöÂ†±
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>„É¶„Éº„Ç∂„Éº„Äå<span id="reportTargetUsername"></span>„Äç„ÇíÈÄöÂ†±„Åó„Åæ„Åô„ÄÇ</p>
                    <div class="mb-3">
                        <label for="reportReason" class="form-label">ÈÄöÂ†±ÁêÜÁî±</label>
                        <select class="form-select" id="reportReason" required>
                            <option value="">ÁêÜÁî±„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="SPAM">„Çπ„Éë„É†„ÉªËø∑ÊÉëË°åÁÇ∫</option>
                            <option value="HARASSMENT">„Éè„É©„Çπ„É°„É≥„Éà„ÉªÂ´å„Åå„Çâ„Åõ</option>
                            <option value="INAPPROPRIATE_CONTENT">‰∏çÈÅ©Âàá„Å™„Ç≥„É≥„ÉÜ„É≥„ÉÑ</option>
                            <option value="HATE_SPEECH">„Éò„Ç§„Éà„Çπ„Éî„Éº„ÉÅ</option>
                            <option value="IMPERSONATION">„Å™„Çä„Åô„Åæ„Åó</option>
                            <option value="VIOLENCE_THREAT">Êö¥ÂäõÁöÑ„Å™ËÑÖËø´</option>
                            <option value="PRIVACY_VIOLATION">„Éó„É©„Ç§„Éê„Ç∑„Éº‰æµÂÆ≥</option>
                            <option value="FRAUD">Ë©êÊ¨∫„Éª‰∏çÊ≠£Ë°åÁÇ∫</option>
                            <option value="OTHER">„Åù„ÅÆ‰ªñ</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="reportDescription" class="form-label">Ë©≥Á¥∞Ë™¨ÊòéÔºà‰ªªÊÑèÔºâ</label>
                        <textarea class="form-control" id="reportDescription" rows="3" placeholder="Ë©≥Á¥∞„Å™Ë™¨Êòé„Åå„ÅÇ„Çå„Å∞ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="button" class="btn btn-danger" onclick="submitReport()">ÈÄöÂ†±„Åô„Çã</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // „É¶„Éº„Ç∂„Éº„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„ÉºÈñ¢ÈÄ£„ÅÆÂ§âÊï∞
        let contextMenuTargetUserId = null;
        let contextMenuTargetUsername = null;

        // „Éï„É¨„É≥„ÉâÁî≥Ë´ãÈÄöÁü•„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkFriendNotifications() {
            fetch('/friends/api/notification-count')
                .then(response => response.json())
                .then(data => {
                    const badge = document.getElementById('friendNotificationBadge');
                    const count = document.getElementById('friendNotificationCount');
                    
                    if (data.count > 0) {
                        badge.style.display = 'block';
                        count.textContent = data.count;
                    } else {
                        badge.style.display = 'none';
                    }
                })
                .catch(error => console.error('ÈÄöÁü•„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº:', error));
        }

        // „É¶„Éº„Ç∂„Éº„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº„ÅÆË°®Á§∫
        function showUserContextMenu(event, element) {
            event.preventDefault();
            event.stopPropagation();
            
            contextMenuTargetUserId = element.dataset.userId;
            contextMenuTargetUsername = element.dataset.username;
            
            const menu = document.getElementById('userContextMenu');
            const rect = element.getBoundingClientRect();
            
            menu.style.display = 'block';
            menu.style.left = (rect.left + window.scrollX) + 'px';
            menu.style.top = (rect.bottom + window.scrollY + 5) + 'px';
            
            // „ÇØ„É™„ÉÉ„ÇØÂ§ñ„Åó„ÅßÈñâ„Åò„Çã
            document.addEventListener('click', hideUserContextMenu, { once: true });
        }

        function hideUserContextMenu() {
            document.getElementById('userContextMenu').style.display = 'none';
        }

        // „Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫
        function viewUserProfile() {
            if (contextMenuTargetUserId) {
                window.open(`/profile/${contextMenuTargetUserId}`, '_blank');
            }
            hideUserContextMenu();
        }

        // „Éï„É¨„É≥„ÉâÁî≥Ë´ãÈÄÅ‰ø°
        function sendFriendRequest() {
            if (!contextMenuTargetUserId) return;
            
            fetch('/friends/request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ targetUserId: contextMenuTargetUserId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`${contextMenuTargetUsername}„Å´„Éï„É¨„É≥„ÉâÁî≥Ë´ã„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü`);
                } else {
                    alert(data.message || '„Éï„É¨„É≥„ÉâÁî≥Ë´ã„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            })
            .catch(error => {
                console.error('„Éï„É¨„É≥„ÉâÁî≥Ë´ã„Ç®„É©„Éº:', error);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            });
            
            hideUserContextMenu();
        }

        // „É¶„Éº„Ç∂„Éº„Éñ„É≠„ÉÉ„ÇØ
        function blockUser() {
            if (!contextMenuTargetUserId || !confirm(`${contextMenuTargetUsername}„Çí„Éñ„É≠„ÉÉ„ÇØ„Åó„Åæ„Åô„ÅãÔºü`)) return;
            
            fetch('/friends/block', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ targetUserId: contextMenuTargetUserId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`${contextMenuTargetUsername}„Çí„Éñ„É≠„ÉÉ„ÇØ„Åó„Åæ„Åó„Åü`);
                } else {
                    alert(data.message || '„Éñ„É≠„ÉÉ„ÇØ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            })
            .catch(error => {
                console.error('„Éñ„É≠„ÉÉ„ÇØ„Ç®„É©„Éº:', error);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            });
            
            hideUserContextMenu();
        }

        // ÈÄöÂ†±„É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function reportUser() {
            if (!contextMenuTargetUserId) return;
            
            document.getElementById('reportTargetUsername').textContent = contextMenuTargetUsername;
            const modal = new bootstrap.Modal(document.getElementById('reportModal'));
            modal.show();
            
            hideUserContextMenu();
        }

        // ÈÄöÂ†±ÈÄÅ‰ø°
        function submitReport() {
            const reason = document.getElementById('reportReason').value;
            const description = document.getElementById('reportDescription').value;
            
            if (!reason) {
                alert('ÈÄöÂ†±ÁêÜÁî±„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            fetch('/api/reports', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    reportedUserId: contextMenuTargetUserId,
                    reason: reason,
                    description: description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ÈÄöÂ†±„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ„ÅîÂçîÂäõ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
                    modal.hide();
                    
                    // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
                    document.getElementById('reportReason').value = '';
                    document.getElementById('reportDescription').value = '';
                } else {
                    alert(data.message || 'ÈÄöÂ†±„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            })
            .catch(error => {
                console.error('ÈÄöÂ†±„Ç®„É©„Éº:', error);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            });
        }

        // „É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢„É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showUserSearchModal() {
            const modal = new bootstrap.Modal(document.getElementById('userSearchModal'));
            modal.show();
        }

        // „É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢ÂÆüË°å
        function searchUsers() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            fetch(`/api/users/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(users => {
                    displaySearchResults(users);
                })
                .catch(error => {
                    console.error('Ê§úÁ¥¢„Ç®„É©„Éº:', error);
                    alert('Ê§úÁ¥¢‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                });
        }

        // Ê§úÁ¥¢ÁµêÊûúË°®Á§∫
        function displaySearchResults(users) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (users.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="text-center text-muted p-3">
                        <i class="fas fa-search fa-2x mb-2"></i>
                        <p>Ë©≤ÂΩì„Åô„Çã„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</p>
                    </div>
                `;
                return;
            }
            
            resultsContainer.innerHTML = users.map(user => `
                <div class="d-flex align-items-center p-3 border rounded mb-2" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                         style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;">
                        ${user.username.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold" style="color: #2d3748;">${escapeHtml(user.username)}</div>
                        <small class="text-muted d-block">
                            <i class="fas fa-hashtag me-1"></i>ID: ${user.id}
                        </small>
                        <small class="text-muted d-block">
                            <i class="fas fa-code me-1"></i>„Éï„É¨„É≥„Éâ„Ç≥„Éº„Éâ: ${user.friendCode || '„Å™„Åó'}
                        </small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewUserProfileById(${user.id})" title="„Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫">
                            <i class="fas fa-user"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="sendFriendRequestById(${user.id}, '${escapeHtml(user.username)}')" title="„Éï„É¨„É≥„ÉâÁî≥Ë´ã">
                            <i class="fas fa-user-plus"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Ê§úÁ¥¢ÁµêÊûú„Åã„Çâ„Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫
        function viewUserProfileById(userId) {
            window.open(`/profile/${userId}`, '_blank');
        }

        // Ê§úÁ¥¢ÁµêÊûú„Åã„Çâ„Éï„É¨„É≥„ÉâÁî≥Ë´ã
        function sendFriendRequestById(userId, username) {
            fetch('/friends/request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ targetUserId: userId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`${username}„Å´„Éï„É¨„É≥„ÉâÁî≥Ë´ã„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü`);
                } else {
                    alert(data.message || '„Éï„É¨„É≥„ÉâÁî≥Ë´ã„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            })
            .catch(error => {
                console.error('„Éï„É¨„É≥„ÉâÁî≥Ë´ã„Ç®„É©„Éº:', error);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            });
        }

        // HTML„Ç®„Çπ„Ç±„Éº„Éó
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Enter„Ç≠„Éº„Åß„ÅÆÊ§úÁ¥¢
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchUsers();
                    }
                });
            }
            
            // „Éï„É¨„É≥„ÉâÈÄöÁü•„ÇíÂÆöÊúüÁöÑ„Å´„ÉÅ„Çß„ÉÉ„ÇØ
            checkFriendNotifications();
            setInterval(checkFriendNotifications, 30000); // 30Áßí„Åî„Å®
            
            // „Éû„ÉÉ„ÉÅ„É≥„Ç∞Áµ±Ë®à„ÇíË™≠„ÅøËæº„Åø
            loadMatchingStats();
        });

        // „É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞Èñ¢ÈÄ£„ÅÆÈñ¢Êï∞
        function showQuickMatchModal() {
            const modal = new bootstrap.Modal(document.getElementById('quickMatchModal'));
            modal.show();
            startQuickMatch();
        }

        function startQuickMatch() {
            // UI „Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('quickMatchStatus').style.display = 'block';
            document.getElementById('quickMatchResult').style.display = 'none';
            document.getElementById('quickMatchNoResult').style.display = 'none';
            
            // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            const progressBar = document.getElementById('matchProgress');
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress > 90) progress = 90;
                progressBar.style.width = progress + '%';
            }, 200);

            // „É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞ API Âëº„Å≥Âá∫„Åó
            fetch('/api/random-matching/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                
                setTimeout(() => {
                    if (data.success && data.roomId) {
                        // „Éû„ÉÉ„ÉÅÊàêÂäü
                        currentMatchRoomId = data.roomId;
                        document.getElementById('compatibilityScore').textContent = data.compatibilityScore + '%';
                        document.getElementById('quickMatchStatus').style.display = 'none';
                        document.getElementById('quickMatchResult').style.display = 'block';
                    } else {
                        // „Éû„ÉÉ„ÉÅÂ§±Êïó
                        document.getElementById('quickMatchStatus').style.display = 'none';
                        document.getElementById('quickMatchNoResult').style.display = 'block';
                    }
                }, 500);
            })
            .catch(error => {
                clearInterval(progressInterval);
                console.error('Error:', error);
                document.getElementById('quickMatchStatus').style.display = 'none';
                document.getElementById('quickMatchNoResult').style.display = 'block';
            });
        }

        function startMatchedChat() {
            if (currentMatchRoomId) {
                bootstrap.Modal.getInstance(document.getElementById('quickMatchModal')).hide();
                switchRoom(currentMatchRoomId, '„É©„É≥„ÉÄ„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞');
            }
        }

        function findAnotherMatch() {
            startQuickMatch();
        }

        function loadMatchingStats() {
            fetch('/random-matching/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('todayMatches').textContent = data.todayMatches || 0;
                    document.getElementById('totalMatches').textContent = data.totalMatches || 0;
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                });
        }

        // CSS „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>

    <!-- „Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖãÁÆ°ÁêÜJavaScript -->
    <script>
        // „Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖãÁÆ°ÁêÜÁî®„ÅÆÂ§âÊï∞
        let heartbeatInterval = null;
        let onlineFriends = [];

        // „Ç™„É≥„É©„Ç§„É≥„Éï„É¨„É≥„Éâ‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„Åø
        function loadOnlineFriends() {
            fetch('/api/online/friends')
                .then(response => response.json())
                .then(friends => {
                    onlineFriends = friends;
                    updateOnlineFriendsDisplay();
                })
                .catch(error => {
                    console.error('„Ç™„É≥„É©„Ç§„É≥„Éï„É¨„É≥„ÉâÂèñÂæó„Ç®„É©„Éº:', error);
                });
        }

        // „Ç™„É≥„É©„Ç§„É≥„Éï„É¨„É≥„ÉâË°®Á§∫„ÇíÊõ¥Êñ∞
        function updateOnlineFriendsDisplay() {
            const friendsList = document.getElementById('onlineFriendsList');
            const friendsCount = document.getElementById('onlineFriendsCount');
            const noOnlineFriends = document.getElementById('noOnlineFriends');

            friendsCount.textContent = onlineFriends.length;

            if (onlineFriends.length === 0) {
                friendsList.innerHTML = `
                    <div class="text-center py-3 text-muted" id="noOnlineFriends">
                        <i class="fas fa-user-slash mb-2"></i>
                        <div>„Ç™„É≥„É©„Ç§„É≥„ÅÆ„Éï„É¨„É≥„Éâ„ÅØ„ÅÑ„Åæ„Åõ„Çì</div>
                    </div>
                `;
            } else {
                let friendsHtml = '';
                onlineFriends.forEach(friend => {
                    const statusIcon = getStatusIcon(friend.status);
                    const statusColor = getStatusColor(friend.status);
                    const statusText = getStatusText(friend.status);
                    
                    friendsHtml += `
                        <div class="list-group-item list-group-item-action d-flex align-items-center online-friend-item" 
                             data-user-id="${friend.userId}" 
                             style="cursor: pointer;"
                             onclick="openFriendChat('${friend.username}', '${friend.displayName}', ${friend.userId})">
                            <div class="me-3 position-relative">
                                <i class="fas fa-user-circle fa-2x text-secondary"></i>
                                <span class="position-absolute bottom-0 end-0 p-1 bg-white rounded-circle">
                                    <i class="fas ${statusIcon} fa-xs" style="color: ${statusColor};"></i>
                                </span>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-bold">${friend.displayName}</div>
                                <small class="text-muted">${statusText}</small>
                            </div>
                            <div class="text-muted">
                                <i class="fas fa-comment"></i>
                            </div>
                        </div>
                    `;
                });
                friendsList.innerHTML = friendsHtml;
            }
        }

        // „Éï„É¨„É≥„Éâ„ÅÆÁä∂ÊÖãÊõ¥Êñ∞„ÇíÂá¶ÁêÜ
        function handleFriendStatusUpdate(statusUpdate) {
            if (statusUpdate.type === 'friend_status_change') {
                console.log('„Éï„É¨„É≥„ÉâÁä∂ÊÖãÊõ¥Êñ∞:', statusUpdate);
                
                // „Ç™„É≥„É©„Ç§„É≥„Éï„É¨„É≥„Éâ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
                if (statusUpdate.isOnline) {
                    // „Éï„É¨„É≥„Éâ„Åå„Ç™„É≥„É©„Ç§„É≥„Å´„Å™„Å£„Åü
                    const existingFriend = onlineFriends.find(f => f.userId === statusUpdate.userId);
                    if (!existingFriend) {
                        onlineFriends.push({
                            userId: statusUpdate.userId,
                            username: statusUpdate.username,
                            displayName: statusUpdate.displayName,
                            status: statusUpdate.status || 'online'
                        });
                    } else {
                        // Êó¢Â≠ò„Éï„É¨„É≥„Éâ„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                        existingFriend.status = statusUpdate.status || 'online';
                    }
                } else {
                    // „Éï„É¨„É≥„Éâ„Åå„Ç™„Éï„É©„Ç§„É≥„Å´„Å™„Å£„Åü
                    onlineFriends = onlineFriends.filter(f => f.userId !== statusUpdate.userId);
                }
                
                updateOnlineFriendsDisplay();
            }
        }

        // „Ç™„É≥„É©„Ç§„É≥„É¶„Éº„Ç∂„ÉºÊï∞„ÇíÊõ¥Êñ∞
        function updateOnlineUserCount(countUpdate) {
            // „Åì„Åì„ÅßÂÖ®‰Ωì„ÅÆ„Ç™„É≥„É©„Ç§„É≥„É¶„Éº„Ç∂„ÉºÊï∞Ë°®Á§∫„ÇíÊõ¥Êñ∞„Åß„Åç„Åæ„Åô
            console.log('„Ç™„É≥„É©„Ç§„É≥„É¶„Éº„Ç∂„ÉºÊï∞Êõ¥Êñ∞:', countUpdate);
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„Åü„Ç¢„Ç§„Ç≥„É≥„ÇíÂèñÂæó
        function getStatusIcon(status) {
            switch(status) {
                case 'online': return 'fa-circle';
                case 'away': return 'fa-clock';
                case 'busy': return 'fa-minus-circle';
                default: return 'fa-circle';
            }
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„ÅüËâ≤„ÇíÂèñÂæó
        function getStatusColor(status) {
            switch(status) {
                case 'online': return '#28a745';
                case 'away': return '#ffc107';
                case 'busy': return '#dc3545';
                default: return '#6c757d';
            }
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„Åü„ÉÜ„Ç≠„Çπ„Éà„ÇíÂèñÂæó
        function getStatusText(status) {
            switch(status) {
                case 'online': return '„Ç™„É≥„É©„Ç§„É≥';
                case 'away': return 'Èõ¢Â∏≠‰∏≠';
                case 'busy': return 'Âèñ„ÇäËæº„Åø‰∏≠';
                default: return '„Ç™„É≥„É©„Ç§„É≥';
            }
        }

        // „Éï„É¨„É≥„Éâ„Å®„ÅÆ„ÉÅ„É£„ÉÉ„Éà„ÇíÈñã„Åè
        function openFriendChat(username, displayName, userId) {
            // „Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫„Åæ„Åü„ÅØDM„ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†‰ΩúÊàê„ÅÆÂá¶ÁêÜ
            window.open(`/profile/${userId}`, '_blank');
        }

        // ‰∏ÄÂõû„ÅÆ„Éè„Éº„Éà„Éì„Éº„Éà„ÇíÈÄÅ‰ø°
        function sendHeartbeat() {
            fetch('/api/online/heartbeat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('„Éè„Éº„Éà„Éì„Éº„ÉàÈÄÅ‰ø°ÊàêÂäü - „Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖãÁ¢∫Ë™ç');
                } else {
                    console.warn('„Éè„Éº„Éà„Éì„Éº„ÉàÂ§±Êïó:', data.message);
                }
            })
            .catch(error => {
                console.error('„Éè„Éº„Éà„Éì„Éº„Éà„Ç®„É©„Éº:', error);
            });
        }

        // „Éè„Éº„Éà„Éì„Éº„Éà„ÇíÈñãÂßã
        function startHeartbeat() {
            // 30Áßí„Åî„Å®„Å´„Éè„Éº„Éà„Éì„Éº„Éà„ÇíÈÄÅ‰ø°
            heartbeatInterval = setInterval(() => {
                fetch('/api/online/heartbeat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        console.warn('„Éè„Éº„Éà„Éì„Éº„ÉàÂ§±Êïó:', data.message);
                    }
                })
                .catch(error => {
                    console.error('„Éè„Éº„Éà„Éì„Éº„Éà„Ç®„É©„Éº:', error);
                });
            }, 30000);
        }

        // „Éè„Éº„Éà„Éì„Éº„Éà„ÇíÂÅúÊ≠¢
        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }

        // „É¶„Éº„Ç∂„Éº„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂ§âÊõ¥
        function changeUserStatus(status) {
            fetch('/api/online/status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: status })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞ÊàêÂäü:', status);
                } else {
                    console.error('„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞Â§±Êïó:', data.message);
                }
            })
            .catch(error => {
                console.error('„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞„Ç®„É©„Éº:', error);
            });
        }

        // „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„Å´„Éè„Éº„Éà„Éì„Éº„Éà„ÇíÂÅúÊ≠¢
        window.addEventListener('beforeunload', function() {
            stopHeartbeat();
        });

        // „Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖãÂàá„ÇäÊõø„ÅàÔºàÊó¢Â≠ò„ÅÆtoggleOnlineStatusÈñ¢Êï∞„ÇíÊã°ÂºµÔºâ
        function toggleOnlineStatus() {
            const options = [
                { value: 'online', text: '„Ç™„É≥„É©„Ç§„É≥', icon: 'fa-circle', color: '#28a745' },
                { value: 'away', text: 'Èõ¢Â∏≠‰∏≠', icon: 'fa-clock', color: '#ffc107' },
                { value: 'busy', text: 'Âèñ„ÇäËæº„Åø‰∏≠', icon: 'fa-minus-circle', color: '#dc3545' }
            ];
            
            let optionsHtml = '';
            options.forEach(option => {
                optionsHtml += `
                    <button class="btn btn-outline-secondary w-100 mb-2 text-start" 
                            onclick="changeUserStatus('${option.value}')">
                        <i class="fas ${option.icon} me-2" style="color: ${option.color};"></i>
                        ${option.text}
                    </button>
                `;
            });
            
            const modalHtml = `
                <div class="modal fade" id="statusModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${optionsHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existingModal = document.getElementById('statusModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('statusModal'));
            modal.show();
        }

        // ÂÆöÊúüÁöÑ„Å´„Ç™„É≥„É©„Ç§„É≥„Éï„É¨„É≥„Éâ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
        setInterval(loadOnlineFriends, 60000); // 1ÂàÜ„Åî„Å®

        // „Éû„É´„ÉÅ„Çª„ÉÉ„Ç∑„Éß„É≥Ê©üËÉΩ
        function openMultiSessionTab() {
            // Êñ∞„Åó„ÅÑ„Çø„Éñ„Åß„Éû„É´„ÉÅ„Çª„ÉÉ„Ç∑„Éß„É≥„É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„ÇíÈñã„Åè
            const newTabId = 'tab-' + Math.random().toString(36).substr(2, 8);
            const url = '/multi-session/login?tab=' + newTabId;
            window.open(url, '_blank');
        }
    </script>

    <!-- „ÇØ„Ç§„ÉÉ„ÇØ„Éû„ÉÉ„ÉÅ„É¢„Éº„ÉÄ„É´ -->
    <div class="modal fade" id="quickMatchModal" tabindex="-1" aria-labelledby="quickMatchModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header text-white" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
                    <h5 class="modal-title" id="quickMatchModalLabel">
                        <i class="fas fa-bolt me-2"></i>„ÇØ„Ç§„ÉÉ„ÇØ„Éû„ÉÉ„ÉÅ
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <div id="quickMatchStatus">
                            <i class="fas fa-dice fa-3x mb-3" style="color: #ff6b6b; animation: spin 2s linear infinite;"></i>
                            <h5>ÊúÄÈÅ©„Å™„Éû„ÉÉ„ÉÅ„ÇíÊ§úÁ¥¢‰∏≠...</h5>
                            <p class="text-muted">„ÅÇ„Å™„Åü„Å´ÊúÄÈÅ©„Å™Áõ∏Êâã„ÇíÊé¢„Åó„Å¶„ÅÑ„Åæ„Åô</p>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     style="width: 0%; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);"
                                     id="matchProgress"></div>
                            </div>
                        </div>
                        <div id="quickMatchResult" style="display: none;">
                            <i class="fas fa-heart fa-3x mb-3 text-success"></i>
                            <h5>„Éû„ÉÉ„ÉÅ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„ÅüÔºÅ</h5>
                            <p class="text-muted">Áõ∏ÊÄßÂ∫¶: <span id="compatibilityScore" class="text-primary fw-bold">0%</span></p>
                            <div class="d-grid gap-2 mt-4">
                                <button class="btn btn-success" onclick="startMatchedChat()">
                                    <i class="fas fa-comments me-2"></i>„ÉÅ„É£„ÉÉ„ÉàÈñãÂßã
                                </button>
                                <button class="btn btn-outline-secondary" onclick="findAnotherMatch()">
                                    <i class="fas fa-dice me-2"></i>‰ªñ„ÅÆÁõ∏Êâã„ÇíÊé¢„Åô
                                </button>
                            </div>
                        </div>
                        <div id="quickMatchNoResult" style="display: none;">
                            <i class="fas fa-search fa-3x mb-3 text-warning"></i>
                            <h5>„Éû„ÉÉ„ÉÅ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</h5>
                            <p class="text-muted">ÁèæÂú®„Ç™„É≥„É©„Ç§„É≥„ÅÆÈÅ©Âêà„Åô„ÇãÁõ∏Êâã„Åå„ÅÑ„Åæ„Åõ„Çì</p>
                            <div class="d-grid gap-2 mt-4">
                                <button class="btn btn-primary" onclick="findAnotherMatch()">
                                    <i class="fas fa-redo me-2"></i>ÂÜçÊ§úÁ¥¢
                                </button>
                                <a href="/random-matching" class="btn btn-outline-primary">
                                    <i class="fas fa-cog me-2"></i>Ë©≥Á¥∞Ë®≠ÂÆö
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kawaii Theme JavaScript -->
    <script src="/js/kawaii-theme.js"></script>
    <script>
        // „ÉÅ„É£„ÉÉ„ÉàÂ∞ÇÁî®ÂàùÊúüÂåñ
        function initPageSpecific() {
            // „É°„ÉÉ„Çª„Éº„Ç∏„Å´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú„ÇíËøΩÂä†
            const messages = document.querySelectorAll('.message-bubble');
            messages.forEach((msg, index) => {
                msg.style.animationDelay = (index * 0.1) + 's';
            });
            
            // „É´„Éº„É†È†ÖÁõÆ„Å´„Ç≠„É©„Ç≠„É©ÂäπÊûú
            document.querySelectorAll('.room-item').forEach(room => {
                KawaiiTheme.addSparkle(room);
            });
            
            // „Ç™„É≥„É©„Ç§„É≥„É¶„Éº„Ç∂„ÉºÊï∞„Å´„Éè„Éº„ÉàÂäπÊûú
            document.querySelectorAll('.user-card').forEach(user => {
                user.addEventListener('mouseenter', function() {
                    KawaiiTheme.addHeartBeat(this);
                });
            });
        }
        
        // „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°ÊôÇ„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Âº∑Âåñ
        const originalSendMessage = sendMessage;
        sendMessage = function() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (message) {
                // „Ç≠„É©„Ç≠„É©ÂäπÊûú
                const sparkle = document.createElement('div');
                sparkle.innerHTML = '‚ú®üí´‚ú®';
                sparkle.style.position = 'absolute';
                sparkle.style.top = '50%';
                sparkle.style.left = '50%';
                sparkle.style.transform = 'translate(-50%, -50%)';
                sparkle.style.animation = 'sparkle 1s ease-out forwards';
                sparkle.style.pointerEvents = 'none';
                sparkle.style.zIndex = '1000';
                
                const sendButton = document.querySelector('button[onclick="sendMessage()"]');
                sendButton.style.position = 'relative';
                sendButton.appendChild(sparkle);
                
                setTimeout(() => sparkle.remove(), 1000);
            }
            
            originalSendMessage();
        };
    </script>
    
    <!-- „É¢„Éê„Ç§„É´Áî®JavaScript -->
    <script>
        // „É¢„Éê„Ç§„É´Áî®ÈÄöÁü•„Éê„ÉÉ„Ç∏ÂêåÊúü
        function syncMobileNotifications() {
            const desktopBadge = document.getElementById('friendNotificationBadge');
            const mobileBadge = document.getElementById('mobileNotificationBadge');
            const desktopCount = document.getElementById('friendNotificationCount');
            
            if (desktopBadge && mobileBadge && desktopCount) {
                const count = desktopCount.textContent;
                if (desktopBadge.style.display !== 'none' && count > 0) {
                    mobileBadge.textContent = count;
                    mobileBadge.style.display = 'inline';
                } else {
                    mobileBadge.style.display = 'none';
                }
            }
        }
        
        // ÂÆöÊúüÁöÑ„Å´ÈÄöÁü•„Éê„ÉÉ„Ç∏„ÇíÂêåÊúü
        setInterval(syncMobileNotifications, 1000);
        
        // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„Å´ÂêåÊúü
        document.addEventListener('DOMContentLoaded', syncMobileNotifications);
        
        // ÁîªÈù¢„Çµ„Ç§„Ç∫Â§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜ
        window.addEventListener('resize', function() {
            // „É¢„Éê„Ç§„É´Ë°®Á§∫„Åß„Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅÈñâ„Åò„Çã
            if (window.innerWidth > 768) {
                const mobileDropdown = document.querySelector('.mobile-hamburger .dropdown-menu');
                if (mobileDropdown && mobileDropdown.classList.contains('show')) {
                    const dropdown = bootstrap.Dropdown.getInstance(document.querySelector('.mobile-hamburger .dropdown-toggle'));
                    if (dropdown) {
                        dropdown.hide();
                    }
                }
            }
        });
        
        // „É°„ÉÉ„Çª„Éº„Ç∏ÂÖ•ÂäõÊôÇ„ÅÆ„É¢„Éê„Ç§„É´ÊúÄÈÅ©Âåñ
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('messageInput');
            if (messageInput && window.innerWidth <= 768) {
                messageInput.addEventListener('focus', function() {
                    // „É°„ÉÉ„Çª„Éº„Ç∏„Ç®„É™„Ç¢„ÇíÊúÄ‰∏ãÈÉ®„Å´„Çπ„ÇØ„É≠„Éº„É´
                    setTimeout(function() {
                        const messagesContainer = document.querySelector('.chat-messages');
                        if (messagesContainer) {
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }
                    }, 300);
                });
            }
        });
    </script>
    
    <!-- PWAÊ©üËÉΩ -->
    <script src="/js/pwa.js"></script>
</body>
</html>
