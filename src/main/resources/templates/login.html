<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, interactive-widget=resizes-visual-viewport">
    <title>ğŸŒŸ ãƒ­ã‚°ã‚¤ãƒ³ - ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª</title>
    <!-- PWAè¨­å®š -->
    <link rel="manifest" href="/manifest.json?v=4">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ğŸ’«ChatApp">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
    <link rel="shortcut icon" href="/icon-192.png">
    
    <!-- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–è¨­å®š -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@500;700;800&display=swap" rel="stylesheet">
    <link th:href="@{/css/app-style.css(v=${@appVersion})}" rel="stylesheet">
    <link th:href="@{/css/tenkou.css(v=${@appVersion})}" rel="stylesheet">
    <link th:href="@{/css/common.css(v=${@appVersion})}" rel="stylesheet">
    <!-- çµ±åˆCSSãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ï¼ˆPCãƒ»ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰ -->
</head>
<body>
    <!-- ã‚¢ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ï¼ˆå³ä¸Šå›ºå®šï¼‰ -->
    <button id="install-button" style="display: none; position: fixed; top: 1rem; right: 1rem; z-index: 9999; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 2px solid rgba(102, 126, 234, 0.5); border-radius: 50px; padding: 0.5rem 1rem; font-size: 0.9rem; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); transition: all 0.3s ease;" 
            onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)';" 
            onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 15px rgba(0, 0, 0, 0.2)';">
        <i class="fas fa-download me-1" style="color: #667eea;"></i>
        <span style="color: #667eea; font-weight: 600;">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</span>
    </button>
    
    <div class="login-kontena">
        <div class="container" style="padding: 0;">
            <div class="row justify-content-center" style="margin: 0;">
                <div class="col-12" style="padding: 0;">
                    <div class="text-center" style="margin-bottom: 1rem;">
                        <div style="margin-bottom: 0.5rem;">
                            <i class="fas fa-comments apuri-rogo" style="margin-top: 0;"></i>
                        </div>
                        <h1 class="app-title" style="margin-bottom: 0.25rem;color: #d1c7da; font-family: 'M PLUS Rounded 1c', sans-serif; font-weight: 800;">ãƒ­ã‚°ã‚¤ãƒ³</h1>
                        <!-- <p class="text-white-50 fs-5" style="margin-bottom: 0.5rem;">ğŸ’« ç´ æ•µãªãƒãƒ£ãƒƒãƒˆä½“é¨“ã¸ã‚ˆã†ã“ã</p> -->
                    </div>
                    
                                            <div class="card login-kaado mx-auto">
                        <!-- <div class="login-hedda">
                            <h2 class="mb-0 position-relative">
                                <i class="fas fa-sign-in-alt me-2"></i>ğŸŒŸ ãƒ­ã‚°ã‚¤ãƒ³
                            </h2>
                        </div> -->
                        <div class="login-bodii">
                            <!-- æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
                            <div th:if="${success}" class="alert alert-success fade-in" th:text="${success}">
                                <i class="fas fa-check-circle me-1"></i>
                            </div>
                            
                            <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
                            <div th:if="${error}" class="alert alert-danger fade-in" th:text="${error}">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                            </div>
                            
                            <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                            <div th:if="${param.sessionExpired}" class="alert alert-warning fade-in">
                                <i class="fas fa-info-circle me-1"></i>
                                åˆ¥ã®å ´æ‰€ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã•ã‚ŒãŸãŸã‚ã€ã“ã¡ã‚‰ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ç„¡åŠ¹ã«ãªã‚Šã¾ã—ãŸ
                            </div>
                            
                            <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¶é™ã‚¨ãƒ©ãƒ¼ï¼ˆéæ¨å¥¨ï¼šç¾åœ¨ã¯ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰ -->
                            <div th:if="${param.sessionLimit}" class="alert alert-danger fade-in">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                ãã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™
                            </div>
                            
                            <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
                            <div th:if="${message}" class="alert alert-info fade-in" th:text="${message}">
                                <i class="fas fa-info-circle me-1"></i>
                            </div>
                            
                            <form th:action="@{/login}" method="post">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="username" name="username" 
                                           placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å" required>
                                    <label for="username">
                                        <i class="fas fa-user me-1"></i>ãƒ¦ãƒ¼ã‚¶ãƒ¼å
                                    </label>
                                </div>
                                
                                <div class="form-floating">
                                    <input type="password" class="form-control" id="password" name="password" 
                                           placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
                                    <label for="password">
                                        <i class="fas fa-lock me-1"></i>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
                                    </label>
                                </div>
                                
                                <button type="submit" class="btn login-btn sparkle-on-hover">
                                    <i class="fas fa-sign-in-alt me-2"></i> ãƒ­ã‚°ã‚¤ãƒ³
                                </button>
                            </form>
                            
                            <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸå ´åˆã®ãƒªãƒ³ã‚¯ -->
                            <div class="text-center mt-3">
                                <a href="/passreset" class="text-muted" style="font-size: 0.9rem; text-decoration: none;">
                                    <i class="fas fa-key me-1"></i>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸå ´åˆ
                                </a>
                            </div>
                            
                            <!-- <div class="cute-divider">
                                <span>âœ¨ ã¾ãŸã¯ âœ¨</span>
                            </div> -->
                            
                            <div class="text-center">
                                <div class="row">
                                    <div th:if="${!debugMode}" class="col-12">
                                        <p class="mb-2">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„æ–¹ã¯</p>
                                        <a th:href="@{/register}" class="register-link">
                                            <i class="fas fa-user-plus me-1"></i>ğŸŒŸ æ–°è¦ç™»éŒ²ã¯ã“ã¡ã‚‰
                                        </a>
                                    </div>
                                    <!-- ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯2åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
                                    <div th:if="${debugMode}" class="col-md-6">
                                        <p class="mb-2">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„æ–¹ã¯</p>
                                        <a th:href="@{/register}" class="register-link">
                                            <i class="fas fa-user-plus me-1"></i>ğŸŒŸ æ–°è¦ç™»éŒ²ã¯ã“ã¡ã‚‰
                                        </a>
                                    </div>
                                    <div th:if="${debugMode}" class="col-md-6">
                                        <p class="mb-2">ãƒãƒ«ãƒã‚¿ãƒ–ã§ãƒ­ã‚°ã‚¤ãƒ³</p>
                                        <a href="javascript:void(0)" onclick="openNewTab()" class="register-link">
                                            <i class="fas fa-cogs me-1"></i>ğŸ”— ãƒãƒ«ãƒãƒ­ã‚°ã‚¤ãƒ³
                                        </a>
                                    </div>
                                </div>
                                <!-- ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã®è¡¨ç¤º -->
                                <div th:if="${debugMode}" class="mt-3">
                                    <p class="mb-2" style="color: #e74c3c; font-weight: bold;">âš ï¸ ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹</p>
                                    <a th:href="@{/login/offdbg}" class="register-link" style="color: #e74c3c;">
                                        <i class="fas fa-bug me-1"></i>ğŸ”§ ãƒ‡ãƒãƒƒã‚°ç„¡åŠ¹åŒ–
                                    </a>
                                </div>
                                <!-- ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ãŒæœ‰åŠ¹ã§ã€ã‹ã¤ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ãŒç„¡åŠ¹ã®å ´åˆã®ã¿è¡¨ç¤ºï¼ˆæœ¬ç•ªã§ã¯éè¡¨ç¤ºï¼‰ -->
                                <div th:if="${debugEnabled and !debugMode}" class="mt-3">
                                    <small style="color: #999; font-size: 0.8rem;">
                                        <!-- é–‹ç™ºè€…ã®æ–¹ã¯ <a href="javascript:void(0)" onclick="tryEnableDebugMode()" style="color: #667eea; text-decoration: none;">ã“ã¡ã‚‰</a> ã‹ã‚‰ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã§ãã¾ã™ -->
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Kawaii Theme JavaScript -->
    <!--<script src="/js/kawaii-theme.js"></script>-->
    <script>
        function openNewTab() {
            // æ–°ã—ã„ã‚¿ãƒ–ã§ãƒãƒ«ãƒã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚’é–‹ã
            const newTabId = 'tab-' + Math.random().toString(36).substr(2, 8);
            const url = '/multi-session/login?tab=' + newTabId;
            window.open(url, '_blank');
        }
        
        // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–ã‚’è©¦è¡Œ
        function tryEnableDebugMode() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å ´åˆã®ã¿ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–
            if (username === 'yutosystem' && password === 'dbgmodeon') {
                // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–ãƒšãƒ¼ã‚¸ã«ç§»å‹•ï¼ˆã“ã‚ŒãŒ/login/dbgmodeã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰
                window.location.href = '/login/ondbg';
            }
            // ãã‚Œä»¥å¤–ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆå®Œå…¨ã«ç„¡åå¿œï¼‰
        }
        
        // ãƒ­ã‚°ã‚¤ãƒ³å°‚ç”¨åˆæœŸåŒ–
        function initPageSpecific() {
            // æ˜Ÿç©ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
            setupStarryNight();
            
            // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®è¨­å®š
            setupInstallButton();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹åŠ¹æœ
            const inputs = document.querySelectorAll('.form-control');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    this.parentElement.style.transform = 'scale(1.02)';
                    this.parentElement.style.zIndex = '10';
                });
                
                input.addEventListener('blur', function() {
                    this.parentElement.style.transform = 'scale(1)';
                    this.parentElement.style.zIndex = '1';
                });
            });
            
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã«ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœ
            // const loginBtn = document.querySelector('.login-btn');
            // if (loginBtn) {
            //     loginBtn.addEventListener('click', function() {
                    // æˆåŠŸæ™‚ã®ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœ
            //         for (let i = 0; i < 5; i++) {
            //             setTimeout(() => {
            //                 const sparkle = document.createElement('div');
            //                 sparkle.innerHTML = 'âœ¨';
            //                 sparkle.style.position = 'absolute';
            //                 sparkle.style.left = Math.random() * 100 + '%';
            //                 sparkle.style.top = Math.random() * 100 + '%';
            //                 sparkle.style.animation = 'sparkle 1s ease-out forwards';
            //                 sparkle.style.pointerEvents = 'none';
            //                 sparkle.style.zIndex = '1000';
            //                 document.body.appendChild(sparkle);
                            
            //                 setTimeout(() => sparkle.remove(), 1000);
            //             }, i * 100);
            //         }
            //     });
            // }
        }
        
        // æ˜Ÿç©ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¨­å®š
        function setupStarryNight() {
            const container = document.querySelector('.login-kontena');
            if (!container) return;
            
            // æ˜Ÿç©ºã‚¯ãƒ©ã‚¹ã‚’é©ç”¨
            container.classList.add('starry');
            
            // theme-colorã‚’æ˜Ÿç©ºã«è¨­å®š
            document.querySelector('meta[name="theme-color"]').setAttribute('content', '#203A43');
            
            // æ˜Ÿã‚’ç”Ÿæˆ
            createStars(80);
            
            console.log('âœ¨ Starry night activated');
        }
        
        // æ˜Ÿã‚’ç”Ÿæˆ
        function createStars(count) {
            const container = document.querySelector('.login-kontena');
            if (!container) return;
            
            for (let i = 0; i < count; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                
                // å¤§ãã„æ˜Ÿã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é…ç½®
                if (Math.random() > 0.8) {
                    star.style.width = '3px';
                    star.style.height = '3px';
                }
                
                container.appendChild(star);
            }
        }
        
        /*
        // ãƒ©ãƒ³ãƒ€ãƒ ãªå¤©æ°—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’é¸æŠ
        function selectRandomWeather() {
            const weathers = ['sunny', 'cloudy', 'rainy', 'stormy', 'starry'];
            const randomWeather = weathers[Math.floor(Math.random() * weathers.length)];
            
            const container = document.querySelector('.login-kontena');
            if (!container) return;
            
            // å¤©æ°—ã‚¯ãƒ©ã‚¹ã‚’é©ç”¨
            container.classList.add(randomWeather);
            
            // theme-colorã‚’å¤©æ°—ã«å¿œã˜ã¦å¤‰æ›´
            const themeColors = {
                sunny: '#4A90E2',
                cloudy: '#78909C',
                rainy: '#455A64',
                stormy: '#263238',
                starry: '#203A43'
            };
            document.querySelector('meta[name="theme-color"]').setAttribute('content', themeColors[randomWeather]);
            
            // å¤©æ°—ã«å¿œã˜ãŸã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆ
            switch(randomWeather) {
                case 'sunny':
                case 'cloudy':
                    // é›²ã¯ CSS ã® ::before ::after ã§è¡¨ç¤ºã•ã‚Œã‚‹
                    break;
                    
                case 'rainy':
                    createRain(100);
                    break;
                    
                case 'stormy':
                    createRain(150);
                    createLightning();
                    break;
                    
                case 'starry':
                    createStars(80);
                    break;
            }
            
            console.log('ğŸŒ¤ï¸ Selected weather:', randomWeather);
        }
        
        // é›¨ã‚’ç”Ÿæˆ
        function createRain(count) {
            const container = document.querySelector('.login-kontena');
            if (!container) return;
            
            for (let i = 0; i < count; i++) {
                const drop = document.createElement('div');
                drop.className = 'raindrop';
                drop.style.left = Math.random() * 100 + '%';
                drop.style.top = '-50px';
                drop.style.animationDuration = (Math.random() * 0.5 + 0.5) + 's';
                drop.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(drop);
            }
        }
        
        // æ˜Ÿã‚’ç”Ÿæˆ
        function createStars(count) {
            const container = document.querySelector('.login-kontena');
            if (!container) return;
            
            for (let i = 0; i < count; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                
                // å¤§ãã„æ˜Ÿã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é…ç½®
                if (Math.random() > 0.8) {
                    star.style.width = '3px';
                    star.style.height = '3px';
                }
                
                container.appendChild(star);
            }
        }
        
        // é›·ã®é–ƒå…‰ã‚’ç”Ÿæˆ
        function createLightning() {
            const container = document.querySelector('.login-kontena');
            if (!container) return;
            
            const flash = document.createElement('div');
            flash.className = 'lightning-flash';
            container.appendChild(flash);
        }
        */
        
        // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®è¨­å®š
        let deferredPrompt;
        
        function setupInstallButton() {
            const installButton = document.getElementById('install-button');
            
            // PWAæ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
                // æ—¢ã«ã‚¢ãƒ—ãƒªã¨ã—ã¦å®Ÿè¡Œä¸­
                return;
            }
            
            // iOSï¼ˆSafariï¼‰ã‹ãƒã‚§ãƒƒã‚¯
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isInStandaloneMode = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
            
            if (isIOS && !isInStandaloneMode) {
                // iOSç”¨ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¡ˆå†…ã‚’è¡¨ç¤º
                installButton.style.display = 'block';
                installButton.innerHTML = '<i class="fas fa-mobile-alt me-1" style="color: #667eea;"></i><span style="color: #667eea; font-weight: 600;">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</span>';
                
                installButton.addEventListener('click', () => {
                    showIOSInstallGuide();
                });
                return;
            }
            
            // Android/Chromeç”¨ã®beforeinstallprompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                installButton.style.display = 'block';
            });
            
            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚
            installButton.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                
                // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
                deferredPrompt.prompt();
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠã‚’å¾…ã¤
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response: ${outcome}`);
                
                // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ã„åˆ‡ã£ãŸã®ã§ã‚¯ãƒªã‚¢
                deferredPrompt = null;
                installButton.style.display = 'none';
            });
            
            // ã‚¢ãƒ—ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸã‚‰
            window.addEventListener('appinstalled', () => {
                installButton.style.display = 'none';
                console.log('PWA installed successfully!');
            });
        }
        
        // iOSç”¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¬ã‚¤ãƒ‰è¡¨ç¤º
        function showIOSInstallGuide() {
            const guide = document.createElement('div');
            guide.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(20px);
                border-radius: 20px;
                padding: 2rem;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                max-width: 90%;
                width: 400px;
                text-align: center;
            `;
            
            guide.innerHTML = `
                <h5 style="color: #667eea; margin-bottom: 1rem;">ğŸ“± ã‚¢ãƒ—ãƒªã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</h5>
                <p style="color: #666; margin-bottom: 1.5rem; line-height: 1.6;">
                    Safari ã®ä¸‹éƒ¨ã«ã‚ã‚‹<br>
                    <strong style="color: #667eea;">å…±æœ‰ãƒœã‚¿ãƒ³ <i class="fas fa-share" style="font-size: 1.2rem;"></i></strong> ã‚’ã‚¿ãƒƒãƒ—<br>
                    â†“<br>
                    <strong style="color: #667eea;">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </strong> ã‚’é¸æŠ
                </p>
                <button onclick="this.parentElement.remove()" 
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                               color: white; border: none; border-radius: 25px; 
                               padding: 0.75rem 2rem; font-weight: 600; cursor: pointer;">
                    ã‚ã‹ã‚Šã¾ã—ãŸ
                </button>
            `;
            
            // èƒŒæ™¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 9999;
            `;
            overlay.onclick = () => {
                overlay.remove();
                guide.remove();
            };
            
            document.body.appendChild(overlay);
            document.body.appendChild(guide);
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', function() {
            initPageSpecific();
            checkAutoLogin();
        });
        
        // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½
        function checkAutoLogin() {
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç¢ºèª
            const urlParams = new URLSearchParams(window.location.search);
            const hasError = urlParams.has('error');
            const hasLogout = urlParams.has('logout');
            
            // ã‚¨ãƒ©ãƒ¼ã‚„ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãŒã‚ã‚‹å ´åˆã¯localStorageã‚’ã‚¯ãƒªã‚¢
            if (hasError || hasLogout) {
                localStorage.removeItem('rememberLogin');
                localStorage.removeItem('savedUsername');
                sessionStorage.removeItem('loginRedirectCount');
                return;
            }
            
            // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ«ãƒ¼ãƒ—ã‚’é˜²ããŸã‚ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
            let redirectCount = parseInt(sessionStorage.getItem('loginRedirectCount') || '0');
            if (redirectCount > 2) {
                // 3å›ä»¥ä¸Šãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚ŒãŸå ´åˆã¯localStorageã‚’ã‚¯ãƒªã‚¢
                console.log('ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ«ãƒ¼ãƒ—ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚');
                localStorage.removeItem('rememberLogin');
                localStorage.removeItem('savedUsername');
                sessionStorage.removeItem('loginRedirectCount');
                return;
            }
            
            // ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒè¨˜æ†¶ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const rememberLogin = localStorage.getItem('rememberLogin');
            const savedUsername = localStorage.getItem('savedUsername');
            
            // rememberLoginãŒtrueã§ã€ã‹ã¤usernameãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹å ´åˆ
            if (rememberLogin === 'true' && savedUsername) {
                console.log('è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™...');
                // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚«ã‚¦ãƒ³ãƒˆã‚’å¢—ã‚„ã™
                sessionStorage.setItem('loginRedirectCount', (redirectCount + 1).toString());
                // Remember-Meãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹å ´åˆã€Spring SecurityãŒè‡ªå‹•çš„ã«ãƒ­ã‚°ã‚¤ãƒ³ã‚’å‡¦ç†ã—ã¾ã™
                // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã§ã¯ãªããƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                window.location.href = '/home';
            } else {
                // ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒãªã„å ´åˆã¯ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                sessionStorage.removeItem('loginRedirectCount');
            }
        }
        
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã«ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’è¨˜æ†¶
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.querySelector('form[action*="/login"]');
            if (loginForm) {
                loginForm.addEventListener('submit', function() {
                    const username = document.getElementById('username').value;
                    // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã®ãŸã‚ã«æƒ…å ±ã‚’è¨˜æ†¶ï¼ˆå®Ÿéš›ã®ä¿å­˜ã¯ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸå¾Œï¼‰
                    sessionStorage.setItem('pendingUsername', username);
                });
            }
        });
        
        // æµ®éŠçµµæ–‡å­—ã‚’ä½œæˆ
        // function createFloatingEmojis() {
        //     const emojis = ['ğŸ’«', 'â­', 'ğŸŒŸ', 'âœ¨', 'ğŸ’–', 'ğŸ¦„', 'ğŸŒˆ', 'ğŸˆ'];
            
        //     setInterval(() => {
        //         const emoji = document.createElement('div');
        //         emoji.className = 'floating-emoji';
        //         emoji.innerHTML = emojis[Math.floor(Math.random() * emojis.length)];
        //         emoji.style.left = Math.random() * 100 + '%';
        //         emoji.style.animationDuration = (Math.random() * 3 + 5) + 's';
                
        //         document.body.appendChild(emoji);
                
        //         setTimeout(() => {
        //             if (emoji.parentNode) {
        //                 emoji.parentNode.removeChild(emoji);
        //             }
        //         }, 8000);
        //     }, 2000);
        // }
    </script>
    
    <!-- ã‚·ãƒ³ãƒ—ãƒ«ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­– -->
    <script>
        console.log('Login page loaded - CSS version: 20251110001');
        // é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ç¢ºèªç”¨
        console.log('Current mobile.css styles applied');
    </script>
    
    <!-- PWAæ©Ÿèƒ½ -->
    <script src="/js/pwa.js"></script>

    <!-- CSRFå¯¾å¿œ -->
    <script th:src="@{/js/csrf-helper.js(v=${@appVersion})}"></script>

    <!-- äºŒé‡é€ä¿¡é˜²æ­¢ -->
    <script th:src="@{/js/prevent-double-submit.js(v=${@appVersion})}"></script>
</body>
</html>
